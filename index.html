<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#f59e0b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ë„í† ë¦¬ ìƒì ">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="icons/icon-192x192.png">
<title>ğŸŒ° ë„í† ë¦¬ ìƒì </title>
<script>
// â”€â”€ Supabase ê²½ëŸ‰ í´ë¼ì´ì–¸íŠ¸ (CDN ì—†ì´ ì§ì ‘ êµ¬í˜„) â”€â”€
const supabase = (() => {
  function createClient(url, key) {
    const headers = { 'apikey': key, 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' };
    let _session = null;
    let _listeners = [];
    let _refreshTimer = null;

    function _notify(event, session) {
      _listeners.forEach(fn => fn(event, session));
    }

    function _saveSession(s) {
      _session = s;
      if (s) {
        localStorage.setItem('sb_session', JSON.stringify(s));
        // ìë™ í† í° ê°±ì‹ 
        const exp = s.expires_at * 1000 - Date.now() - 60000;
        if (_refreshTimer) clearTimeout(_refreshTimer);
        if (exp > 0) _refreshTimer = setTimeout(_refreshSession, exp);
      } else {
        localStorage.removeItem('sb_session');
      }
    }

    async function _refreshSession() {
      const s = _session;
      if (!s?.refresh_token) return;
      try {
        const r = await fetch(url + '/auth/v1/token?grant_type=refresh_token', {
          method: 'POST', headers,
          body: JSON.stringify({ refresh_token: s.refresh_token })
        });
        const d = await r.json();
        if (d.access_token) {
          const ns = { ...d, user: d.user || s.user };
          _saveSession(ns);
          headers['Authorization'] = 'Bearer ' + d.access_token;
          _notify('TOKEN_REFRESHED', ns);
        }
      } catch(e) {}
    }

    const auth = {
      async getSession() {
        if (_session) return { data: { session: _session } };
        const stored = localStorage.getItem('sb_session');
        if (stored) {
          try {
            const s = JSON.parse(stored);
            if (s.expires_at && s.expires_at * 1000 > Date.now()) {
              _session = s;
              headers['Authorization'] = 'Bearer ' + s.access_token;
              return { data: { session: s } };
            }
          } catch(e) {}
        }
        return { data: { session: null } };
      },

      onAuthStateChange(fn) {
        _listeners.push(fn);
        return { data: { subscription: { unsubscribe: () => { _listeners = _listeners.filter(f => f !== fn); } } } };
      },

      async signUp({ email, password, options }) {
        const r = await fetch(url + '/auth/v1/signup', {
          method: 'POST', headers,
          body: JSON.stringify({ email, password, data: options?.data || {} })
        });
        const d = await r.json();
        if (d.error || d.msg) return { error: { message: d.error_description || d.msg || d.error } };
        if (d.access_token) {
          const s = { ...d, user: d.user };
          _saveSession(s);
          headers['Authorization'] = 'Bearer ' + d.access_token;
          _notify('SIGNED_IN', s);
        }
        return { data: d, error: null };
      },

      async signInWithPassword({ email, password }) {
        const r = await fetch(url + '/auth/v1/token?grant_type=password', {
          method: 'POST', headers,
          body: JSON.stringify({ email, password })
        });
        const d = await r.json();
        if (!r.ok) return { error: { message: d.error_description || d.msg || 'ë¡œê·¸ì¸ ì‹¤íŒ¨' } };
        const s = { ...d, user: d.user };
        _saveSession(s);
        headers['Authorization'] = 'Bearer ' + d.access_token;
        _notify('SIGNED_IN', s);
        return { data: { session: s }, error: null };
      },

      async signInWithOAuth({ provider, options }) {
        const redirectTo = encodeURIComponent(options?.redirectTo || window.location.href);
        window.location.href = url + '/auth/v1/authorize?provider=' + provider + '&redirect_to=' + redirectTo;
        return { error: null };
      },

      async signOut() {
        try {
          await fetch(url + '/auth/v1/logout', { method: 'POST', headers });
        } catch(e) {}
        _saveSession(null);
        headers['Authorization'] = 'Bearer ' + key;
        _notify('SIGNED_OUT', null);
      },

      async getUser() {
        if (!_session) return { data: { user: null } };
        return { data: { user: _session.user } };
      }
    };

    function from(table) {
      let _url = url + '/rest/v1/' + table;
      let _method = 'GET';
      let _body = null;
      let _filters = [];
      let _select = '*';
      let _order = null;
      let _single = false;
      let _upsert = false;

      const q = {
        select(cols) { _select = cols; _url = url + '/rest/v1/' + table + '?select=' + cols; return q; },
        eq(col, val) { _filters.push(col + '=eq.' + encodeURIComponent(val)); return q; },
        neq(col, val) { _filters.push(col + '=neq.' + encodeURIComponent(val)); return q; },
        order(col, opts) { _order = col + (opts?.ascending === false ? '.desc' : '.asc'); return q; },
        limit(n) { _filters.push('limit=' + n); return q; },
        single() { _single = true; return q; },
        insert(data) { _method = 'POST'; _body = JSON.stringify(data); return q; },
        upsert(data, opts) { 
          _method = 'POST'; 
          _body = JSON.stringify(data); 
          _upsert = true;
          return q; 
        },
        update(data) { _method = 'PATCH'; _body = JSON.stringify(data); return q; },
        delete() { _method = 'DELETE'; return q; },

        async then(resolve, reject) {
          try {
            let finalUrl = _url;
            if (!finalUrl.includes('?')) finalUrl += '?select=' + _select;
            if (_filters.length) finalUrl += '&' + _filters.join('&');
            if (_order) finalUrl += '&order=' + _order;

            const h = { ...headers };
            if (_upsert) h['Prefer'] = 'resolution=merge-duplicates,return=representation';
            else if (_method === 'POST') h['Prefer'] = 'return=representation';
            if (_single) h['Accept'] = 'application/vnd.pgrst.object+json';

            const r = await fetch(finalUrl, { method: _method, headers: h, body: _body });
            const text = await r.text();
            let d = null;
            try { d = text ? JSON.parse(text) : null; } catch(e) { d = null; }
            if (!r.ok) {
              resolve({ data: null, error: { message: d?.message || d?.hint || r.statusText } });
            } else {
              resolve({ data: d, error: null });
            }
          } catch(e) {
            resolve({ data: null, error: { message: e.message } });
          }
        }
      };
      return q;
    }

    async function rpc(fn, params) {
      const h = { ...headers, 'Prefer': 'return=representation' };
      try {
        const r = await fetch(url + '/rest/v1/rpc/' + fn, {
          method: 'POST', headers: h,
          body: JSON.stringify(params)
        });
        const d = await r.json();
        if (!r.ok) return { data: null, error: { message: d?.message || d?.hint || 'RPC ì˜¤ë¥˜' } };
        return { data: d, error: null };
      } catch(e) {
        return { data: null, error: { message: e.message } };
      }
    }

    function channel(name) {
      // Realtimeì€ WebSocket í•„ìš” - í´ë§ìœ¼ë¡œ ëŒ€ì²´ (ê°„ë‹¨ êµ¬í˜„)
      return {
        on(event, filter, cb) { return this; },
        subscribe() { return this; }
      };
    }

    return { auth, from, rpc, channel };
  }
  return { createClient };
})();
</script>


<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>

/* â”€â”€ Tailwind í•µì‹¬ ìœ í‹¸ë¦¬í‹° (CDN ëŒ€ì²´) â”€â”€ */
.hidden{display:none!important}
.flex{display:flex}.inline-flex{display:inline-flex}.block{display:block}.grid{display:grid}
.flex-1{flex:1 1 0%}.flex-col{flex-direction:column}.flex-row{flex-direction:row}
.items-center{align-items:center}.items-start{align-items:flex-start}
.justify-center{justify-content:center}.justify-between{justify-content:space-between}.justify-end{justify-content:flex-end}
.gap-1{gap:4px}.gap-2{gap:8px}.gap-3{gap:12px}.gap-4{gap:16px}.gap-6{gap:24px}
.w-full{width:100%}.w-auto{width:auto}.h-full{height:100%}.h-px{height:1px}
.min-h-screen{min-height:100vh}
.max-w-2xl{max-width:42rem}.max-w-sm{max-width:24rem}.max-w-lg{max-width:32rem}
.mx-auto{margin-left:auto;margin-right:auto}
.p-1{padding:4px}.p-2{padding:8px}.p-3{padding:12px}.p-4{padding:16px}.p-5{padding:20px}.p-6{padding:24px}
.px-2{padding-left:8px;padding-right:8px}.px-3{padding-left:12px;padding-right:12px}.px-4{padding-left:16px;padding-right:16px}
.py-1{padding-top:4px;padding-bottom:4px}.py-2{padding-top:8px;padding-bottom:8px}.py-3{padding-top:12px;padding-bottom:12px}.py-4{padding-top:16px;padding-bottom:16px}
.pt-2{padding-top:8px}.pb-2{padding-bottom:8px}.pb-4{padding-bottom:16px}.pb-6{padding-bottom:24px}
.m-0{margin:0}.mt-1{margin-top:4px}.mt-2{margin-top:8px}.mt-3{margin-top:12px}.mt-4{margin-top:16px}
.mb-1{margin-bottom:4px}.mb-2{margin-bottom:8px}.mb-3{margin-bottom:12px}.mb-4{margin-bottom:16px}.mb-6{margin-bottom:24px}
.ml-1{margin-left:4px}.ml-2{margin-left:8px}.mr-1{margin-right:4px}.mr-2{margin-right:8px}
.space-y-2>*+*{margin-top:8px}.space-y-3>*+*{margin-top:12px}.space-y-4>*+*{margin-top:16px}
.text-xs{font-size:12px}.text-sm{font-size:13px}.text-base{font-size:14px}.text-lg{font-size:18px}.text-xl{font-size:20px}.text-2xl{font-size:24px}.text-3xl{font-size:30px}
.font-bold{font-weight:700}.font-semibold{font-weight:600}.font-black{font-weight:900}.font-medium{font-weight:500}
.text-center{text-align:center}.text-left{text-align:left}.text-right{text-align:right}
.text-white{color:#fff}.text-gray-400{color:#9ca3af}.text-gray-500{color:#6b7280}.text-gray-600{color:#4b5563}.text-gray-700{color:#374151}.text-gray-800{color:#1f2937}.text-gray-900{color:#111827}
.text-amber-500{color:#f59e0b}.text-amber-600{color:#d97706}.text-amber-700{color:#b45309}
.text-red-500{color:#ef4444}.text-red-600{color:#dc2626}.text-green-600{color:#16a34a}.text-blue-600{color:#2563eb}.text-purple-600{color:#9333ea}
.bg-white{background:#fff}.bg-gray-50{background:#f9fafb}.bg-gray-100{background:#f3f4f6}.bg-gray-200{background:#e5e7eb}
.bg-amber-50{background:#fffbeb}.bg-amber-100{background:#fef3c7}.bg-amber-500{background:#f59e0b}
.bg-green-100{background:#dcfce7}.bg-red-100{background:#fee2e2}.bg-blue-100{background:#dbeafe}
.bg-yellow-100{background:#fef9c3}.bg-purple-100{background:#ede9fe}
.rounded{border-radius:4px}.rounded-md{border-radius:6px}.rounded-lg{border-radius:8px}.rounded-xl{border-radius:12px}.rounded-2xl{border-radius:16px}.rounded-full{border-radius:9999px}
.border{border:1px solid #e5e7eb}.border-2{border:2px solid #e5e7eb}.border-gray-200{border-color:#e5e7eb}.border-amber-200{border-color:#fde68a}
.shadow{box-shadow:0 1px 3px rgba(0,0,0,.1)}.shadow-md{box-shadow:0 4px 6px rgba(0,0,0,.07)}.shadow-lg{box-shadow:0 10px 15px rgba(0,0,0,.1)}
.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.overflow-x-auto{overflow-x:auto}
.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.whitespace-nowrap{white-space:nowrap}
.relative{position:relative}.absolute{position:absolute}.fixed{position:fixed}.sticky{position:sticky}
.top-0{top:0}.bottom-0{bottom:0}.left-0{left:0}.right-0{right:0}.inset-0{inset:0}
.z-10{z-index:10}.z-50{z-index:50}
.opacity-50{opacity:.5}.opacity-0{opacity:0}.opacity-100{opacity:1}
.cursor-pointer{cursor:pointer}.pointer-events-none{pointer-events:none}
.underline{text-decoration:underline}.line-through{text-decoration:line-through}
.select-none{user-select:none}
.resize-none{resize:none}
.transition{transition:all .15s}
.grid-cols-2{grid-template-columns:repeat(2,1fr)}.grid-cols-3{grid-template-columns:repeat(3,1fr)}
.col-span-2{grid-column:span 2}
.shrink-0{flex-shrink:0}
.aspect-square{aspect-ratio:1}
.leading-tight{line-height:1.25}.leading-relaxed{line-height:1.625}
.italic{font-style:italic}
.capitalize{text-transform:capitalize}.uppercase{text-transform:uppercase}
.w-8{width:32px}.h-8{height:32px}.w-10{width:40px}.h-10{height:40px}.w-12{width:48px}.h-12{height:48px}
.w-6{width:24px}.h-6{height:24px}.w-4{width:16px}.h-4{height:16px}
.text-yellow-800{color:#854d0e}.text-green-800{color:#166534}.text-red-800{color:#991b1b}.text-blue-800{color:#1e40af}.text-purple-800{color:#6b21a8}

*,*::before,*::after{font-family:'Nunito',sans-serif;box-sizing:border-box}
html{-webkit-tap-highlight-color:transparent}
body{background:linear-gradient(135deg,#fff8f0 0%,#fef3e2 40%,#fde8d8 100%);min-height:100dvh;padding-bottom:env(safe-area-inset-bottom)}

.clay-card{background:#fff;border-radius:24px;box-shadow:0 8px 32px rgba(0,0,0,.08),0 2px 8px rgba(0,0,0,.04);transition:transform .2s,box-shadow .2s}
.card-hover:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.12)}

.btn{border-radius:16px;font-weight:800;transition:all .15s;cursor:pointer;border:none;outline:none;display:inline-flex;align-items:center;justify-content:center;gap:4px}
.btn:active{transform:scale(.96)}
.btn-primary{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;box-shadow:0 4px 16px rgba(245,158,11,.4)}
.btn-primary:hover{box-shadow:0 6px 24px rgba(245,158,11,.55);transform:translateY(-1px)}
.btn-green{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;box-shadow:0 4px 14px rgba(34,197,94,.3)}
.btn-red{background:linear-gradient(135deg,#f87171,#ef4444);color:#fff;box-shadow:0 4px 14px rgba(239,68,68,.3)}
.btn-purple{background:linear-gradient(135deg,#a78bfa,#8b5cf6);color:#fff;box-shadow:0 4px 14px rgba(139,92,246,.35)}
.btn-blue{background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff;box-shadow:0 4px 14px rgba(59,130,246,.3)}
.btn-gray{background:#f3f4f6;color:#6b7280}
.btn-kakao{background:#FEE500;color:#191919;box-shadow:0 4px 14px rgba(254,229,0,.4)}
.btn-pink{background:linear-gradient(135deg,#f9a8d4,#ec4899);color:#fff;box-shadow:0 4px 14px rgba(236,72,153,.3)}

.tab-btn{border-radius:14px;padding:10px 14px;font-weight:700;font-size:13px;cursor:pointer;transition:all .2s;border:none;background:transparent;color:#9ca3af;white-space:nowrap}
.tab-btn.active{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;box-shadow:0 4px 16px rgba(245,158,11,.35)}

.field{border:2px solid #e5e7eb;border-radius:14px;padding:10px 14px;font-family:'Nunito',sans-serif;font-weight:600;width:100%;outline:none;transition:border-color .2s;background:#fafafa;font-size:14px}
.field:focus{border-color:#f59e0b;background:#fff}

.badge{border-radius:20px;padding:3px 12px;font-size:12px;font-weight:800}
.rc-common{background:#f3f4f6;color:#6b7280}
.rc-rare{background:#dbeafe;color:#1d4ed8}
.rc-epic{background:#ede9fe;color:#7c3aed}
.rc-legend{background:#fee2e2;color:#dc2626}

.st-pending{background:#fef9c3;color:#854d0e}
.st-approved{background:#dcfce7;color:#15803d}
.st-rejected{background:#fee2e2;color:#b91c1c}

.rt-auto{background:#dcfce7;color:#15803d;border-radius:10px;padding:2px 9px;font-size:11px;font-weight:800}
.rt-manual{background:#e0e7ff;color:#3730a3;border-radius:10px;padding:2px 9px;font-size:11px;font-weight:800}

.rep-badge{border-radius:10px;padding:2px 8px;font-size:11px;font-weight:800}
.rep-once{background:#f3f4f6;color:#6b7280}
.rep-daily{background:#dbeafe;color:#1d4ed8}
.rep-weekly{background:#ede9fe;color:#7c3aed}

.ct-auto{background:#fef9c3;color:#854d0e;border-radius:10px;padding:2px 8px;font-size:11px;font-weight:800}
.ct-approval{background:#fce7f3;color:#9d174d;border-radius:10px;padding:2px 8px;font-size:11px;font-weight:800}

.qs-inprogress{background:#f3f4f6;color:#6b7280;border-radius:12px;padding:3px 10px;font-size:11px;font-weight:800}
.qs-done{background:#dcfce7;color:#15803d;border-radius:12px;padding:3px 10px;font-size:11px;font-weight:800}
.qs-pending{background:#fef9c3;color:#854d0e;border-radius:12px;padding:3px 10px;font-size:11px;font-weight:800}

.acorn-pill{background:linear-gradient(135deg,#fef3c7,#fde68a);border:3px solid #f59e0b;border-radius:20px;padding:4px 16px;font-weight:900;color:#92400e}

.tx-plus{color:#16a34a;font-weight:900}
.tx-minus{color:#dc2626;font-weight:900}

.stat-card{border-radius:20px;padding:18px}
.sc-orange{background:linear-gradient(135deg,#fff7ed,#ffedd5);border:2px solid #fed7aa}
.sc-blue{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:2px solid #bfdbfe}
.sc-green{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:2px solid #bbf7d0}
.sc-purple{background:linear-gradient(135deg,#faf5ff,#ede9fe);border:2px solid #ddd6fe}

.toggle-wrap{position:relative;display:inline-block;width:44px;height:24px}
.toggle-wrap input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:#d1d5db;border-radius:24px;cursor:pointer;transition:.3s}
.toggle-slider:before{content:'';position:absolute;width:18px;height:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}
.toggle-wrap input:checked+.toggle-slider{background:linear-gradient(135deg,#22c55e,#16a34a)}
.toggle-wrap input:checked+.toggle-slider:before{transform:translateX(20px)}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(5px);z-index:500;display:flex;align-items:center;justify-content:center;animation:fadeIn .2s}
.modal-box{background:#fff;border-radius:28px;padding:28px;width:92%;max-width:440px;animation:slideUp .25s cubic-bezier(.34,1.56,.64,1);box-shadow:0 24px 80px rgba(0,0,0,.2);max-height:90dvh;overflow-y:auto}

.login-screen{position:fixed;inset:0;z-index:300;background:linear-gradient(135deg,#fff8f0,#fde8d8);display:flex;align-items:center;justify-content:center}
.login-card{background:#fff;border-radius:32px;padding:40px 32px;width:92%;max-width:380px;box-shadow:0 24px 80px rgba(0,0,0,.12)}

.loading-screen{position:fixed;inset:0;z-index:400;background:#fff8f0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}

.notif-dot{width:8px;height:8px;background:#ef4444;border-radius:50%;position:absolute;top:0;right:0;animation:pulse .9s ease infinite}

#adminTabBar{overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none}
#adminTabBar::-webkit-scrollbar{display:none}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:99px}

#installBanner{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:150;width:calc(100% - 48px);max-width:400px;background:#fff;border-radius:20px;padding:14px 18px;box-shadow:0 8px 32px rgba(0,0,0,.15);display:flex;align-items:center;gap:12px;animation:slideUp .3s ease}

.drag-item{cursor:grab;user-select:none}
.drag-item:active{cursor:grabbing}
.drag-over{border:2px dashed #f59e0b !important;background:#fffbeb !important}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(40px) scale(.95);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
@keyframes bounceIn{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes popIn{0%{transform:scale(0) rotate(-180deg);opacity:0}100%{transform:scale(1) rotate(0);opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes spin{to{transform:rotate(360deg)}}

.bounce-in{animation:bounceIn .4s cubic-bezier(.34,1.56,.64,1) both}
.pop-in{animation:popIn .6s cubic-bezier(.34,1.56,.64,1) both}
.shake-anim{animation:shake .4s ease}
.spinner{animation:spin 1s linear infinite;border:3px solid #f3f4f6;border-top-color:#f59e0b;border-radius:50%;width:32px;height:32px}

.hidden{display:none !important}
</style>
</head>
<body>

<!-- â”€â”€ ë¡œë”© â”€â”€ -->
<div id="loadingScreen" class="loading-screen hidden">
  <div class="text-6xl">ğŸŒ°</div>
  <div class="spinner"></div>
  <p class="text-sm font-bold text-amber-600">ë¡œë”© ì¤‘...</p>
</div>

<!-- â”€â”€ ë¡œê·¸ì¸ â”€â”€ -->
<div id="loginScreen" class="login-screen">
  <div class="login-card bounce-in">
    <div class="text-center mb-8">
      <div class="text-6xl mb-3">ğŸŒ°</div>
      <h1 class="text-3xl font-black text-amber-900">ë„í† ë¦¬ ìƒì </h1>
      <p class="text-sm text-amber-600 font-semibold mt-1">Acorn Shop âœ¨</p>
    </div>

    <!-- ì´ë©”ì¼ ë¡œê·¸ì¸ -->
    <div class="space-y-3 mb-4">
      <input class="field" type="email" id="loginEmail" placeholder="ì´ë©”ì¼" onkeydown="if(event.key==='Enter')doEmailLogin()">
      <input class="field" type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key==='Enter')doEmailLogin()">
      <div id="loginErr" class="hidden text-xs text-red-500 font-bold text-center pt-1"></div>
    </div>
    <button class="btn btn-primary w-full py-4 text-base mb-3" onclick="doEmailLogin()">ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸</button>

    <!-- êµ¬ë¶„ì„  -->
    <div class="flex items-center gap-3 mb-3">
      <div class="flex-1 h-px bg-gray-200"></div>
      <span class="text-xs text-gray-400 font-semibold">ë˜ëŠ”</span>
      <div class="flex-1 h-px bg-gray-200"></div>
    </div>

    <!-- ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ -->
    <button class="btn btn-kakao w-full py-4 text-base mb-4" onclick="doKakaoLogin()">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none" style="flex-shrink:0">
        <path d="M9 1.5C4.86 1.5 1.5 4.14 1.5 7.38c0 2.1 1.35 3.93 3.39 4.98L4.05 15l3.57-2.43c.45.06.9.09 1.38.09 4.14 0 7.5-2.64 7.5-5.88C16.5 4.14 13.14 1.5 9 1.5z" fill="#191919"/>
      </svg>
      ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸
    </button>

    <!-- íšŒì›ê°€ì… -->
    <div class="text-center">
      <button class="text-xs text-amber-600 font-bold underline" onclick="console.log('ë²„íŠ¼í´ë¦­ë¨'); showSignup();">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ì•± ë£¨íŠ¸ â”€â”€ -->
<div id="appRoot" class="hidden min-h-screen p-4">
<div class="max-w-2xl mx-auto">

  <!-- í—¤ë” -->
  <div class="flex items-center justify-between mb-5 py-2">
    <div class="flex items-center gap-3">
      <div class="text-4xl">ğŸŒ°</div>
      <div>
        <h1 class="text-xl font-black text-amber-900">ë„í† ë¦¬ ìƒì </h1>
        <p class="text-xs text-amber-500 font-bold -mt-0.5" id="headerUserLabel">Acorn Shop âœ¨</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button class="relative p-2 rounded-2xl bg-white shadow-sm hidden" onclick="showNotifications()" id="notifBtn">
        <span class="text-xl">ğŸ””</span>
        <span class="notif-dot hidden" id="notifDot"></span>
      </button>
      <div class="acorn-pill text-sm hidden" id="headerAcorns">ğŸŒ° 0</div>
      <button class="btn btn-gray px-3 py-2 text-xs" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <!-- â”€â”€ ì‚¬ìš©ì ëª¨ë“œ â”€â”€ -->
  <div id="userMode" class="hidden">
    <div class="flex gap-1 mb-5 clay-card p-2">
      <button class="tab-btn active flex-1" onclick="uTab('shop',this)">ğŸ›ï¸ ìƒì </button>
      <button class="tab-btn flex-1" onclick="uTab('gacha',this)">ğŸ² ë½‘ê¸°</button>
      <button class="tab-btn flex-1" onclick="uTab('quest',this)">ğŸ“‹ í€˜ìŠ¤íŠ¸</button>
      <button class="tab-btn flex-1" onclick="uTab('mypage',this)">ğŸ‘¤ ë§ˆì´</button>
    </div>
    <div id="utab-shop">
      <p class="text-sm font-bold text-amber-700 mb-3 px-1">ğŸ›’ êµ¬ë§¤ ê°€ëŠ¥í•œ ìƒí’ˆ</p>
      <div id="shopGrid" class="grid grid-cols-2 gap-3"></div>
    </div>
    <div id="utab-gacha" class="hidden">
      <div class="clay-card p-6 text-center mb-4">
        <div class="text-6xl mb-3" id="gachaIcon">ğŸ</div>
        <h2 class="text-xl font-black text-gray-800 mb-1">ë„í† ë¦¬ ë½‘ê¸°</h2>
        <p class="text-sm text-gray-400 font-semibold mb-4">1íšŒ = <span class="text-amber-600 font-black">ğŸŒ° 10</span> &nbsp;|&nbsp; 5íšŒ = <span class="text-amber-600 font-black">ğŸŒ° 50</span></p>
        <div class="flex justify-center gap-3">
          <button class="btn btn-primary px-8 py-3 text-base" onclick="doGacha(1)">1íšŒ ë½‘ê¸°</button>
          <button class="btn btn-purple px-8 py-3 text-base" onclick="doGacha(5)">5íšŒ ë½‘ê¸°</button>
        </div>
      </div>
      <div id="gachaResult" class="hidden clay-card p-6 text-center mb-4">
        <p class="text-sm font-bold text-gray-400 mb-4">ğŸ‰ ê²°ê³¼!</p>
        <div id="gachaResultItems" class="flex flex-wrap justify-center gap-4"></div>
      </div>
      <div class="clay-card p-4">
        <p class="text-sm font-black text-gray-700 mb-3">ğŸ“Š í™•ë¥ í‘œ</p>
        <div class="space-y-2">
          <div class="flex justify-between"><span class="text-sm font-bold">âšª ì¼ë°˜</span><span class="badge rc-common">50%</span></div>
          <div class="flex justify-between"><span class="text-sm font-bold">ğŸ”µ ë ˆì–´</span><span class="badge rc-rare">30%</span></div>
          <div class="flex justify-between"><span class="text-sm font-bold">ğŸŸ£ ì—í”½</span><span class="badge rc-epic">15%</span></div>
          <div class="flex justify-between"><span class="text-sm font-bold">ğŸ”´ ì „ì„¤</span><span class="badge rc-legend">5%</span></div>
        </div>
      </div>
    </div>
    <div id="utab-quest" class="hidden">
      <p class="text-sm font-bold text-amber-700 mb-3 px-1">ğŸ“‹ í€˜ìŠ¤íŠ¸</p>
      <div id="questList" class="space-y-3"></div>
    </div>
    <div id="utab-mypage" class="hidden">
      <div class="clay-card p-6 mb-4" id="mypageHeader"></div>
      <div class="clay-card p-5 mb-4">
        <p class="text-sm font-black text-gray-700 mb-3">ğŸ“¦ ì‹ ì²­ í˜„í™©</p>
        <div id="myRequestList" class="space-y-2"></div>
      </div>
      <div class="clay-card p-5">
        <p class="text-sm font-black text-gray-700 mb-3">ğŸ“œ ë„í† ë¦¬ ë‚´ì—­ <span class="text-gray-400 text-xs">(ìµœì‹ ìˆœ)</span></p>
        <div id="myTxList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ ê´€ë¦¬ì ëª¨ë“œ â”€â”€ -->
  <div id="adminMode" class="hidden">
    <div id="adminTabBar" class="flex gap-1 mb-5 clay-card p-2">
      <button class="tab-btn active" onclick="aTab('dashboard',this)">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
      <button class="tab-btn" onclick="aTab('give',this)">ğŸŒ° ì§€ê¸‰</button>
      <button class="tab-btn" onclick="aTab('gachaTest',this)">ğŸ² í…ŒìŠ¤íŠ¸</button>
      <button class="tab-btn" onclick="aTab('products',this)">ğŸ›ï¸ ìƒí’ˆ</button>
      <button class="tab-btn" onclick="aTab('quests',this)">ğŸ“‹ í€˜ìŠ¤íŠ¸</button>
      <button class="tab-btn" onclick="aTab('requests',this)">ğŸ“¬ ì‹ ì²­</button>
      <button class="tab-btn" onclick="aTab('txlog',this)">ğŸ—‚ï¸ ë¡œê·¸</button>
      <button class="tab-btn" onclick="aTab('users',this)">ğŸ‘¥ íšŒì›</button>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ -->
    <div id="atab-dashboard">
      <p class="text-xs font-black text-amber-600 uppercase tracking-wider mb-3 px-1">ì˜¤ëŠ˜ í˜„í™©</p>
      <div class="grid grid-cols-2 gap-3 mb-5">
        <div class="stat-card sc-orange bounce-in"><div class="text-2xl mb-1">ğŸ‘¥</div><div class="text-2xl font-black text-orange-700" id="ds-users">â€”</div><div class="text-xs font-bold text-orange-500 mt-1">ì „ì²´ ì‚¬ìš©ì</div></div>
        <div class="stat-card sc-blue bounce-in" style="animation-delay:.05s"><div class="text-2xl mb-1">ğŸ²</div><div class="text-2xl font-black text-blue-700" id="ds-todayGacha">â€”</div><div class="text-xs font-bold text-blue-500 mt-1">ì˜¤ëŠ˜ ë½‘ê¸°</div></div>
        <div class="stat-card sc-green bounce-in" style="animation-delay:.1s"><div class="text-2xl mb-1">â¬†ï¸</div><div class="text-2xl font-black text-green-700" id="ds-todayGiven">â€”</div><div class="text-xs font-bold text-green-500 mt-1">ì˜¤ëŠ˜ ì§€ê¸‰</div></div>
        <div class="stat-card sc-purple bounce-in" style="animation-delay:.15s"><div class="text-2xl mb-1">â¬‡ï¸</div><div class="text-2xl font-black text-purple-700" id="ds-todayUsed">â€”</div><div class="text-xs font-bold text-purple-500 mt-1">ì˜¤ëŠ˜ ì‚¬ìš©</div></div>
      </div>
      <p class="text-xs font-black text-amber-600 uppercase tracking-wider mb-3 px-1">ìµœê·¼ í™œë™</p>
      <div class="clay-card p-4"><div id="ds-activityLog"></div></div>
    </div>

    <!-- ì§€ê¸‰ -->
    <div id="atab-give" class="hidden">
      <div class="clay-card p-6">
        <h2 class="text-lg font-black text-gray-800 mb-5">ğŸŒ° ë„í† ë¦¬ ì§€ê¸‰</h2>
        <div class="space-y-4">
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ì‚¬ìš©ì ì„ íƒ</label><select class="field" id="giveUser"></select></div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ì§€ê¸‰ëŸ‰</label><input class="field" type="number" id="giveAmount" placeholder="ì§€ê¸‰í•  ë„í† ë¦¬ ìˆ˜" min="1"></div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ë©”ëª¨</label><input class="field" type="text" id="giveMemo" placeholder="ì§€ê¸‰ ì‚¬ìœ "></div>
          <button class="btn btn-primary w-full py-3 text-base" onclick="giveAcorns()">ğŸŒ° ì§€ê¸‰í•˜ê¸°</button>
        </div>
      </div>
      <div class="clay-card p-5 mt-4"><p class="text-sm font-black text-gray-700 mb-3">ğŸ“œ ìµœê·¼ ì§€ê¸‰ ë‚´ì—­</p><div id="giveHistory" class="space-y-2"></div></div>
    </div>

    <!-- ë½‘ê¸° í…ŒìŠ¤íŠ¸ -->
    <div id="atab-gachaTest" class="hidden">
      <div class="clay-card p-6 mb-4">
        <h2 class="text-lg font-black text-gray-800 mb-2">ğŸ² ë½‘ê¸° í…ŒìŠ¤íŠ¸ ëª¨ë“œ</h2>
        <div class="text-xs font-bold text-amber-700 bg-amber-50 rounded-2xl p-3 mb-4">âš¡ ì‹¤ì œ ë„í† ë¦¬ ì°¨ê° ì—†ì´ í…ŒìŠ¤íŠ¸!</div>
        <div class="grid grid-cols-2 gap-2 mb-2">
          <button class="btn btn-gray py-2 text-xs" onclick="setForce('')">ğŸ² ëœë¤</button>
          <button class="btn rc-common border-2 border-gray-200 py-2 text-xs" onclick="setForce('common')">âšª ì¼ë°˜</button>
          <button class="btn rc-rare border-2 border-blue-200 py-2 text-xs" onclick="setForce('rare')">ğŸ”µ ë ˆì–´</button>
          <button class="btn rc-epic border-2 border-purple-200 py-2 text-xs" onclick="setForce('epic')">ğŸŸ£ ì—í”½</button>
        </div>
        <button class="btn rc-legend border-2 border-red-200 w-full py-2 text-xs mb-4" onclick="setForce('legend')">ğŸ”´ ì „ì„¤ ê°•ì œ</button>
        <p class="text-sm font-bold text-gray-600 mb-4">ê°•ì œ: <span id="forceLabel" class="text-amber-600 font-black">ëœë¤</span></p>
        <div class="flex gap-3">
          <button class="btn btn-primary flex-1 py-3" onclick="doGachaTest(1)">1íšŒ í…ŒìŠ¤íŠ¸</button>
          <button class="btn btn-purple flex-1 py-3" onclick="doGachaTest(5)">5íšŒ í…ŒìŠ¤íŠ¸</button>
        </div>
      </div>
      <div id="gachaTestResult" class="hidden clay-card p-6 text-center">
        <p class="text-sm font-bold text-gray-400 mb-4">ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼</p>
        <div id="gachaTestItems" class="flex flex-wrap justify-center gap-4"></div>
      </div>
    </div>

    <!-- ìƒí’ˆ -->
    <div id="atab-products" class="hidden">
      <div class="clay-card p-5 mb-4">
        <h2 class="text-lg font-black text-gray-800 mb-4">â• ìƒí’ˆ ë“±ë¡</h2>
        <div class="space-y-3">
          <input class="field" type="text" id="np-name" placeholder="ìƒí’ˆ ì´ë¦„">
          <div class="grid grid-cols-2 gap-3">
            <input class="field" type="number" id="np-price" placeholder="ë„í† ë¦¬ ê°€ê²©">
            <input class="field" type="text" id="np-icon" placeholder="ì´ëª¨ì§€ ì•„ì´ì½˜">
          </div>
          <input class="field" type="text" id="np-desc" placeholder="ìƒí’ˆ ì„¤ëª…">
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ë³´ìƒ íƒ€ì…</label>
            <select class="field" id="np-rewardType" onchange="toggleAcornField('np')">
              <option value="MANUAL_ITEM">ğŸ“¬ MANUAL_ITEM â€” ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”</option>
              <option value="AUTO_ACORN">âš¡ AUTO_ACORN â€” ì¦‰ì‹œ ë„í† ë¦¬ ì§€ê¸‰</option>
            </select>
          </div>
          <div id="np-acornWrap" class="hidden"><input class="field" type="number" id="np-acornAmt" placeholder="ì§€ê¸‰ ë„í† ë¦¬ ìˆ˜ëŸ‰"></div>
          <button class="btn btn-primary w-full py-3" onclick="addProduct()">ğŸ›ï¸ ìƒí’ˆ ì¶”ê°€</button>
        </div>
      </div>
      <div class="clay-card p-5"><p class="text-sm font-black text-gray-700 mb-4">ğŸ“¦ ìƒí’ˆ ëª©ë¡</p><div id="productAdminList" class="space-y-3"></div></div>
    </div>

    <!-- í€˜ìŠ¤íŠ¸ -->
    <div id="atab-quests" class="hidden">
      <div class="clay-card p-5 mb-4">
        <h2 class="text-lg font-black text-gray-800 mb-4">â• í€˜ìŠ¤íŠ¸ ë“±ë¡</h2>
        <div class="space-y-3">
          <input class="field" type="text" id="nq-name" placeholder="í€˜ìŠ¤íŠ¸ ì´ë¦„">
          <input class="field" type="text" id="nq-desc" placeholder="í€˜ìŠ¤íŠ¸ ì„¤ëª…">
          <div class="grid grid-cols-2 gap-3">
            <input class="field" type="number" id="nq-reward" placeholder="ë³´ìƒ ë„í† ë¦¬">
            <input class="field" type="text" id="nq-icon" placeholder="ì´ëª¨ì§€">
          </div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ë°˜ë³µ ìœ í˜•</label>
            <select class="field" id="nq-repeat">
              <option value="once">1íšŒì„±</option>
              <option value="daily">ì¼ì¼ â€” ë§¤ì¼ ì´ˆê¸°í™”</option>
              <option value="weekly">ì£¼ê°„ â€” ë§¤ì£¼ ì›”ìš”ì¼</option>
            </select>
          </div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ì™„ë£Œ ë°©ì‹</label>
            <select class="field" id="nq-completionType">
              <option value="auto">âš¡ ìë™ ì™„ë£Œ</option>
              <option value="approval">ğŸ‘¤ ê´€ë¦¬ì ìŠ¹ì¸</option>
            </select>
          </div>
          <button class="btn btn-primary w-full py-3" onclick="addQuest()">ğŸ“‹ í€˜ìŠ¤íŠ¸ ì¶”ê°€</button>
        </div>
      </div>
      <div class="clay-card p-5 mb-4"><p class="text-sm font-black text-gray-700 mb-3">ğŸ“‹ í€˜ìŠ¤íŠ¸ ëª©ë¡</p><div id="questAdminList" class="space-y-3"></div></div>
      <div class="clay-card p-5"><p class="text-sm font-black text-gray-700 mb-3">âœ‹ ì™„ë£Œ ìŠ¹ì¸ ìš”ì²­</p><div id="questApprovalList" class="space-y-3"></div></div>
    </div>

    <!-- ì‹ ì²­ -->
    <div id="atab-requests" class="hidden">
      <div class="clay-card p-5">
        <h2 class="text-lg font-black text-gray-800 mb-4">ğŸ“¬ ìƒí’ˆ ì‹ ì²­ ëª©ë¡</h2>
        <div class="flex gap-2 mb-4 flex-wrap">
          <button class="tab-btn active text-xs px-3 py-2" onclick="filterReqs('all',this)">ì „ì²´</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('pending',this)">ëŒ€ê¸°ì¤‘</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('approved',this)">ìŠ¹ì¸</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('rejected',this)">ê±°ì ˆ</button>
        </div>
        <div id="requestAdminList" class="space-y-3"></div>
      </div>
    </div>

    <!-- TX ë¡œê·¸ -->
    <div id="atab-txlog" class="hidden">
      <div class="clay-card p-5">
        <h2 class="text-lg font-black text-gray-800 mb-3">ğŸ—‚ï¸ ë„í† ë¦¬ ë¡œê·¸</h2>
        <div class="flex gap-2 mb-4"><select class="field" id="logUserFilter" onchange="renderTxLog()"><option value="all">ì „ì²´ ì‚¬ìš©ì</option></select></div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm" style="min-width:420px">
            <thead><tr class="border-b-2 border-gray-100 text-left">
              <th class="pb-3 pr-3 font-black text-gray-400 text-xs">ì‚¬ìš©ì</th>
              <th class="pb-3 pr-3 font-black text-gray-400 text-xs">ë³€í™”ëŸ‰</th>
              <th class="pb-3 pr-3 font-black text-gray-400 text-xs">ì”ì•¡</th>
              <th class="pb-3 pr-3 font-black text-gray-400 text-xs">ì‚¬ìœ </th>
              <th class="pb-3 font-black text-gray-400 text-xs">ì¼ì‹œ</th>
            </tr></thead>
            <tbody id="txLogTable" class="divide-y divide-gray-50"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- íšŒì› ëª©ë¡ -->
    <div id="atab-users" class="hidden">
      <div class="clay-card p-5"><h2 class="text-lg font-black text-gray-800 mb-4">ğŸ‘¥ ì „ì²´ íšŒì›</h2><div id="userAdminList" class="space-y-3"></div></div>
    </div>
  </div>

</div></div>

<!-- ëª¨ë‹¬ -->
<div id="modal" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()"><div id="modalContent"></div></div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast" class="hidden" style="position:fixed;top:24px;right:24px;z-index:500;min-width:220px">
  <div class="clay-card px-5 py-3 flex items-center gap-2 border-l-4 border-amber-400 bounce-in">
    <span id="toastIcon" class="text-lg"></span>
    <span id="toastMsg" class="font-bold text-gray-800 text-sm"></span>
  </div>
</div>

<!-- PWA ì„¤ì¹˜ ë°°ë„ˆ -->
<div id="installBanner" class="hidden">
  <div class="text-3xl">ğŸŒ°</div>
  <div class="flex-1"><p class="font-black text-gray-800 text-sm">í™ˆ í™”ë©´ì— ì¶”ê°€</p><p class="text-xs text-gray-500 font-semibold">ì•±ì²˜ëŸ¼ ì‚¬ìš©í•´ìš”!</p></div>
  <button class="btn btn-primary px-4 py-2 text-sm" onclick="installPWA()">ì„¤ì¹˜</button>
  <button class="btn btn-gray px-3 py-2 text-xs" onclick="document.getElementById('installBanner').classList.add('hidden')">âœ•</button>
</div>

<script>
/* ================================================================
   ğŸŒ° ë„í† ë¦¬ ìƒì  v4 â€” Supabase ì™„ì „ ì—°ë™
   ================================================================ */

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SUPABASE ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL = 'https://fqtnxrkxyzjrmaiaunqe.supabase.co';
const SUPABASE_KEY = 'sb_publishable_MpZnq9JYoQLTXc9Uda_nmA_5OAybs0X';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_EMAIL   = 'lovecoa37@gmail.com';
const GACHA_COST    = 10;
const TODAY         = new Date().toISOString().slice(0, 10);
const NOW_TS        = () => new Date().toLocaleString('ko-KR');
const WEEK_KEY      = (() => {
  const d = new Date();
  const y = d.getFullYear();
  const start = new Date(y, 0, 1);
  const week  = Math.ceil(((d - start) / 86400000 + start.getDay() + 1) / 7);
  return `${y}-W${String(week).padStart(2,'0')}`;
})();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ì„¸ì…˜ ìƒíƒœ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let session   = null;   // supabase auth session
let myProfile = null;   // public.users í”„ë¡œí•„
let allUsers  = [];     // ê´€ë¦¬ììš© ì „ì²´ ìœ ì € ìºì‹œ
let allTxs    = [];     // ê´€ë¦¬ììš© ì „ì²´ TX ìºì‹œ
let gachaPool = [];     // gacha_items ìºì‹œ
let reqFilter = 'all';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ì•± ì‹œì‘
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
  // 1. ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í›„ ëŒì•„ì™”ì„ ë•Œ URLì˜ í† í°ì„ í™•ì¸í•©ë‹ˆë‹¤.
  const hash = window.location.hash;
  if (hash && hash.includes('access_token=')) {
    const params = new URLSearchParams(hash.substring(1));
    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const expiresIn = params.get('expires_in');
    
    if (accessToken) {
      const session = {
        access_token: accessToken,
        refresh_token: refreshToken,
        expires_at: Math.floor(Date.now() / 1000) + parseInt(expiresIn || 3600),
        user: {} 
      };
      
      // í† í°ì„ ì €ì¥í•©ë‹ˆë‹¤.
      localStorage.setItem('sb_session', JSON.stringify(session));
      
      // ì£¼ì†Œì°½ì„ ê¹¨ë—í•˜ê²Œ ì •ë¦¬í•˜ê³  ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
      window.history.replaceState(null, null, window.location.pathname);
      window.location.reload(); 
      return;
    }
  }

  // 2. í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœ(ì„¸ì…˜)ê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
  const { data: { session } } = await supabase.auth.getSession();
  
  if (session) {
    // ë¡œê·¸ì¸ ëœ ê²½ìš°: ìƒì  í™”ë©´ í‘œì‹œ
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('appRoot').classList.remove('hidden');
    await loadData(); 
  } else {
    // ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš°: ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('appRoot').classList.add('hidden');
  }
}

function showLoginScreen() {
  console.log("showLoginScreen ì‹¤í–‰ë¨");
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('appRoot').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
}

async function onSignedIn(s) {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('loadingScreen').classList.remove('hidden');

  try {
    // í”„ë¡œí•„ ë¡œë“œ (ì—†ìœ¼ë©´ ìƒì„±)
    let { data: profile, error } = await sb.from('users').select('*').eq('id', s.user.id).single();
    if (error || !profile) {
      // íŠ¸ë¦¬ê±°ê°€ ì´ë¯¸ ìƒì„±í–ˆì§€ë§Œ í˜¹ì‹œ ì—†ìœ¼ë©´ ìˆ˜ë™ ìƒì„±
      const email = s.user.email || '';
      const name  = s.user.user_metadata?.full_name || s.user.user_metadata?.name || email.split('@')[0] || 'ì‚¬ìš©ì';
      const { data: created } = await sb.from('users').upsert({
        id: s.user.id, display_name: name, acorns: 0, is_admin: email === ADMIN_EMAIL
      }).select().single();
      profile = created;
    }
    myProfile = profile;

    // ë½‘ê¸° í’€ ë¡œë“œ
    const { data: gi } = await sb.from('gacha_items').select('*').eq('active', true);
    gachaPool = gi || [];

    // ì‹¤ì‹œê°„ êµ¬ë…
    setupRealtime();

    // UI ì´ˆê¸°í™”
    initAppUI();
  } catch (err) {
    console.error('onSignedIn error:', err);
    toast('âŒ', 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”');
    showLoginScreen();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ì‹¤ì‹œê°„ êµ¬ë…
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupRealtime() {
  // ë‚´ ì”ì•¡ ë³€ê²½ â†’ ì¦‰ì‹œ í—¤ë” ì—…ë°ì´íŠ¸
  sb.channel('my-balance')
    .on('postgres_changes', {
      event: 'UPDATE', schema: 'public', table: 'users',
      filter: `id=eq.${myProfile.id}`
    }, payload => {
      myProfile = { ...myProfile, ...payload.new };
      updateAcornDisplay();
      if (document.getElementById('utab-mypage') && !document.getElementById('utab-mypage').classList.contains('hidden')) {
        renderMypage();
      }
    })
    .subscribe();

  // ë‚´ ì•Œë¦¼
  sb.channel('my-notif')
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'notifications',
      filter: `user_id=eq.${myProfile.id}`
    }, payload => {
      updateNotifDot();
    })
    .subscribe();

  // ê´€ë¦¬ì: ì‹ ì²­ ë³€ê²½ êµ¬ë…
  if (myProfile.is_admin) {
    sb.channel('admin-requests')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'product_requests' }, () => {
        if (!document.getElementById('atab-requests').classList.contains('hidden')) renderRequestAdmin();
      })
      .on('postgres_changes', { event: '*', schema: 'public', table: 'quest_completion_requests' }, () => {
        if (!document.getElementById('atab-quests').classList.contains('hidden')) renderQuestAdmin();
      })
      .subscribe();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  UI ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initAppUI() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('appRoot').classList.remove('hidden');

  if (myProfile.is_admin) {
    document.getElementById('headerUserLabel').textContent = 'ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ';
    document.getElementById('headerAcorns').classList.add('hidden');
    document.getElementById('notifBtn').classList.add('hidden');
    document.getElementById('adminMode').classList.remove('hidden');
    document.getElementById('userMode').classList.add('hidden');
    renderDashboard();
    populateGiveSelect();
    populateLogFilter();
  } else {
    document.getElementById('headerUserLabel').textContent = myProfile.display_name;
    document.getElementById('headerAcorns').classList.remove('hidden');
    document.getElementById('notifBtn').classList.remove('hidden');
    document.getElementById('userMode').classList.remove('hidden');
    document.getElementById('adminMode').classList.add('hidden');
    updateAcornDisplay();
    updateNotifDot();
    renderShop();
    // ì¶œì„ ìë™ í€˜ìŠ¤íŠ¸
    setTimeout(() => triggerAutoQuest('attendance'), 500);
  }
}

function updateAcornDisplay() {
  document.getElementById('headerAcorns').textContent = `ğŸŒ° ${myProfile.acorns || 0}`;
  const el = document.getElementById('myAcornVal');
  if (el) el.textContent = myProfile.acorns || 0;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AUTH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doEmailLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pw    = document.getElementById('loginPw').value;
  const errEl = document.getElementById('loginErr');
  errEl.classList.add('hidden');
  if (!email || !pw) { showErr('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  document.getElementById('loginEmail').disabled = true;
  const { error } = await sb.auth.signInWithPassword({ email, password: pw });
  document.getElementById('loginEmail').disabled = false;
  if (error) { showErr(error.message.includes('Invalid') ? 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”' : error.message); }
}

async function doKakaoLogin() {
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'kakao',
    options: { redirectTo: window.location.href }
  });
  if (error) toast('âŒ', 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message);
}

async function doLogout() {
  await sb.auth.signOut();
}

function showErr(msg) {
  const el = document.getElementById('loginErr');
  el.textContent = 'âŒ ' + msg;
  el.classList.remove('hidden');
  document.getElementById('loginEmail').classList.add('shake-anim');
  setTimeout(() => document.getElementById('loginEmail').classList.remove('shake-anim'), 500);
}

function showSignup() {
  console.log("showSignup ì‹¤í–‰ë¨");
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-4">âœ¨ íšŒì›ê°€ì…</h2>
    <div class="space-y-3">
      <input class="field" type="text" id="su-name" placeholder="ì´ë¦„ (ë‹‰ë„¤ì„)">
      <input class="field" type="email" id="su-email" placeholder="ì´ë©”ì¼">
      <input class="field" type="password" id="su-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
      <div id="su-err" class="hidden text-xs text-red-500 font-bold"></div>
      <button class="btn btn-primary w-full py-3" onclick="doSignup()">ê°€ì…í•˜ê¸°</button>
      <button class="btn btn-gray w-full py-2 text-sm" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>`);
}

async function doSignup() {
  const name  = document.getElementById('su-name').value.trim();
  const email = document.getElementById('su-email').value.trim();
  const pw    = document.getElementById('su-pw').value;
  const errEl = document.getElementById('su-err');
  if (!name || !email || !pw) { errEl.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'; errEl.classList.remove('hidden'); return; }
  if (pw.length < 6) { errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•´ìš”'; errEl.classList.remove('hidden'); return; }

  const { error } = await sb.auth.signUp({ email, password: pw, options: { data: { full_name: name } } });
  if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
  closeModal();
  toast('âœ…', 'ê°€ì… ì™„ë£Œ! ì´ë©”ì¼ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TABS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const U_TABS = ['shop','gacha','quest','mypage'];
const A_TABS = ['dashboard','give','gachaTest','products','quests','requests','txlog','users'];

function uTab(tab, btn) {
  U_TABS.forEach(t => document.getElementById('utab-'+t).classList.add('hidden'));
  document.querySelectorAll('#userMode>.clay-card .tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('utab-'+tab).classList.remove('hidden');
  btn.classList.add('active');
  if (tab === 'shop')   { renderShop(); triggerAutoQuest('shopVisit'); }
  if (tab === 'quest')  renderQuests();
  if (tab === 'mypage') renderMypage();
}

function aTab(tab, btn) {
  A_TABS.forEach(t => document.getElementById('atab-'+t).classList.add('hidden'));
  document.querySelectorAll('#adminTabBar .tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('atab-'+tab).classList.remove('hidden');
  btn.classList.add('active');
  if (tab === 'dashboard') renderDashboard();
  if (tab === 'products')  renderProductAdmin();
  if (tab === 'quests')    renderQuestAdmin();
  if (tab === 'requests')  renderRequestAdmin();
  if (tab === 'txlog')     renderTxLog();
  if (tab === 'give')      renderGiveHistory();
  if (tab === 'users')     renderUserAdmin();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SHOP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderShop() {
  const grid = document.getElementById('shopGrid');
  grid.innerHTML = '<p class="text-sm text-gray-400 col-span-2 text-center py-4">ë¡œë”© ì¤‘...</p>';
  const { data: products } = await sb.from('products').select('*').eq('active', true).order('sort_order');
  if (!products?.length) { grid.innerHTML = '<p class="text-sm text-gray-400 col-span-2 text-center py-8">ìƒí’ˆì´ ì—†ì–´ìš”</p>'; return; }
  grid.innerHTML = products.map((p,i) => `
    <div class="clay-card card-hover p-4 flex flex-col bounce-in" style="animation-delay:${i*.06}s">
      <div class="text-4xl text-center mb-2">${p.icon}</div>
      <h3 class="font-black text-gray-800 text-center text-sm mb-1">${p.name}</h3>
      <p class="text-xs text-gray-400 font-semibold text-center mb-2">${p.description}</p>
      <div class="flex justify-center mb-3">
        <span class="${p.reward_type==='AUTO_ACORN'?'rt-auto':'rt-manual'}">${p.reward_type==='AUTO_ACORN'?'âš¡ ì¦‰ì‹œì§€ê¸‰':'ğŸ“¬ ìŠ¹ì¸í•„ìš”'}</span>
      </div>
      <div class="mt-auto">
        <div class="text-center font-black text-amber-600 mb-2">ğŸŒ° ${p.price}</div>
        <button class="btn btn-primary w-full py-2 text-sm" onclick="requestProduct('${p.id}')">ì‹ ì²­í•˜ê¸°</button>
      </div>
    </div>`).join('');
}

async function requestProduct(id) {
  const { data: p } = await sb.from('products').select('*').eq('id', id).single();
  if (!p) return;
  if ((myProfile.acorns || 0) < p.price) { toast('âŒ', 'ë„í† ë¦¬ê°€ ë¶€ì¡±í•´ìš”!'); return; }
  showModal(`
    <div class="text-center">
      <div class="text-6xl mb-3">${p.icon}</div>
      <h2 class="text-xl font-black text-gray-800 mb-1">${p.name}</h2>
      <p class="text-sm text-gray-400 mb-3">${p.description}</p>
      <div class="bg-amber-50 rounded-2xl p-3 mb-5 text-left">
        <p class="text-sm font-bold text-amber-800">ğŸŒ° ${p.price} ë„í† ë¦¬ ì°¨ê°</p>
        ${p.reward_type==='AUTO_ACORN'?`<p class="text-xs text-green-700 font-bold mt-1">âœ¨ ì¦‰ì‹œ +${p.acorn_amt} ë„í† ë¦¬!</p>`:''}
      </div>
      <div class="flex gap-3">
        <button class="btn btn-gray flex-1 py-3" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-3" onclick="confirmRequest('${p.id}')">ì‹ ì²­!</button>
      </div>
    </div>`);
}

async function confirmRequest(productId) {
  closeModal();
  const { data: p } = await sb.from('products').select('*').eq('id', productId).single();
  if (!p || (myProfile.acorns || 0) < p.price) { toast('âŒ', 'ë„í† ë¦¬ ë¶€ì¡±!'); return; }

  // ë„í† ë¦¬ ì°¨ê°
  const res = await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: -p.price, p_reason: `ìƒí’ˆ êµí™˜ â€” ${p.icon} ${p.name}` });
  if (!res.data?.success) { toast('âŒ', 'ì²˜ë¦¬ ì‹¤íŒ¨: ' + (res.data?.error || '')); return; }
  myProfile.acorns = res.data.balance;

  // ì‹ ì²­ ê¸°ë¡
  await sb.from('product_requests').insert({
    user_id: myProfile.id, product_id: p.id,
    product_snapshot: p, price: p.price,
    status: p.reward_type === 'AUTO_ACORN' ? 'approved' : 'pending',
    reward_type: p.reward_type, from_gacha: false
  });

  if (p.reward_type === 'AUTO_ACORN') {
    await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: p.acorn_amt, p_reason: `ìë™ ë³´ìƒ â€” ${p.name}` });
    myProfile.acorns += p.acorn_amt;
    await pushNotif(myProfile.id, 'reward', 'ë³´ìƒ ì§€ê¸‰! âš¡', `${p.name} êµí™˜ìœ¼ë¡œ +${p.acorn_amt}ğŸŒ°!`);
    toast('âš¡', `ì¦‰ì‹œ +${p.acorn_amt} ë„í† ë¦¬!`);
  } else {
    await pushNotif(myProfile.id, 'request', 'ì‹ ì²­ ì™„ë£Œ!', `${p.name} ì‹ ì²­ ì™„ë£Œ. ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì´ì—ìš”.`);
    toast('âœ…', `${p.name} ì‹ ì²­ ì™„ë£Œ!`);
  }
  updateAcornDisplay();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GACHA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let forceRarity = '';
const RARITY_PROB = [['legend',5],['epic',20],['rare',50],['common',100]];

function drawItem(force) {
  const r = force || (() => { const v=Math.random()*100; return RARITY_PROB.find(([,p])=>v<p)[0]; })();
  const pool = gachaPool.filter(x => x.rarity === r);
  return pool.length ? pool[Math.floor(Math.random()*pool.length)] : gachaPool[0];
}

async function doGacha(count) {
  const cost = GACHA_COST * count;
  if ((myProfile.acorns||0) < cost) { toast('âŒ', 'ë„í† ë¦¬ê°€ ë¶€ì¡±í•´ìš”!'); return; }

  // ì°¨ê°
  const res = await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: -cost, p_reason: `ë½‘ê¸° ì‚¬ìš© (${count}íšŒ)` });
  if (!res.data?.success) { toast('âŒ', 'ì²˜ë¦¬ ì‹¤íŒ¨'); return; }
  myProfile.acorns = res.data.balance;
  updateAcornDisplay();

  const results = [];
  for (let i = 0; i < count; i++) {
    const item = drawItem('');
    results.push(item);

    if (item.reward_type === 'AUTO_ACORN' && item.acorn_amt > 0) {
      await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: item.acorn_amt, p_reason: `ë½‘ê¸° ë³´ìƒ â€” ${item.name}` });
      myProfile.acorns += item.acorn_amt;
      await pushNotif(myProfile.id, 'gachaReward', 'ë½‘ê¸° ë³´ìƒ! ğŸ²', `${item.icon} ${item.name} íšë“! +${item.acorn_amt}ğŸŒ°`);
    } else if (item.reward_type === 'MANUAL_ITEM') {
      await sb.from('product_requests').insert({
        user_id: myProfile.id, product_snapshot: item, price: 0,
        status: 'pending', reward_type: 'MANUAL_ITEM', from_gacha: true
      });
      await pushNotif(myProfile.id, 'gachaReward', 'ë½‘ê¸° ì•„ì´í…œ! ğŸ²', `${item.icon} ${item.name} íšë“! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì§€ê¸‰.`);
    }
  }
  updateAcornDisplay();

  // ë½‘ê¸° í€˜ìŠ¤íŠ¸
  triggerAutoQuest('gachaPlay');

  renderGachaCards(results, 'gachaResult', 'gachaResultItems');
  const el = document.getElementById('gachaIcon');
  el.style.animation = 'none'; void el.offsetWidth;
  el.textContent = 'ğŸŠ'; el.style.animation = 'bounceIn .5s';
  setTimeout(() => { el.textContent = 'ğŸ'; el.style.animation = ''; }, 1600);
}

function renderGachaCards(results, wrapId, itemsId) {
  document.getElementById(wrapId).classList.remove('hidden');
  document.getElementById(itemsId).innerHTML = results.map((item,i) => `
    <div class="text-center pop-in" style="animation-delay:${i*.12}s">
      <div class="text-5xl mb-2">${item.icon}</div>
      <div class="badge ${rcClass(item.rarity)} mb-1 block">${item.name}</div>
      <span class="${item.reward_type==='AUTO_ACORN'?'rt-auto':'rt-manual'} block mt-1">
        ${item.reward_type==='AUTO_ACORN'?`+${item.acorn_amt}ğŸŒ°`:'ğŸ“¬ ìŠ¹ì¸ëŒ€ê¸°'}
      </span>
    </div>`).join('');
}

const rcClass = r => ({common:'rc-common',rare:'rc-rare',epic:'rc-epic',legend:'rc-legend'})[r]||'rc-common';

function setForce(r) { forceRarity=r; document.getElementById('forceLabel').textContent=({'':'ëœë¤',common:'âšª ì¼ë°˜',rare:'ğŸ”µ ë ˆì–´',epic:'ğŸŸ£ ì—í”½',legend:'ğŸ”´ ì „ì„¤'})[r]; }
function doGachaTest(count) { const r=Array.from({length:count},()=>drawItem(forceRarity)); renderGachaCards(r,'gachaTestResult','gachaTestItems'); toast('ğŸ§ª','í…ŒìŠ¤íŠ¸ ì™„ë£Œ! (ì°¨ê° ì—†ìŒ)'); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  QUEST HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPeriodKey(repeatType) {
  if (repeatType === 'once')   return 'once';
  if (repeatType === 'daily')  return TODAY;
  if (repeatType === 'weekly') return WEEK_KEY;
  return 'once';
}

async function isQuestDone(questId, repeatType) {
  const key = getPeriodKey(repeatType);
  const { data } = await sb.from('quest_progress')
    .select('id').eq('user_id', myProfile.id).eq('quest_id', questId).eq('period_key', key)
    .maybeSingle();
  return !!data;
}

async function hasPendingQCR(questId, repeatType) {
  const key = getPeriodKey(repeatType);
  const { data } = await sb.from('quest_completion_requests')
    .select('id').eq('user_id', myProfile.id).eq('quest_id', questId)
    .eq('status', 'pending').eq('period_key', key).maybeSingle();
  return !!data;
}

async function markQuestDone(questId, repeatType) {
  const key = getPeriodKey(repeatType);
  await sb.from('quest_progress').upsert(
    { user_id: myProfile.id, quest_id: questId, period_key: key },
    { onConflict: 'user_id,quest_id,period_key', ignoreDuplicates: true }
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AUTO QUEST TRIGGER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function triggerAutoQuest(triggerType) {
  if (!myProfile || myProfile.is_admin) return;
  const { data: quests } = await sb.from('quests').select('*').eq('active', true).eq('completion_type', 'auto');
  if (!quests) return;

  for (const q of quests) {
    const match =
      (triggerType === 'attendance' && (q.name.includes('ì¶œì„') || q.description.includes('ì ‘ì†') || q.description.includes('ë¡œê·¸ì¸'))) ||
      (triggerType === 'shopVisit'  && (q.name.includes('ìƒì ') || q.name.includes('ìƒí’ˆ') || q.description.includes('ìƒì ') || q.description.includes('íƒ­'))) ||
      (triggerType === 'gachaPlay'  && (q.name.includes('ë½‘ê¸°') || q.description.includes('ë½‘ê¸°')));
    if (!match) continue;
    const done = await isQuestDone(q.id, q.repeat_type);
    if (done) continue;

    await markQuestDone(q.id, q.repeat_type);
    const res = await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: q.reward, p_reason: `í€˜ìŠ¤íŠ¸ ìë™ì™„ë£Œ â€” ${q.name}` });
    if (res.data?.success) {
      myProfile.acorns = res.data.balance;
      updateAcornDisplay();
    }
    await pushNotif(myProfile.id, 'quest', 'í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ğŸ‰', `${q.icon} ${q.name} ì™„ë£Œ! +${q.reward}ğŸŒ°`);
    setTimeout(() => toast('ğŸ‰', `${q.name} ì™„ë£Œ! +${q.reward}ğŸŒ°`), 400);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  QUEST (USER)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const repLabel = { once:'1íšŒì„±', daily:'ì¼ì¼', weekly:'ì£¼ê°„' };
const repClass  = { once:'rep-once', daily:'rep-daily', weekly:'rep-weekly' };

async function renderQuests() {
  const el = document.getElementById('questList');
  el.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ë¡œë”© ì¤‘...</p>';
  const { data: quests } = await sb.from('quests').select('*').eq('active', true).order('sort_order');
  if (!quests?.length) { el.innerHTML = '<p class="text-sm text-gray-400 text-center py-8">í€˜ìŠ¤íŠ¸ê°€ ì—†ì–´ìš”</p>'; return; }

  const cards = await Promise.all(quests.map(async q => {
    const ct   = q.completion_type || 'approval';
    const done = await isQuestDone(q.id, q.repeat_type);

    if (ct === 'auto') {
      return `<div class="clay-card p-4 flex items-center gap-3 ${done?'opacity-75':''}">
        <div class="w-10 h-10 rounded-2xl flex items-center justify-center flex-shrink-0 ${done?'bg-green-100':'bg-amber-50'}">
          <span class="text-xl">${done?'âœ…':'âš¡'}</span>
        </div>
        <div class="text-2xl flex-shrink-0">${q.icon}</div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-0.5 flex-wrap">
            <p class="font-black text-sm ${done?'line-through text-gray-400':'text-gray-800'}">${q.name}</p>
            <span class="rep-badge ${repClass[q.repeat_type]}">${repLabel[q.repeat_type]}</span>
            <span class="ct-auto">âš¡ ìë™</span>
          </div>
          <p class="text-xs text-gray-400 font-semibold">${q.description}</p>
        </div>
        <div class="text-right flex-shrink-0">
          <div class="font-black text-amber-600 text-sm">+${q.reward}ğŸŒ°</div>
          <span class="${done?'qs-done':'qs-inprogress'}">${done?'ì™„ë£Œë¨':'ì§„í–‰ì¤‘'}</span>
        </div>
      </div>`;
    } else {
      const pending = done ? false : await hasPendingQCR(q.id, q.repeat_type);
      const canReq  = !done && !pending;
      return `<div class="clay-card p-4 flex items-center gap-3 ${done?'opacity-75':''}">
        <div class="w-10 h-10 rounded-2xl flex items-center justify-center flex-shrink-0 ${done?'bg-green-100':pending?'bg-yellow-100':'bg-pink-50'}">
          <span class="text-xl">${done?'âœ…':pending?'â³':'ğŸ‘¤'}</span>
        </div>
        <div class="text-2xl flex-shrink-0">${q.icon}</div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-0.5 flex-wrap">
            <p class="font-black text-sm ${done?'line-through text-gray-400':'text-gray-800'}">${q.name}</p>
            <span class="rep-badge ${repClass[q.repeat_type]}">${repLabel[q.repeat_type]}</span>
            <span class="ct-approval">ğŸ‘¤ ìŠ¹ì¸</span>
          </div>
          <p class="text-xs text-gray-400 font-semibold">${q.description}</p>
        </div>
        <div class="text-right flex-shrink-0 flex flex-col items-end gap-1">
          <div class="font-black text-amber-600 text-sm">+${q.reward}ğŸŒ°</div>
          ${done?'<span class="qs-done">ì™„ë£Œë¨</span>':pending?'<span class="qs-pending">ìŠ¹ì¸ ëŒ€ê¸°</span>':canReq?`<button class="btn btn-pink px-3 py-1 text-xs" onclick="requestQuestCompletion('${q.id}')">âœ‹ ì™„ë£Œ ìš”ì²­</button>`:'<span class="qs-inprogress">ë¶ˆê°€</span>'}
        </div>
      </div>`;
    }
  }));
  el.innerHTML = cards.join('');
}

async function requestQuestCompletion(questId) {
  const { data: q } = await sb.from('quests').select('*').eq('id', questId).single();
  if (!q) return;
  const done    = await isQuestDone(questId, q.repeat_type);
  const pending = await hasPendingQCR(questId, q.repeat_type);
  if (done || pending) { toast('â³', 'ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ì—ìš”!'); return; }

  const key = getPeriodKey(q.repeat_type);
  await sb.from('quest_completion_requests').insert({
    user_id: myProfile.id, quest_id: questId, status: 'pending', period_key: key
  });
  await pushNotif(myProfile.id, 'quest', 'ì™„ë£Œ ìš”ì²­ ì „ì†¡! âœ‹', `${q.icon} ${q.name} ì™„ë£Œ ìš”ì²­ì„ ë³´ëƒˆì–´ìš”.`);
  toast('âœ‹', `${q.name} ì™„ë£Œ ìš”ì²­ ì „ì†¡!`);
  renderQuests();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MYPAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderMypage() {
  document.getElementById('mypageHeader').innerHTML = `
    <div class="flex items-center gap-4">
      <div class="text-5xl">${myProfile.avatar_emoji || 'ğŸ¿ï¸'}</div>
      <div>
        <h2 class="text-xl font-black text-gray-800">${myProfile.display_name}</h2>
        <p class="text-xs text-gray-400 font-semibold">${session?.user?.email || ''}</p>
      </div>
      <div class="ml-auto text-center">
        <div class="text-3xl font-black text-amber-600" id="myAcornVal">${myProfile.acorns || 0}</div>
        <div class="text-xs text-gray-500 font-bold">ğŸŒ° ë„í† ë¦¬</div>
      </div>
    </div>`;

  // ì‹ ì²­ í˜„í™© (ìƒí’ˆ + í€˜ìŠ¤íŠ¸)
  const [{ data: myReqs }, { data: myQCRs }] = await Promise.all([
    sb.from('product_requests').select('*').eq('user_id', myProfile.id).order('created_at', { ascending: false }).limit(5),
    sb.from('quest_completion_requests').select('*, quests(name,icon)').eq('user_id', myProfile.id).order('created_at', { ascending: false }).limit(5),
  ]);
  const rqEl = document.getElementById('myRequestList');
  const reqs = [
    ...(myReqs||[]).map(r => ({ label: r.product_snapshot?.name || 'ìƒí’ˆ', icon: r.product_snapshot?.icon||'ğŸ', sub: fmtTs(r.created_at)+(r.price?` Â· ${r.price}ğŸŒ°`:' Â· ë½‘ê¸°')+(r.from_gacha?' ğŸ²':''), status: r.status })),
    ...(myQCRs||[]).map(r => ({ label: r.quests?.name || 'í€˜ìŠ¤íŠ¸', icon: r.quests?.icon||'ğŸ“‹', sub: fmtTs(r.created_at)+' Â· ì™„ë£Œ ìš”ì²­', status: r.status })),
  ];
  rqEl.innerHTML = reqs.length
    ? reqs.map(r => `<div class="flex items-center justify-between p-3 rounded-xl bg-gray-50">
        <div><p class="text-sm font-bold text-gray-800">${r.icon} ${r.label}</p><p class="text-xs text-gray-400">${r.sub}</p></div>
        <span class="badge ${stClass(r.status)}">${stLabel(r.status)}</span>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-3">ì‹ ì²­ ë‚´ì—­ì´ ì—†ì–´ìš”</p>';

  // TX ë‚´ì—­
  const { data: txs } = await sb.from('transactions').select('*').eq('user_id', myProfile.id).order('created_at', { ascending: false }).limit(30);
  const txEl = document.getElementById('myTxList');
  txEl.innerHTML = txs?.length
    ? txs.map(t => `<div class="flex items-center justify-between p-3 rounded-xl bg-gray-50">
        <div class="flex-1 min-w-0 mr-3">
          <p class="text-sm font-bold text-gray-700 truncate">${t.reason}</p>
          <p class="text-xs text-gray-400">${fmtTs(t.created_at)} Â· ì”ì•¡ ${t.balance}ğŸŒ°</p>
        </div>
        <span class="font-black text-base flex-shrink-0 ${t.amount>0?'tx-plus':'tx-minus'}">${t.amount>0?'+':''}${t.amount}ğŸŒ°</span>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-3">ë‚´ì—­ì´ ì—†ì–´ìš”</p>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  NOTIFICATIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pushNotif(userId, type, title, body) {
  await sb.from('notifications').insert({ user_id: userId, type, title, body });
}

async function updateNotifDot() {
  const { count } = await sb.from('notifications').select('*', { count: 'exact', head: true })
    .eq('user_id', myProfile.id).eq('is_read', false);
  const dot = document.getElementById('notifDot');
  const btn = document.getElementById('notifBtn');
  if (dot) dot.classList.toggle('hidden', !count);
  if (btn) btn.classList.toggle('hidden', false);
}

async function showNotifications() {
  const { data: notifs } = await sb.from('notifications').select('*')
    .eq('user_id', myProfile.id).order('created_at', { ascending: false }).limit(20);
  // ì½ìŒ ì²˜ë¦¬
  await sb.from('notifications').update({ is_read: true }).eq('user_id', myProfile.id).eq('is_read', false);
  updateNotifDot();
  const typeIcon = { reward:'ğŸ', quest:'ğŸ“‹', admin:'ğŸ‘‘', gachaReward:'ğŸ²', request:'ğŸ“¬', quest_approved:'âœ…', quest_rejected:'âŒ' };
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-4">ğŸ”” ì•Œë¦¼</h2>
    ${!notifs?.length ? '<p class="text-sm text-gray-400 text-center py-6">ì•Œë¦¼ì´ ì—†ì–´ìš”</p>' :
      notifs.map(n => `<div class="p-3 rounded-2xl bg-gray-50 mb-2 flex gap-3">
        <span class="text-xl">${typeIcon[n.type]||'ğŸ””'}</span>
        <div><p class="text-sm font-black text-gray-800">${n.title}</p>
          <p class="text-xs text-gray-400 font-semibold">${n.body}</p>
          <p class="text-xs text-gray-300 mt-1">${fmtTs(n.created_at)}</p>
        </div>
      </div>`).join('')}
    <button class="btn btn-gray w-full py-3 mt-2" onclick="closeModal()">ë‹«ê¸°</button>`);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” GIVE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function populateGiveSelect() {
  const { data: users } = await sb.from('users').select('*').eq('is_admin', false).order('display_name');
  allUsers = users || [];
  const sel = document.getElementById('giveUser');
  if (!sel) return;
  sel.innerHTML = allUsers.map(u => `<option value="${u.id}">${u.display_name} (${u.acorns}ğŸŒ°)</option>`).join('');
  const logSel = document.getElementById('logUserFilter');
  if (logSel) {
    logSel.innerHTML = '<option value="all">ì „ì²´ ì‚¬ìš©ì</option>' + allUsers.map(u => `<option value="${u.id}">${u.display_name}</option>`).join('');
  }
}

async function giveAcorns() {
  const userId = document.getElementById('giveUser').value;
  const amount = parseInt(document.getElementById('giveAmount').value);
  const memo   = document.getElementById('giveMemo').value.trim() || 'ê´€ë¦¬ì ì§€ê¸‰';
  if (!amount || amount < 1) { toast('âŒ', 'ì§€ê¸‰ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  const res = await sb.rpc('admin_give_acorns', { p_target_user_id: userId, p_amount: amount, p_memo: memo });
  if (!res.data?.success) { toast('âŒ', 'ì§€ê¸‰ ì‹¤íŒ¨: ' + (res.data?.error || '')); return; }

  await pushNotif(userId, 'admin', 'ë„í† ë¦¬ ì§€ê¸‰! ğŸŒ°', `ê´€ë¦¬ìê°€ ğŸŒ°${amount} ë„í† ë¦¬ë¥¼ ì§€ê¸‰í–ˆì–´ìš”! (${memo})`);
  const u = allUsers.find(x => x.id === userId);
  toast('ğŸŒ°', `${u?.display_name||'ì‚¬ìš©ì'}ì—ê²Œ ${amount} ë„í† ë¦¬ ì§€ê¸‰!`);
  document.getElementById('giveAmount').value = '';
  document.getElementById('giveMemo').value = '';
  populateGiveSelect();
  renderGiveHistory();
}

async function renderGiveHistory() {
  const { data: list } = await sb.from('transactions').select('*, users(display_name)').ilike('reason', 'ê´€ë¦¬ì ì§€ê¸‰%').order('created_at', { ascending: false }).limit(8);
  const el = document.getElementById('giveHistory');
  el.innerHTML = list?.length
    ? list.map(t => `<div class="flex items-center justify-between p-3 rounded-xl bg-gray-50">
        <div><p class="text-sm font-bold text-gray-800">${t.users?.display_name||''}</p>
          <p class="text-xs text-gray-400">${t.reason.replace('ê´€ë¦¬ì ì§€ê¸‰ â€” ','')} Â· ${fmtTs(t.created_at)}</p></div>
        <span class="font-black text-amber-600">+${t.amount}ğŸŒ°</span>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-4">ì§€ê¸‰ ë‚´ì—­ ì—†ìŒ</p>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” PRODUCTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAcornField(prefix) {
  const sel = document.getElementById(prefix+'-rewardType');
  const fld = document.getElementById(prefix+'-acornWrap');
  if (sel && fld) fld.classList.toggle('hidden', sel.value !== 'AUTO_ACORN');
}

async function renderProductAdmin() {
  const { data: products } = await sb.from('products').select('*').order('sort_order');
  const el = document.getElementById('productAdminList');
  if (!products?.length) { el.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ìƒí’ˆì´ ì—†ì–´ìš”</p>'; return; }
  el.innerHTML = products.map((p,i) => `
    <div class="flex items-center gap-3 p-3 rounded-2xl ${p.active?'bg-gray-50':'bg-red-50 opacity-60'} drag-item border-2 border-transparent"
      draggable="true" ondragstart="drgStart(event,${i})" ondragover="drgOver(event)"
      ondrop="drgDrop(event,'${p.id}')" ondragend="drgEnd(event)">
      <div class="text-gray-300 text-lg select-none">â ¿</div>
      <div class="text-2xl">${p.icon}</div>
      <div class="flex-1 min-w-0">
        <p class="font-black text-gray-800 text-sm">${p.name}</p>
        <div class="flex items-center gap-1 flex-wrap mt-0.5">
          <span class="text-xs text-gray-400">${p.price}ğŸŒ°</span>
          <span class="${p.reward_type==='AUTO_ACORN'?'rt-auto':'rt-manual'}">${p.reward_type==='AUTO_ACORN'?'âš¡ AUTO':'ğŸ“¬ MANUAL'}</span>
          ${p.reward_type==='AUTO_ACORN'?`<span class="text-xs text-green-600 font-bold">+${p.acorn_amt}ğŸŒ°</span>`:''}
        </div>
      </div>
      <button class="btn btn-blue px-3 py-1 text-xs flex-shrink-0" onclick="editProduct('${p.id}')">ìˆ˜ì •</button>
      <button class="btn btn-red px-3 py-1 text-xs flex-shrink-0" onclick="deleteProduct('${p.id}')">ì‚­ì œ</button>
    </div>`).join('');
}

async function addProduct() {
  const name       = document.getElementById('np-name').value.trim();
  const price      = parseInt(document.getElementById('np-price').value);
  const icon       = document.getElementById('np-icon').value || 'ğŸ';
  const desc       = document.getElementById('np-desc').value || '';
  const rewardType = document.getElementById('np-rewardType').value;
  const acornAmt   = parseInt(document.getElementById('np-acornAmt').value) || 0;
  if (!name || !price) { toast('âŒ', 'ì´ë¦„ê³¼ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const { count } = await sb.from('products').select('*', { count: 'exact', head: true });
  await sb.from('products').insert({ name, price, icon, description: desc, reward_type: rewardType, acorn_amt: acornAmt, sort_order: (count||0)+1 });
  ['np-name','np-price','np-icon','np-desc','np-acornAmt'].forEach(id => { const e=document.getElementById(id); if(e) e.value=''; });
  renderProductAdmin(); toast('âœ…', 'ìƒí’ˆ ì¶”ê°€ ì™„ë£Œ!');
}

async function deleteProduct(id) {
  if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
  await sb.from('products').delete().eq('id', id);
  renderProductAdmin(); toast('ğŸ—‘ï¸', 'ìƒí’ˆ ì‚­ì œë¨');
}

async function editProduct(id) {
  const { data: p } = await sb.from('products').select('*').eq('id', id).single();
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-4">âœï¸ ìƒí’ˆ ìˆ˜ì •</h2>
    <div class="space-y-3">
      <input class="field" id="ep-name" value="${p.name}">
      <div class="grid grid-cols-2 gap-2">
        <input class="field" type="number" id="ep-price" value="${p.price}">
        <input class="field" id="ep-icon" value="${p.icon}">
      </div>
      <input class="field" id="ep-desc" value="${p.description}">
      <select class="field" id="ep-rt" onchange="toggleEditAcorn()">
        <option value="MANUAL_ITEM" ${p.reward_type==='MANUAL_ITEM'?'selected':''}>ğŸ“¬ MANUAL_ITEM</option>
        <option value="AUTO_ACORN" ${p.reward_type==='AUTO_ACORN'?'selected':''}>âš¡ AUTO_ACORN</option>
      </select>
      <div id="ep-acornWrap" class="${p.reward_type==='AUTO_ACORN'?'':'hidden'}">
        <input class="field" type="number" id="ep-acornAmt" value="${p.acorn_amt}">
      </div>
      <div class="flex gap-3 pt-2">
        <button class="btn btn-gray flex-1 py-3" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-3" onclick="saveProduct('${id}')">ì €ì¥</button>
      </div>
    </div>`);
}
function toggleEditAcorn() { const s=document.getElementById('ep-rt'),f=document.getElementById('ep-acornWrap'); if(s&&f)f.classList.toggle('hidden',s.value!=='AUTO_ACORN'); }
async function saveProduct(id) {
  await sb.from('products').update({
    name: document.getElementById('ep-name').value,
    price: parseInt(document.getElementById('ep-price').value)||0,
    icon: document.getElementById('ep-icon').value,
    description: document.getElementById('ep-desc').value,
    reward_type: document.getElementById('ep-rt').value,
    acorn_amt: parseInt(document.getElementById('ep-acornAmt')?.value)||0,
  }).eq('id', id);
  closeModal(); renderProductAdmin(); toast('âœ…', 'ìˆ˜ì • ì™„ë£Œ!');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DRAG & DROP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _dragSrc = null;
function drgStart(e,idx){ _dragSrc=idx; setTimeout(()=>{e.target.style.opacity='.4';},0); e.dataTransfer.effectAllowed='move'; }
function drgOver(e){ e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function drgDrop(e,targetId){ e.preventDefault(); document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over')); _dragSrc=null; e.currentTarget.style.opacity=''; /* simple swap - re-render */ renderProductAdmin(); }
function drgEnd(e){ e.currentTarget.style.opacity=''; document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over')); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” QUESTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderQuestAdmin() {
  const [{ data: quests }, { data: qcrs }] = await Promise.all([
    sb.from('quests').select('*').order('sort_order'),
    sb.from('quest_completion_requests').select('*, users(display_name), quests(name,icon,reward)').eq('status','pending').order('created_at',{ascending:false}),
  ]);

  const el = document.getElementById('questAdminList');
  el.innerHTML = quests?.length
    ? quests.map(q => {
        const ct = q.completion_type;
        return `<div class="flex items-center gap-2 p-3 rounded-2xl ${q.active?'bg-gray-50':'bg-red-50 opacity-60'} border-2 border-transparent">
          <div class="text-xl flex-shrink-0">${q.icon}</div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <p class="font-black text-gray-800 text-sm">${q.name}</p>
              <span class="rep-badge ${repClass[q.repeat_type]}">${repLabel[q.repeat_type]}</span>
              <span class="${ct==='auto'?'ct-auto':'ct-approval'}">${ct==='auto'?'âš¡ ìë™':'ğŸ‘¤ ìŠ¹ì¸'}</span>
              ${!q.active?'<span class="rep-badge bg-red-100 text-red-600">ë¹„í™œì„±</span>':''}
            </div>
            <p class="text-xs text-gray-400">${q.description} Â· +${q.reward}ğŸŒ°</p>
          </div>
          <button class="btn btn-blue px-2 py-1 text-xs flex-shrink-0" onclick="editQuest('${q.id}')">ìˆ˜ì •</button>
          <label class="toggle-wrap flex-shrink-0"><input type="checkbox" ${q.active?'checked':''} onchange="toggleQuestActive('${q.id}')"><span class="toggle-slider"></span></label>
          <button class="btn btn-red px-2 py-1 text-xs flex-shrink-0" onclick="deleteQuest('${q.id}')">ì‚­ì œ</button>
        </div>`;
      }).join('')
    : '<p class="text-sm text-gray-400 text-center py-4">í€˜ìŠ¤íŠ¸ê°€ ì—†ì–´ìš”</p>';

  const apEl = document.getElementById('questApprovalList');
  apEl.innerHTML = qcrs?.length
    ? qcrs.map(r => `<div class="p-4 rounded-2xl bg-pink-50 border border-pink-100 flex flex-col gap-2">
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-xl">${r.quests?.icon||'ğŸ“‹'}</span>
              <p class="font-black text-gray-800 text-sm">${r.quests?.name||'í€˜ìŠ¤íŠ¸'}</p>
              <span class="ct-approval">ğŸ‘¤ ìŠ¹ì¸ í•„ìš”</span>
            </div>
            <p class="text-xs text-gray-400 mt-1">${r.users?.display_name||''} Â· ${fmtTs(r.created_at)}</p>
          </div>
          <span class="font-black text-amber-600 flex-shrink-0">+${r.quests?.reward||0}ğŸŒ°</span>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-green flex-1 py-2 text-sm" onclick="approveQuestReq('${r.id}')">âœ… ìŠ¹ì¸í•˜ê¸°</button>
          <button class="btn btn-red flex-1 py-2 text-sm" onclick="rejectQuestReq('${r.id}')">âŒ ê±°ì ˆ</button>
        </div>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-4">ëŒ€ê¸°ì¤‘ì¸ ìš”ì²­ì´ ì—†ì–´ìš”</p>';
}

async function addQuest() {
  const name = document.getElementById('nq-name').value.trim();
  const desc = document.getElementById('nq-desc').value;
  const reward = parseInt(document.getElementById('nq-reward').value);
  const icon = document.getElementById('nq-icon').value || 'ğŸ“‹';
  const repeat = document.getElementById('nq-repeat').value;
  const ct = document.getElementById('nq-completionType').value;
  if (!name || !reward) { toast('âŒ', 'ì´ë¦„ê³¼ ë³´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const { count } = await sb.from('quests').select('*',{count:'exact',head:true});
  await sb.from('quests').insert({ name, description:desc, icon, reward, repeat_type:repeat, completion_type:ct, sort_order:(count||0)+1 });
  ['nq-name','nq-desc','nq-reward','nq-icon'].forEach(id => document.getElementById(id).value='');
  renderQuestAdmin(); toast('âœ…', 'í€˜ìŠ¤íŠ¸ ì¶”ê°€ ì™„ë£Œ!');
}

async function deleteQuest(id) {
  if (!confirm('í€˜ìŠ¤íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  await sb.from('quests').delete().eq('id', id);
  renderQuestAdmin(); toast('ğŸ—‘ï¸', 'í€˜ìŠ¤íŠ¸ ì‚­ì œë¨');
}

async function toggleQuestActive(id) {
  const { data: q } = await sb.from('quests').select('active').eq('id', id).single();
  await sb.from('quests').update({ active: !q.active }).eq('id', id);
  renderQuestAdmin(); toast(q.active?'â¸ï¸':'âœ…', q.active?'ë¹„í™œì„±í™”ë¨':'í™œì„±í™”ë¨');
}

async function editQuest(id) {
  const { data: q } = await sb.from('quests').select('*').eq('id', id).single();
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-4">âœï¸ í€˜ìŠ¤íŠ¸ ìˆ˜ì •</h2>
    <div class="space-y-3">
      <input class="field" id="eq-name" value="${q.name}">
      <input class="field" id="eq-desc" value="${q.description}">
      <div class="grid grid-cols-2 gap-2">
        <input class="field" type="number" id="eq-reward" value="${q.reward}">
        <input class="field" id="eq-icon" value="${q.icon}">
      </div>
      <select class="field" id="eq-repeat">
        <option value="once" ${q.repeat_type==='once'?'selected':''}>1íšŒì„±</option>
        <option value="daily" ${q.repeat_type==='daily'?'selected':''}>ì¼ì¼</option>
        <option value="weekly" ${q.repeat_type==='weekly'?'selected':''}>ì£¼ê°„</option>
      </select>
      <select class="field" id="eq-ct">
        <option value="auto" ${q.completion_type==='auto'?'selected':''}>âš¡ ìë™ ì™„ë£Œ</option>
        <option value="approval" ${q.completion_type==='approval'?'selected':''}>ğŸ‘¤ ê´€ë¦¬ì ìŠ¹ì¸</option>
      </select>
      <div class="flex gap-3 pt-2">
        <button class="btn btn-gray flex-1 py-3" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-3" onclick="saveQuest('${id}')">ì €ì¥</button>
      </div>
    </div>`);
}

async function saveQuest(id) {
  await sb.from('quests').update({
    name: document.getElementById('eq-name').value,
    description: document.getElementById('eq-desc').value,
    reward: parseInt(document.getElementById('eq-reward').value)||0,
    icon: document.getElementById('eq-icon').value,
    repeat_type: document.getElementById('eq-repeat').value,
    completion_type: document.getElementById('eq-ct').value,
  }).eq('id', id);
  closeModal(); renderQuestAdmin(); toast('âœ…', 'í€˜ìŠ¤íŠ¸ ìˆ˜ì • ì™„ë£Œ!');
}

async function approveQuestReq(reqId) {
  const res = await sb.rpc('approve_quest_request', { p_request_id: reqId });
  if (!res.data?.success) { toast('âŒ', 'ì²˜ë¦¬ ì‹¤íŒ¨: ' + (res.data?.error||'')); return; }
  renderQuestAdmin(); toast('âœ…', 'í€˜ìŠ¤íŠ¸ ìŠ¹ì¸ ì™„ë£Œ!');
}

async function rejectQuestReq(reqId) {
  const { data: r } = await sb.from('quest_completion_requests').select('*, quests(name,icon), users(display_name)').eq('id', reqId).single();
  await sb.from('quest_completion_requests').update({ status: 'rejected' }).eq('id', reqId);
  if (r) await pushNotif(r.user_id, 'quest_rejected', 'í€˜ìŠ¤íŠ¸ ê±°ì ˆ âŒ', `${r.quests?.icon||''} ${r.quests?.name||''} ì™„ë£Œ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆì–´ìš”.`);
  renderQuestAdmin(); toast('âŒ', 'ê±°ì ˆ ì™„ë£Œ');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” REQUESTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderRequestAdmin() {
  const { data: list } = await sb.from('product_requests')
    .select('*, users(display_name)')
    .order('created_at', { ascending: false })
    .limit(50);
  const el = document.getElementById('requestAdminList');
  let items = list || [];
  if (reqFilter !== 'all') items = items.filter(r => r.status === reqFilter);
  el.innerHTML = items.length
    ? items.map(r => `<div class="p-4 rounded-2xl bg-gray-50 flex flex-col gap-2">
        <div class="flex items-start justify-between gap-2">
          <div>
            <p class="font-black text-gray-800 text-sm">${r.product_snapshot?.icon||'ğŸ'} ${r.product_snapshot?.name||'ìƒí’ˆ'}</p>
            <p class="text-xs text-gray-400 mt-0.5">${r.users?.display_name||''} Â· ${fmtTs(r.created_at)}${r.price?` Â· ${r.price}ğŸŒ°`:''}${r.from_gacha?' Â· ğŸ²':''}</p>
          </div>
          <span class="badge ${stClass(r.status)} flex-shrink-0">${stLabel(r.status)}</span>
        </div>
        ${r.status==='pending'?`<div class="flex gap-2">
          <button class="btn btn-green flex-1 py-2 text-sm" onclick="updateReq('${r.id}','approved')">âœ… ìŠ¹ì¸</button>
          <button class="btn btn-red flex-1 py-2 text-sm" onclick="updateReq('${r.id}','rejected')">âŒ ê±°ì ˆ</button>
        </div>`:''}
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-6">ì‹ ì²­ ë‚´ì—­ ì—†ìŒ</p>';
}

async function updateReq(id, status) {
  const { data: r } = await sb.from('product_requests').select('*, users(display_name)').eq('id', id).single();
  await sb.from('product_requests').update({ status }).eq('id', id);
  if (r) await pushNotif(r.user_id, status==='approved'?'approved':'rejected',
    status==='approved'?'ì‹ ì²­ ìŠ¹ì¸! âœ…':'ì‹ ì²­ ê±°ì ˆ âŒ',
    status==='approved'?`${r.product_snapshot?.name||'ìƒí’ˆ'} ì‹ ì²­ì´ ìŠ¹ì¸ë˜ì—ˆì–´ìš”!`:`${r.product_snapshot?.name||'ìƒí’ˆ'} ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆì–´ìš”.`);
  renderRequestAdmin(); toast(status==='approved'?'âœ…':'âŒ', status==='approved'?'ìŠ¹ì¸í–ˆì–´ìš”!':'ê±°ì ˆí–ˆì–´ìš”');
}

function filterReqs(f, btn) {
  reqFilter = f;
  document.querySelectorAll('#atab-requests .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active'); renderRequestAdmin();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” TX LOG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function populateLogFilter() {
  await populateGiveSelect();
}

async function renderTxLog() {
  const filter = document.getElementById('logUserFilter')?.value || 'all';
  let query = sb.from('transactions').select('*, users(display_name)').order('created_at', { ascending: false }).limit(100);
  if (filter !== 'all') query = query.eq('user_id', filter);
  const { data: list } = await query;
  const tbody = document.getElementById('txLogTable');
  tbody.innerHTML = list?.length
    ? list.map(t => `<tr class="hover:bg-gray-50">
        <td class="py-2.5 pr-2 font-bold text-gray-700 text-xs">${t.users?.display_name||''}</td>
        <td class="py-2.5 pr-2 font-black text-sm ${t.amount>0?'tx-plus':'tx-minus'}">${t.amount>0?'+':''}${t.amount}ğŸŒ°</td>
        <td class="py-2.5 pr-2 text-xs text-gray-500 font-semibold">${t.balance}ğŸŒ°</td>
        <td class="py-2.5 pr-2 text-xs text-gray-500">${t.reason}</td>
        <td class="py-2.5 text-xs text-gray-400 whitespace-nowrap">${fmtTs(t.created_at)}</td>
      </tr>`).join('')
    : '<tr><td colspan="5" class="text-center text-gray-400 py-8 text-sm">ë‚´ì—­ ì—†ìŒ</td></tr>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” USERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderUserAdmin() {
  const { data: users } = await sb.from('users').select('*').order('acorns', { ascending: false });
  const el = document.getElementById('userAdminList');
  el.innerHTML = users?.length
    ? users.map(u => `<div class="flex items-center gap-3 p-3 rounded-2xl bg-gray-50">
        <div class="text-2xl">${u.avatar_emoji||'ğŸ¿ï¸'}</div>
        <div class="flex-1 min-w-0">
          <p class="font-black text-gray-800 text-sm">${u.display_name}${u.is_admin?' ğŸ‘‘':''}</p>
          <p class="text-xs text-gray-400">ê°€ì…: ${fmtTs(u.created_at)}</p>
        </div>
        <div class="text-right">
          <div class="font-black text-amber-600">ğŸŒ° ${u.acorns}</div>
        </div>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-6">íšŒì›ì´ ì—†ì–´ìš”</p>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” DASHBOARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderDashboard() {
  const todayStart = TODAY + 'T00:00:00.000Z';
  const [{ data: users }, { data: todayTxs }, { data: recentTxs }] = await Promise.all([
    sb.from('users').select('id', { count: 'exact' }),
    sb.from('transactions').select('amount,reason').gte('created_at', todayStart),
    sb.from('transactions').select('*, users(display_name)').order('created_at', { ascending: false }).limit(10),
  ]);

  const todayGacha = (todayTxs||[]).filter(t => t.reason?.startsWith('ë½‘ê¸° ì‚¬ìš©'));
  const todayGachaCount = todayGacha.reduce((s,t) => s + Math.abs(t.amount)/GACHA_COST, 0);
  const todayGiven = (todayTxs||[]).filter(t => t.amount > 0 && !t.reason?.startsWith('ë½‘ê¸° ì‚¬ìš©')).reduce((s,t)=>s+t.amount,0);
  const todayUsed  = (todayTxs||[]).filter(t => t.amount < 0).reduce((s,t)=>s+Math.abs(t.amount),0);

  document.getElementById('ds-users').textContent      = users?.length || 0;
  document.getElementById('ds-todayGacha').textContent = todayGachaCount;
  document.getElementById('ds-todayGiven').textContent = '+' + todayGiven;
  document.getElementById('ds-todayUsed').textContent  = '-' + todayUsed;

  const logEl = document.getElementById('ds-activityLog');
  logEl.innerHTML = recentTxs?.length
    ? `<div class="overflow-x-auto"><table class="w-full" style="min-width:340px">
        <thead><tr class="border-b border-gray-100 text-left">
          <th class="pb-2 font-black text-gray-400 text-xs pr-2">ì‚¬ìš©ì</th>
          <th class="pb-2 font-black text-gray-400 text-xs pr-2">í™œë™</th>
          <th class="pb-2 font-black text-gray-400 text-xs pr-2">ë³€í™”</th>
          <th class="pb-2 font-black text-gray-400 text-xs">ì¼ì‹œ</th>
        </tr></thead>
        <tbody>${recentTxs.map(t=>`<tr class="border-b border-gray-50">
          <td class="py-2 pr-2 font-bold text-gray-700 text-xs whitespace-nowrap">${t.users?.display_name||''}</td>
          <td class="py-2 pr-2 text-gray-400 text-xs" style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.reason}</td>
          <td class="py-2 pr-2 font-black text-sm ${t.amount>0?'tx-plus':'tx-minus'}">${t.amount>0?'+':''}${t.amount}ğŸŒ°</td>
          <td class="py-2 text-gray-400 text-xs whitespace-nowrap">${fmtTs(t.created_at)}</td>
        </tr>`).join('')}</tbody>
      </table></div>`
    : '<p class="text-sm text-gray-400 text-center py-4">í™œë™ ì—†ìŒ</p>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const stClass = s => ({ pending:'st-pending', approved:'st-approved', rejected:'st-rejected' })[s] || 'st-pending';
const stLabel = s => ({ pending:'â³ ëŒ€ê¸°ì¤‘', approved:'âœ… ìŠ¹ì¸', rejected:'âŒ ê±°ì ˆ' })[s] || s;

function fmtTs(iso) {
  if (!iso) return '';
  try { return new Date(iso).toLocaleString('ko-KR', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }); }
  catch { return iso.slice(0,16).replace('T',' '); }
}

function showModal(html) { 
  console.log("showModal ì‹¤í–‰ë¨");
  const modalEl = document.getElementById('modal');
  const contentEl = document.getElementById('modalContent');
  console.log("modal ì—˜ë¦¬ë¨¼íŠ¸:", modalEl);
  console.log("modalContent ì—˜ë¦¬ë¨¼íŠ¸:", contentEl);
  if (!modalEl || !contentEl) { console.error("ëª¨ë‹¬ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ëª» ì°¾ìŒ!"); return; }
  contentEl.innerHTML = html; 
  modalEl.classList.remove('hidden'); 
  console.log("ëª¨ë‹¬ í´ë˜ìŠ¤:", modalEl.className);
}
function closeModal() { document.getElementById('modal').classList.add('hidden'); }

let _toastT;
function toast(icon, msg) {
  clearTimeout(_toastT);
  document.getElementById('toastIcon').textContent = icon;
  document.getElementById('toastMsg').textContent  = msg;
  const el = document.getElementById('toast');
  el.classList.remove('hidden'); el.style.animation='none'; void el.offsetWidth; el.style.animation='bounceIn .3s';
  _toastT = setTimeout(()=>{ el.classList.add('hidden'); el.style.animation=''; }, 3000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PWA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _deferredInstall = null;
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault(); _deferredInstall = e;
  document.getElementById('installBanner').classList.remove('hidden');
});
window.addEventListener('appinstalled', () => {
  document.getElementById('installBanner').classList.add('hidden'); _deferredInstall = null;
});
function installPWA() {
  if (!_deferredInstall) return;
  _deferredInstall.prompt();
  _deferredInstall.userChoice.then(r => {
    if (r.outcome === 'accepted') document.getElementById('installBanner').classList.add('hidden');
    _deferredInstall = null;
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  START
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
boot();
</script>
</body>
</html>
