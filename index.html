<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#ff8fab">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ë„í† ë¦¬ ìƒì ">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="icons/icon-192x192.png">
<title>ğŸŒ° ë„í† ë¦¬ ìƒì </title>
<script>
// â”€â”€ Supabase ê²½ëŸ‰ í´ë¼ì´ì–¸íŠ¸ (CDN ì—†ì´ ì§ì ‘ êµ¬í˜„) â”€â”€
const supabase = (() => {
  function createClient(url, key) {
    const headers = { 'apikey': key, 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' };
    let _session = null;
    let _listeners = [];
    let _refreshTimer = null;

    function _notify(event, session) {
      _listeners.forEach(fn => fn(event, session));
    }

    function _saveSession(s) {
      _session = s;
      if (s) {
        localStorage.setItem('sb_session', JSON.stringify(s));
        // ìë™ í† í° ê°±ì‹ 
        const exp = s.expires_at * 1000 - Date.now() - 60000;
        if (_refreshTimer) clearTimeout(_refreshTimer);
        if (exp > 0) _refreshTimer = setTimeout(_refreshSession, exp);
      } else {
        localStorage.removeItem('sb_session');
      }
    }

    async function _refreshSession() {
      const s = _session;
      if (!s?.refresh_token) return;
      try {
        const r = await fetch(url + '/auth/v1/token?grant_type=refresh_token', {
          method: 'POST', headers,
          body: JSON.stringify({ refresh_token: s.refresh_token })
        });
        const d = await r.json();
        if (d.access_token) {
          const ns = { ...d, user: d.user || s.user };
          _saveSession(ns);
          headers['Authorization'] = 'Bearer ' + d.access_token;
          _notify('TOKEN_REFRESHED', ns);
        }
      } catch(e) {}
    }

    const auth = {
      async getSession() {
        if (_session) return { data: { session: _session } };
        const stored = localStorage.getItem('sb_session');
        if (stored) {
          try {
            const s = JSON.parse(stored);
            if (s.expires_at && s.expires_at * 1000 > Date.now()) {
              _session = s;
              headers['Authorization'] = 'Bearer ' + s.access_token;
              return { data: { session: s } };
            }
          } catch(e) {}
        }
        return { data: { session: null } };
      },

      onAuthStateChange(fn) {
        _listeners.push(fn);
        return { data: { subscription: { unsubscribe: () => { _listeners = _listeners.filter(f => f !== fn); } } } };
      },

      async signUp({ email, password, options }) {
        const r = await fetch(url + '/auth/v1/signup', {
          method: 'POST', headers,
          body: JSON.stringify({ email, password, data: options?.data || {} })
        });
        const d = await r.json();
        if (d.error || d.msg) return { error: { message: d.error_description || d.msg || d.error } };
        if (d.access_token) {
          const s = { ...d, user: d.user };
          _saveSession(s);
          headers['Authorization'] = 'Bearer ' + d.access_token;
          _notify('SIGNED_IN', s);
        }
        return { data: d, error: null };
      },

      async signInWithPassword({ email, password }) {
        const r = await fetch(url + '/auth/v1/token?grant_type=password', {
          method: 'POST', headers,
          body: JSON.stringify({ email, password })
        });
        const d = await r.json();
        if (!r.ok) return { error: { message: d.error_description || d.msg || 'ë¡œê·¸ì¸ ì‹¤íŒ¨' } };
        const s = { ...d, user: d.user };
        _saveSession(s);
        headers['Authorization'] = 'Bearer ' + d.access_token;
        _notify('SIGNED_IN', s);
        return { data: { session: s }, error: null };
      },

      async signInWithOAuth({ provider, options }) {
        const redirectTo = encodeURIComponent(options?.redirectTo || window.location.href);
        window.location.href = url + '/auth/v1/authorize?provider=' + provider + '&redirect_to=' + redirectTo;
        return { error: null };
      },

      async signOut() {
        try {
          await fetch(url + '/auth/v1/logout', { method: 'POST', headers });
        } catch(e) {}
        _saveSession(null);
        headers['Authorization'] = 'Bearer ' + key;
        _notify('SIGNED_OUT', null);
      },

      async getUser() {
        if (!_session) return { data: { user: null } };
        return { data: { user: _session.user } };
      }
    };

    function from(table) {
      let _url = url + '/rest/v1/' + table;
      let _method = 'GET';
      let _body = null;
      let _filters = [];
      let _select = '*';
      let _order = null;
      let _single = false;
      let _maybeSingle = false;
      let _upsert = false;
      let _countExact = false;

      const q = {
        select(cols, opts) {
          _select = cols || '*';
          _url = url + '/rest/v1/' + table + '?select=' + _select;
          if (opts?.count === 'exact') _countExact = true;
          return q;
        },
        eq(col, val)   { _filters.push(col + '=eq.'   + encodeURIComponent(val)); return q; },
        neq(col, val)  { _filters.push(col + '=neq.'  + encodeURIComponent(val)); return q; },
        ilike(col, val){ _filters.push(col + '=ilike.' + encodeURIComponent(val)); return q; },
        gte(col, val)  { _filters.push(col + '=gte.'  + encodeURIComponent(val)); return q; },
        order(col, opts){ _order = col + (opts?.ascending === false ? '.desc' : '.asc'); return q; },
        limit(n)       { _filters.push('limit=' + n); return q; },
        single()       { _single = true; return q; },
        maybeSingle()  { _maybeSingle = true; return q; },
        insert(data)   { _method = 'POST'; _body = JSON.stringify(data); return q; },
        upsert(data)   { _method = 'POST'; _body = JSON.stringify(data); _upsert = true; return q; },
        update(data)   { _method = 'PATCH'; _body = JSON.stringify(data); return q; },
        delete()       { _method = 'DELETE'; return q; },

        async then(resolve, reject) {
          try {
            let finalUrl = _url;
            if (!finalUrl.includes('?')) finalUrl += '?select=' + _select;
            if (_filters.length) finalUrl += '&' + _filters.join('&');
            if (_order) finalUrl += '&order=' + _order;

            const h = { ...headers };
            if (_upsert) h['Prefer'] = 'resolution=merge-duplicates,return=representation';
            else if (_method === 'POST') h['Prefer'] = 'return=representation';
            if (_countExact) h['Prefer'] = (h['Prefer'] ? h['Prefer'] + ',' : '') + 'count=exact';
            if (_single || _maybeSingle) h['Accept'] = 'application/vnd.pgrst.object+json';

            const r = await fetch(finalUrl, { method: _method, headers: h, body: _body });
            const text = await r.text();
            let d = null;
            try { d = text ? JSON.parse(text) : null; } catch(e) { d = null; }

            // Content-Range í—¤ë”ì—ì„œ count íŒŒì‹±
            let count = null;
            const cr = r.headers?.get?.('Content-Range');
            if (cr) { const m = cr.match(/\/(\d+)/); if (m) count = parseInt(m[1]); }

            if (!r.ok) {
              // maybeSingle: 406(ê²°ê³¼ì—†ìŒ)ì€ ì—ëŸ¬ ì•„ë‹˜ â†’ data:null, error:null
              if (_maybeSingle && (r.status === 406 || r.status === 404)) {
                resolve({ data: null, error: null, count });
              } else {
                resolve({ data: null, error: { message: d?.message || d?.hint || r.statusText }, count });
              }
            } else {
              resolve({ data: d, error: null, count });
            }
          } catch(e) {
            resolve({ data: null, error: { message: e.message }, count: null });
          }
        }
      };
      return q;
    }

    async function rpc(fn, params) {
      const h = { ...headers, 'Prefer': 'return=representation' };
      try {
        const r = await fetch(url + '/rest/v1/rpc/' + fn, {
          method: 'POST', headers: h,
          body: JSON.stringify(params)
        });
        const d = await r.json();
        if (!r.ok) return { data: null, error: { message: d?.message || d?.hint || 'RPC ì˜¤ë¥˜' } };
        return { data: d, error: null };
      } catch(e) {
        return { data: null, error: { message: e.message } };
      }
    }

    function channel(name) {
      // Realtimeì€ WebSocket í•„ìš” - í´ë§ìœ¼ë¡œ ëŒ€ì²´ (ê°„ë‹¨ êµ¬í˜„)
      return {
        on(event, filter, cb) { return this; },
        subscribe() { return this; }
      };
    }

    return { auth, from, rpc, channel };
  }
  return { createClient };
})();
</script>


<link href="https://fonts.googleapis.com/css2?family=Jua&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>

/* â”€â”€ Tailwind í•µì‹¬ ìœ í‹¸ë¦¬í‹° (CDN ëŒ€ì²´) â”€â”€ */
.hidden{display:none!important}
.flex{display:flex}.inline-flex{display:inline-flex}.block{display:block}.grid{display:grid}
.flex-1{flex:1 1 0%}.flex-col{flex-direction:column}.flex-row{flex-direction:row}
.items-center{align-items:center}.items-start{align-items:flex-start}
.justify-center{justify-content:center}.justify-between{justify-content:space-between}.justify-end{justify-content:flex-end}
.gap-1{gap:4px}.gap-2{gap:8px}.gap-3{gap:12px}.gap-4{gap:16px}.gap-6{gap:24px}
.w-full{width:100%}.w-auto{width:auto}.h-full{height:100%}.h-px{height:1px}
.min-h-screen{min-height:100vh}
.max-w-2xl{max-width:42rem}.max-w-sm{max-width:24rem}.max-w-lg{max-width:32rem}
.mx-auto{margin-left:auto;margin-right:auto}
.p-1{padding:4px}.p-2{padding:8px}.p-3{padding:12px}.p-4{padding:16px}.p-5{padding:20px}.p-6{padding:24px}
.px-2{padding-left:8px;padding-right:8px}.px-3{padding-left:12px;padding-right:12px}.px-4{padding-left:16px;padding-right:16px}
.py-1{padding-top:4px;padding-bottom:4px}.py-2{padding-top:8px;padding-bottom:8px}.py-3{padding-top:12px;padding-bottom:12px}.py-4{padding-top:16px;padding-bottom:16px}
.pt-2{padding-top:8px}.pb-2{padding-bottom:8px}.pb-4{padding-bottom:16px}.pb-6{padding-bottom:24px}
.m-0{margin:0}.mt-1{margin-top:4px}.mt-2{margin-top:8px}.mt-3{margin-top:12px}.mt-4{margin-top:16px}
.mb-1{margin-bottom:4px}.mb-2{margin-bottom:8px}.mb-3{margin-bottom:12px}.mb-4{margin-bottom:16px}.mb-6{margin-bottom:24px}
.ml-1{margin-left:4px}.ml-2{margin-left:8px}.mr-1{margin-right:4px}.mr-2{margin-right:8px}
.space-y-2>*+*{margin-top:8px}.space-y-3>*+*{margin-top:12px}.space-y-4>*+*{margin-top:16px}
.text-xs{font-size:12px}.text-sm{font-size:13px}.text-base{font-size:14px}.text-lg{font-size:18px}.text-xl{font-size:20px}.text-2xl{font-size:24px}.text-3xl{font-size:30px}
.font-bold{font-weight:700}.font-semibold{font-weight:600}.font-black{font-weight:900}.font-medium{font-weight:500}
.text-center{text-align:center}.text-left{text-align:left}.text-right{text-align:right}
.text-white{color:#fff}.text-gray-400{color:#9ca3af}.text-gray-500{color:#6b7280}.text-gray-600{color:#4b5563}.text-gray-700{color:#374151}.text-gray-800{color:#1f2937}.text-gray-900{color:#111827}
.text-amber-500{color:#f59e0b}.text-amber-600{color:#d97706}.text-amber-700{color:#b45309}
.text-red-500{color:#ef4444}.text-red-600{color:#dc2626}.text-green-600{color:#16a34a}.text-blue-600{color:#2563eb}.text-purple-600{color:#9333ea}
.bg-white{background:#fff}.bg-gray-50{background:#f9fafb}.bg-gray-100{background:#f3f4f6}.bg-gray-200{background:#e5e7eb}
.bg-amber-50{background:#fffbeb}.bg-amber-100{background:#fef3c7}.bg-amber-500{background:#f59e0b}
.bg-green-100{background:#dcfce7}.bg-red-100{background:#fee2e2}.bg-blue-100{background:#dbeafe}
.bg-yellow-100{background:#fef9c3}.bg-purple-100{background:#ede9fe}
.rounded{border-radius:4px}.rounded-md{border-radius:6px}.rounded-lg{border-radius:8px}.rounded-xl{border-radius:12px}.rounded-2xl{border-radius:16px}.rounded-full{border-radius:9999px}
.border{border:1px solid #e5e7eb}.border-2{border:2px solid #e5e7eb}.border-gray-200{border-color:#e5e7eb}.border-amber-200{border-color:#fde68a}
.shadow{box-shadow:0 1px 3px rgba(0,0,0,.1)}.shadow-md{box-shadow:0 4px 6px rgba(0,0,0,.07)}.shadow-lg{box-shadow:0 10px 15px rgba(0,0,0,.1)}
.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.overflow-x-auto{overflow-x:auto}
.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.whitespace-nowrap{white-space:nowrap}
.relative{position:relative}.absolute{position:absolute}.fixed{position:fixed}.sticky{position:sticky}
.top-0{top:0}.bottom-0{bottom:0}.left-0{left:0}.right-0{right:0}.inset-0{inset:0}
.z-10{z-index:10}.z-50{z-index:50}
.opacity-50{opacity:.5}.opacity-0{opacity:0}.opacity-100{opacity:1}
.cursor-pointer{cursor:pointer}.pointer-events-none{pointer-events:none}
.underline{text-decoration:underline}.line-through{text-decoration:line-through}
.select-none{user-select:none}
.resize-none{resize:none}
.transition{transition:all .15s}
.grid-cols-2{grid-template-columns:repeat(2,1fr)}.grid-cols-3{grid-template-columns:repeat(3,1fr)}
.col-span-2{grid-column:span 2}
.shrink-0{flex-shrink:0}
.aspect-square{aspect-ratio:1}
.leading-tight{line-height:1.25}.leading-relaxed{line-height:1.625}
.italic{font-style:italic}
.capitalize{text-transform:capitalize}.uppercase{text-transform:uppercase}
.w-8{width:32px}.h-8{height:32px}.w-10{width:40px}.h-10{height:40px}.w-12{width:48px}.h-12{height:48px}
.w-6{width:24px}.h-6{height:24px}.w-4{width:16px}.h-4{height:16px}
.text-yellow-800{color:#854d0e}.text-green-800{color:#166534}.text-red-800{color:#991b1b}.text-blue-800{color:#1e40af}.text-purple-800{color:#6b21a8}

/* â”€â”€ ê¸°ë³¸ â”€â”€ */
*,*::before,*::after{box-sizing:border-box}
html{-webkit-tap-highlight-color:transparent}

/* UI í…ìŠ¤íŠ¸ëŠ” Jua, ë³¸ë¬¸ì€ Nunito */
body, input, select, textarea, button {
  font-family: 'Nunito', sans-serif;
}
h1, h2, h3, .tab-btn, .btn, .acorn-pill,
#headerUserLabel, .font-black {
  font-family: 'Jua', 'Nunito', sans-serif;
}

/* â”€â”€ ë°°ê²½ â”€â”€ */
@keyframes bgShift {
  0%   { background-position: 0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
body {
  background: linear-gradient(-45deg, #ffd6e7, #ffefba, #c3e8ff, #fce4ff);
  background-size: 400% 400%;
  animation: bgShift 18s ease infinite;
  min-height: 100dvh;
  padding-bottom: env(safe-area-inset-bottom);
}

/* â”€â”€ ê¸€ë¼ìŠ¤ ì¹´ë“œ â”€â”€ */
.clay-card {
  background: rgba(255,255,255,0.72);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border-radius: 24px;
  border: 1.5px solid rgba(255,255,255,0.85);
  box-shadow: 0 8px 32px rgba(180,140,200,0.13), 0 2px 8px rgba(180,140,200,0.08);
  transition: transform .2s, box-shadow .2s;
}
.card-hover:hover {
  transform: translateY(-2px);
  box-shadow: 0 14px 40px rgba(180,140,200,0.2);
}

/* â”€â”€ ë²„íŠ¼ â”€â”€ */
.btn {
  border-radius: 18px;
  font-weight: 800;
  font-family: 'Jua', 'Nunito', sans-serif;
  transition: all .15s;
  cursor: pointer;
  border: none;
  outline: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  letter-spacing: 0.01em;
}
.btn:active { transform: scale(.95); }

.btn-primary {
  background: linear-gradient(135deg, #ff8fab, #ff6b9d);
  color: #fff;
  box-shadow: 0 4px 18px rgba(255,107,157,.38);
}
.btn-primary:hover {
  box-shadow: 0 6px 26px rgba(255,107,157,.52);
  transform: translateY(-1px);
}
.btn-green {
  background: linear-gradient(135deg, #86efb5, #34d399);
  color: #065f46;
  box-shadow: 0 4px 14px rgba(52,211,153,.3);
}
.btn-red {
  background: linear-gradient(135deg, #fca5a5, #f87171);
  color: #7f1d1d;
  box-shadow: 0 4px 14px rgba(248,113,113,.3);
}
.btn-purple {
  background: linear-gradient(135deg, #c4b5fd, #a78bfa);
  color: #3b0764;
  box-shadow: 0 4px 14px rgba(167,139,250,.35);
}
.btn-blue {
  background: linear-gradient(135deg, #93c5fd, #60a5fa);
  color: #1e3a8a;
  box-shadow: 0 4px 14px rgba(96,165,250,.3);
}
.btn-gray {
  background: rgba(255,255,255,0.7);
  color: #6b7280;
  border: 1.5px solid rgba(200,200,220,0.4);
}
.btn-kakao {
  background: #FEE500;
  color: #191919;
  box-shadow: 0 4px 14px rgba(254,229,0,.4);
}
.btn-pink {
  background: linear-gradient(135deg, #fbcfe8, #f9a8d4);
  color: #9d174d;
  box-shadow: 0 4px 14px rgba(249,168,212,.35);
}

/* â”€â”€ íƒ­ ë²„íŠ¼ â”€â”€ */
.tab-btn {
  border-radius: 16px;
  padding: 10px 14px;
  font-weight: 700;
  font-size: 13px;
  font-family: 'Jua', 'Nunito', sans-serif;
  cursor: pointer;
  transition: all .2s;
  border: none;
  background: transparent;
  color: #b0a0c0;
  white-space: nowrap;
}
.tab-btn.active {
  background: linear-gradient(135deg, #ff8fab, #c084fc);
  color: #fff;
  box-shadow: 0 4px 16px rgba(192,132,252,.35);
}

/* â”€â”€ ì¸í’‹ í•„ë“œ â”€â”€ */
.field {
  border: 2px solid rgba(210,180,240,0.4);
  border-radius: 16px;
  padding: 10px 14px;
  font-family: 'Nunito', sans-serif;
  font-weight: 600;
  width: 100%;
  outline: none;
  transition: border-color .2s, background .2s;
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(8px);
  font-size: 14px;
  color: #4a3060;
}
.field:focus {
  border-color: #f9a8d4;
  background: rgba(255,255,255,0.9);
}

/* â”€â”€ ë°°ì§€ â”€â”€ */
.badge { border-radius: 20px; padding: 3px 12px; font-size: 12px; font-weight: 800; }
.rc-common  { background: #f3e8ff; color: #7c3aed; }
.rc-rare    { background: #dbeafe; color: #1d4ed8; }
.rc-epic    { background: #fce7f3; color: #be185d; }
.rc-legend  { background: #fee2e2; color: #dc2626; }

.st-pending  { background: #fef3c7; color: #92400e; }
.st-approved { background: #d1fae5; color: #065f46; }
.st-rejected { background: #fee2e2; color: #991b1b; }

.rt-auto   { background: #d1fae5; color: #065f46; border-radius: 10px; padding: 2px 9px; font-size: 11px; font-weight: 800; }
.rt-manual { background: #ede9fe; color: #5b21b6; border-radius: 10px; padding: 2px 9px; font-size: 11px; font-weight: 800; }

.rep-badge { border-radius: 10px; padding: 2px 8px; font-size: 11px; font-weight: 800; }
.rep-once   { background: rgba(243,232,255,0.8); color: #7c3aed; }
.rep-daily  { background: rgba(219,234,254,0.8); color: #1d4ed8; }
.rep-weekly { background: rgba(252,231,243,0.8); color: #be185d; }

.ct-auto     { background: #fef3c7; color: #92400e; border-radius: 10px; padding: 2px 8px; font-size: 11px; font-weight: 800; }
.ct-approval { background: #fce7f3; color: #9d174d; border-radius: 10px; padding: 2px 8px; font-size: 11px; font-weight: 800; }

.qs-inprogress { background: rgba(243,232,255,0.7); color: #7c3aed; border-radius: 12px; padding: 3px 10px; font-size: 11px; font-weight: 800; }
.qs-done       { background: rgba(209,250,229,0.8); color: #065f46; border-radius: 12px; padding: 3px 10px; font-size: 11px; font-weight: 800; }
.qs-pending    { background: rgba(254,243,199,0.8); color: #92400e; border-radius: 12px; padding: 3px 10px; font-size: 11px; font-weight: 800; }

/* â”€â”€ ë„í† ë¦¬ pill â”€â”€ */
.acorn-pill {
  background: linear-gradient(135deg, rgba(255,235,180,0.9), rgba(255,200,120,0.8));
  border: 2px solid rgba(251,191,36,0.5);
  backdrop-filter: blur(6px);
  border-radius: 20px;
  padding: 4px 16px;
  font-weight: 900;
  font-family: 'Jua', sans-serif;
  color: #92400e;
}

/* â”€â”€ ê±°ë˜ ë‚´ì—­ â”€â”€ */
.tx-plus  { color: #059669; font-weight: 900; }
.tx-minus { color: #dc2626; font-weight: 900; }

/* â”€â”€ í†µê³„ ì¹´ë“œ â”€â”€ */
.stat-card { border-radius: 20px; padding: 18px; }
.sc-orange { background: rgba(255,237,213,0.8); border: 1.5px solid rgba(254,215,170,0.6); backdrop-filter: blur(10px); }
.sc-blue   { background: rgba(219,234,254,0.8); border: 1.5px solid rgba(191,219,254,0.6); backdrop-filter: blur(10px); }
.sc-green  { background: rgba(209,250,229,0.8); border: 1.5px solid rgba(187,247,208,0.6); backdrop-filter: blur(10px); }
.sc-purple { background: rgba(243,232,255,0.8); border: 1.5px solid rgba(221,214,254,0.6); backdrop-filter: blur(10px); }

/* â”€â”€ í† ê¸€ â”€â”€ */
.toggle-wrap { position: relative; display: inline-block; width: 44px; height: 24px; }
.toggle-wrap input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; inset: 0; background: #e2d9f3; border-radius: 24px; cursor: pointer; transition: .3s; }
.toggle-slider:before { content: ''; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: .3s; }
.toggle-wrap input:checked + .toggle-slider { background: linear-gradient(135deg, #86efb5, #34d399); }
.toggle-wrap input:checked + .toggle-slider:before { transform: translateX(20px); }

/* â”€â”€ ëª¨ë‹¬ â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(100,60,140,.35);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 500;
  display: flex; align-items: center; justify-content: center;
  animation: fadeIn .2s;
}
.modal-box {
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border: 1.5px solid rgba(255,255,255,0.9);
  border-radius: 32px;
  padding: 28px;
  width: 92%; max-width: min(440px, calc(100vw - 32px));
  animation: slideUp .25s cubic-bezier(.34,1.56,.64,1);
  box-shadow: 0 24px 80px rgba(140,100,200,.25);
  max-height: 90dvh; overflow-y: auto;
}

/* â”€â”€ ë¡œê·¸ì¸ â”€â”€ */
.login-screen {
  position: fixed; inset: 0; z-index: 300;
  background: linear-gradient(-45deg, #ffd6e7, #ffefba, #c3e8ff, #fce4ff);
  background-size: 400% 400%;
  animation: bgShift 18s ease infinite;
  display: flex; align-items: center; justify-content: center;
}
.login-card {
  background: rgba(255,255,255,0.82);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border: 2px solid rgba(255,255,255,0.9);
  border-radius: 36px;
  padding: 40px 32px;
  width: 92%; max-width: 380px;
  box-shadow: 0 24px 80px rgba(180,140,220,.2);
}

/* â”€â”€ ë¡œë”© â”€â”€ */
.loading-screen {
  position: fixed; inset: 0; z-index: 400;
  background: linear-gradient(-45deg, #ffd6e7, #ffefba, #c3e8ff, #fce4ff);
  background-size: 400% 400%;
  animation: bgShift 18s ease infinite;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px;
}

/* â”€â”€ ì•Œë¦¼ ì  â”€â”€ */
.notif-dot {
  width: 8px; height: 8px;
  background: #f472b6;
  border-radius: 50%;
  position: absolute; top: 0; right: 0;
  animation: pulse .9s ease infinite;
}

/* â”€â”€ ìŠ¤í¬ë¡¤ë°” â”€â”€ */
#adminTabBar { overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
#adminTabBar::-webkit-scrollbar { display: none; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: rgba(200,180,230,0.4); border-radius: 99px; }

/* â”€â”€ ì„¤ì¹˜ ë°°ë„ˆ â”€â”€ */
#installBanner {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  z-index: 150; width: calc(100% - 48px); max-width: 400px;
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(16px);
  border: 1.5px solid rgba(255,255,255,0.9);
  border-radius: 20px; padding: 14px 18px;
  box-shadow: 0 8px 32px rgba(180,140,200,.2);
  display: flex; align-items: center; gap: 12px;
  animation: slideUp .3s ease;
}

/* â”€â”€ ë“œë˜ê·¸ â”€â”€ */
.drag-item { cursor: grab; user-select: none; }
.drag-item:active { cursor: grabbing; }
.drag-over { border: 2px dashed #f9a8d4 !important; background: rgba(252,231,243,0.5) !important; }

/* â”€â”€ í‚¤í”„ë ˆì„ â”€â”€ */
@keyframes fadeIn   { from{opacity:0} to{opacity:1} }
@keyframes slideUp  { from{transform:translateY(40px) scale(.95);opacity:0} to{transform:translateY(0) scale(1);opacity:1} }
@keyframes bounceIn { from{transform:scale(.5);opacity:0} to{transform:scale(1);opacity:1} }
@keyframes toastIn { from{opacity:0;scale:.85} to{opacity:1;scale:1} }
@keyframes popIn    { 0%{transform:scale(0) rotate(-180deg);opacity:0} 100%{transform:scale(1) rotate(0);opacity:1} }
@keyframes shake    { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-6px)} 40%,80%{transform:translateX(6px)} }
@keyframes pulse    { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
@keyframes spin     { to{transform:rotate(360deg)} }

.bounce-in { animation: bounceIn .4s cubic-bezier(.34,1.56,.64,1) both; }
.pop-in    { animation: popIn .6s cubic-bezier(.34,1.56,.64,1) both; }
.shake-anim{ animation: shake .4s ease; }
.spinner {
  animation: spin 1s linear infinite;
  border: 3px solid rgba(240,210,255,0.5);
  border-top-color: #f9a8d4;
  border-radius: 50%; width: 32px; height: 32px;
}

.hidden { display: none !important; }

/* â”€â”€ ìƒì  ì¹´ë“œ â”€â”€ */
#shopGrid .clay-card { display: flex; flex-direction: column; min-height: 200px; }

/* â”€â”€ ë²„íŠ¼ ë¡œë”© â”€â”€ */
.btn-loading { opacity: 0.65; pointer-events: none; cursor: not-allowed; }
.btn-loading::after { content: '...'; margin-left: 4px; }

/* â”€â”€ ë½‘ê¸° ìŠ¤í”¼ë„ˆ â”€â”€ */
#gachaSpinner { display: none; flex-direction: column; align-items: center; gap: 12px; padding: 24px 0; }
#gachaSpinner.active { display: flex; }
@keyframes gachaSpin {
  0%   { transform: rotate(0deg) scale(1); }
  50%  { transform: rotate(180deg) scale(1.3); }
  100% { transform: rotate(360deg) scale(1); }
}
.gacha-spinning { animation: gachaSpin .6s ease-in-out infinite; }

/* â”€â”€ ì‹ ì²­ ë°°ì§€ â”€â”€ */
.req-badge {
  background: #f472b6;
  color: #fff;
  border-radius: 999px;
  font-size: 10px; font-weight: 900;
  padding: 0 5px; min-width: 16px; height: 16px;
  display: inline-flex; align-items: center; justify-content: center;
  margin-left: 3px; vertical-align: top;
}

/* â”€â”€ ìœ„ì¹˜ ê³ ì • í´ë˜ìŠ¤ë“¤ â”€â”€ */
.toast-container { position: fixed; top: 35%; left: 50%; transform: translateX(-50%); z-index: 500; min-width: 220px; max-width: calc(100vw - 48px); pointer-events: none; }
.notif-scroll { max-height: 55dvh; overflow-y: auto; margin: 0 -4px; padding: 0 4px; }
.text-ellipsis { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* â”€â”€ ë±ƒì§€ (ìƒì /ìƒí’ˆê´€ë¦¬) â”€â”€ */
.badge-soldout    { background: rgba(254,226,226,0.9); color: #b91c1c; border-radius: 10px; padding: 2px 10px; font-size: 11px; font-weight: 800; }
.badge-stock      { background: rgba(243,232,255,0.9); color: #7c3aed; border-radius: 10px; padding: 2px 10px; font-size: 11px; font-weight: 800; }
.badge-gacha-pct  { background: rgba(237,233,254,0.9); color: #7c3aed; border-radius: 10px; padding: 2px 10px; font-size: 12px; font-weight: 800; }
.badge-unlimited  { background: rgba(209,250,229,0.9); color: #065f46; border-radius: 10px; padding: 2px 10px; font-size: 11px; font-weight: 800; }
.badge-soldout-sm  { background: rgba(254,226,226,0.9); color: #b91c1c; border-radius: 6px; padding: 1px 5px; font-size: 10px; font-weight: 800; }
.badge-stock-sm    { background: rgba(243,232,255,0.9); color: #7c3aed; border-radius: 6px; padding: 1px 5px; font-size: 10px; font-weight: 800; }
.badge-unlimited-sm{ background: rgba(209,250,229,0.9); color: #065f46; border-radius: 6px; padding: 1px 5px; font-size: 10px; font-weight: 800; }
.badge-prob       { background: rgba(237,233,254,0.9); color: #7c3aed; border-radius: 10px; padding: 2px 10px; font-size: 12px; font-weight: 800; }
.badge-prob-sm    { background: rgba(237,233,254,0.9); color: #7c3aed; border-radius: 6px; padding: 1px 5px; font-size: 10px; font-weight: 800; }



/* â”€â”€ í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ â”€â”€ */
.page-nav-btn {
  width: 28px; height: 28px;
  border-radius: 10px;
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(6px);
  border: 1.5px solid rgba(210,180,240,0.3);
  color: #9c87b8;
  font-size: 16px; font-weight: 900;
  cursor: pointer;
  display: inline-flex; align-items: center; justify-content: center;
  transition: all .15s;
  line-height: 1;
}
.page-nav-btn:hover:not(:disabled) {
  background: rgba(249,168,212,0.25);
  color: #be185d;
  border-color: rgba(249,168,212,0.5);
}
.page-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

</style>
</head>
<body>

<!-- â”€â”€ ë¡œë”© â”€â”€ -->
<div id="loadingScreen" class="loading-screen hidden">
  <div class="text-6xl">ğŸŒ°</div>
  <div class="spinner"></div>
  <p class="text-sm font-bold text-amber-600">ë¡œë”© ì¤‘...</p>
</div>

<!-- â”€â”€ ë¡œê·¸ì¸ â”€â”€ -->
<div id="loginScreen" class="login-screen">
  <div class="login-card bounce-in">
    <div class="text-center mb-8">
      <div class="text-6xl mb-3">ğŸŒ°</div>
      <h1 class="text-3xl font-black text-amber-900">ë„í† ë¦¬ ìƒì </h1>
      <p class="text-sm text-amber-600 font-semibold mt-1">Acorn Shop âœ¨</p>
    </div>

    <!-- ì´ë©”ì¼ ë¡œê·¸ì¸ -->
    <div class="space-y-3 mb-4">
      <input class="field" type="email" id="loginEmail" placeholder="ì´ë©”ì¼" onkeydown="if(event.key==='Enter')doEmailLogin()">
      <input class="field" type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key==='Enter')doEmailLogin()">
      <div id="loginErr" class="hidden text-xs text-red-500 font-bold text-center pt-1"></div>
    </div>
    <button class="btn btn-primary w-full py-4 text-base mb-3" onclick="playSound('click');doEmailLogin()">ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸</button>

    <!-- êµ¬ë¶„ì„  -->
    <div class="flex items-center gap-3 mb-3">
      <div class="flex-1 h-px bg-gray-200"></div>
      <span class="text-xs text-gray-400 font-semibold">ë˜ëŠ”</span>
      <div class="flex-1 h-px bg-gray-200"></div>
    </div>

    <!-- ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ -->
    <button class="btn btn-kakao w-full py-4 text-base mb-4" onclick="playSound('click');doKakaoLogin()">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none" style="flex-shrink:0">
        <path d="M9 1.5C4.86 1.5 1.5 4.14 1.5 7.38c0 2.1 1.35 3.93 3.39 4.98L4.05 15l3.57-2.43c.45.06.9.09 1.38.09 4.14 0 7.5-2.64 7.5-5.88C16.5 4.14 13.14 1.5 9 1.5z" fill="#191919"/>
      </svg>
      ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸
    </button>

    <!-- íšŒì›ê°€ì… -->
    <div class="text-center">
      <button class="text-xs text-amber-600 font-bold underline" onclick="showSignup()">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ì•± ë£¨íŠ¸ â”€â”€ -->
<div id="appRoot" class="hidden min-h-screen p-4">
<div class="max-w-2xl mx-auto">

  <!-- í—¤ë” -->
  <div class="flex items-center justify-between mb-5 py-2">
    <div class="flex items-center gap-3">
      <div class="text-4xl">ğŸŒ°</div>
      <div>
        <h1 class="text-xl font-black text-amber-900">ë„í† ë¦¬ ìƒì </h1>
        <p class="text-xs text-amber-500 font-bold -mt-0.5" id="headerUserLabel">Acorn Shop âœ¨</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button class="relative p-2 rounded-2xl bg-white shadow-sm hidden" onclick="showNotifications()" id="notifBtn">
        <span class="text-xl">ğŸ””</span>
        <span class="notif-dot hidden" id="notifDot"></span>
      </button>
      <div class="acorn-pill text-sm hidden" id="headerAcorns">ğŸŒ° 0</div>
      <button class="btn btn-gray px-3 py-2 text-xs" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <!-- â”€â”€ ì‚¬ìš©ì ëª¨ë“œ â”€â”€ -->
  <div id="userMode" class="hidden">
    <div class="flex gap-1 mb-5 clay-card p-2">
      <button class="tab-btn active flex-1" onclick="uTab('shop',this)">ğŸ›ï¸ ìƒì </button>
      <button class="tab-btn flex-1" onclick="uTab('gacha',this)">ğŸ² ë½‘ê¸°</button>
      <button class="tab-btn flex-1" onclick="uTab('quest',this)">ğŸ“‹ í€˜ìŠ¤íŠ¸</button>
      <button class="tab-btn flex-1" onclick="uTab('mypage',this)">ğŸ‘¤ ë§ˆì´</button>
    </div>
    <div id="utab-shop">
      <p class="text-sm font-bold text-amber-700 mb-3 px-1">ğŸ›’ êµ¬ë§¤ ê°€ëŠ¥í•œ ìƒí’ˆ</p>
      <div id="shopGrid" class="grid grid-cols-2 gap-3"></div>
    </div>
    <div id="utab-gacha" class="hidden">
      <div class="clay-card p-6 text-center mb-4">
        <div class="text-6xl mb-3" id="gachaIcon">ğŸ</div>
        <h2 class="text-xl font-black text-gray-800 mb-1">ë„í† ë¦¬ ë½‘ê¸°</h2>
        <p class="text-sm text-gray-400 font-semibold mb-4">1íšŒ = <span class="text-amber-600 font-black">ğŸŒ° 10</span> &nbsp;|&nbsp; 5íšŒ = <span class="text-amber-600 font-black">ğŸŒ° 50</span></p>
        <div class="flex justify-center gap-3">
          <button class="btn btn-primary px-8 py-3 text-base" onclick="doGacha(1)">1íšŒ ë½‘ê¸°</button>
          <button class="btn btn-purple px-8 py-3 text-base" onclick="doGacha(5)">5íšŒ ë½‘ê¸°</button>
        </div>
      </div>
      <!-- ë½‘ê¸° ì—°ì¶œ ìŠ¤í”¼ë„ˆ -->
      <div id="gachaSpinner">
        <div class="text-6xl" id="gachaSpinIcon">ğŸ</div>
        <p class="text-sm font-black text-amber-600" style="animation:pulse 1s infinite">ë‘ê·¼ë‘ê·¼...</p>
      </div>

      <div id="gachaResult" class="hidden clay-card p-6 text-center mb-4">
        <p class="text-sm font-bold text-gray-400 mb-4">ğŸ‰ ê²°ê³¼!</p>
        <div id="gachaResultItems" class="flex flex-wrap justify-center gap-4"></div>
      </div>
      <div class="clay-card p-4">
        <p class="text-sm font-black text-gray-700 mb-3">ğŸ“Š ë½‘ê¸° ìƒí’ˆ & í™•ë¥ </p>
        <div id="gachaProbTable" class="space-y-1">
          <p class="text-xs text-gray-400 text-center py-2">ë¡œë”© ì¤‘...</p>
        </div>
      </div>
    </div>
    <div id="utab-quest" class="hidden">
      <p class="text-sm font-bold text-amber-700 mb-3 px-1">ğŸ“‹ í€˜ìŠ¤íŠ¸</p>
      <div id="questList" class="space-y-3"></div>
    </div>
    <div id="utab-mypage" class="hidden">
      <div class="clay-card p-6 mb-4" id="mypageHeader"></div>

      <!-- ì¸ë²¤í† ë¦¬ -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">ğŸ’ ì¸ë²¤í† ë¦¬</p>
          <span class="text-xs text-gray-400 font-semibold">ì•„ì´í…œì„ ëˆŒëŸ¬ ì‚¬ìš©í•˜ì„¸ìš”</span>
        </div>
        <div id="myInventory" class="grid grid-cols-3 gap-2"></div>
      </div>

      <!-- ì‹ ì²­ í˜„í™© -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">ğŸ“¦ ì‹ ì²­ í˜„í™©</p>
          <div class="flex items-center gap-2">
            <button id="reqPrevBtn" class="page-nav-btn" onclick="moveReqPage(-1)">â€¹</button>
            <span id="reqPageLabel" class="text-xs font-bold text-gray-400"></span>
            <button id="reqNextBtn" class="page-nav-btn" onclick="moveReqPage(1)">â€º</button>
          </div>
        </div>
        <div id="myRequestList" class="space-y-2"></div>
      </div>

      <!-- ë„í† ë¦¬ ë‚´ì—­ -->
      <div class="clay-card p-5">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">ğŸ“œ ë„í† ë¦¬ ë‚´ì—­</p>
          <div class="flex items-center gap-2">
            <button id="txPrevBtn" class="page-nav-btn" onclick="moveTxPage(-1)">â€¹</button>
            <span id="txPageLabel" class="text-xs font-bold text-gray-400"></span>
            <button id="txNextBtn" class="page-nav-btn" onclick="moveTxPage(1)">â€º</button>
          </div>
        </div>
        <div id="myTxList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ ê´€ë¦¬ì ëª¨ë“œ â”€â”€ -->
  <div id="adminMode" class="hidden">
    <div id="adminTabBar" class="flex gap-1 mb-5 clay-card p-2">
      <button class="tab-btn active" onclick="aTab('dashboard',this)">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
      <button class="tab-btn" onclick="aTab('give',this)">ğŸŒ° ì§€ê¸‰</button>
      <button class="tab-btn" onclick="aTab('gachaTest',this)">ğŸ² í…ŒìŠ¤íŠ¸</button>
      <button class="tab-btn" onclick="aTab('products',this)">ğŸ›ï¸ ìƒí’ˆ</button>
      <button class="tab-btn" onclick="aTab('quests',this)">ğŸ“‹ í€˜ìŠ¤íŠ¸</button>
      <button class="tab-btn" onclick="aTab('requests',this)">ğŸ“¬ ì‹ ì²­<span class="req-badge hidden" id="reqBadge"></span></button>
      <button class="tab-btn" onclick="aTab('txlog',this)">ğŸ—‚ï¸ ë¡œê·¸</button>
      <button class="tab-btn" onclick="aTab('users',this)">ğŸ‘¥ íšŒì›</button>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ -->
    <div id="atab-dashboard">
      <p class="text-xs font-black text-amber-600 uppercase tracking-wider mb-3 px-1">ì˜¤ëŠ˜ í˜„í™©</p>
      <div class="grid grid-cols-2 gap-3 mb-5">
        <div class="stat-card sc-orange bounce-in"><div class="text-2xl mb-1">ğŸ‘¥</div><div class="text-2xl font-black text-orange-700" id="ds-users">â€”</div><div class="text-xs font-bold text-orange-500 mt-1">ì „ì²´ ì‚¬ìš©ì</div></div>
        <div class="stat-card sc-blue bounce-in" style="animation-delay:.05s"><div class="text-2xl mb-1">ğŸ²</div><div class="text-2xl font-black text-blue-700" id="ds-todayGacha">â€”</div><div class="text-xs font-bold text-blue-500 mt-1">ì˜¤ëŠ˜ ë½‘ê¸°</div></div>
        <div class="stat-card sc-green bounce-in" style="animation-delay:.1s"><div class="text-2xl mb-1">â¬†ï¸</div><div class="text-2xl font-black text-green-700" id="ds-todayGiven">â€”</div><div class="text-xs font-bold text-green-500 mt-1">ì˜¤ëŠ˜ ì§€ê¸‰</div></div>
        <div class="stat-card sc-purple bounce-in" style="animation-delay:.15s"><div class="text-2xl mb-1">â¬‡ï¸</div><div class="text-2xl font-black text-purple-700" id="ds-todayUsed">â€”</div><div class="text-xs font-bold text-purple-500 mt-1">ì˜¤ëŠ˜ ì‚¬ìš©</div></div>
      </div>
      <p class="text-xs font-black text-amber-600 uppercase tracking-wider mb-3 px-1">ìµœê·¼ í™œë™</p>
      <div class="clay-card p-4"><div id="ds-activityLog"></div></div>
    </div>

    <!-- ì§€ê¸‰ -->
    <div id="atab-give" class="hidden">
      <div class="clay-card p-6">
        <h2 class="text-lg font-black text-gray-800 mb-5">ğŸŒ° ë„í† ë¦¬ ì§€ê¸‰</h2>
        <div class="space-y-4">
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ì‚¬ìš©ì ì„ íƒ</label><select class="field" id="giveUser"></select></div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ì§€ê¸‰ëŸ‰</label><input class="field" type="number" id="giveAmount" placeholder="ì§€ê¸‰(+) / ì°¨ê°(-)"></div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ë©”ëª¨</label><input class="field" type="text" id="giveMemo" placeholder="ì§€ê¸‰ ì‚¬ìœ "></div>
          <button class="btn btn-primary w-full py-3 text-base" onclick="giveAcorns()">ğŸŒ° ì§€ê¸‰í•˜ê¸°</button>
        </div>
      </div>
      <div class="clay-card p-5 mt-4"><p class="text-sm font-black text-gray-700 mb-3">ğŸ“œ ìµœê·¼ ì§€ê¸‰ ë‚´ì—­</p><div id="giveHistory" class="space-y-2"></div></div>
    </div>

    <!-- ë½‘ê¸° í…ŒìŠ¤íŠ¸ -->
    <div id="atab-gachaTest" class="hidden">
      <!-- ê´€ë¦¬ì ë¬´ë£Œ ë½‘ê¸° (ì‚¬ìš©ì íƒ­ê³¼ ë™ì¼í•œ UX, ë„í† ë¦¬ ì°¨ê° ì—†ìŒ) -->
      <div class="clay-card p-6 text-center mb-4">
        <div class="text-xs font-bold text-amber-700 bg-amber-50 rounded-2xl p-3 mb-4">ğŸ‘‘ ê´€ë¦¬ì ë¬´ë£Œ ë½‘ê¸° â€” ë„í† ë¦¬ ì°¨ê° ì—†ìŒ</div>
        <div class="text-6xl mb-3" id="adminGachaIcon">ğŸ</div>
        <h2 class="text-xl font-black text-gray-800 mb-1">ë„í† ë¦¬ ë½‘ê¸°</h2>
        <p class="text-sm text-gray-400 font-semibold mb-4">ê²°ê³¼ë§Œ í™•ì¸ Â· ì¸ë²¤í† ë¦¬ ì €ì¥ ì•ˆ ë¨</p>
        <div class="flex justify-center gap-3">
          <button class="btn btn-primary px-8 py-3 text-base" onclick="doAdminGacha(1)">1íšŒ ë½‘ê¸°</button>
          <button class="btn btn-purple px-8 py-3 text-base" onclick="doAdminGacha(5)">5íšŒ ë½‘ê¸°</button>
        </div>
      </div>
      <div id="adminGachaSpinner" style="display:none;flex-direction:column;align-items:center;gap:12px;padding:24px 0">
        <div class="text-6xl" id="adminGachaSpinIcon">ğŸ</div>
        <p class="text-sm font-black text-amber-600" style="animation:pulse 1s infinite">ë‘ê·¼ë‘ê·¼...</p>
      </div>
      <div id="adminGachaResult" class="hidden clay-card p-6 text-center mb-4">
        <p class="text-sm font-bold text-gray-400 mb-4">ğŸ‰ ê²°ê³¼!</p>
        <div id="adminGachaResultItems" class="flex flex-wrap justify-center gap-4"></div>
      </div>
      <div class="clay-card p-4">
        <p class="text-sm font-black text-gray-700 mb-3">ğŸ“Š ë½‘ê¸° ìƒí’ˆ & í™•ë¥ </p>
        <div id="adminGachaProbTable" class="space-y-1">
          <p class="text-xs text-gray-400 text-center py-2">ë¡œë”© ì¤‘...</p>
        </div>
      </div>
    </div>

    <!-- ìƒí’ˆ -->
    <div id="atab-products" class="hidden">

      <!-- ë“±ë¡ í¼: 2ì—´ (ìƒì  / ë½‘ê¸°) -->
      <div class="grid grid-cols-2 gap-3 mb-4" style="align-items:start">

        <!-- ìƒì  ìƒí’ˆ ë“±ë¡ -->
        <div class="clay-card p-4">
          <h3 class="font-black text-gray-800 mb-3 flex items-center gap-1">ğŸ›ï¸ <span>ìƒì  ìƒí’ˆ</span></h3>
          <div class="space-y-2">
            <input class="field" type="text" id="ns-name" placeholder="ìƒí’ˆëª…">
            <div class="grid grid-cols-2 gap-2">
              <input class="field" type="text" id="ns-icon" placeholder="ì´ëª¨ì§€ ğŸ">
              <input class="field" type="number" id="ns-price" placeholder="ê°€ê²©(ğŸŒ°)">
            </div>
            <input class="field" type="text" id="ns-desc" placeholder="ì„¤ëª…">
            <select class="field" id="ns-rewardType" onchange="toggleAcornField('ns')">
              <option value="MANUAL_ITEM">ğŸ“¬ ìŠ¹ì¸ í•„ìš”</option>
              <option value="AUTO_ACORN">âš¡ ì¦‰ì‹œ ì§€ê¸‰</option>
            </select>
            <div id="ns-acornWrap" class="hidden">
              <input class="field" type="number" id="ns-acornAmt" placeholder="ì§€ê¸‰ ë„í† ë¦¬ëŸ‰">
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 mb-1 block">íŒë§¤ ìˆ˜ëŸ‰</label>
              <div class="flex gap-2 items-center">
                <select class="field" id="ns-stockType" onchange="toggleStockField()" style="flex:1">
                  <option value="unlimited">â™¾ï¸ ë¬´ì œí•œ (ìƒì‹œíŒë§¤)</option>
                  <option value="limited">ğŸ”¢ ìˆ˜ëŸ‰ ì œí•œ</option>
                </select>
                <input class="field hidden" type="number" id="ns-stock" placeholder="ê°œìˆ˜" min="1" style="width:80px;flex-shrink:0">
              </div>
            </div>
            <button class="btn btn-primary w-full py-2 text-sm" onclick="addStoreProduct()">â• ì¶”ê°€</button>
          </div>
        </div>

        <!-- ë½‘ê¸° ìƒí’ˆ ë“±ë¡ -->
        <div class="clay-card p-4">
          <h3 class="font-black text-gray-800 mb-3 flex items-center gap-1">ğŸ² <span>ë½‘ê¸° ìƒí’ˆ</span></h3>
          <div class="space-y-2">
            <input class="field" type="text" id="ng-name" placeholder="ì•„ì´í…œëª…">
            <div class="grid grid-cols-2 gap-2">
              <input class="field" type="text" id="ng-icon" placeholder="ì´ëª¨ì§€ âœ¨">
              <input class="field" type="number" id="ng-probability" placeholder="í™•ë¥  %" step="0.1" min="0">
            </div>
            <input class="field" type="text" id="ng-desc" placeholder="ì„¤ëª…">
            <select class="field" id="ng-rewardType" onchange="toggleAcornField('ng')">
              <option value="MANUAL_ITEM">ğŸ“¬ ìŠ¹ì¸ í•„ìš”</option>
              <option value="AUTO_ACORN">âš¡ ì¦‰ì‹œ ì§€ê¸‰</option>
            </select>
            <div id="ng-acornWrap" class="hidden">
              <input class="field" type="number" id="ng-acornAmt" placeholder="ì§€ê¸‰ ë„í† ë¦¬ëŸ‰">
            </div>
            <p class="text-xs text-gray-400">â€» í™•ë¥  í•©â‰ 100ì´ì–´ë„ ìë™ ì •ê·œí™”</p>
            <button class="btn btn-purple w-full py-2 text-sm" onclick="addGachaProduct()">â• ì¶”ê°€</button>
          </div>
        </div>

      </div>

      <!-- ëª©ë¡: 2ì—´ (ìƒì  / ë½‘ê¸°) -->
      <div class="grid grid-cols-2 gap-3" style="align-items:start">
        <div class="clay-card p-4">
          <p class="text-sm font-black text-gray-700 mb-3">ğŸ›ï¸ ìƒì  ìƒí’ˆ</p>
          <div id="storeProductList" class="space-y-2"></div>
        </div>
        <div class="clay-card p-4">
          <p class="text-sm font-black text-gray-700 mb-3">ğŸ² ë½‘ê¸° ìƒí’ˆ</p>
          <div id="gachaProductList" class="space-y-2"></div>
        </div>
      </div>

    </div>

    <!-- í€˜ìŠ¤íŠ¸ -->
    <div id="atab-quests" class="hidden">
      <div class="clay-card p-5 mb-4">
        <h2 class="text-lg font-black text-gray-800 mb-4">â• í€˜ìŠ¤íŠ¸ ë“±ë¡</h2>
        <div class="space-y-3">
          <input class="field" type="text" id="nq-name" placeholder="í€˜ìŠ¤íŠ¸ ì´ë¦„">
          <input class="field" type="text" id="nq-desc" placeholder="í€˜ìŠ¤íŠ¸ ì„¤ëª…">
          <div class="grid grid-cols-2 gap-3">
            <input class="field" type="number" id="nq-reward" placeholder="ë³´ìƒ ë„í† ë¦¬">
            <input class="field" type="text" id="nq-icon" placeholder="ì´ëª¨ì§€">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-bold text-gray-500 mb-1 block">ëª©í‘œ íšŸìˆ˜ (ìë™ì™„ë£Œ ì „ìš©)</label>
              <select class="field" id="nq-countType" onchange="toggleQuestCount()">
                <option value="once">1íšŒ â€” íŠ¸ë¦¬ê±°ë˜ë©´ ë°”ë¡œ ì™„ë£Œ</option>
                <option value="multi">íšŸìˆ˜ ì§€ì • â€” NíšŒ ëˆ„ì  í›„ ì™„ë£Œ</option>
              </select>
            </div>
            <div id="nq-countWrap" class="hidden">
              <label class="text-xs font-bold text-gray-500 mb-1 block">ëª©í‘œ íšŸìˆ˜</label>
              <input class="field" type="number" id="nq-targetCount" placeholder="ì˜ˆ: 3" min="2">
            </div>
          </div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ë°˜ë³µ ìœ í˜•</label>
            <select class="field" id="nq-repeat">
              <option value="once">1íšŒì„±</option>
              <option value="daily">ì¼ì¼ â€” ë§¤ì¼ ì´ˆê¸°í™”</option>
              <option value="weekly">ì£¼ê°„ â€” ë§¤ì£¼ ì›”ìš”ì¼</option>
            </select>
          </div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ì™„ë£Œ ë°©ì‹</label>
            <select class="field" id="nq-completionType">
              <option value="auto">âš¡ ìë™ ì™„ë£Œ</option>
              <option value="approval">ğŸ‘¤ ê´€ë¦¬ì ìŠ¹ì¸</option>
            </select>
          </div>
          <button class="btn btn-primary w-full py-3" onclick="addQuest()">ğŸ“‹ í€˜ìŠ¤íŠ¸ ì¶”ê°€</button>
        </div>
      </div>
      <div class="clay-card p-5 mb-4"><p class="text-sm font-black text-gray-700 mb-3">ğŸ“‹ í€˜ìŠ¤íŠ¸ ëª©ë¡</p><div id="questAdminList" class="space-y-3"></div></div>
      <div class="clay-card p-5"><p class="text-sm font-black text-gray-700 mb-3">âœ‹ ì™„ë£Œ ìŠ¹ì¸ ìš”ì²­</p><div id="questApprovalList" class="space-y-3"></div></div>
    </div>

    <!-- ì‹ ì²­ -->
    <div id="atab-requests" class="hidden">
      <div class="clay-card p-5">
        <h2 class="text-lg font-black text-gray-800 mb-4">ğŸ“¬ ìƒí’ˆ ì‹ ì²­ ëª©ë¡</h2>
        <div class="flex gap-2 mb-4 flex-wrap">
          <button class="tab-btn active text-xs px-3 py-2" onclick="filterReqs('all',this)">ì „ì²´</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('pending',this)">ëŒ€ê¸°ì¤‘</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('approved',this)">ìŠ¹ì¸</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('rejected',this)">ê±°ì ˆ</button>
        </div>
        <div id="requestAdminList" class="space-y-3"></div>
      </div>
    </div>

    <!-- TX ë¡œê·¸ -->
    <div id="atab-txlog" class="hidden">
      <div class="clay-card p-5">
        <h2 class="text-lg font-black text-gray-800 mb-3">ğŸ—‚ï¸ ë„í† ë¦¬ ë¡œê·¸</h2>
        <div class="flex gap-2 mb-4"><select class="field" id="logUserFilter" onchange="renderTxLog()"><option value="all">ì „ì²´ ì‚¬ìš©ì</option></select></div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm" style="min-width:420px">
            <thead><tr class="border-b-2 border-gray-100 text-left">
              <th class="pb-3 pr-3 font-black text-gray-400 text-xs">ì‚¬ìš©ì</th>
              <th class="pb-3 pr-3 font-black text-gray-400 text-xs">ë³€í™”ëŸ‰</th>
              <th class="pb-3 pr-3 font-black text-gray-400 text-xs">ì”ì•¡</th>
              <th class="pb-3 pr-3 font-black text-gray-400 text-xs">ì‚¬ìœ </th>
              <th class="pb-3 font-black text-gray-400 text-xs">ì¼ì‹œ</th>
            </tr></thead>
            <tbody id="txLogTable" class="divide-y divide-gray-50"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- íšŒì› ëª©ë¡ -->
    <div id="atab-users" class="hidden">
      <div class="clay-card p-5"><h2 class="text-lg font-black text-gray-800 mb-4">ğŸ‘¥ ì „ì²´ íšŒì›</h2><div id="userAdminList" class="space-y-3"></div></div>
    </div>
  </div>

</div></div>

<!-- ëª¨ë‹¬ -->
<div id="modal" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()"><div id="modalContent"></div></div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast" class="toast-container hidden">
  <div id="toastInner" style="text-align:center;animation:toastIn .25s cubic-bezier(.34,1.56,.64,1) both;background:rgba(245,210,255,0.42);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1.5px solid rgba(255,255,255,0.6);border-radius:20px;padding:14px 24px;display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:0 8px 32px rgba(120,80,180,0.2)">
    <span id="toastIcon" class="text-2xl"></span>
    <span id="toastMsg" style="font-weight:800;font-size:14px;color:rgba(90,30,130,0.92)"></span>
  </div>
</div>

<!-- PWA ì„¤ì¹˜ ë°°ë„ˆ -->
<div id="installBanner" class="hidden">
  <div class="text-3xl">ğŸŒ°</div>
  <div class="flex-1"><p class="font-black text-gray-800 text-sm">í™ˆ í™”ë©´ì— ì¶”ê°€</p><p class="text-xs text-gray-500 font-semibold">ì•±ì²˜ëŸ¼ ì‚¬ìš©í•´ìš”!</p></div>
  <button class="btn btn-primary px-4 py-2 text-sm" onclick="installPWA()">ì„¤ì¹˜</button>
  <button class="btn btn-gray px-3 py-2 text-xs" onclick="document.getElementById('installBanner').classList.add('hidden')">âœ•</button>
</div>

<script>
/* ================================================================
   ğŸŒ° ë„í† ë¦¬ ìƒì  v4 â€” Supabase ì™„ì „ ì—°ë™
   ================================================================ */


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ë²„íŠ¼ ì´ì¤‘í´ë¦­ ë°©ì§€ ìœ í‹¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function btnLock(el, text = 'ì²˜ë¦¬ ì¤‘...') {
  if (!el) return;
  el.dataset.origText = el.textContent;
  el.textContent = text;
  el.classList.add('btn-loading');
  el.disabled = true;
}
function btnUnlock(el) {
  if (!el) return;
  el.textContent = el.dataset.origText || el.textContent;
  el.classList.remove('btn-loading');
  el.disabled = false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SOUND SYSTEM (Web Audio API - ì™¸ë¶€ íŒŒì¼ ì—†ìŒ)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _audioCtx = null;

// ëª¨ë°”ì¼ ì—¬ë¶€ ê°ì§€ â†’ ë³¼ë¥¨ ë°°ìœ¨ (ëª¨ë°”ì¼ +15%)
const _isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const _volMult = _isMobile ? 1.15 : 1.0;

// ì²« í„°ì¹˜/í´ë¦­ ì‹œ AudioContext ìƒì„± (ë¸Œë¼ìš°ì € ìë™ì¬ìƒ ì •ì±… ìš°íšŒ)
function _ensureAudio() {
  if (!_audioCtx) {
    try { _audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
  }
  if (_audioCtx && _audioCtx.state === 'suspended') _audioCtx.resume();
}
['touchstart', 'mousedown', 'keydown'].forEach(e =>
  document.addEventListener(e, _ensureAudio, { once: false, passive: true })
);

function _playTone(freq, type, duration, vol=0.165) {
  _ensureAudio();
  if (!_audioCtx || _audioCtx.state !== 'running') return;
  try {
    const osc = _audioCtx.createOscillator();
    const gain = _audioCtx.createGain();
    osc.connect(gain); gain.connect(_audioCtx.destination);
    osc.type = type; osc.frequency.setValueAtTime(freq, _audioCtx.currentTime);
    gain.gain.setValueAtTime(vol * _volMult, _audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, _audioCtx.currentTime + duration);
    osc.start(); osc.stop(_audioCtx.currentTime + duration);
  } catch(e) {}
}

function _playChord(notes, type='sine', duration=0.12, vol=0.132) {
  notes.forEach((f,i) => setTimeout(() => _playTone(f, type, duration, vol), i*60));
}

function playSound(name) {
  if (!_audioCtx) return;
  // ì •ì§€ëœ AudioContext ì¬ê°œ
  if (_audioCtx.state === 'suspended') _audioCtx.resume();
  switch(name) {
    case 'click':
      _playTone(880, 'sine', 0.08, 0.11); break;
    case 'tab':
      _playTone(660, 'sine', 0.1, 0.088); break;
    case 'gacha':
      _playChord([261, 329, 392, 523], 'triangle', 0.18, 0.11); break;
    case 'gachaResult':
      _playChord([523, 659, 784, 1047], 'sine', 0.22, 0.132); break;
    case 'reward':
      _playChord([523, 659, 784], 'sine', 0.2, 0.143);
      setTimeout(() => _playChord([784, 1047], 'sine', 0.3, 0.11), 200); break;
    case 'notify':
      _playTone(880, 'sine', 0.12, 0.11);
      setTimeout(() => _playTone(1047, 'sine', 0.15, 0.11), 100); break;
    case 'approve':
      _playChord([523, 659, 784, 1047], 'sine', 0.25, 0.11); break;
    case 'reject':
      _playTone(220, 'sawtooth', 0.2, 0.088); break;
    case 'error':
      _playTone(180, 'square', 0.15, 0.077); break;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SUPABASE ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL = 'https://fqtnxrkxyzjrmaiaunqe.supabase.co';
const SUPABASE_KEY = 'sb_publishable_MpZnq9JYoQLTXc9Uda_nmA_5OAybs0X';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_EMAIL   = 'lovecoa37@gmail.com';
const GACHA_COST    = 10;

// â”€â”€ ì´ì¤‘ í´ë¦­ ë°©ì§€ (ì ê¸ˆ) â”€â”€
const _busy = new Set();
async function withLock(key, fn) {
  if (_busy.has(key)) { return; }
  _busy.add(key);
  try { await fn(); }
  finally { _busy.delete(key); }
}
// ë²„íŠ¼ ë¹„í™œì„±í™” í—¬í¼
function setBtnLoading(el, loading, text) {
  if (!el) return;
  el.disabled = loading;
  if (text !== undefined) el.textContent = loading ? 'ì²˜ë¦¬ ì¤‘...' : text;
  el.style.opacity = loading ? '0.6' : '';
}
// KST(UTC+9) ê¸°ì¤€ ë‚ ì§œ í—¬í¼
function _kstNow() {
  const now = new Date();
  return new Date(now.getTime() + 9 * 60 * 60 * 1000); // UTC+9
}
// TODAY, WEEK_KEYë¥¼ í•¨ìˆ˜ë¡œ â€” ì•±ì„ ì¼œë†“ì•„ë„ ìì •/ì›”ìš”ì¼ 0ì‹œì— ìë™ ê°±ì‹ 
function getToday() {
  return _kstNow().toISOString().slice(0, 10);
}
function getWeekKey() {
  const d = _kstNow();
  const day = d.getUTCDay() || 7;       // ì¼ìš”ì¼(0) â†’ 7
  const monday = new Date(d);
  monday.setUTCDate(d.getUTCDate() - (day - 1));
  return 'W-' + monday.toISOString().slice(0, 10); // ex) "W-2026-02-16"
}
// í•˜ìœ„ í˜¸í™˜: ê¸°ì¡´ TODAY/WEEK_KEY ë³€ìˆ˜ ì°¸ì¡° ì½”ë“œê°€ ìˆì„ ê²½ìš°ë¥¼ ìœ„í•œ ê²Œí„°
Object.defineProperty(window, 'TODAY',    { get: getToday });
Object.defineProperty(window, 'WEEK_KEY', { get: getWeekKey });
const NOW_TS = () => new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ì„¸ì…˜ ìƒíƒœ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let session   = null;   // supabase auth session
let myProfile = null;   // public.users í”„ë¡œí•„
let allUsers  = [];     // ê´€ë¦¬ììš© ì „ì²´ ìœ ì € ìºì‹œ
let allTxs    = [];     // ê´€ë¦¬ììš© ì „ì²´ TX ìºì‹œ
let gachaPool = [];     // gacha_items ìºì‹œ
let reqFilter = 'all';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ì•± ì‹œì‘
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
  // â”€â”€ OAuth ì½œë°± ì²˜ë¦¬ (ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í›„ URL í•´ì‹œì—ì„œ í† í° íŒŒì‹±) â”€â”€
  const hash = window.location.hash;
  if (hash && hash.includes('access_token=')) {
    const params = new URLSearchParams(hash.substring(1));
    const access_token = params.get('access_token');

    if (access_token) {
      // JWT payloadì—ì„œ userId íŒŒì‹± (ì¹´ì¹´ì˜¤ OAuthëŠ” URLì— user ê°ì²´ë¥¼ ì•ˆ ì¤Œ)
      let userId = '';
      try {
        const rawUser = params.get('user');
        if (rawUser) {
          userId = JSON.parse(rawUser).id;
        } else {
          const payload = JSON.parse(atob(access_token.split('.')[1]));
          userId = payload.sub;
        }
      } catch(e) { userId = 'oauth_user'; }

      const sessionData = {
        access_token,
        refresh_token: params.get('refresh_token'),
        expires_at: Math.floor(Date.now() / 1000) + parseInt(params.get('expires_in') || '3600'),
        user: { id: userId, email: 'kakao_user' }
      };
      localStorage.setItem('sb_session', JSON.stringify(sessionData));
      window.history.replaceState(null, null, window.location.pathname);
      window.location.reload(); // ì„¸ì…˜ ì €ì¥ í›„ ìƒˆë¡œê³ ì¹¨í•´ì•¼ getSession()ì´ ì •ìƒ ë™ì‘
      return;
    }
  }

  // Auth ìƒíƒœ ë³€ê²½ êµ¬ë…
  sb.auth.onAuthStateChange(async (event, s) => {
    session = s;
    if (s && s.user) {
      await onSignedIn(s);
    } else if (event === 'SIGNED_OUT') {
      showLoginScreen();
    }
  });

  // í˜„ì¬ ì„¸ì…˜ í™•ì¸
  const { data } = await sb.auth.getSession();
  if (data && data.session && data.session.user) {
    await onSignedIn(data.session);
  } else {
    showLoginScreen();
  }
}

function showLoginScreen() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('appRoot').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì´ë©”ì¼ ìë™ ì…ë ¥
  const saved = localStorage.getItem('dotori_last_email');
  if (saved) { const el = document.getElementById('loginEmail'); if(el) el.value = saved; }
}

async function onSignedIn(s) {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('loadingScreen').classList.remove('hidden');

  try {
    // í”„ë¡œí•„ ë¡œë“œ (ì—†ìœ¼ë©´ ìƒì„±)
    let { data: profile, error } = await sb.from('users').select('*').eq('id', s.user.id).single();
    if (error || !profile) {
      // íŠ¸ë¦¬ê±°ê°€ ì´ë¯¸ ìƒì„±í–ˆì§€ë§Œ í˜¹ì‹œ ì—†ìœ¼ë©´ ìˆ˜ë™ ìƒì„±
      const email = s.user.email || '';
      const name  = s.user.user_metadata?.full_name || s.user.user_metadata?.name || email.split('@')[0] || 'ì‚¬ìš©ì';
      const { data: created } = await sb.from('users').upsert({
        id: s.user.id, display_name: name, acorns: 0, is_admin: email === ADMIN_EMAIL
      }).select().single();
      profile = created;
    }
    myProfile = profile;

    // ë½‘ê¸° í’€ ë¡œë“œ
    const { data: gi } = await sb.from('gacha_items').select('*').eq('active', true);
    gachaPool = gi || [];

    // ì‹¤ì‹œê°„ êµ¬ë…
    setupRealtime();

    // UI ì´ˆê¸°í™”
    initAppUI();
  } catch (err) {
    console.error('onSignedIn error:', err);
    toast('âŒ', 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”');
    showLoginScreen();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ì‹¤ì‹œê°„ êµ¬ë…
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Realtime: í´ë§ ë°©ì‹ (WebSocket ì—†ì´ ì£¼ê¸°ì  ë™ê¸°í™”)
let _pollTimer = null;
let _lastNotifCount = 0;
let _lastReqCount = 0;
let _lastReqRemindAt = 0;   // ë§ˆì§€ë§‰ ì¬ì•Œë¦¼ ì‹œê° (ms)
const REQ_REMIND_INTERVAL = 3 * 60 * 1000; // 3ë¶„

async function _pollSync() {
  if (!myProfile) return;
  const token = session?.access_token || SUPABASE_KEY;
  const h = { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + token };

  try {
    // ë‚´ ì”ì•¡ ë™ê¸°í™”
    const ur = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${myProfile.id}&select=acorns`, { headers: h });
    const ud = await ur.json();
    if (ud?.[0] && ud[0].acorns !== myProfile.acorns) {
      myProfile.acorns = ud[0].acorns;
      updateAcornDisplay();
      playSound('reward');
    }

    // ìƒˆ ì•Œë¦¼ í™•ì¸
    const nr = await fetch(`${SUPABASE_URL}/rest/v1/notifications?user_id=eq.${myProfile.id}&select=id&order=created_at.desc`, { headers: h });
    const nd = await nr.json();
    if (Array.isArray(nd) && nd.length > _lastNotifCount) {
      if (_lastNotifCount > 0) { playSound('notify'); }
      _lastNotifCount = nd.length;
      updateNotifDot();
    }

    // ê´€ë¦¬ì: ì‹ ì²­ ê°œìˆ˜ í™•ì¸
    if (myProfile.is_admin) {
      const rr = await fetch(`${SUPABASE_URL}/rest/v1/product_requests?status=eq.pending&select=id`, { headers: h });
      const rd = await rr.json();
      if (Array.isArray(rd)) {
        const cnt = rd.length;
        // ë°°ì§€ ì—…ë°ì´íŠ¸
        const badge = document.getElementById('reqBadge');
        if (badge) {
          if (cnt > 0) {
            badge.textContent = cnt > 9 ? '9+' : cnt;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
        if (cnt !== _lastReqCount) {
          _lastReqCount = cnt;
          if (!document.getElementById('atab-requests').classList.contains('hidden')) renderRequestAdmin();
          // ìƒˆ ì‹ ì²­ ë„ì°© ì‹œ ì¦‰ì‹œ ì•Œë¦¼
          if (cnt > 0) {
            sendBrowserNotif(`ğŸ“¬ ë¯¸ì²˜ë¦¬ ì‹ ì²­ ${cnt}ê±´`, 'í™•ì¸ì´ í•„ìš”í•œ ì‹ ì²­ì´ ìˆì–´ìš”!');
            _lastReqRemindAt = Date.now();
          }
        }
        // 3ë¶„ë§ˆë‹¤ ì¬ì•Œë¦¼ (pending ì‹ ì²­ì´ ìˆëŠ”ë° ì²˜ë¦¬ ì•ˆ ëì„ ë•Œ)
        if (cnt > 0 && Date.now() - _lastReqRemindAt >= REQ_REMIND_INTERVAL) {
          playSound('notify');
          sendBrowserNotif(`ğŸ“¬ ë¯¸ì²˜ë¦¬ ì‹ ì²­ ${cnt}ê±´`, `${cnt}ê±´ì˜ ì‹ ì²­ì´ ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ì–´ìš”. í™•ì¸í•´ì£¼ì„¸ìš”!`);
          _lastReqRemindAt = Date.now();
        }
      }
    }
  } catch(e) {}
}

function setupRealtime() {
  // 5ì´ˆë§ˆë‹¤ í´ë§
  if (_pollTimer) clearInterval(_pollTimer);
  _pollTimer = setInterval(_pollSync, 5000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  UI ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initAppUI() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('appRoot').classList.remove('hidden');

  if (myProfile.is_admin) {
    document.getElementById('headerUserLabel').textContent = 'ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ';
    document.getElementById('headerAcorns').classList.add('hidden');
    document.getElementById('notifBtn').classList.add('hidden');
    document.getElementById('adminMode').classList.remove('hidden');
    document.getElementById('userMode').classList.add('hidden');
    renderDashboard();
    populateGiveSelect();
    populateLogFilter();
    updateReqBadge();
  } else {
    document.getElementById('headerUserLabel').textContent = myProfile.display_name;
    document.getElementById('headerAcorns').classList.remove('hidden');
    document.getElementById('notifBtn').classList.remove('hidden');
    document.getElementById('userMode').classList.remove('hidden');
    document.getElementById('adminMode').classList.add('hidden');
    updateAcornDisplay();
    updateNotifDot();
    renderShop();
    // ì¶œì„ ìë™ í€˜ìŠ¤íŠ¸
    setTimeout(() => triggerAutoQuest('attendance'), 500);
  }
}

function updateAcornDisplay() {
  document.getElementById('headerAcorns').textContent = `ğŸŒ° ${myProfile.acorns || 0}`;
  const el = document.getElementById('myAcornVal');
  if (el) el.textContent = myProfile.acorns || 0;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AUTH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doEmailLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pw    = document.getElementById('loginPw').value;
  const errEl = document.getElementById('loginErr');
  errEl.classList.add('hidden');
  if (!email || !pw) { showErr('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  document.getElementById('loginEmail').disabled = true;
  const { error } = await sb.auth.signInWithPassword({ email, password: pw });
  document.getElementById('loginEmail').disabled = false;
  if (error) { showErr(error.message.includes('Invalid') ? 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”' : error.message); }
}

async function doKakaoLogin() {
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'kakao',
    options: { redirectTo: window.location.href }
  });
  if (error) toast('âŒ', 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message);
}

async function doLogout() {
  playSound('click');
  await sb.auth.signOut();
}

function showErr(msg) {
  const el = document.getElementById('loginErr');
  el.textContent = 'âŒ ' + msg;
  el.classList.remove('hidden');
  document.getElementById('loginEmail').classList.add('shake-anim');
  setTimeout(() => document.getElementById('loginEmail').classList.remove('shake-anim'), 500);
}

function showSignup() {
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-4">âœ¨ íšŒì›ê°€ì…</h2>
    <div class="space-y-3">
      <input class="field" type="text" id="su-name" placeholder="ì´ë¦„ (ë‹‰ë„¤ì„)">
      <input class="field" type="email" id="su-email" placeholder="ì´ë©”ì¼">
      <input class="field" type="password" id="su-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
      <div id="su-err" class="hidden text-xs text-red-500 font-bold"></div>
      <button class="btn btn-primary w-full py-3" onclick="doSignup()">ê°€ì…í•˜ê¸°</button>
      <button class="btn btn-gray w-full py-2 text-sm" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>`);
}

async function doSignup() {
  const name  = document.getElementById('su-name').value.trim();
  const email = document.getElementById('su-email').value.trim();
  const pw    = document.getElementById('su-pw').value;
  const errEl = document.getElementById('su-err');
  if (!name || !email || !pw) { errEl.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'; errEl.classList.remove('hidden'); return; }
  if (pw.length < 6) { errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•´ìš”'; errEl.classList.remove('hidden'); return; }

  const { error } = await sb.auth.signUp({ email, password: pw, options: { data: { full_name: name } } });
  if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
  closeModal();
  toast('âœ…', 'ê°€ì… ì™„ë£Œ! ì´ë©”ì¼ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TABS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const U_TABS = ['shop','gacha','quest','mypage'];
const A_TABS = ['dashboard','give','gachaTest','products','quests','requests','txlog','users'];

function uTab(tab, btn) {
  U_TABS.forEach(t => document.getElementById('utab-'+t).classList.add('hidden'));
  document.querySelectorAll('#userMode>.clay-card .tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('utab-'+tab).classList.remove('hidden');
  btn.classList.add('active');
  playSound('tab');
  if (tab === 'shop')   { renderShop(); triggerAutoQuest('shopVisit'); }
  if (tab === 'gacha')  renderGachaProbTable();
  if (tab === 'quest')  renderQuests();
  if (tab === 'mypage') renderMypage();
}

function aTab(tab, btn) {
  playSound('tab');
  A_TABS.forEach(t => document.getElementById('atab-'+t).classList.add('hidden'));
  document.querySelectorAll('#adminTabBar .tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('atab-'+tab).classList.remove('hidden');
  btn.classList.add('active');
  if (tab === 'dashboard')  renderDashboard();
  if (tab === 'gachaTest')  renderAdminGachaProbTable();
  if (tab === 'products')   renderProductAdmin();
  if (tab === 'quests')     renderQuestAdmin();
  if (tab === 'requests')   renderRequestAdmin();
  if (tab === 'txlog')      renderTxLog();
  if (tab === 'give')       renderGiveHistory();
  if (tab === 'users')      renderUserAdmin();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SHOP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderShop() {
  const grid = document.getElementById('shopGrid');
  grid.innerHTML = '<p class="text-sm text-gray-400 col-span-2 text-center py-4">ë¡œë”© ì¤‘...</p>';
  const { data: products } = await sb.from('products').select('*').eq('active', true).eq('item_type', 'store').order('sort_order');
  if (!products?.length) { grid.innerHTML = '<p class="text-sm text-gray-400 col-span-2 text-center py-8">ìƒí’ˆì´ ì—†ì–´ìš”</p>'; return; }
  grid.innerHTML = products.map((p,i) => {
    const unlimited = p.stock === null || p.stock === undefined || p.stock < 0;
    const soldOut   = !unlimited && p.stock <= 0;
    const stockLabel = unlimited ? '' : soldOut
      ? '<span class="badge-soldout">í’ˆì ˆ</span>'
      : `<span class="badge-stock">ë‚¨ì€ìˆ˜ëŸ‰ ${p.stock}ê°œ</span>`;
    return `
    <div class="clay-card p-4 flex flex-col bounce-in ${soldOut?'opacity-60':''}" style="animation-delay:${i*.06}s">
      <div class="text-4xl text-center mb-2">${p.icon}</div>
      <h3 class="font-black text-gray-800 text-center text-sm mb-1">${p.name}</h3>
      <p class="text-xs text-gray-400 font-semibold text-center mb-2">${p.description||''}</p>
      <div class="flex justify-center gap-1 mb-3 flex-wrap">
        <span class="${p.reward_type==='AUTO_ACORN'?'rt-auto':'rt-manual'}">${p.reward_type==='AUTO_ACORN'?'âš¡ ì¦‰ì‹œì§€ê¸‰':'ğŸ“¬ ìŠ¹ì¸í•„ìš”'}</span>
        ${stockLabel}
      </div>
      <div class="mt-auto">
        <div class="text-center font-black text-amber-600 mb-2">ğŸŒ° ${p.price}</div>
        ${soldOut
          ? '<button class="btn btn-gray w-full py-2 text-sm" disabled>í’ˆì ˆ</button>'
          : `<button class="btn btn-primary w-full py-2 text-sm" onclick="requestProduct('${p.id}')">êµ¬ë§¤í•˜ê¸°</button>`
        }
      </div>
    </div>`;
  }).join('');
}

async function requestProduct(id) {
  const { data: p } = await sb.from('products').select('*').eq('id', id).single();
  if (!p) return;
  const unlimited = p.stock === null || p.stock === undefined || p.stock < 0;
  if (!unlimited && p.stock <= 0) { toast('âŒ', 'í’ˆì ˆëœ ìƒí’ˆì´ì—ìš”!'); renderShop(); return; }
  if ((myProfile.acorns || 0) < p.price) { playSound('reject'); toast('âŒ', 'ë„í† ë¦¬ê°€ ë¶€ì¡±í•´ìš”!'); return; }
  showModal(`
    <div class="text-center">
      <div class="text-6xl mb-3">${p.icon}</div>
      <h2 class="text-xl font-black text-gray-800 mb-1">${p.name}</h2>
      <p class="text-sm text-gray-400 mb-3">${p.description}</p>
      <div class="bg-amber-50 rounded-2xl p-3 mb-5 text-left">
        <p class="text-sm font-bold text-amber-800">ğŸŒ° ${p.price} ë„í† ë¦¬ ì°¨ê°</p>
        ${p.reward_type==='AUTO_ACORN'?`<p class="text-xs text-green-700 font-bold mt-1">âœ¨ ì¦‰ì‹œ +${p.acorn_amt} ë„í† ë¦¬!</p>`:''}
      </div>
      <div class="flex gap-3">
        <button class="btn btn-gray flex-1 py-3" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-3" onclick="confirmRequest('${p.id}')">êµ¬ë§¤í•˜ê¸°!</button>
      </div>
    </div>`);
}

async function confirmRequest(productId) {
  await withLock('purchase_'+productId, async () => { await _confirmRequestInner(productId); });
}
async function _confirmRequestInner(productId) {
  closeModal();
  if (window._buyLock) return;
  window._buyLock = true;

  try {
    const { data: p } = await sb.from('products').select('*').eq('id', productId).single();
    if (!p || (myProfile.acorns || 0) < p.price) { toast('âŒ', 'ë„í† ë¦¬ ë¶€ì¡±!'); return; }

    const unlimited = p.stock === null || p.stock === undefined || p.stock < 0;
    if (!unlimited && p.stock <= 0) { toast('âŒ', 'í’ˆì ˆëœ ìƒí’ˆì´ì—ìš”!'); renderShop(); return; }

    const res = await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: -p.price, p_reason: `ìƒí’ˆ êµ¬ë§¤ â€” ${p.icon} ${p.name}` });
    if (!res.data?.success) { toast('âŒ', 'ì²˜ë¦¬ ì‹¤íŒ¨: ' + (res.data?.error || '')); return; }
    myProfile.acorns = res.data.balance;

    if (!unlimited) {
      await sb.from('products').update({ stock: p.stock - 1 }).eq('id', productId);
    }

    if (p.reward_type === 'MANUAL_ITEM') {
      await sb.from('inventory').insert({
        user_id: myProfile.id, product_snapshot: p, from_gacha: false, status: 'held'
      });
      await pushNotif(myProfile.id, 'request', 'ì•„ì´í…œ íšë“! ğŸ', `${p.icon} ${p.name} íšë“! ì¸ë²¤í† ë¦¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`);
      playSound('reward');
      toast('ğŸ’', `${p.icon} ${p.name} ì¸ë²¤í† ë¦¬ì— ì¶”ê°€ëì–´ìš”!`);
      updateAcornDisplay();
      renderShop();
      return;
    }

    await sb.from('product_requests').insert({
      user_id: myProfile.id, product_id: p.id,
      product_snapshot: p, price: p.price, status: 'approved',
      reward_type: p.reward_type, from_gacha: false
    });

    if (p.reward_type === 'AUTO_ACORN') {
      await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: p.acorn_amt, p_reason: `ìë™ ë³´ìƒ â€” ${p.name}` });
      myProfile.acorns += p.acorn_amt;
      await pushNotif(myProfile.id, 'reward', 'ë³´ìƒ ì§€ê¸‰! âš¡', `${p.name} êµí™˜ìœ¼ë¡œ +${p.acorn_amt}ğŸŒ°!`);
      toast('âš¡', `ì¦‰ì‹œ +${p.acorn_amt} ë„í† ë¦¬!`);
    } else {
      await pushNotif(myProfile.id, 'request', 'ì‹ ì²­ ì™„ë£Œ!', `${p.name} ì‹ ì²­ ì™„ë£Œ. ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì´ì—ìš”.`);
      toast('âœ…', `${p.name} ì‹ ì²­ ì™„ë£Œ!`);
    }
    playSound('reward');
    updateAcornDisplay();
    renderShop();
    triggerAutoQuest('itemBuy');
  } finally {
    window._buyLock = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GACHA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í™•ë¥  ê¸°ë°˜ weighted random ë½‘ê¸°
async function loadGachaPool() {
  const { data } = await sb.from('products')
    .select('*')
    .eq('active', true)
    .eq('item_type', 'gacha');
  gachaPool = data || [];
  return gachaPool;
}

function drawItemWeighted(pool) {
  if (!pool.length) return null;
  // probability í•©ê³„ ê³„ì‚°
  const total = pool.reduce((s, x) => s + (x.probability || 0), 0);
  if (total <= 0) {
    // í™•ë¥ ì´ ì„¤ì • ì•ˆ ëœ ê²½ìš° ê· ë“± ë¶„ë°°
    return pool[Math.floor(Math.random() * pool.length)];
  }
  let rand = Math.random() * total;
  for (const item of pool) {
    rand -= (item.probability || 0);
    if (rand <= 0) return item;
  }
  return pool[pool.length - 1];
}

async function doGacha(count) {
  const btns = document.querySelectorAll('#utab-gacha button');
  const spinner = document.getElementById('gachaSpinner');
  const gachaResultEl = document.getElementById('gachaResult');

  // ì´ì¤‘í´ë¦­ ë°©ì§€
  btns.forEach(b => btnLock(b, 'ë½‘ëŠ” ì¤‘...'));

  // ë½‘ê¸° ì—°ì¶œ ì‹œì‘
  if (spinner) {
    if (gachaResultEl) gachaResultEl.classList.add('hidden');
    spinner.classList.add('active');
    const spinIcon = document.getElementById('gachaSpinIcon');
    const spinEmojis = ['ğŸ','ğŸŒ°','âœ¨','ğŸ²','ğŸŠ','â­','ğŸ€'];
    let spinIdx = 0;
    window._spinInterval = setInterval(() => {
      if (spinIcon) spinIcon.textContent = spinEmojis[spinIdx++ % spinEmojis.length];
    }, 120);
    if (spinIcon) spinIcon.classList.add('gacha-spinning');
  }

  // ìŠ¤í”¼ë„ˆ/ë²„íŠ¼ ì •ë¦¬ í—¬í¼ (ì—ëŸ¬ ì‹œì—ë„ ë°˜ë“œì‹œ ì‹¤í–‰)
  function _cleanupGacha() {
    if (window._spinInterval) clearInterval(window._spinInterval);
    if (spinner) {
      spinner.classList.remove('active');
      const si = document.getElementById('gachaSpinIcon');
      if (si) { si.classList.remove('gacha-spinning'); si.textContent = 'ğŸ'; }
    }
    btns.forEach(btnUnlock);
  }

  try {
    const cost = GACHA_COST * count;
    if ((myProfile.acorns||0) < cost) {
      playSound('reject'); toast('âŒ', 'ë„í† ë¦¬ê°€ ë¶€ì¡±í•´ìš”!'); return;
    }
    playSound('gacha');

    // ë½‘ê¸° í’€ ìµœì‹ í™”
    const pool = await loadGachaPool();
    if (!pool.length) {
      toast('âŒ', 'ë½‘ê¸° ìƒí’ˆì´ ì—†ì–´ìš”! ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'); return;
    }

    // ì°¨ê°
    const res = await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: -cost, p_reason: `ë½‘ê¸° ì‚¬ìš© (${count}íšŒ)` });
    if (!res.data?.success) { toast('âŒ', 'ì²˜ë¦¬ ì‹¤íŒ¨'); return; }
    myProfile.acorns = res.data.balance;
    updateAcornDisplay();

    // â”€â”€ ë½‘ê¸° ê²°ê³¼ ê³„ì‚° (ë¡œì»¬, ì¦‰ì‹œ) â”€â”€
    const results = Array.from({ length: count }, () => drawItemWeighted(pool)).filter(Boolean);

    // â”€â”€ AUTO_ACORN ë³´ìƒ í•©ì‚° â†’ í•œ ë²ˆì— ì§€ê¸‰ â”€â”€
    const acornItems    = results.filter(r => r.reward_type === 'AUTO_ACORN' && r.acorn_amt > 0);
    const manualItems   = results.filter(r => r.reward_type === 'MANUAL_ITEM');
    const totalAcornAmt = acornItems.reduce((s, r) => s + r.acorn_amt, 0);

    // â”€â”€ DB ì‘ì—… ë³‘ë ¬ ì‹¤í–‰ â”€â”€
    const dbTasks = [];

    // ë„í† ë¦¬ ë³´ìƒ í•œ ë²ˆì—
    if (totalAcornAmt > 0) {
      dbTasks.push(
        sb.rpc('adjust_acorns', {
          p_user_id: myProfile.id,
          p_amount: totalAcornAmt,
          p_reason: `ë½‘ê¸° ë³´ìƒ (${acornItems.map(r=>r.name).join(', ')})`
        }).then(r => {
          if (r.data?.success) myProfile.acorns = r.data.balance;
        })
      );
    }

    // ì¸ë²¤í† ë¦¬ ì‚½ì… í•œ ë²ˆì— (ë°°ì—´ë¡œ)
    if (manualItems.length > 0) {
      dbTasks.push(
        sb.from('inventory').insert(
          manualItems.map(item => ({
            user_id: myProfile.id,
            product_snapshot: item,
            from_gacha: true,
            status: 'held'
          }))
        )
      );
    }

    // ì•Œë¦¼ í•œ ë²ˆì— (ê° ì•„ì´í…œë³„ ì•Œë¦¼ â†’ ë³‘ë ¬)
    for (const item of results) {
      if (item.reward_type === 'AUTO_ACORN' && item.acorn_amt > 0) {
        dbTasks.push(pushNotif(myProfile.id, 'gachaReward', 'ë½‘ê¸° ë³´ìƒ! ğŸ²', `${item.icon} ${item.name} íšë“! +${item.acorn_amt}ğŸŒ°`));
      } else if (item.reward_type === 'MANUAL_ITEM') {
        dbTasks.push(pushNotif(myProfile.id, 'gachaReward', 'ì•„ì´í…œ íšë“! ğŸ²', `${item.icon} ${item.name} íšë“! ì¸ë²¤í† ë¦¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`));
      }
    }

    await Promise.all(dbTasks);
    updateAcornDisplay();
    playSound('reward');
    triggerAutoQuest('gachaPlay', count); // ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ (await ì—†ìŒ â€” ë½‘ê¸° UXì— ì˜í–¥ ì•ˆ ì¤Œ)

    renderGachaCards(results, 'gachaResult', 'gachaResultItems');
    setTimeout(() => playSound('gachaResult'), 100);
    const el = document.getElementById('gachaIcon');
    el.style.animation = 'none'; void el.offsetWidth;
    el.textContent = 'ğŸŠ'; el.style.animation = 'bounceIn .5s';
    setTimeout(() => { el.textContent = 'ğŸ'; el.style.animation = ''; }, 1600);

  } catch(err) {
    toast('âŒ', 'ë½‘ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”');
    console.error('doGacha error:', err);
  } finally {
    _cleanupGacha();
  }
}

function renderGachaCards(results, wrapId, itemsId) {
  document.getElementById(wrapId).classList.remove('hidden');
  document.getElementById(itemsId).innerHTML = results.map((item,i) => `
    <div class="text-center pop-in" style="animation-delay:${i*.12}s">
      <div class="text-5xl mb-2">${item.icon}</div>
      <div class="badge ${rcClass(item.rarity)} mb-1 block">${item.name}</div>
      <span class="${item.reward_type==='AUTO_ACORN'?'rt-auto':'rt-manual'} block mt-1">
        ${item.reward_type==='AUTO_ACORN'?`+${item.acorn_amt}ğŸŒ°`:'ğŸ“¬ ìŠ¹ì¸ëŒ€ê¸°'}
      </span>
    </div>`).join('');
}

const rcClass = r => ({common:'rc-common',rare:'rc-rare',epic:'rc-epic',legend:'rc-legend'})[r]||'rc-common';

async function renderGachaProbTable() {
  const el = document.getElementById('gachaProbTable');
  if (!el) return;
  const { data: items, error } = await sb.from('products')
    .select('name,icon,probability,description')
    .eq('active', true).eq('item_type', 'gacha')
    .order('probability', { ascending: false });
  if (error) { el.innerHTML = `<p class="text-xs text-red-400 text-center py-2">ì˜¤ë¥˜: ${error.message}</p>`; return; }
  if (!items?.length) { el.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">ë“±ë¡ëœ ë½‘ê¸° ìƒí’ˆ ì—†ìŒ</p>'; return; }
  const total = items.reduce((s,x) => s+(x.probability||0), 0);
  el.innerHTML = items.map(x => {
    const pct = total > 0 ? ((x.probability||0)/total*100).toFixed(1) : (100/items.length).toFixed(1);
    return `<div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
      <span class="text-sm font-bold text-gray-700">${x.icon||'ğŸ'} ${x.name}</span>
      <span class="badge-gacha-pct">${pct}%</span>
    </div>`;
  }).join('');
}

function setForce(r) { forceRarity=r; document.getElementById('forceLabel').textContent=({'':'ëœë¤',common:'âšª ì¼ë°˜',rare:'ğŸ”µ ë ˆì–´',epic:'ğŸŸ£ ì—í”½',legend:'ğŸ”´ ì „ì„¤'})[r]; }
async function doAdminGacha(count) {
  const btns = document.querySelectorAll('#atab-gachaTest button');
  const spinner = document.getElementById('adminGachaSpinner');
  const resultEl = document.getElementById('adminGachaResult');

  btns.forEach(b => btnLock(b, 'ë½‘ëŠ” ì¤‘...'));
  if (spinner) { spinner.style.display = 'flex'; if (resultEl) resultEl.classList.add('hidden'); }

  const spinIcon = document.getElementById('adminGachaSpinIcon');
  const spinEmojis = ['ğŸ','ğŸŒ°','âœ¨','ğŸ²','ğŸŠ','â­','ğŸ€'];
  let spinIdx = 0;
  const spinInterval = setInterval(() => {
    if (spinIcon) spinIcon.textContent = spinEmojis[spinIdx++ % spinEmojis.length];
  }, 120);

  playSound('gacha');

  try {
    const pool = await loadGachaPool();
    if (!pool.length) { toast('âŒ', 'ë½‘ê¸° ìƒí’ˆì´ ì—†ì–´ìš”!'); return; }

    // ì‹¤ì œ í™•ë¥ ë¡œ ë½‘ë˜ ë„í† ë¦¬ ì°¨ê°/ì¸ë²¤í† ë¦¬ ì €ì¥ ì—†ìŒ
    const results = Array.from({length: count}, () => drawItemWeighted(pool)).filter(Boolean);

    renderGachaCards(results, 'adminGachaResult', 'adminGachaResultItems');
    setTimeout(() => playSound('gachaResult'), 100);

    const icon = document.getElementById('adminGachaIcon');
    if (icon) {
      icon.style.animation = 'none'; void icon.offsetWidth;
      icon.textContent = 'ğŸŠ'; icon.style.animation = 'bounceIn .5s';
      setTimeout(() => { icon.textContent = 'ğŸ'; icon.style.animation = ''; }, 1600);
    }
  } catch(e) {
    toast('âŒ', 'ì˜¤ë¥˜ ë°œìƒ');
  } finally {
    clearInterval(spinInterval);
    if (spinner) spinner.style.display = 'none';
    if (spinIcon) spinIcon.textContent = 'ğŸ';
    btns.forEach(btnUnlock);
  }
}

// ê´€ë¦¬ì ë½‘ê¸° íƒ­ ì§„ì… ì‹œ í™•ë¥  í…Œì´ë¸” ë Œë”
async function renderAdminGachaProbTable() {
  const el = document.getElementById('adminGachaProbTable');
  if (!el) return;
  const { data: items, error } = await sb.from('products')
    .select('name,icon,probability,description')
    .eq('active', true).eq('item_type', 'gacha')
    .order('probability', { ascending: false });
  if (error || !items?.length) {
    el.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">ë“±ë¡ëœ ë½‘ê¸° ìƒí’ˆ ì—†ìŒ</p>';
    return;
  }
  const total = items.reduce((s,x) => s+(x.probability||0), 0);
  el.innerHTML = items.map(x => {
    const pct = total > 0 ? ((x.probability||0)/total*100).toFixed(1) : (100/items.length).toFixed(1);
    return `<div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
      <span class="text-sm font-bold text-gray-700">${x.icon||'ğŸ'} ${x.name}</span>
      <span class="badge-prob">${pct}%</span>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  QUEST HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPeriodKey(repeatType) {
  if (repeatType === 'once')   return 'once';
  if (repeatType === 'daily')  return TODAY;
  if (repeatType === 'weekly') return WEEK_KEY;
  return 'once';
}

async function isQuestDone(questId, repeatType, targetCount = 1) {
  const key = getPeriodKey(repeatType);
  const { data } = await sb.from('quest_progress')
    .select('id, progress_count')
    .eq('user_id', myProfile.id).eq('quest_id', questId).eq('period_key', key)
    .maybeSingle();
  if (!data) return false;
  // target_count > 1 ì´ë©´ ëˆ„ì  íšŸìˆ˜ ê¸°ì¤€
  if (targetCount > 1) return (data.progress_count || 0) >= targetCount;
  return true;
}

async function hasPendingQCR(questId, repeatType) {
  const key = getPeriodKey(repeatType);
  const { data } = await sb.from('quest_completion_requests')
    .select('id').eq('user_id', myProfile.id).eq('quest_id', questId)
    .eq('status', 'pending').eq('period_key', key).maybeSingle();
  return !!data;
}

async function markQuestDone(questId, repeatType) {
  const key = getPeriodKey(repeatType);
  await sb.from('quest_progress').upsert(
    { user_id: myProfile.id, quest_id: questId, period_key: key },
    { onConflict: 'user_id,quest_id,period_key', ignoreDuplicates: true }
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AUTO QUEST TRIGGER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ í€˜ìŠ¤íŠ¸ ìë™ì™„ë£Œ íŠ¸ë¦¬ê±° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// triggerType ëª©ë¡:
//   'attendance'  - ë¡œê·¸ì¸/ì¶œì„ ì‹œ
//   'shopVisit'   - ìƒì  íƒ­ ë°©ë¬¸ ì‹œ
//   'gachaPlay'   - ë½‘ê¸° ì‹¤í–‰ ì‹œ (count: ë½‘ê¸° íšŸìˆ˜)
//   'itemBuy'     - ìƒì ì—ì„œ ìƒí’ˆ êµ¬ë§¤ ì‹œ
//   'itemUse'     - ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ì‚¬ìš© ì‹ ì²­ ì‹œ
//   'questSubmit' - í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì œì¶œ ì‹œ
//
// í€˜ìŠ¤íŠ¸ ì´ë¦„/ì„¤ëª…ì— í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ë¡œ ë§¤ì¹­:
//   attendance  â†’ ì´ë¦„: "ì¶œì„"  / ì„¤ëª…: "ì ‘ì†","ë¡œê·¸ì¸"
//   shopVisit   â†’ ì´ë¦„: "ìƒì ","ìƒí’ˆ" / ì„¤ëª…: "ìƒì ","ë°©ë¬¸"
//   gachaPlay   â†’ ì´ë¦„: "ë½‘ê¸°" / ì„¤ëª…: "ë½‘ê¸°"
//   itemBuy     â†’ ì´ë¦„: "êµ¬ë§¤" / ì„¤ëª…: "êµ¬ë§¤","ìƒì ì—ì„œ"
//   itemUse     â†’ ì´ë¦„: "ì‚¬ìš©","ì‹ ì²­" / ì„¤ëª…: "ì•„ì´í…œ","ì‚¬ìš©ì‹ ì²­"
//   questSubmit â†’ ì´ë¦„: "í€˜ìŠ¤íŠ¸","ì œì¶œ" / ì„¤ëª…: "í€˜ìŠ¤íŠ¸","ì œì¶œ"
//
// íšŸìˆ˜ ê¸°ë°˜ í€˜ìŠ¤íŠ¸: quests.target_count ì»¬ëŸ¼ (NULL=1íšŒ, N=NíšŒ ëˆ„ì  í›„ ì™„ë£Œ)
//   ì˜ˆ) target_count=3, ë½‘ê¸° í€˜ìŠ¤íŠ¸ â†’ ë½‘ê¸°ë¥¼ 3ë²ˆ íŠ¸ë¦¬ê±°í•´ì•¼ ì™„ë£Œ
//       (5íšŒ ë½‘ê¸° 1ë²ˆ = gachaPlay 1íšŒ ì¹´ìš´íŠ¸, 3ì´ ë¼ì•¼ ì™„ë£Œ)
async function triggerAutoQuest(triggerType, count = 1) {
  if (!myProfile || myProfile.is_admin) return;
  const { data: quests } = await sb.from('quests').select('*').eq('active', true).eq('completion_type', 'auto');
  if (!quests) return;

  for (const q of quests) {
    const match =
      (triggerType === 'attendance'    && (q.name.includes('ì¶œì„') || q.description.includes('ì ‘ì†') || q.description.includes('ë¡œê·¸ì¸'))) ||
      (triggerType === 'shopVisit'     && (q.name.includes('ìƒì ') || q.name.includes('ìƒí’ˆ') || q.description.includes('ìƒì ') || q.description.includes('ë°©ë¬¸'))) ||
      (triggerType === 'gachaPlay'     && (q.name.includes('ë½‘ê¸°') || q.description.includes('ë½‘ê¸°'))) ||
      (triggerType === 'itemBuy'       && (q.name.includes('êµ¬ë§¤') || q.description.includes('êµ¬ë§¤') || q.description.includes('ìƒì ì—ì„œ'))) ||
      (triggerType === 'itemUse'       && (q.name.includes('ì‚¬ìš©') || q.name.includes('ì‹ ì²­') || q.description.includes('ì•„ì´í…œ') || q.description.includes('ì‚¬ìš©ì‹ ì²­'))) ||
      (triggerType === 'questSubmit'   && (q.name.includes('í€˜ìŠ¤íŠ¸') || q.name.includes('ì œì¶œ') || q.description.includes('í€˜ìŠ¤íŠ¸') || q.description.includes('ì œì¶œ'))) ||
      (triggerType === 'questComplete' && (q.target_count||1) >= 2 && (q.name.includes('í€˜ìŠ¤íŠ¸') || q.description.includes('í€˜ìŠ¤íŠ¸') || q.description.includes('ì™„ë£Œ')));
    if (!match) continue;

    const done = await isQuestDone(q.id, q.repeat_type, q.target_count || 1);
    if (done) continue;

    // íšŸìˆ˜ ê¸°ë°˜ í€˜ìŠ¤íŠ¸ ì²˜ë¦¬
    const target = q.target_count || 1;
    if (target > 1) {
      // quest_progressì—ì„œ í˜„ì¬ ëˆ„ì  íšŸìˆ˜ í™•ì¸
      const key = getPeriodKey(q.repeat_type);
      const { data: prog } = await sb.from('quest_progress')
        .select('id, progress_count')
        .eq('user_id', myProfile.id).eq('quest_id', q.id).eq('period_key', key)
        .maybeSingle();

      const current = (prog?.progress_count || 0) + count;
      if (current < target) {
        // ì•„ì§ ëª©í‘œ ë¯¸ë‹¬ â†’ ì¹´ìš´íŠ¸ë§Œ ì—…ë°ì´íŠ¸
        if (prog) {
          await sb.from('quest_progress').update({ progress_count: current }).eq('id', prog.id);
        } else {
          await sb.from('quest_progress').insert({
            user_id: myProfile.id, quest_id: q.id, period_key: key, progress_count: current
          });
        }
        toast('ğŸ“‹', `${q.name} (${current}/${target})`);
        continue;
      }
      // ëª©í‘œ ë‹¬ì„± â†’ ì™„ë£Œ ì²˜ë¦¬
      if (prog) {
        await sb.from('quest_progress').update({ progress_count: target }).eq('id', prog.id);
      } else {
        await sb.from('quest_progress').insert({
          user_id: myProfile.id, quest_id: q.id, period_key: key, progress_count: target
        });
      }
    } else {
      // 1íšŒ ì™„ë£Œ í€˜ìŠ¤íŠ¸
      await markQuestDone(q.id, q.repeat_type);
    }

    const res = await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: q.reward, p_reason: `í€˜ìŠ¤íŠ¸ ìë™ì™„ë£Œ â€” ${q.name}` });
    if (res.data?.success) { myProfile.acorns = res.data.balance; updateAcornDisplay(); }
    await pushNotif(myProfile.id, 'quest', 'í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ğŸ‰', `${q.icon} ${q.name} ì™„ë£Œ! +${q.reward}ğŸŒ°`);
    setTimeout(() => toast('ğŸ‰', `${q.name} ì™„ë£Œ! +${q.reward}ğŸŒ°`), 400);

    // í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì‹œ "í€˜ìŠ¤íŠ¸ NíšŒ ì™„ë£Œí•˜ê¸°" í€˜ìŠ¤íŠ¸ ì¹´ìš´íŠ¸ (ë¬´í•œë£¨í”„ ë°©ì§€: questComplete íŠ¸ë¦¬ê±°ëŠ” target_count>=2 í€˜ìŠ¤íŠ¸ë§Œ ë§¤ì¹­)
    if (triggerType !== 'questComplete') {
      triggerAutoQuest('questComplete');
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  QUEST (USER)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const repLabel = { once:'1íšŒì„±', daily:'ì¼ì¼', weekly:'ì£¼ê°„' };
const repClass  = { once:'rep-once', daily:'rep-daily', weekly:'rep-weekly' };

async function renderQuests() {
  const el = document.getElementById('questList');
  el.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ë¡œë”© ì¤‘...</p>';
  // ì„¸ì…˜ í† í°ì„ ëª…ì‹œì ìœ¼ë¡œ í¬í•¨í•œ ì§ì ‘ fetch (RLS ìš°íšŒ ë°©ì§€)
  let quests = null;
  try {
    const token = session?.access_token || SUPABASE_KEY;
    const res = await fetch(`${SUPABASE_URL}/rest/v1/quests?active=eq.true&order=sort_order.asc`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    quests = await res.json();
    if (!Array.isArray(quests)) quests = null;
  } catch(e) {
    const { data } = await sb.from('quests').select('*').eq('active', true).order('sort_order');
    quests = data;
  }
  if (!quests?.length) { el.innerHTML = '<p class="text-sm text-gray-400 text-center py-8">í€˜ìŠ¤íŠ¸ê°€ ì—†ì–´ìš”</p>'; return; }

  const cards = await Promise.all(quests.map(async q => {
    const ct   = q.completion_type || 'approval';
    const done = await isQuestDone(q.id, q.repeat_type, q.target_count || 1);
    // íšŸìˆ˜ ê¸°ë°˜ í€˜ìŠ¤íŠ¸ ì§„í–‰ í˜„í™©
    let progCount = 0;
    if ((q.target_count||1) > 1) {
      const key = getPeriodKey(q.repeat_type);
      const { data: prog } = await sb.from('quest_progress')
        .select('progress_count')
        .eq('user_id', myProfile.id).eq('quest_id', q.id).eq('period_key', key)
        .maybeSingle();
      progCount = prog?.progress_count || 0;
    }

    if (ct === 'auto') {
      return `<div class="clay-card p-4 flex items-center gap-3 ${done?'opacity-75':''}">
        <div class="w-10 h-10 rounded-2xl flex items-center justify-center flex-shrink-0 ${done?'bg-green-100':'bg-amber-50'}">
          <span class="text-xl">${done?'âœ…':'âš¡'}</span>
        </div>
        <div class="text-2xl flex-shrink-0">${q.icon}</div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-0.5 flex-wrap">
            <p class="font-black text-sm ${done?'line-through text-gray-400':'text-gray-800'}">${q.name}</p>
            <span class="rep-badge ${repClass[q.repeat_type]}">${repLabel[q.repeat_type]}</span>
            <span class="ct-auto">âš¡ ìë™</span>
          </div>
          <p class="text-xs text-gray-400 font-semibold">${q.description}</p>
          ${(q.target_count||1) > 1 ? `<div class="mt-1.5">
            <div style="background:#f3f4f6;border-radius:999px;height:6px;overflow:hidden">
              <div style="background:#f59e0b;height:100%;width:${done?100:Math.min(100,Math.round((progCount/(q.target_count||1))*100))}%;transition:width .3s;border-radius:999px"></div>
            </div>
            <p class="text-xs text-gray-400 mt-0.5 font-bold">${done?q.target_count:progCount} / ${q.target_count}íšŒ</p>
          </div>` : ''}
        </div>
        <div class="text-right flex-shrink-0">
          <div class="font-black text-amber-600 text-sm">+${q.reward}ğŸŒ°</div>
          <span class="${done?'qs-done':'qs-inprogress'}">${done?'ì™„ë£Œë¨':'ì§„í–‰ì¤‘'}</span>
        </div>
      </div>`;
    } else {
      const pending = done ? false : await hasPendingQCR(q.id, q.repeat_type);
      const canReq  = !done && !pending;
      return `<div class="clay-card p-4 flex items-center gap-3 ${done?'opacity-75':''}">
        <div class="w-10 h-10 rounded-2xl flex items-center justify-center flex-shrink-0 ${done?'bg-green-100':pending?'bg-yellow-100':'bg-pink-50'}">
          <span class="text-xl">${done?'âœ…':pending?'â³':'ğŸ‘¤'}</span>
        </div>
        <div class="text-2xl flex-shrink-0">${q.icon}</div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-0.5 flex-wrap">
            <p class="font-black text-sm ${done?'line-through text-gray-400':'text-gray-800'}">${q.name}</p>
            <span class="rep-badge ${repClass[q.repeat_type]}">${repLabel[q.repeat_type]}</span>
            <span class="ct-approval">ğŸ‘¤ ìŠ¹ì¸</span>
          </div>
          <p class="text-xs text-gray-400 font-semibold">${q.description}</p>
        </div>
        <div class="text-right flex-shrink-0 flex flex-col items-end gap-1">
          <div class="font-black text-amber-600 text-sm">+${q.reward}ğŸŒ°</div>
          ${done?'<span class="qs-done">ì™„ë£Œë¨</span>':pending?'<span class="qs-pending">ìŠ¹ì¸ ëŒ€ê¸°</span>':canReq?`<button class="btn btn-pink px-3 py-1 text-xs" onclick="requestQuestCompletion('${q.id}')">âœ‹ ì™„ë£Œ ìš”ì²­</button>`:'<span class="qs-inprogress">ë¶ˆê°€</span>'}
        </div>
      </div>`;
    }
  }));
  el.innerHTML = cards.join('');
}

async function requestQuestCompletion(questId) {
  const { data: q } = await sb.from('quests').select('*').eq('id', questId).single();
  if (!q) return;
  const done    = await isQuestDone(questId, q.repeat_type);
  const pending = await hasPendingQCR(questId, q.repeat_type);
  if (done || pending) { toast('â³', 'ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ì—ìš”!'); return; }

  const key = getPeriodKey(q.repeat_type);
  await sb.from('quest_completion_requests').insert({
    user_id: myProfile.id, quest_id: questId, status: 'pending', period_key: key
  });
  await pushNotif(myProfile.id, 'quest', 'ì™„ë£Œ ìš”ì²­ ì „ì†¡! âœ‹', `${q.icon} ${q.name} ì™„ë£Œ ìš”ì²­ì„ ë³´ëƒˆì–´ìš”.`);
  toast('âœ‹', `${q.name} ì™„ë£Œ ìš”ì²­ ì „ì†¡!`);
  triggerAutoQuest('questSubmit');
  renderQuests();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MYPAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ ë§ˆì´í˜ì´ì§€ í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ â”€â”€
let _reqPage = 0, _reqItems = [];
let _txPage  = 0, _txItems  = [];
const PAGE_SIZE = 5;

function _renderReqPage() {
  const el = document.getElementById('myRequestList');
  const total = _reqItems.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  const slice = _reqItems.slice(_reqPage * PAGE_SIZE, (_reqPage + 1) * PAGE_SIZE);

  el.innerHTML = slice.length
    ? slice.map(r => `<div class="flex items-center justify-between p-3 rounded-xl" style="background:rgba(255,255,255,0.5)">
        <div class="min-w-0 mr-2">
          <p class="text-sm font-bold text-gray-800">${r.icon} ${r.label}</p>
          <p class="text-xs text-gray-400">${r.sub}</p>
        </div>
        <span class="badge ${stClass(r.status)} shrink-0">${stLabel(r.status)}</span>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-3">ì‹ ì²­ ë‚´ì—­ì´ ì—†ì–´ìš”</p>';

  const label = document.getElementById('reqPageLabel');
  const prev  = document.getElementById('reqPrevBtn');
  const next  = document.getElementById('reqNextBtn');
  if (label) label.textContent = total ? `${_reqPage+1} / ${totalPages}` : '';
  if (prev)  prev.disabled  = _reqPage === 0;
  if (next)  next.disabled  = _reqPage >= totalPages - 1;
}

function _renderTxPage() {
  const el = document.getElementById('myTxList');
  const total = _txItems.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  const slice = _txItems.slice(_txPage * PAGE_SIZE, (_txPage + 1) * PAGE_SIZE);

  el.innerHTML = slice.length
    ? slice.map(t => `<div class="flex items-center justify-between p-3 rounded-xl" style="background:rgba(255,255,255,0.5)">
        <div class="flex-1 min-w-0 mr-3">
          <p class="text-sm font-bold text-gray-700 truncate">${t.reason}</p>
          <p class="text-xs text-gray-400">${fmtTs(t.created_at)} Â· ì”ì•¡ ${t.balance}ğŸŒ°</p>
        </div>
        <span class="font-black text-base shrink-0 ${t.amount>0?'tx-plus':'tx-minus'}">${t.amount>0?'+':''}${t.amount}ğŸŒ°</span>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-3">ë‚´ì—­ì´ ì—†ì–´ìš”</p>';

  const label = document.getElementById('txPageLabel');
  const prev  = document.getElementById('txPrevBtn');
  const next  = document.getElementById('txNextBtn');
  if (label) label.textContent = total ? `${_txPage+1} / ${totalPages}` : '';
  if (prev)  prev.disabled  = _txPage === 0;
  if (next)  next.disabled  = _txPage >= totalPages - 1;
}

function moveReqPage(dir) {
  const totalPages = Math.max(1, Math.ceil(_reqItems.length / PAGE_SIZE));
  _reqPage = Math.max(0, Math.min(totalPages - 1, _reqPage + dir));
  _renderReqPage();
}

function moveTxPage(dir) {
  const totalPages = Math.max(1, Math.ceil(_txItems.length / PAGE_SIZE));
  _txPage = Math.max(0, Math.min(totalPages - 1, _txPage + dir));
  _renderTxPage();
}

async function renderMypage() {
  document.getElementById('mypageHeader').innerHTML = `
    <div class="flex items-center gap-4">
      <div class="text-5xl">${myProfile.avatar_emoji || 'ğŸ¿ï¸'}</div>
      <div>
        <h2 class="text-xl font-black text-gray-800">${myProfile.display_name}</h2>
        <p class="text-xs text-gray-400 font-semibold">${session?.user?.email || ''}</p>
      </div>
      <div class="ml-auto text-center">
        <div class="text-3xl font-black text-amber-600" id="myAcornVal">${myProfile.acorns || 0}</div>
        <div class="text-xs text-gray-500 font-bold">ğŸŒ° ë„í† ë¦¬</div>
      </div>
    </div>`;

  renderInventory();

  // 30ì¼ ê¸°ì¤€ ë‚ ì§œ (KST)
  const cutoff = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();

  const [{ data: myReqs }, { data: myQCRs }, { data: txs }] = await Promise.all([
    sb.from('product_requests').select('*')
      .eq('user_id', myProfile.id).gte('created_at', cutoff)
      .order('created_at', { ascending: false }).limit(200),
    sb.from('quest_completion_requests').select('*, quests(name,icon)')
      .eq('user_id', myProfile.id).gte('created_at', cutoff)
      .order('created_at', { ascending: false }).limit(100),
    sb.from('transactions').select('*')
      .eq('user_id', myProfile.id).gte('created_at', cutoff)
      .order('created_at', { ascending: false }).limit(500),
  ]);

  // ì‹ ì²­ í˜„í™© ë°ì´í„° í•©ì‚° í›„ ë‚ ì§œìˆœ ì •ë ¬
  _reqPage  = 0;
  _reqItems = [
    ...(myReqs||[]).map(r => ({
      label: r.product_snapshot?.name || 'ìƒí’ˆ',
      icon:  r.product_snapshot?.icon || 'ğŸ',
      sub:   fmtTs(r.created_at) + (r.price ? ` Â· ${r.price}ğŸŒ°` : ' Â· ë½‘ê¸°') + (r.from_gacha ? ' ğŸ²' : ''),
      status: r.status,
      created_at: r.created_at,
    })),
    ...(myQCRs||[]).map(r => ({
      label: r.quests?.name || 'í€˜ìŠ¤íŠ¸',
      icon:  r.quests?.icon || 'ğŸ“‹',
      sub:   fmtTs(r.created_at) + ' Â· ì™„ë£Œ ìš”ì²­',
      status: r.status,
      created_at: r.created_at,
    })),
  ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

  _renderReqPage();

  // ë„í† ë¦¬ ë‚´ì—­
  _txPage  = 0;
  _txItems = txs || [];
  _renderTxPage();
}

async function renderInventory() {
  const el = document.getElementById('myInventory');
  if (!el) return;
  el.innerHTML = '<p class="text-xs text-gray-400 col-span-3 text-center py-2">ë¡œë”© ì¤‘...</p>';

  const { data: items } = await sb.from('inventory')
    .select('*').eq('user_id', myProfile.id).eq('status', 'held')
    .order('created_at', { ascending: false });

  if (!items?.length) {
    el.innerHTML = '<p class="text-xs text-gray-400 col-span-3 text-center py-4">ì•„ì´í…œì´ ì—†ì–´ìš” ğŸ’</p>';
    return;
  }

  el.innerHTML = items.map(item => {
    const snap = item.product_snapshot || {};
    return `<div class="flex flex-col items-center gap-1 p-3 rounded-2xl bg-amber-50 border-2 border-amber-100 cursor-pointer card-hover"
        onclick="useInventoryItem('${item.id}')">
      <div class="text-3xl">${snap.icon || 'ğŸ'}</div>
      <p class="text-xs font-black text-gray-700 text-center leading-tight">${snap.name || 'ì•„ì´í…œ'}</p>
      <span class="text-xs ${item.from_gacha ? 'it-gacha' : 'it-store'}">${item.from_gacha ? 'ğŸ² ë½‘ê¸°' : 'ğŸ›ï¸ êµ¬ë§¤'}</span>
      <button class="btn btn-primary w-full py-1 text-xs mt-1">ì‚¬ìš©í•˜ê¸°</button>
    </div>`;
  }).join('');
}

async function useInventoryItem(inventoryId) {
  const { data: item } = await sb.from('inventory').select('*').eq('id', inventoryId).single();
  if (!item) return;
  const snap = item.product_snapshot || {};
  showModal(`
    <div class="text-center">
      <div class="text-6xl mb-3">${snap.icon || 'ğŸ'}</div>
      <h2 class="text-xl font-black text-gray-800 mb-1">${snap.name || 'ì•„ì´í…œ'}</h2>
      <p class="text-sm text-gray-400 mb-2">${snap.description || ''}</p>
      <div class="bg-amber-50 rounded-2xl p-3 mb-5 text-left text-sm font-bold text-amber-800">
        âœ‹ ì‚¬ìš©í•˜ë©´ ê´€ë¦¬ìì—ê²Œ ì‹ ì²­ì´ ì „ë‹¬ë¼ìš”.<br>ìŠ¹ì¸ í›„ ì•„ì´í…œì´ ì§€ê¸‰ë©ë‹ˆë‹¤.
      </div>
      <div class="flex gap-3">
        <button class="btn btn-gray flex-1 py-3" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-3" onclick="confirmUseItem('${inventoryId}')">ì‚¬ìš©í•˜ê¸°!</button>
      </div>
    </div>`);
}

async function confirmUseItem(inventoryId) {
  await withLock('useitem_'+inventoryId, async () => { await _confirmUseItemInner(inventoryId); });
}
async function _confirmUseItemInner(inventoryId) {
  closeModal();
  const { data: item } = await sb.from('inventory').select('*').eq('id', inventoryId).single();
  if (!item) { toast('âŒ', 'ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”'); return; }
  const snap = item.product_snapshot || {};

  // ì¸ë²¤í† ë¦¬ì—ì„œ 'ì‚¬ìš©ë¨'ìœ¼ë¡œ ë³€ê²½
  await sb.from('inventory').update({ status: 'used' }).eq('id', inventoryId);

  // product_requestsì— ì‹ ì²­ ìƒì„±
  await sb.from('product_requests').insert({
    user_id: myProfile.id,
    product_snapshot: snap,
    price: 0,
    status: 'pending',
    reward_type: 'MANUAL_ITEM',
    from_gacha: item.from_gacha || false
  });

  // ì‚¬ìš©ì ë³¸ì¸ ì•Œë¦¼
  await pushNotif(myProfile.id, 'request', 'ì‹ ì²­ ì™„ë£Œ! âœ‹', `${snap.icon} ${snap.name} ì‹ ì²­ì„ ë³´ëƒˆì–´ìš”. ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì´ì—ìš”.`);

  // ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ (DB + ë¸Œë¼ìš°ì € Push)
  try {
    const { data: adminUser } = await sb.from('users').select('id').eq('is_admin', true).maybeSingle();
    if (adminUser) {
      await pushNotif(
        adminUser.id, 'request',
        `ğŸ“¬ ì‹ ì²­ ë„ì°©! ${snap.icon} ${snap.name}`,
        `${myProfile.display_name}ë‹˜ì´ ì•„ì´í…œ ì‚¬ìš©ì„ ì‹ ì²­í–ˆì–´ìš”. í™•ì¸í•´ì£¼ì„¸ìš”!`
      );
    }
  } catch(e) {}

  // ë¸Œë¼ìš°ì € Push ì•Œë¦¼ (ê´€ë¦¬ì ê¸°ê¸°ì—ì„œ ë°›ì„ ìˆ˜ ìˆë„ë¡)
  sendBrowserNotif('ğŸ“¬ ìƒˆ ì‹ ì²­ì´ ë„ì°©í–ˆì–´ìš”!', `${myProfile.display_name}ë‹˜: ${snap.icon} ${snap.name} ì‚¬ìš© ì‹ ì²­`);

  playSound('pop');
  toast('âœ…', `${snap.name} ì‹ ì²­ ì™„ë£Œ!`);
  triggerAutoQuest('itemUse');
  renderInventory();
  renderMypage();
}

// ë¸Œë¼ìš°ì € Push ì•Œë¦¼ (Web Notification API)
async function requestNotifPermission() {
  if (!('Notification' in window)) return false;
  if (Notification.permission === 'granted') return true;
  if (Notification.permission === 'denied') return false;
  const result = await Notification.requestPermission();
  return result === 'granted';
}

function sendBrowserNotif(title, body, icon = 'ğŸŒ°') {
  if (!('Notification' in window)) return;
  if (Notification.permission !== 'granted') return;
  try {
    new Notification(title, {
      body,
      icon: '/acorn-shop/apple-touch-icon.png',
      badge: '/acorn-shop/apple-touch-icon.png',
      tag: 'acorn-admin-request',
      renotify: true
    });
  } catch(e) {}
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  NOTIFICATIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pushNotif(userId, type, title, body) {
  await sb.from('notifications').insert({ user_id: userId, type, title, body });
}

async function updateReqBadge() {
  if (!myProfile?.is_admin) return;
  try {
    const { data } = await sb.from('product_requests').select('id').eq('status', 'pending');
    const badge = document.getElementById('reqBadge');
    if (!badge) return;
    const cnt = data?.length || 0;
    if (cnt > 0) {
      badge.textContent = cnt > 9 ? '9+' : cnt;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  } catch(e) {}
}

async function updateNotifDot() {
  const { count } = await sb.from('notifications').select('*', { count: 'exact', head: true })
    .eq('user_id', myProfile.id).eq('is_read', false);
  const dot = document.getElementById('notifDot');
  const btn = document.getElementById('notifBtn');
  if (dot) dot.classList.toggle('hidden', !count);
  if (btn) btn.classList.toggle('hidden', false);
}

async function showNotifications() {
  const { data: notifs } = await sb.from('notifications').select('*')
    .eq('user_id', myProfile.id).order('created_at', { ascending: false }).limit(20);
  // ì½ìŒ ì²˜ë¦¬
  await sb.from('notifications').update({ is_read: true }).eq('user_id', myProfile.id).eq('is_read', false);
  updateNotifDot();
  const typeIcon = { reward:'ğŸ', quest:'ğŸ“‹', admin:'ğŸ‘‘', gachaReward:'ğŸ²', request:'ğŸ“¬', quest_approved:'âœ…', quest_rejected:'âŒ' };
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-3">ğŸ”” ì•Œë¦¼</h2>
    <div class="notif-scroll">
    ${!notifs?.length ? '<p class="text-sm text-gray-400 text-center py-6">ì•Œë¦¼ì´ ì—†ì–´ìš”</p>' :
      notifs.map(n => `<div class="p-3 rounded-2xl bg-gray-50 mb-2 flex gap-3">
        <span class="text-xl shrink-0">${typeIcon[n.type]||'ğŸ””'}</span>
        <div><p class="text-sm font-black text-gray-800">${n.title}</p>
          <p class="text-xs text-gray-400 font-semibold" style="word-break:break-word">${n.body}</p>
          <p class="text-xs text-gray-300 mt-1">${fmtTs(n.created_at)}</p>
        </div>
      </div>`).join('')}
    </div>`);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” GIVE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function populateGiveSelect() {
  const { data: users } = await sb.from('users').select('*').eq('is_admin', false).order('display_name');
  allUsers = users || [];
  const sel = document.getElementById('giveUser');
  if (!sel) return;
  sel.innerHTML = allUsers.map(u => `<option value="${u.id}">${u.display_name} (${u.acorns}ğŸŒ°)</option>`).join('');
  const logSel = document.getElementById('logUserFilter');
  if (logSel) {
    logSel.innerHTML = '<option value="all">ì „ì²´ ì‚¬ìš©ì</option>' + allUsers.map(u => `<option value="${u.id}">${u.display_name}</option>`).join('');
  }
}

async function giveAcorns() {
  await withLock('giveAcorns', async () => { await _giveAcornsInner(); });
}
async function _giveAcornsInner() {
  const giveBtn = document.querySelector('#atab-give .btn-primary');
  btnLock(giveBtn, 'ì§€ê¸‰ ì¤‘...');
  playSound('click');

  try {
    const userId = document.getElementById('giveUser').value;
    const amount = parseInt(document.getElementById('giveAmount').value);
    const memo   = document.getElementById('giveMemo')?.value || '';
    if (!userId || !amount || amount === 0) { toast('âŒ', 'ì‚¬ìš©ìì™€ ì§€ê¸‰ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”'); return; }

    const res = await sb.rpc('admin_give_acorns', { p_target_user_id: userId, p_amount: amount, p_memo: memo || 'ê´€ë¦¬ì ì§€ê¸‰' });
    if (!res.data?.success) { toast('âŒ', 'ì§€ê¸‰ ì‹¤íŒ¨: ' + (res.data?.error || '')); return; }

    const { data: u } = await sb.from('users').select('display_name').eq('id', userId).single();
    const isDeduct = amount < 0;
    const absAmt = Math.abs(amount);
    await pushNotif(userId, 'admin',
      isDeduct ? 'ë„í† ë¦¬ ì°¨ê° ğŸŒ°' : 'ë„í† ë¦¬ ì§€ê¸‰! ğŸŒ°',
      `ê´€ë¦¬ìê°€ ${absAmt} ë„í† ë¦¬ë¥¼ ${isDeduct ? 'ì°¨ê°í–ˆì–´ìš”' : 'ì§€ê¸‰í–ˆì–´ìš”'}! ${memo ? '(' + memo + ')' : ''}`
    );
    toast('âœ…', `${u?.display_name||'ì‚¬ìš©ì'}ì—ê²Œ ${absAmt} ë„í† ë¦¬ ${isDeduct ? 'ì°¨ê°' : 'ì§€ê¸‰'}!`);
    document.getElementById('giveAmount').value = '';
    document.getElementById('giveMemo').value = '';
    populateGiveSelect();
    renderGiveHistory();
  } finally {
    btnUnlock(giveBtn);
  }
}


async function renderGiveHistory() {
  const { data: list } = await sb.from('transactions').select('*, users(display_name)').ilike('reason', 'ê´€ë¦¬ì ì§€ê¸‰%').order('created_at', { ascending: false }).limit(8);
  const el = document.getElementById('giveHistory');
  el.innerHTML = list?.length
    ? list.map(t => `<div class="flex items-center justify-between p-3 rounded-xl bg-gray-50">
        <div><p class="text-sm font-bold text-gray-800">${t.users?.display_name||''}</p>
          <p class="text-xs text-gray-400">${t.reason.replace('ê´€ë¦¬ì ì§€ê¸‰ â€” ','')} Â· ${fmtTs(t.created_at)}</p></div>
        <span class="font-black text-amber-600">+${t.amount}ğŸŒ°</span>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-4">ì§€ê¸‰ ë‚´ì—­ ì—†ìŒ</p>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” PRODUCTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAcornField(prefix) {
  const sel = document.getElementById(prefix+'-rewardType');
  const fld = document.getElementById(prefix+'-acornWrap');
  if (sel && fld) fld.classList.toggle('hidden', sel.value !== 'AUTO_ACORN');
}

function toggleItemType(prefix) {
  const sel = document.getElementById(prefix+'-itemType');
  const probWrap = document.getElementById(prefix+'-probabilityWrap');
  const priceWrap = document.getElementById(prefix+'-priceWrap');
  if (sel && probWrap) probWrap.classList.toggle('hidden', sel.value !== 'gacha');
  if (sel && priceWrap) priceWrap.classList.toggle('hidden', sel.value === 'gacha');
}

function _productCard(p, i, listType) {
  const bg = p.active ? 'bg-gray-50' : 'bg-red-50 opacity-60';
  return `<div class="p-3 rounded-2xl ${bg} drag-item border-2 border-transparent"
      data-id="${p.id}" data-type="${listType}" data-order="${p.sort_order}"
      draggable="true"
      ondragstart="drgStart(event,'${p.id}','${listType}')"
      ondragover="drgOver(event)"
      ondrop="drgDrop(event,'${p.id}','${listType}')"
      ondragend="drgEnd(event)">
    <div class="flex items-center gap-2">
      <div class="text-gray-300 select-none">â ¿</div>
      <div class="text-xl">${p.icon}</div>
      <div class="flex-1 min-w-0">
        <p class="font-black text-gray-800 text-sm truncate">${p.name}</p>
        <div class="flex items-center gap-1 flex-wrap mt-0.5">
          ${listType === 'store'
          ? `<span class="text-xs text-gray-500 font-bold">${p.price}ğŸŒ°</span>
             ${p.stock !== null && p.stock !== undefined && p.stock >= 0
               ? (p.stock === 0
                 ? '<span class="badge-soldout-sm">í’ˆì ˆ</span>'
                 : `<span class="badge-stock-sm">ì¬ê³  ${p.stock}</span>`)
               : '<span class="badge-unlimited-sm">ë¬´ì œí•œ</span>'}`
          : `<span class="text-xs text-purple-600 font-bold">${p.probability||0}%</span>`}
          <span class="${p.reward_type==='AUTO_ACORN'?'rt-auto':'rt-manual'} text-xs">${p.reward_type==='AUTO_ACORN'?'âš¡':'ğŸ“¬'}</span>
          ${p.reward_type==='AUTO_ACORN'?`<span class="text-xs text-green-600 font-bold">+${p.acorn_amt}ğŸŒ°</span>`:''}
          ${!p.active?'<span class="badge-soldout-sm">ë¹„í™œì„±</span>':''}
        </div>
      </div>
    </div>
    <div class="flex gap-1 mt-2">
      <button class="btn btn-blue flex-1 py-1 text-xs" onclick="editProduct('${p.id}')">ìˆ˜ì •</button>
      <button class="btn btn-red px-2 py-1 text-xs" onclick="deleteProduct('${p.id}')">ğŸ—‘</button>
    </div>
  </div>`;
}

async function renderProductAdmin() {
  const { data: products } = await sb.from('products').select('*').order('sort_order');
  const storeEl = document.getElementById('storeProductList');
  const gachaEl = document.getElementById('gachaProductList');
  if (!storeEl || !gachaEl) return;

  const storeItems = (products||[]).filter(p => (p.item_type||'store') === 'store');
  const gachaItems = (products||[]).filter(p => p.item_type === 'gacha');

  storeEl.innerHTML = storeItems.length
    ? storeItems.map((p,i) => _productCard(p,i,'store')).join('')
    : '<p class="text-xs text-gray-400 text-center py-3">ìƒí’ˆì´ ì—†ì–´ìš”</p>';

  gachaEl.innerHTML = gachaItems.length
    ? gachaItems.map((p,i) => _productCard(p,i,'gacha')).join('')
    : '<p class="text-xs text-gray-400 text-center py-3">ìƒí’ˆì´ ì—†ì–´ìš”</p>';
}

function toggleStockField() {
  const type = document.getElementById('ns-stockType')?.value;
  const fld  = document.getElementById('ns-stock');
  if (fld) fld.classList.toggle('hidden', type !== 'limited');
}

async function addStoreProduct() {
  const name       = document.getElementById('ns-name').value.trim();
  const icon       = document.getElementById('ns-icon').value || 'ğŸ';
  const price      = parseInt(document.getElementById('ns-price').value) || 0;
  const desc       = document.getElementById('ns-desc').value || '';
  const rewardType = document.getElementById('ns-rewardType').value;
  const acornAmt   = parseInt(document.getElementById('ns-acornAmt').value) || 0;
  const stockType  = document.getElementById('ns-stockType')?.value || 'unlimited';
  const stock      = stockType === 'limited' ? (parseInt(document.getElementById('ns-stock').value) || 1) : null;
  if (!name) { toast('âŒ', 'ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!price) { toast('âŒ', 'ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (stockType === 'limited' && (!stock || stock < 1)) { toast('âŒ', 'ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const { data: all } = await sb.from('products').select('id');
  const { error } = await sb.from('products').insert({
    name, price, icon, description: desc,
    reward_type: rewardType, acorn_amt: acornAmt,
    item_type: 'store', probability: 0,
    stock: stock,
    active: true, sort_order: (all?.length||0)+1
  });
  if (error) { toast('âŒ', 'ì¶”ê°€ ì‹¤íŒ¨: ' + error.message); return; }
  ['ns-name','ns-icon','ns-price','ns-desc','ns-acornAmt','ns-stock'].forEach(id => { const e=document.getElementById(id); if(e) e.value=''; });
  document.getElementById('ns-stockType').value = 'unlimited';
  toggleStockField();
  playSound('click');
  renderProductAdmin(); toast('âœ…', 'ìƒì  ìƒí’ˆ ì¶”ê°€ ì™„ë£Œ!');
}

async function addGachaProduct() {
  const name        = document.getElementById('ng-name').value.trim();
  const icon        = document.getElementById('ng-icon').value || 'âœ¨';
  const probability = parseFloat(document.getElementById('ng-probability').value) || 0;
  const desc        = document.getElementById('ng-desc').value || '';
  const rewardType  = document.getElementById('ng-rewardType').value;
  const acornAmt    = parseInt(document.getElementById('ng-acornAmt').value) || 0;
  if (!name) { toast('âŒ', 'ì•„ì´í…œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!probability) { toast('âŒ', 'í™•ë¥ ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 10)'); return; }
  const { data: all } = await sb.from('products').select('id');
  const { error } = await sb.from('products').insert({
    name, price: 0, icon, description: desc,
    reward_type: rewardType, acorn_amt: acornAmt,
    item_type: 'gacha', probability,
    active: true, sort_order: (all?.length||0)+1
  });
  if (error) { toast('âŒ', 'ì¶”ê°€ ì‹¤íŒ¨: ' + error.message); return; }
  ['ng-name','ng-icon','ng-probability','ng-desc','ng-acornAmt'].forEach(id => { const e=document.getElementById(id); if(e) e.value=''; });
  playSound('click');
  renderProductAdmin(); toast('âœ…', 'ë½‘ê¸° ìƒí’ˆ ì¶”ê°€ ì™„ë£Œ!');
}

async function deleteProduct(id) {
  if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
  await sb.from('products').delete().eq('id', id);
  renderProductAdmin(); toast('ğŸ—‘ï¸', 'ìƒí’ˆ ì‚­ì œë¨');
}

async function editProduct(id) {
  const { data: p } = await sb.from('products').select('*').eq('id', id).single();
  const it = p.item_type || 'store';
  const prob = p.probability || 0;
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-4">âœï¸ ìƒí’ˆ ìˆ˜ì •</h2>
    <div class="space-y-3">
      <input class="field" id="ep-name" value="${p.name}" placeholder="ìƒí’ˆëª…">
      <div class="grid grid-cols-2 gap-2">
        <input class="field" type="number" id="ep-price" value="${p.price}" placeholder="ê°€ê²©">
        <input class="field" id="ep-icon" value="${p.icon}" placeholder="ì´ëª¨ì§€">
      </div>
      <input class="field" id="ep-desc" value="${p.description||''}" placeholder="ì„¤ëª…">
      <div>
        <label class="text-xs font-bold text-gray-500 mb-1 block">ë³´ìƒ íƒ€ì…</label>
        <select class="field" id="ep-rt" onchange="toggleEditAcorn()">
          <option value="MANUAL_ITEM" ${p.reward_type==='MANUAL_ITEM'?'selected':''}>ğŸ“¬ MANUAL â€” ê´€ë¦¬ì ìŠ¹ì¸</option>
          <option value="AUTO_ACORN" ${p.reward_type==='AUTO_ACORN'?'selected':''}>âš¡ AUTO â€” ì¦‰ì‹œ ì§€ê¸‰</option>
        </select>
      </div>
      <div id="ep-acornWrap" class="${p.reward_type==='AUTO_ACORN'?'':'hidden'}">
        <label class="text-xs font-bold text-gray-500 mb-1 block">ì§€ê¸‰ ë„í† ë¦¬</label>
        <input class="field" type="number" id="ep-acornAmt" value="${p.acorn_amt||0}" placeholder="ë„í† ë¦¬ ìˆ˜ëŸ‰">
      </div>
      <div>
        <label class="text-xs font-bold text-gray-500 mb-1 block">ìƒí’ˆ íƒ€ì…</label>
        <select class="field" id="ep-itemType" onchange="toggleItemType('ep')">
          <option value="store" ${it==='store'?'selected':''}>ğŸ›ï¸ ìƒì  ìƒí’ˆ</option>
          <option value="gacha" ${it==='gacha'?'selected':''}>ğŸ² ë½‘ê¸° ìƒí’ˆ</option>
        </select>
      </div>
      <div id="ep-probabilityWrap" class="${it==='gacha'?'':'hidden'}">
        <label class="text-xs font-bold text-gray-500 mb-1 block">í™•ë¥  (%)</label>
        <input class="field" type="number" step="0.1" min="0" id="ep-probability" value="${prob}" placeholder="ì˜ˆ: 10 â†’ 10%">
        <p class="text-xs text-gray-400 mt-1">â€» í•©ì´ 100ì´ ì•„ë‹ˆì–´ë„ ìë™ ì •ê·œí™”ë©ë‹ˆë‹¤</p>
      </div>
      <div id="ep-stockWrap" class="${it==='store'?'':'hidden'}">
        <label class="text-xs font-bold text-gray-500 mb-1 block">íŒë§¤ ìˆ˜ëŸ‰</label>
        <div class="flex gap-2">
          <select class="field" id="ep-stockType" onchange="toggleEditStock()" style="flex:1">
            <option value="unlimited" ${(p.stock===null||p.stock===undefined||p.stock<0)?'selected':''}>â™¾ï¸ ë¬´ì œí•œ</option>
            <option value="limited" ${(p.stock!==null&&p.stock!==undefined&&p.stock>=0)?'selected':''}>ğŸ”¢ ìˆ˜ëŸ‰ ì œí•œ</option>
          </select>
          <input class="field" type="number" id="ep-stock" value="${(p.stock!==null&&p.stock!==undefined&&p.stock>=0)?p.stock:''}"
            placeholder="ê°œìˆ˜" min="0"
            class="${(p.stock!==null&&p.stock!==undefined&&p.stock>=0)?'':'hidden'}"
            style="width:80px;flex-shrink:0;${(p.stock!==null&&p.stock!==undefined&&p.stock>=0)?'':'display:none'}">
        </div>
      </div>
      <div class="flex gap-3 pt-2">
        <button class="btn btn-gray flex-1 py-3" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-3" onclick="saveProduct('${id}')">ì €ì¥</button>
      </div>
    </div>`);
}
function toggleEditStock() {
  const type = document.getElementById('ep-stockType')?.value;
  const fld  = document.getElementById('ep-stock');
  if (fld) fld.style.display = type === 'limited' ? '' : 'none';
}
function toggleEditAcorn() { const s=document.getElementById('ep-rt'),f=document.getElementById('ep-acornWrap'); if(s&&f)f.classList.toggle('hidden',s.value!=='AUTO_ACORN'); }
async function saveProduct(id) {
  const it = document.getElementById('ep-itemType')?.value || 'store';
  const stockType = document.getElementById('ep-stockType')?.value || 'unlimited';
  const stockVal = stockType === 'limited'
    ? (parseInt(document.getElementById('ep-stock')?.value) ?? 0)
    : null;
  await sb.from('products').update({
    name: document.getElementById('ep-name').value,
    price: parseInt(document.getElementById('ep-price').value)||0,
    icon: document.getElementById('ep-icon').value,
    description: document.getElementById('ep-desc').value,
    reward_type: document.getElementById('ep-rt').value,
    acorn_amt: parseInt(document.getElementById('ep-acornAmt')?.value)||0,
    item_type: it,
    probability: it === 'gacha' ? (parseFloat(document.getElementById('ep-probability')?.value)||0) : 0,
    stock: it === 'store' ? stockVal : null,
  }).eq('id', id);
  closeModal(); renderProductAdmin(); renderShop(); toast('âœ…', 'ìˆ˜ì • ì™„ë£Œ!');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DRAG & DROP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _dragSrcId = null;
let _dragSrcType = null;

function drgStart(e, id, type) {
  _dragSrcId = id;
  _dragSrcType = type;
  setTimeout(() => { e.target.style.opacity = '.4'; }, 0);
  e.dataTransfer.effectAllowed = 'move';
}
function drgOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}
function drgEnd(e) {
  e.currentTarget.style.opacity = '';
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}
async function drgDrop(e, targetId, targetType) {
  e.preventDefault();
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  if (!_dragSrcId || _dragSrcId === targetId || _dragSrcType !== targetType) {
    _dragSrcId = null; return;
  }

  // ê°™ì€ íƒ€ì… ë‚´ì—ì„œë§Œ ìˆœì„œ ë³€ê²½
  const listEl = targetType === 'store'
    ? document.getElementById('storeProductList')
    : document.getElementById('gachaProductList');
  const cards = Array.from(listEl.querySelectorAll('[data-id]'));
  const ids = cards.map(c => c.dataset.id);

  const srcIdx = ids.indexOf(_dragSrcId);
  const tgtIdx = ids.indexOf(targetId);
  if (srcIdx === -1 || tgtIdx === -1) { _dragSrcId = null; return; }

  // ë°°ì—´ ìˆœì„œ êµí™˜
  ids.splice(srcIdx, 1);
  ids.splice(tgtIdx, 0, _dragSrcId);

  // DBì— sort_order ì €ì¥
  await Promise.all(ids.map((id, idx) =>
    sb.from('products').update({ sort_order: idx + 1 }).eq('id', id)
  ));

  _dragSrcId = null;
  renderProductAdmin();
  playSound('click');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” QUESTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderQuestAdmin() {
  const [{ data: quests }, { data: qcrs }] = await Promise.all([
    sb.from('quests').select('*').order('sort_order'),
    sb.from('quest_completion_requests').select('*, users(display_name), quests(name,icon,reward)').eq('status','pending').order('created_at',{ascending:false}),
  ]);

  const el = document.getElementById('questAdminList');
  el.innerHTML = quests?.length
    ? quests.map(q => {
        const ct = q.completion_type;
        return `<div class="flex items-center gap-2 p-3 rounded-2xl ${q.active?'bg-gray-50':'bg-red-50 opacity-60'} border-2 border-transparent">
          <div class="text-xl flex-shrink-0">${q.icon}</div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <p class="font-black text-gray-800 text-sm">${q.name}</p>
              <span class="rep-badge ${repClass[q.repeat_type]}">${repLabel[q.repeat_type]}</span>
              <span class="${ct==='auto'?'ct-auto':'ct-approval'}">${ct==='auto'?'âš¡ ìë™':'ğŸ‘¤ ìŠ¹ì¸'}</span>
              ${!q.active?'<span class="rep-badge bg-red-100 text-red-600">ë¹„í™œì„±</span>':''}
            </div>
            <p class="text-xs text-gray-400">${q.description} Â· +${q.reward}ğŸŒ°</p>
          </div>
          <button class="btn btn-blue px-2 py-1 text-xs flex-shrink-0" onclick="editQuest('${q.id}')">ìˆ˜ì •</button>
          <label class="toggle-wrap flex-shrink-0"><input type="checkbox" ${q.active?'checked':''} onchange="toggleQuestActive('${q.id}')"><span class="toggle-slider"></span></label>
          <button class="btn btn-red px-2 py-1 text-xs flex-shrink-0" onclick="deleteQuest('${q.id}')">ì‚­ì œ</button>
        </div>`;
      }).join('')
    : '<p class="text-sm text-gray-400 text-center py-4">í€˜ìŠ¤íŠ¸ê°€ ì—†ì–´ìš”</p>';

  const apEl = document.getElementById('questApprovalList');
  apEl.innerHTML = qcrs?.length
    ? qcrs.map(r => `<div class="p-4 rounded-2xl bg-pink-50 border border-pink-100 flex flex-col gap-2">
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-xl">${r.quests?.icon||'ğŸ“‹'}</span>
              <p class="font-black text-gray-800 text-sm">${r.quests?.name||'í€˜ìŠ¤íŠ¸'}</p>
              <span class="ct-approval">ğŸ‘¤ ìŠ¹ì¸ í•„ìš”</span>
            </div>
            <p class="text-xs text-gray-400 mt-1">${r.users?.display_name||''} Â· ${fmtTs(r.created_at)}</p>
          </div>
          <span class="font-black text-amber-600 flex-shrink-0">+${r.quests?.reward||0}ğŸŒ°</span>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-green flex-1 py-2 text-sm" onclick="approveQuestReq('${r.id}')">âœ… ìŠ¹ì¸í•˜ê¸°</button>
          <button class="btn btn-red flex-1 py-2 text-sm" onclick="rejectQuestReq('${r.id}')">âŒ ê±°ì ˆ</button>
        </div>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-4">ëŒ€ê¸°ì¤‘ì¸ ìš”ì²­ì´ ì—†ì–´ìš”</p>';
}

function toggleQuestCount() {
  const type = document.getElementById('nq-countType')?.value;
  const wrap = document.getElementById('nq-countWrap');
  if (wrap) wrap.classList.toggle('hidden', type !== 'multi');
}

async function addQuest() {
  const name = document.getElementById('nq-name').value.trim();
  const desc = document.getElementById('nq-desc').value;
  const reward = parseInt(document.getElementById('nq-reward').value);
  const icon = document.getElementById('nq-icon').value || 'ğŸ“‹';
  const repeat = document.getElementById('nq-repeat').value;
  const ct = document.getElementById('nq-completionType').value;
  const countType = document.getElementById('nq-countType')?.value || 'once';
  const targetCount = countType === 'multi' ? (parseInt(document.getElementById('nq-targetCount')?.value) || 1) : 1;
  if (!name || !reward) { toast('âŒ', 'ì´ë¦„ê³¼ ë³´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const { count } = await sb.from('quests').select('*',{count:'exact',head:true});
  await sb.from('quests').insert({ name, target_count: targetCount, description:desc, icon, reward, repeat_type:repeat, completion_type:ct, sort_order:(count||0)+1 });
  ['nq-name','nq-desc','nq-reward','nq-icon'].forEach(id => document.getElementById(id).value='');
  renderQuestAdmin(); toast('âœ…', 'í€˜ìŠ¤íŠ¸ ì¶”ê°€ ì™„ë£Œ!');
}

async function deleteQuest(id) {
  if (!confirm('í€˜ìŠ¤íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  await sb.from('quests').delete().eq('id', id);
  renderQuestAdmin(); toast('ğŸ—‘ï¸', 'í€˜ìŠ¤íŠ¸ ì‚­ì œë¨');
}

async function toggleQuestActive(id) {
  const { data: q } = await sb.from('quests').select('active').eq('id', id).single();
  await sb.from('quests').update({ active: !q.active }).eq('id', id);
  renderQuestAdmin(); toast(q.active?'â¸ï¸':'âœ…', q.active?'ë¹„í™œì„±í™”ë¨':'í™œì„±í™”ë¨');
}

async function editQuest(id) {
  const { data: q } = await sb.from('quests').select('*').eq('id', id).single();
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-4">âœï¸ í€˜ìŠ¤íŠ¸ ìˆ˜ì •</h2>
    <div class="space-y-3">
      <input class="field" id="eq-name" value="${q.name}">
      <input class="field" id="eq-desc" value="${q.description}">
      <div class="grid grid-cols-2 gap-2">
        <input class="field" type="number" id="eq-reward" value="${q.reward}">
        <input class="field" id="eq-icon" value="${q.icon}">
      </div>
      <select class="field" id="eq-repeat">
        <option value="once" ${q.repeat_type==='once'?'selected':''}>1íšŒì„±</option>
        <option value="daily" ${q.repeat_type==='daily'?'selected':''}>ì¼ì¼</option>
        <option value="weekly" ${q.repeat_type==='weekly'?'selected':''}>ì£¼ê°„</option>
      </select>
      <select class="field" id="eq-ct">
        <option value="auto" ${q.completion_type==='auto'?'selected':''}>âš¡ ìë™ ì™„ë£Œ</option>
        <option value="approval" ${q.completion_type==='approval'?'selected':''}>ğŸ‘¤ ê´€ë¦¬ì ìŠ¹ì¸</option>
      </select>
      <div class="flex gap-3 pt-2">
        <button class="btn btn-gray flex-1 py-3" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-3" onclick="saveQuest('${id}')">ì €ì¥</button>
      </div>
    </div>`);
}

async function saveQuest(id) {
  await sb.from('quests').update({
    name: document.getElementById('eq-name').value,
    description: document.getElementById('eq-desc').value,
    reward: parseInt(document.getElementById('eq-reward').value)||0,
    icon: document.getElementById('eq-icon').value,
    repeat_type: document.getElementById('eq-repeat').value,
    completion_type: document.getElementById('eq-ct').value,
  }).eq('id', id);
  closeModal(); renderQuestAdmin(); toast('âœ…', 'í€˜ìŠ¤íŠ¸ ìˆ˜ì • ì™„ë£Œ!');
}

async function approveQuestReq(reqId) {
  playSound('approve');
  // ìŠ¹ì¸ ì „ ìš”ì²­ ì •ë³´ ì¡°íšŒ (user_id í™•ë³´)
  const { data: qcr } = await sb.from('quest_completion_requests')
    .select('user_id').eq('id', reqId).maybeSingle();

  const res = await sb.rpc('approve_quest_request', { p_request_id: reqId });
  if (!res.data?.success) { toast('âŒ', 'ì²˜ë¦¬ ì‹¤íŒ¨: ' + (res.data?.error||'')); return; }

  // ìŠ¹ì¸ëœ ìœ ì €ì˜ "í€˜ìŠ¤íŠ¸ NíšŒ ì™„ë£Œí•˜ê¸°" ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
  if (qcr?.user_id) await incrementQuestComplete(qcr.user_id);

  renderQuestAdmin(); toast('âœ…', 'í€˜ìŠ¤íŠ¸ ìŠ¹ì¸ ì™„ë£Œ!');
}

// íŠ¹ì • ìœ ì €ì˜ questComplete ì¹´ìš´íŠ¸ë¥¼ DBì—ì„œ ì§ì ‘ ì—…ë°ì´íŠ¸
async function incrementQuestComplete(userId) {
  try {
    const { data: quests } = await sb.from('quests')
      .select('*').eq('active', true).eq('completion_type', 'auto');
    if (!quests) return;
    for (const q of quests) {
      const isQC = (q.target_count||1) >= 2 &&
        (q.name.includes('í€˜ìŠ¤íŠ¸') || q.description.includes('í€˜ìŠ¤íŠ¸') || q.description.includes('ì™„ë£Œ'));
      if (!isQC) continue;
      const key = getPeriodKey(q.repeat_type);
      const { data: prog } = await sb.from('quest_progress')
        .select('id, progress_count')
        .eq('user_id', userId).eq('quest_id', q.id).eq('period_key', key)
        .maybeSingle();
      const current = (prog?.progress_count || 0) + 1;
      if (current < (q.target_count||1)) {
        if (prog) await sb.from('quest_progress').update({ progress_count: current }).eq('id', prog.id);
        else await sb.from('quest_progress').insert({ user_id: userId, quest_id: q.id, period_key: key, progress_count: current });
      } else if (!prog || (prog.progress_count||0) < (q.target_count||1)) {
        // ëª©í‘œ ë‹¬ì„± â†’ ë³´ìƒ ì§€ê¸‰
        if (prog) await sb.from('quest_progress').update({ progress_count: q.target_count }).eq('id', prog.id);
        else await sb.from('quest_progress').insert({ user_id: userId, quest_id: q.id, period_key: key, progress_count: q.target_count });
        await sb.rpc('adjust_acorns', { p_user_id: userId, p_amount: q.reward, p_reason: `í€˜ìŠ¤íŠ¸ ìë™ì™„ë£Œ â€” ${q.name}` });
        await pushNotif(userId, 'quest', 'í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ğŸ‰', `${q.icon} ${q.name} ì™„ë£Œ! +${q.reward}ğŸŒ°`);
      }
    }
  } catch(e) {}
}

async function rejectQuestReq(reqId) {
  const { data: r } = await sb.from('quest_completion_requests').select('*, quests(name,icon), users(display_name)').eq('id', reqId).single();
  await sb.from('quest_completion_requests').update({ status: 'rejected' }).eq('id', reqId);
  if (r) await pushNotif(r.user_id, 'quest_rejected', 'í€˜ìŠ¤íŠ¸ ê±°ì ˆ âŒ', `${r.quests?.icon||''} ${r.quests?.name||''} ì™„ë£Œ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆì–´ìš”.`);
  renderQuestAdmin(); toast('âŒ', 'ê±°ì ˆ ì™„ë£Œ');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” REQUESTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderRequestAdmin() {
  const { data: list } = await sb.from('product_requests')
    .select('*, users(display_name)')
    .order('created_at', { ascending: false })
    .limit(50);
  const el = document.getElementById('requestAdminList');
  let items = list || [];
  if (reqFilter !== 'all') items = items.filter(r => r.status === reqFilter);
  el.innerHTML = items.length
    ? items.map(r => `<div class="p-4 rounded-2xl bg-gray-50 flex flex-col gap-2">
        <div class="flex items-start justify-between gap-2">
          <div>
            <p class="font-black text-gray-800 text-sm">${r.product_snapshot?.icon||'ğŸ'} ${r.product_snapshot?.name||'ìƒí’ˆ'}</p>
            <p class="text-xs text-gray-400 mt-0.5">${r.users?.display_name||''} Â· ${fmtTs(r.created_at)}${r.price?` Â· ${r.price}ğŸŒ°`:''}${r.from_gacha?' Â· ğŸ²':''}</p>
          </div>
          <span class="badge ${stClass(r.status)} flex-shrink-0">${stLabel(r.status)}</span>
        </div>
        ${r.status==='pending'?`<div class="flex gap-2">
          <button class="btn btn-green flex-1 py-2 text-sm" onclick="updateReq('${r.id}','approved')">âœ… ìŠ¹ì¸</button>
          <button class="btn btn-red flex-1 py-2 text-sm" onclick="updateReq('${r.id}','rejected')">âŒ ê±°ì ˆ</button>
        </div>`:''}
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-6">ì‹ ì²­ ë‚´ì—­ ì—†ìŒ</p>';
}

async function updateReq(id, status) {
  playSound(status === 'approved' ? 'approve' : 'reject');
  const { data: r } = await sb.from('product_requests').select('*, users(display_name)').eq('id', id).single();
  await sb.from('product_requests').update({ status }).eq('id', id);
  if (r) await pushNotif(r.user_id, status==='approved'?'approved':'rejected',
    status==='approved'?'ì‹ ì²­ ìŠ¹ì¸! âœ…':'ì‹ ì²­ ê±°ì ˆ âŒ',
    status==='approved'?`${r.product_snapshot?.name||'ìƒí’ˆ'} ì‹ ì²­ì´ ìŠ¹ì¸ë˜ì—ˆì–´ìš”!`:`${r.product_snapshot?.name||'ìƒí’ˆ'} ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆì–´ìš”.`);
  renderRequestAdmin();
  updateReqBadge();
  toast(status==='approved'?'âœ…':'âŒ', status==='approved'?'ìŠ¹ì¸í–ˆì–´ìš”!':'ê±°ì ˆí–ˆì–´ìš”');
}

function filterReqs(f, btn) {
  reqFilter = f;
  document.querySelectorAll('#atab-requests .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active'); renderRequestAdmin();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” TX LOG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function populateLogFilter() {
  await populateGiveSelect();
}

async function renderTxLog() {
  const filter = document.getElementById('logUserFilter')?.value || 'all';
  let query = sb.from('transactions').select('*, users(display_name)').order('created_at', { ascending: false }).limit(100);
  if (filter !== 'all') query = query.eq('user_id', filter);
  const { data: list } = await query;
  const tbody = document.getElementById('txLogTable');
  tbody.innerHTML = list?.length
    ? list.map(t => `<tr class="hover:bg-gray-50">
        <td class="py-2.5 pr-2 font-bold text-gray-700 text-xs">${t.users?.display_name||''}</td>
        <td class="py-2.5 pr-2 font-black text-sm ${t.amount>0?'tx-plus':'tx-minus'}">${t.amount>0?'+':''}${t.amount}ğŸŒ°</td>
        <td class="py-2.5 pr-2 text-xs text-gray-500 font-semibold">${t.balance}ğŸŒ°</td>
        <td class="py-2.5 pr-2 text-xs text-gray-500">${t.reason}</td>
        <td class="py-2.5 text-xs text-gray-400 whitespace-nowrap">${fmtTs(t.created_at)}</td>
      </tr>`).join('')
    : '<tr><td colspan="5" class="text-center text-gray-400 py-8 text-sm">ë‚´ì—­ ì—†ìŒ</td></tr>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” USERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderUserAdmin() {
  const { data: users } = await sb.from('users').select('*').order('acorns', { ascending: false });
  const el = document.getElementById('userAdminList');
  el.innerHTML = users?.length
    ? users.map(u => `<div class="flex items-center gap-3 p-3 rounded-2xl bg-gray-50">
        <div class="text-2xl">${u.avatar_emoji||'ğŸ¿ï¸'}</div>
        <div class="flex-1 min-w-0">
          <p class="font-black text-gray-800 text-sm">${u.display_name}${u.is_admin?' ğŸ‘‘':''}</p>
          <p class="text-xs text-gray-400">ê°€ì…: ${fmtTs(u.created_at)}</p>
        </div>
        <div class="text-right">
          <div class="font-black text-amber-600">ğŸŒ° ${u.acorns}</div>
        </div>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-6">íšŒì›ì´ ì—†ì–´ìš”</p>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” DASHBOARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderDashboard() {
  const todayStart = getToday() + 'T00:00:00+09:00'; // KST ìì • ê¸°ì¤€
  const [{ data: users }, { data: todayTxs }, { data: recentTxs }] = await Promise.all([
    sb.from('users').select('id', { count: 'exact' }),
    sb.from('transactions').select('amount,reason').gte('created_at', todayStart),
    sb.from('transactions').select('*, users(display_name)').order('created_at', { ascending: false }).limit(10),
  ]);

  const todayGacha = (todayTxs||[]).filter(t => t.reason?.startsWith('ë½‘ê¸° ì‚¬ìš©'));
  const todayGachaCount = todayGacha.reduce((s,t) => s + Math.abs(t.amount)/GACHA_COST, 0);
  const todayGiven = (todayTxs||[]).filter(t => t.amount > 0 && !t.reason?.startsWith('ë½‘ê¸° ì‚¬ìš©')).reduce((s,t)=>s+t.amount,0);
  const todayUsed  = (todayTxs||[]).filter(t => t.amount < 0).reduce((s,t)=>s+Math.abs(t.amount),0);

  document.getElementById('ds-users').textContent      = users?.length || 0;
  document.getElementById('ds-todayGacha').textContent = todayGachaCount;
  document.getElementById('ds-todayGiven').textContent = '+' + todayGiven;
  document.getElementById('ds-todayUsed').textContent  = '-' + todayUsed;

  const logEl = document.getElementById('ds-activityLog');
  logEl.innerHTML = recentTxs?.length
    ? `<div class="overflow-x-auto"><table class="w-full" style="min-width:340px">
        <thead><tr class="border-b border-gray-100 text-left">
          <th class="pb-2 font-black text-gray-400 text-xs pr-2">ì‚¬ìš©ì</th>
          <th class="pb-2 font-black text-gray-400 text-xs pr-2">í™œë™</th>
          <th class="pb-2 font-black text-gray-400 text-xs pr-2">ë³€í™”</th>
          <th class="pb-2 font-black text-gray-400 text-xs">ì¼ì‹œ</th>
        </tr></thead>
        <tbody>${recentTxs.map(t=>`<tr class="border-b border-gray-50">
          <td class="py-2 pr-2 font-bold text-gray-700 text-xs whitespace-nowrap">${t.users?.display_name||''}</td>
          <td class="py-2 pr-2 text-gray-400 text-xs text-ellipsis">${t.reason}</td>
          <td class="py-2 pr-2 font-black text-sm ${t.amount>0?'tx-plus':'tx-minus'}">${t.amount>0?'+':''}${t.amount}ğŸŒ°</td>
          <td class="py-2 text-gray-400 text-xs whitespace-nowrap">${fmtTs(t.created_at)}</td>
        </tr>`).join('')}</tbody>
      </table></div>`
    : '<p class="text-sm text-gray-400 text-center py-4">í™œë™ ì—†ìŒ</p>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const stClass = s => ({ pending:'st-pending', approved:'st-approved', rejected:'st-rejected' })[s] || 'st-pending';
const stLabel = s => ({ pending:'â³ ëŒ€ê¸°ì¤‘', approved:'âœ… ìŠ¹ì¸', rejected:'âŒ ê±°ì ˆ' })[s] || s;

function fmtTs(iso) {
  if (!iso) return '';
  try {
    const now  = new Date();
    const date = new Date(iso);
    const diff = Math.floor((now - date) / 1000); // ì´ˆ ë‹¨ìœ„
    if (diff < 60)   return 'ë°©ê¸ˆ ì „';
    if (diff < 3600) return `${Math.floor(diff/60)}ë¶„ ì „`;
    if (diff < 86400) return `${Math.floor(diff/3600)}ì‹œê°„ ì „`;
    if (diff < 604800) return `${Math.floor(diff/86400)}ì¼ ì „`;
    return date.toLocaleString('ko-KR', { timeZone:'Asia/Seoul', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  } catch { return iso.slice(0,16).replace('T',' '); }
}

let _modalScrollY = 0;
function showModal(html) {
  document.getElementById('modalContent').innerHTML = html;
  // iOS Safari: body fixed ê³ ì • ì „ ìŠ¤í¬ë¡¤ë°” ë„ˆë¹„ ë³´ì • (ë ˆì´ì•„ì›ƒ ë°€ë¦¼ ë°©ì§€)
  const scrollbarW = window.innerWidth - document.documentElement.clientWidth;
  document.body.style.paddingRight = scrollbarW ? scrollbarW + 'px' : '';
  _modalScrollY = window.scrollY;
  document.body.style.position = 'fixed';
  document.body.style.top = `-${_modalScrollY}px`;
  document.body.style.width = '100%';
  document.getElementById('modal').classList.remove('hidden');
}
function closeModal() {
  document.getElementById('modal').classList.add('hidden');
  document.body.style.position = '';
  document.body.style.top = '';
  document.body.style.width = '';
  document.body.style.paddingRight = '';
  window.scrollTo(0, _modalScrollY);
}

let _toastT;
function toast(icon, msg) {
  clearTimeout(_toastT);
  document.getElementById('toastIcon').textContent = icon;
  document.getElementById('toastMsg').textContent  = msg;
  const el = document.getElementById('toast');
  const inner = document.getElementById('toastInner');
  el.classList.remove('hidden');
  if (inner) { inner.style.animation='none'; void inner.offsetWidth; inner.style.animation='toastIn .25s cubic-bezier(.34,1.56,.64,1) both'; }
  _toastT = setTimeout(()=>{ el.classList.add('hidden'); el.style.animation=''; }, 3000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PWA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _deferredInstall = null;
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault(); _deferredInstall = e;
  document.getElementById('installBanner').classList.remove('hidden');
});
window.addEventListener('appinstalled', () => {
  document.getElementById('installBanner').classList.add('hidden'); _deferredInstall = null;
});
function installPWA() {
  if (!_deferredInstall) return;
  _deferredInstall.prompt();
  _deferredInstall.userChoice.then(r => {
    if (r.outcome === 'accepted') document.getElementById('installBanner').classList.add('hidden');
    _deferredInstall = null;
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  START
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
boot();
</script>
</body>
</html>
