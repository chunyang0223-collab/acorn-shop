<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#ff8fab">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="도토리 상점">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="icons/icon-192x192.png">
<title>🌰 도토리 상점</title>
<!-- 외부 CSS 분리 -->
<link href="https://fonts.googleapis.com/css2?family=Jua&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- ── 로딩 ── -->
<div id="loadingScreen" class="loading-screen hidden">
  <div class="text-6xl">🌰</div>
  <div class="spinner"></div>
  <p class="text-sm font-bold text-amber-600">로딩 중...</p>
</div>

<!-- ── 로그인 ── -->
<div id="loginScreen" class="login-screen">
  <div class="login-card bounce-in">
    <div class="text-center mb-8">
      <div class="text-6xl mb-3">🌰</div>
      <h1 class="text-3xl font-black text-amber-900">도토리 상점</h1>
      <p class="text-sm text-amber-600 font-semibold mt-1">Acorn Shop ✨</p>
    </div>

    <!-- 이메일 로그인 -->
    <div class="space-y-3 mb-4">
      <input class="field" type="email" id="loginEmail" placeholder="이메일" onkeydown="if(event.key==='Enter')doEmailLogin()">
      <input class="field" type="password" id="loginPw" placeholder="비밀번호" onkeydown="if(event.key==='Enter')doEmailLogin()">
      <div id="loginErr" class="hidden text-xs text-red-500 font-bold text-center pt-1"></div>
    </div>
    <button class="btn btn-primary w-full py-4 text-base mb-3" onclick="doEmailLogin()">이메일로 로그인</button>

    <!-- 구분선 -->
    <div class="flex items-center gap-3 mb-3">
      <div class="flex-1 h-px bg-gray-200"></div>
      <span class="text-xs text-gray-400 font-semibold">또는</span>
      <div class="flex-1 h-px bg-gray-200"></div>
    </div>

    <!-- 카카오 로그인 -->
    <button class="btn btn-kakao w-full py-4 text-base mb-4" onclick="doKakaoLogin()">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none" style="flex-shrink:0">
        <path d="M9 1.5C4.86 1.5 1.5 4.14 1.5 7.38c0 2.1 1.35 3.93 3.39 4.98L4.05 15l3.57-2.43c.45.06.9.09 1.38.09 4.14 0 7.5-2.64 7.5-5.88C16.5 4.14 13.14 1.5 9 1.5z" fill="#191919"/>
      </svg>
      카카오로 로그인
    </button>

    <!-- 회원가입 -->
    <div class="text-center">
      <button class="text-xs text-amber-600 font-bold underline" onclick="showSignup()">계정이 없으신가요? 회원가입</button>
    </div>
  </div>
</div>

<!-- ── 앱 루트 ── -->
<div id="appRoot" class="hidden min-h-screen p-4" style="position:relative;z-index:0">
<div class="max-w-2xl mx-auto">

  <!-- 헤더 -->
  <div class="mb-5">
    <!-- 로그아웃: 최상단 우측 -->
    <div class="flex justify-end mb-1">
      <button class="btn-logout-sm hidden" id="logoutBtn" onclick="doLogout()">로그아웃</button>
    </div>
    <!-- 메인 헤더 -->
    <div class="flex items-center justify-between">
      <!-- 좌측: 도토리 이모지(테마토글) + 타이틀 -->
      <div class="flex items-center gap-4">
        <div id="headerAcornEmoji" onclick="toggleTheme()" title="테마 전환"
          style="font-size:3.2rem;line-height:1;cursor:pointer;transition:filter .3s,transform .2s;filter:drop-shadow(0 2px 8px rgba(180,100,0,0.25));user-select:none"
          onmouseover="this.style.transform='scale(1.08)'" onmouseout="this.style.transform='scale(1)'">🌰</div>
        <div>
          <h1 class="font-black text-amber-900" style="font-size:1.35rem;line-height:1.2">도토리 상점</h1>
          <p class="text-xs text-amber-500 font-bold mt-0.5" id="headerUserLabel">Acorn Shop ✨</p>
        </div>
      </div>
      <!-- 우측: 도토리 + 티켓 + 종 -->
      <div class="flex items-center gap-3" id="headerRight" style="display:none!important">
        <div class="header-stats">
          <span class="header-stat-ticket" id="headerTickets">🎫 0</span>
          <span class="header-stat-acorn" id="headerAcorns">🌰 0</span>
        </div>
        <button class="header-icon-btn" onclick="showNotifications()" id="notifBtn">
          <span class="header-icon-emoji">🔔</span>
          <span class="notif-dot hidden" id="notifDot"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- ── 사용자 모드 ── -->
  <div id="userMode" class="hidden">
    <div class="tab-bar-wrap"><div id="userTabBar" class="flex gap-1 mb-5 clay-card p-2" style="overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;cursor:grab">
      <button class="tab-btn active" onclick="uTab('shop',this)" style="flex-shrink:0">🛍️ 상점</button>
      <button class="tab-btn" onclick="uTab('gacha',this)" style="flex-shrink:0">🎲 뽑기</button>
      <button class="tab-btn" onclick="uTab('quest',this)" style="flex-shrink:0">📋 퀘스트</button>
      <button class="tab-btn" onclick="uTab('recycle',this)" style="flex-shrink:0">♻️ 재활용</button>
      <button class="tab-btn" onclick="uTab('mypage',this)" style="flex-shrink:0">👤 마이</button>
    </div></div>
    <div id="utab-shop">
      <p class="text-sm font-bold text-amber-700 mb-3 px-1">🛒 구매 가능한 상품</p>
      <div id="shopGrid" class="grid grid-cols-2 gap-3"></div>
    </div>
    <div id="utab-gacha" class="hidden">
      <div class="clay-card p-6 text-center mb-4">
        <div class="text-6xl mb-3" id="gachaIcon">🎁</div>
        <h2 class="text-xl font-black text-gray-800 mb-1">도토리 뽑기</h2>
        <p class="text-sm text-gray-400 font-semibold mb-4">1회 = <span class="text-amber-600 font-black">🌰 10</span> &nbsp;|&nbsp; 5회 = <span class="text-amber-600 font-black">🌰 50</span></p>
        <div id="freeGachaNotice" class="hidden text-xs font-bold rounded-2xl px-3 py-2 mb-3" style="background:rgba(220,252,231,0.8);color:#166534;border:1.5px solid rgba(34,197,94,0.3)"></div>
        <div class="flex justify-center gap-3">
          <button class="btn btn-primary px-8 py-3 text-base" id="btn-gacha1" onclick="doGacha(1)">1회 뽑기</button>
          <button class="btn btn-purple px-8 py-3 text-base" id="btn-gacha5" onclick="doGacha(5)">5회 뽑기</button>
        </div>
      </div>
      <!-- 뽑기 연출 스피너 -->
      <div id="gachaSpinner" class="hidden">
        <div class="text-6xl" id="gachaSpinIcon">🎁</div>
        <p id="gachaSpinMsg" class="text-sm font-black text-amber-600">두근두근...</p>
      </div>

      <div id="gachaResult" class="hidden clay-card p-6 text-center mb-4">
        <p class="text-sm font-bold text-gray-400 mb-4">🎉 결과!</p>
        <div id="gachaResultItems" class="flex flex-wrap justify-center gap-4"></div>
      </div>
      <div class="clay-card p-4 mb-4">
        <p class="text-sm font-black text-gray-700 mb-3">📊 뽑기 상품 & 확률</p>
        <div id="gachaProbTable" class="space-y-1">
          <p class="text-xs text-gray-400 text-center py-2">로딩 중...</p>
        </div>
      </div>
    </div>
    <div id="utab-quest" class="hidden">
      <p class="text-sm font-bold text-amber-700 mb-3 px-1">📋 퀘스트</p>
      <div id="questList" class="space-y-3"></div>
    </div>
    <!-- ♻️ 재활용센터 탭 -->
    <div id="utab-recycle" class="hidden">
      <!-- 배경 헤더 -->
      <div class="recycle-hero clay-card mb-4 p-6 text-center relative overflow-hidden">
        <div class="recycle-bg-deco" aria-hidden="true">
          <span>🌿</span><span>🍃</span><span>🌱</span><span>♻️</span>
          <span>🌿</span><span>🍃</span><span>🌱</span><span>♻️</span>
        </div>
        <div class="relative z-10">
          <div style="font-size:3.5rem;line-height:1;margin-bottom:8px;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.12))">♻️</div>
          <h2 class="text-xl font-black text-green-800 mb-1">재활용 센터</h2>
          <p class="text-sm text-green-600 font-bold">필요없는 아이템을 팔고 도토리를 받아요!</p>
        </div>
      </div>

      <!-- 매입 중인 아이템 목록 -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">💰 오늘의 매입 목록</p>
          <span class="text-xs text-gray-400">아이템 카드를 눌러 판매</span>
        </div>
        <div id="recycleShopList" class="space-y-2"></div>
      </div>

      <!-- 내 판매 가능 아이템 -->
      <div class="clay-card p-5 mb-28">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">🎒 내 판매 가능 아이템</p>
          <span class="text-xs font-bold text-green-600" id="recycleSelCount"></span>
        </div>
        <div id="recycleInventoryList" class="grid grid-cols-3 gap-2"></div>
        <p id="recycleEmptyMsg" class="text-sm text-gray-400 text-center py-6 hidden">판매 가능한 아이템이 없어요</p>
      </div>

      <!-- 하단 고정 판매 버튼 -->
      <div id="recycleSellBar" class="recycle-sell-bar hidden">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-black text-white" id="recycleSellLabel">선택한 아이템 판매</p>
            <p class="text-xs text-green-100" id="recycleSellSub"></p>
          </div>
          <button class="recycle-sell-btn" onclick="confirmRecycleSell()">💰 판매하기</button>
        </div>
      </div>
    </div>

    <div id="utab-mypage" class="hidden">
      <div class="clay-card p-6 mb-4" id="mypageHeader"></div>

      <!-- 인벤토리 -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">🎒 인벤토리</p>
          <span class="text-xs text-gray-400 font-semibold">사용 | 판매는 ♻️ 재활용 탭에서</span>
        </div>
        <div id="myInventory" class="grid grid-cols-3 gap-2"></div>
      </div>

      <!-- 상품 신청 현황 -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">📦 상품 신청 현황</p>
          <div class="flex items-center gap-2">
            <button id="reqPrevBtn" class="page-nav-btn" onclick="moveReqPage(-1)">‹</button>
            <span id="reqPageLabel" class="text-xs font-bold text-gray-400"></span>
            <button id="reqNextBtn" class="page-nav-btn" onclick="moveReqPage(1)">›</button>
          </div>
        </div>
        <div id="myRequestList" class="space-y-2"></div>
      </div>

      <!-- 퀘스트 신청 현황 -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">📋 퀘스트 신청 현황</p>
          <div class="flex items-center gap-2">
            <button id="qcrPrevBtn" class="page-nav-btn" onclick="moveQcrPage(-1)">‹</button>
            <span id="qcrPageLabel" class="text-xs font-bold text-gray-400"></span>
            <button id="qcrNextBtn" class="page-nav-btn" onclick="moveQcrPage(1)">›</button>
          </div>
        </div>
        <div id="myQuestReqList" class="space-y-2"></div>
      </div>

      <!-- 뽑기 기록 -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">🎲 뽑기 기록</p>
          <div class="flex items-center gap-2">
            <button id="glogPrevBtn" class="page-nav-btn" onclick="moveGlogPage(-1)">‹</button>
            <span id="glogPageLabel" class="text-xs font-bold text-gray-400"></span>
            <button id="glogNextBtn" class="page-nav-btn" onclick="moveGlogPage(1)">›</button>
          </div>
        </div>
        <div id="myGachaLogList" class="space-y-2"></div>
      </div>

      <!-- 도토리 내역 -->
      <div class="clay-card p-5">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">📜 도토리 내역</p>
          <div class="flex items-center gap-2">
            <button id="txPrevBtn" class="page-nav-btn" onclick="moveTxPage(-1)">‹</button>
            <span id="txPageLabel" class="text-xs font-bold text-gray-400"></span>
            <button id="txNextBtn" class="page-nav-btn" onclick="moveTxPage(1)">›</button>
          </div>
        </div>
        <div id="myTxList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- ── 관리자 모드 ── -->
  <div id="adminMode" class="hidden">
    <div class="tab-bar-wrap"><div id="adminTabBar" class="flex gap-1 mb-5 clay-card p-2">
      <button class="tab-btn active" onclick="aTab('dashboard',this)">📊 대시보드</button>
      <button class="tab-btn" onclick="aTab('requests',this)">📬 신청목록<span class="req-badge hidden" id="reqBadge"></span></button>
      <button class="tab-btn" onclick="aTab('products',this)">🛍️ 상품</button>
      <button class="tab-btn" onclick="aTab('gachaTest',this)">🎲 뽑기</button>
      <button class="tab-btn" onclick="aTab('quests',this)">📋 퀘스트</button>
      <button class="tab-btn" onclick="aTab('recycle',this)">♻️ 재활용센터</button>
      <button class="tab-btn" onclick="aTab('events',this)">🎉 이벤트</button>
      <button class="tab-btn" onclick="aTab('give',this)">🌰 지급</button>
      <button class="tab-btn" onclick="aTab('txlog',this)">🗂️ 로그</button>
      <button class="tab-btn" onclick="aTab('users',this)">👥 회원</button>
    </div></div>

    <!-- 대시보드 -->
    <div id="atab-dashboard">
      <!-- 상단: 현황(좌) + 메뉴 점검(우) -->
      <div id="dashboard-top" class="flex gap-3 mb-5 items-stretch">
        <!-- 좌: 오늘 현황 4개 소형 -->
        <div class="dashboard-stats flex flex-col gap-2" style="flex:0 0 auto;min-width:130px">
          <p class="text-xs font-black text-amber-600 uppercase tracking-wider px-1">오늘 현황</p>
          <div class="clay-card p-3 flex items-center gap-2 bounce-in">
            <span class="text-lg">👥</span>
            <div><div class="text-base font-black text-orange-700 leading-none" id="ds-users">—</div><div class="text-xs text-orange-400 font-bold">전체 사용자</div></div>
          </div>
          <div class="clay-card p-3 flex items-center gap-2 bounce-in" style="animation-delay:.05s">
            <span class="text-lg">🎲</span>
            <div><div class="text-base font-black text-blue-700 leading-none" id="ds-todayGacha">—</div><div class="text-xs text-blue-400 font-bold">오늘 뽑기</div></div>
          </div>
          <div class="clay-card p-3 flex items-center gap-2 bounce-in" style="animation-delay:.1s">
            <span class="text-lg">⬆️</span>
            <div><div class="text-base font-black text-green-700 leading-none" id="ds-todayGiven">—</div><div class="text-xs text-green-400 font-bold">오늘 지급</div></div>
          </div>
          <div class="clay-card p-3 flex items-center gap-2 bounce-in" style="animation-delay:.15s">
            <span class="text-lg">⬇️</span>
            <div><div class="text-base font-black text-purple-700 leading-none" id="ds-todayUsed">—</div><div class="text-xs text-purple-400 font-bold">오늘 사용</div></div>
          </div>
        </div>

        <!-- 우: 메뉴 점검 토글 -->
        <div class="clay-card p-4 flex-1 flex flex-col">
          <p class="text-xs font-black text-amber-600 uppercase tracking-wider mb-3 px-1">메뉴 점검 관리</p>
          <div class="flex flex-col gap-2 flex-1 justify-around">
            <div class="flex items-center justify-between">
              <span class="text-sm font-black text-gray-700">🛍️ 상점</span>
              <button id="maint-shop" onclick="toggleMaintenance('shop')" class="maint-btn"></button>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-black text-gray-700">🎲 뽑기</span>
              <button id="maint-gacha" onclick="toggleMaintenance('gacha')" class="maint-btn"></button>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-black text-gray-700">📋 퀘스트</span>
              <button id="maint-quest" onclick="toggleMaintenance('quest')" class="maint-btn"></button>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-black text-gray-700">♻️ 재활용</span>
              <button id="maint-recycle" onclick="toggleMaintenance('recycle')" class="maint-btn"></button>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-black text-gray-700">👤 마이</span>
              <button id="maint-mypage" onclick="toggleMaintenance('mypage')" class="maint-btn"></button>
            </div>
          </div>
        </div>
      </div>

      <p class="text-xs font-black text-amber-600 uppercase tracking-wider mb-3 px-1">최근 활동</p>
      <div class="clay-card p-4"><div id="ds-activityLog"></div></div>
    </div>

    <!-- 지급 -->
    <div id="atab-give" class="hidden">
      <div class="clay-card p-6">
        <h2 class="text-lg font-black text-gray-800 mb-5">🌰 도토리 지급</h2>
        <div class="space-y-4">
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">사용자 선택</label><select class="field" id="giveUser"></select></div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">지급량</label><input class="field" type="number" id="giveAmount" placeholder="지급(+) / 차감(-)"></div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">메모</label><input class="field" type="text" id="giveMemo" placeholder="지급 사유"></div>
          <button class="btn btn-primary w-full py-3 text-base" onclick="giveAcorns()">🌰 지급하기</button>
        </div>
      </div>
      <div class="clay-card p-5 mt-4"><p class="text-sm font-black text-gray-700 mb-3">📜 최근 지급 내역</p><div id="giveHistory" class="space-y-2"></div></div>
    </div>

    <!-- 뽑기 테스트 -->
    <div id="atab-gachaTest" class="hidden">
      <!-- 관리자 무료 뽑기 (사용자 탭과 동일한 UX, 도토리 차감 없음) -->
      <div class="clay-card p-6 text-center mb-4">
        <div class="text-xs font-bold text-amber-700 bg-amber-50 rounded-2xl p-3 mb-4">👑 관리자 무료 뽑기 — 도토리 차감 없음</div>
        <div class="text-6xl mb-3" id="adminGachaIcon">🎁</div>
        <h2 class="text-xl font-black text-gray-800 mb-1">도토리 뽑기</h2>
        <p class="text-sm text-gray-400 font-semibold mb-4">결과만 확인 · 인벤토리 저장 안 됨</p>
        <div class="flex justify-center gap-3">
          <button class="btn btn-primary px-8 py-3 text-base" onclick="doAdminGacha(1)">1회 뽑기</button>
          <button class="btn btn-purple px-8 py-3 text-base" onclick="doAdminGacha(5)">5회 뽑기</button>
        </div>
      </div>
      <div id="adminGachaSpinner" style="display:none;flex-direction:column;align-items:center;gap:12px;padding:24px 0">
        <div class="text-6xl" id="adminGachaSpinIcon">🎁</div>
        <p id="adminGachaSpinMsg" class="text-sm font-black text-amber-600">두근두근...</p>
      </div>
      <div id="adminGachaResult" class="hidden clay-card p-6 text-center mb-4">
        <p class="text-sm font-bold text-gray-400 mb-4">🎉 결과!</p>
        <div id="adminGachaResultItems" class="flex flex-wrap justify-center gap-4"></div>
      </div>
      <div class="clay-card p-4 mb-4">
        <p class="text-sm font-black text-gray-700 mb-3">📊 뽑기 상품 & 확률</p>
        <div id="adminGachaProbTable" class="space-y-1">
          <p class="text-xs text-gray-400 text-center py-2">로딩 중...</p>
        </div>
      </div>

      <!-- 확률 시뮬레이터 -->
      <div class="clay-card p-5 mb-4">
        <p class="text-sm font-black text-gray-700 mb-3">🧪 확률 시뮬레이터</p>
        <p class="text-xs text-gray-400 mb-3">실제 뽑기 로직으로 대량 시뮬레이션 — 설계 확률과 실제 결과를 비교합니다.</p>
        <div class="flex gap-2 mb-3">
          <div class="flex-1">
            <label class="text-xs font-bold text-gray-500 mb-1 block">뽑기 횟수</label>
            <select class="field text-sm" id="simCount">
              <option value="1">1회씩</option>
              <option value="5" selected>5회씩</option>
              <option value="10">10회씩</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="text-xs font-bold text-gray-500 mb-1 block">반복 횟수</label>
            <select class="field text-sm" id="simRounds">
              <option value="100">100번</option>
              <option value="500">500번</option>
              <option value="1000" selected>1,000번</option>
              <option value="5000">5,000번</option>
              <option value="10000">10,000번</option>
            </select>
          </div>
        </div>
        <button class="btn btn-purple w-full py-3 font-black mb-4" onclick="runGachaSimulator()">▶ 시뮬레이션 실행</button>
        <div id="simResult" class="hidden"></div>
      </div>
    </div>

    <!-- 상품 -->
    <div id="atab-products" class="hidden">

      <!-- 등록 폼: 2열 (상점 / 뽑기) -->
      <div class="grid grid-cols-2 gap-3 mb-4" style="align-items:start">

        <!-- 상점 상품 등록 -->
        <div class="clay-card p-4">
          <h3 class="font-black text-gray-800 mb-3 flex items-center gap-1">🛍️ <span>상점 상품</span></h3>
          <div class="space-y-2">
            <input class="field" type="text" id="ns-name" placeholder="상품명">
            <div class="grid grid-cols-2 gap-2">
              <input class="field" type="text" id="ns-icon" placeholder="이모지 🎁">
              <input class="field" type="number" id="ns-price" placeholder="가격(🌰)">
            </div>
            <input class="field" type="text" id="ns-desc" placeholder="설명">
            <select class="field" id="ns-rewardType" onchange="toggleAcornField('ns')">
              <option value="MANUAL_ITEM">📬 승인 필요</option>
              <option value="AUTO_ACORN">⚡ 즉시 지급</option>
            </select>
            <div id="ns-acornWrap" class="hidden">
              <input class="field" type="number" id="ns-acornAmt" placeholder="지급 도토리량">
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 mb-1 block">판매 수량</label>
              <div class="flex gap-2 items-center">
                <select class="field" id="ns-stockType" onchange="toggleStockField()" style="flex:1">
                  <option value="unlimited">♾️ 무제한 (상시판매)</option>
                  <option value="limited">🔢 수량 제한</option>
                </select>
                <input class="field hidden" type="number" id="ns-stock" placeholder="개수" min="1" style="width:80px;flex-shrink:0">
              </div>
            </div>
            <button class="btn btn-primary w-full py-2 text-sm" onclick="addStoreProduct()">➕ 추가</button>
          </div>
        </div>

        <!-- 뽑기 상품 등록 -->
        <div class="clay-card p-4">
          <h3 class="font-black text-gray-800 mb-3 flex items-center gap-1">🎲 <span>뽑기 상품</span></h3>
          <div class="space-y-2">
            <input class="field" type="text" id="ng-name" placeholder="아이템명">
            <div class="grid grid-cols-2 gap-2">
              <input class="field" type="text" id="ng-icon" placeholder="이모지 ✨">
              <input class="field" type="number" id="ng-probability" placeholder="확률 %" step="0.1" min="0">
            </div>
            <input class="field" type="text" id="ng-desc" placeholder="설명">
            <select class="field" id="ng-rewardType" onchange="toggleAcornField('ng');toggleCouponField('ng')">
              <option value="MANUAL_ITEM">📬 아이템 (승인 필요)</option>
              <option value="AUTO_ACORN">⚡ 즉시 도토리 지급</option>
              <option value="COUPON">🎟️ 할인쿠폰</option>
              <option value="ACORN_TICKET">🌰 도토리 티켓 (사용 시 즉시 지급)</option>
              <option value="GACHA_TICKET">🎫 뽑기 티켓 (1회 무료 뽑기)</option>
            </select>
            <div id="ng-acornWrap" class="hidden">
              <input class="field" type="number" id="ng-acornAmt" placeholder="지급 도토리량">
            </div>
            <div id="ng-couponWrap" class="hidden">
              <input class="field" type="number" id="ng-discountPct" placeholder="할인율 % (예: 20)" min="1" max="100">
              <p class="text-xs text-gray-400 mt-1">※ 상점 구매 시 1회 사용 가능</p>
            </div>
            <div id="ng-resellWrap">
              <input class="field" type="number" id="ng-resellPrice" placeholder="되팔기 가격 🌰 (0=불가)" min="0">
            </div>
            <p class="text-xs text-gray-400">※ 확률 합≠100이어도 자동 정규화</p>
            <button class="btn btn-purple w-full py-2 text-sm" onclick="addGachaProduct()">➕ 추가</button>
          </div>
        </div>

      </div>

      <!-- 목록: 2열 (상점 / 뽑기) -->
      <div class="grid grid-cols-2 gap-3" style="align-items:start">
        <div class="clay-card p-4">
          <p class="text-sm font-black text-gray-700 mb-3">🛍️ 상점 상품</p>
          <div id="storeProductList" class="space-y-2"></div>
        </div>
        <div class="clay-card p-4">
          <p class="text-sm font-black text-gray-700 mb-3">🎲 뽑기 상품</p>
          <div id="gachaProductList" class="space-y-2"></div>
        </div>
      </div>

    </div>

    <!-- 퀘스트 -->
    <div id="atab-quests" class="hidden">
      <div class="clay-card p-5 mb-4">
        <h2 class="text-lg font-black text-gray-800 mb-4">➕ 퀘스트 등록</h2>
        <div class="space-y-3">
          <input class="field" type="text" id="nq-name" placeholder="퀘스트 이름">
          <input class="field" type="text" id="nq-desc" placeholder="퀘스트 설명">
          <div class="grid grid-cols-2 gap-3">
            <input class="field" type="number" id="nq-reward" placeholder="보상 도토리">
            <input class="field" type="text" id="nq-icon" placeholder="이모지">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-bold text-gray-500 mb-1 block">목표 횟수 (자동완료 전용)</label>
              <select class="field" id="nq-countType" onchange="toggleQuestCount()">
                <option value="once">1회 — 트리거되면 바로 완료</option>
                <option value="multi">횟수 지정 — N회 누적 후 완료</option>
              </select>
            </div>
            <div id="nq-countWrap" class="hidden">
              <label class="text-xs font-bold text-gray-500 mb-1 block">목표 횟수</label>
              <input class="field" type="number" id="nq-targetCount" placeholder="예: 3" min="2">
            </div>
          </div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">반복 유형</label>
            <select class="field" id="nq-repeat">
              <option value="once">1회성</option>
              <option value="daily">일일 — 매일 초기화</option>
              <option value="weekly">주간 — 매주 월요일</option>
            </select>
          </div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">완료 방식</label>
            <select class="field" id="nq-completionType">
              <option value="auto">⚡ 자동 완료</option>
              <option value="approval">👤 관리자 승인</option>
            </select>
          </div>
          <button class="btn btn-primary w-full py-3" onclick="addQuest()">📋 퀘스트 추가</button>
        </div>
      </div>
      <div class="clay-card p-5 mb-4" id="questApprovalCard"><p class="text-sm font-black text-gray-700 mb-3" id="questApprovalTitle">✋ 완료 승인 요청</p><div id="questApprovalList" class="space-y-3"></div></div>
      <div class="clay-card p-5 mb-4"><p class="text-sm font-black text-gray-700 mb-3">📋 퀘스트 목록</p><div id="questAdminList" class="space-y-3"></div></div>
    </div>

    <!-- 신청 -->
    <div id="atab-requests" class="hidden">
      <div class="clay-card p-5">
        <h2 class="text-lg font-black text-gray-800 mb-4">📬 상품 신청 목록</h2>
        <div class="flex gap-2 mb-4 flex-wrap">
          <button class="tab-btn active text-xs px-3 py-2" onclick="filterReqs('all',this)">전체</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('pending',this)">대기중</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('approved',this)">승인</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('rejected',this)">거절</button>
        </div>
        <div id="requestAdminList" class="space-y-3"></div>
      </div>
    </div>

    <!-- TX 로그 -->
    <div id="atab-txlog" class="hidden">
      <!-- 사용자 선택 -->
      <div class="clay-card p-4 mb-3" id="logUserSelectCard">
        <p class="font-black text-gray-700 mb-3" style="font-family:'Jua',sans-serif">👤 사용자 선택</p>
        <div id="logUserBtnList" class="flex flex-wrap gap-2"></div>
      </div>
      <!-- 선택된 사용자 현황판 -->
      <div id="userStatusList" class="space-y-3"></div>
    </div>

    <!-- 회원 목록 -->
    <div id="atab-users" class="hidden">
      <div class="clay-card p-5"><h2 class="text-lg font-black text-gray-800 mb-4">👥 전체 회원</h2><div id="userAdminList" class="space-y-3"></div></div>
    </div>

    <!-- 이벤트 할인 -->
    <div id="atab-events" class="hidden">

      <!-- 활성 이벤트 상단 배너 -->
      <div id="activeEventsBanner" class="mb-4"></div>

      <div class="clay-card p-5 mb-4">
        <h2 class="text-lg font-black text-gray-800 mb-3">🎉 이벤트 할인 관리</h2>

        <!-- 탭 전환 -->
        <div class="flex gap-1 mb-4 p-1 rounded-2xl" style="background:rgba(240,235,255,0.5)">
          <button id="evtTabOnce" class="tab-btn active flex-1 text-xs py-2" onclick="switchEvtTab('once',this)">⏱️ 기간 이벤트</button>
          <button id="evtTabRepeat" class="tab-btn flex-1 text-xs py-2" onclick="switchEvtTab('repeat',this)">🔄 요일 반복</button>
          <button id="evtTabSchedules" class="tab-btn flex-1 text-xs py-2" onclick="switchEvtTab('schedules',this)">📋 목록</button>
        </div>

        <!-- ── 기간 이벤트 패널 ── -->
        <div id="evtPane-once">
          <!-- 상점 -->
          <div class="mb-4 p-4 rounded-2xl" style="background:rgba(254,215,170,0.3);border:1.5px solid rgba(251,146,60,0.25)">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2"><span class="text-xl">🛍️</span><p class="font-black text-gray-800 text-sm">상점 할인</p></div>
              <div id="storeEventStatus" class="text-xs font-bold px-3 py-1 rounded-full" style="background:#fee2e2;color:#b91c1c">비활성</div>
            </div>
            <div class="space-y-2">
              <div class="flex gap-2 items-center">
                <input class="field" type="number" id="storeDiscountPct" placeholder="할인율 %" min="1" max="100" style="width:90px;flex-shrink:0">
                <span class="text-sm font-bold text-gray-500">% 할인</span>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <select class="field text-xs" id="storeEventPreset" onchange="applyEventPreset('store')">
                  <option value="">⚡ 빠른 기간 설정</option>
                  <option value="1h">지금부터 1시간</option>
                  <option value="2h">지금부터 2시간</option>
                  <option value="4h">지금부터 4시간</option>
                  <option value="8h">지금부터 8시간</option>
                  <option value="24h">지금부터 24시간</option>
                </select>
                <button class="btn btn-gray text-xs py-1" onclick="clearEventDates('store')">날짜 초기화</button>
              </div>
              <input class="field text-xs" type="datetime-local" id="storeEventStart">
              <input class="field text-xs" type="datetime-local" id="storeEventEnd">
              <p class="text-xs text-gray-400">※ 시작 비워두면 즉시 · 종료 비워두면 수동 종료</p>
              <div class="flex gap-2">
                <button class="btn btn-green flex-1 py-2 text-sm" onclick="activateEvent('store')">✅ 활성화</button>
                <button class="btn btn-gray flex-1 py-2 text-sm" onclick="deactivateEvent('store')">⏹ 비활성화</button>
              </div>
            </div>
          </div>
          <!-- 뽑기 -->
          <div class="p-4 rounded-2xl" style="background:rgba(196,181,253,0.25);border:1.5px solid rgba(139,92,246,0.2)">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2"><span class="text-xl">🎲</span><p class="font-black text-gray-800 text-sm">뽑기 할인</p></div>
              <div id="gachaEventStatus" class="text-xs font-bold px-3 py-1 rounded-full" style="background:#fee2e2;color:#b91c1c">비활성</div>
            </div>
            <div class="space-y-2">
              <div class="flex gap-2 items-center">
                <input class="field" type="number" id="gachaDiscountPct" placeholder="할인율 %" min="1" max="100" style="width:90px;flex-shrink:0">
                <span class="text-sm font-bold text-gray-500">% 할인</span>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <select class="field text-xs" id="gachaEventPreset" onchange="applyEventPreset('gacha')">
                  <option value="">⚡ 빠른 기간 설정</option>
                  <option value="1h">지금부터 1시간</option>
                  <option value="2h">지금부터 2시간</option>
                  <option value="4h">지금부터 4시간</option>
                  <option value="8h">지금부터 8시간</option>
                  <option value="24h">지금부터 24시간</option>
                </select>
                <button class="btn btn-gray text-xs py-1" onclick="clearEventDates('gacha')">날짜 초기화</button>
              </div>
              <input class="field text-xs" type="datetime-local" id="gachaEventStart">
              <input class="field text-xs" type="datetime-local" id="gachaEventEnd">
              <p class="text-xs text-gray-400">※ 시작 비워두면 즉시 · 종료 비워두면 수동 종료</p>
              <div class="flex gap-2">
                <button class="btn btn-purple flex-1 py-2 text-sm" onclick="activateEvent('gacha')">✅ 활성화</button>
                <button class="btn btn-gray flex-1 py-2 text-sm" onclick="deactivateEvent('gacha')">⏹ 비활성화</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ── 요일 반복 패널 ── -->
        <div id="evtPane-repeat" class="hidden">
          <div class="p-3 rounded-2xl mb-4" style="background:rgba(219,234,254,0.4);border:1.5px solid rgba(96,165,250,0.3)">
            <p class="text-xs font-black text-blue-700 mb-1">💡 요일 반복이란?</p>
            <p class="text-xs text-blue-600 font-semibold leading-relaxed">매주 선택한 요일의 특정 시간대에 자동으로 할인이 적용됩니다.<br>예) 매주 금·토요일 18:00~23:59 상점 20% 할인</p>
          </div>
          <div class="space-y-3">
            <!-- 대상 + 할인율 -->
            <div class="flex gap-2 items-center">
              <select class="field flex-1" id="rpt-target">
                <option value="store">🛍️ 상점 할인</option>
                <option value="gacha">🎲 뽑기 할인</option>
              </select>
              <input class="field" type="number" id="rpt-pct" placeholder="%" min="1" max="100" style="width:70px;flex-shrink:0">
              <span class="text-sm font-bold text-gray-500 flex-shrink-0">%</span>
            </div>
            <!-- 요일 선택 -->
            <div>
              <p class="text-xs font-bold text-gray-500 mb-2">반복 요일</p>
              <div class="flex gap-1.5 flex-wrap" id="rpt-days">
                <label class="evt-day-btn"><input type="checkbox" value="0" onchange="toggleDayBtn(this)"><span>일</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="1" onchange="toggleDayBtn(this)"><span>월</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="2" onchange="toggleDayBtn(this)"><span>화</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="3" onchange="toggleDayBtn(this)"><span>수</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="4" onchange="toggleDayBtn(this)"><span>목</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="5" onchange="toggleDayBtn(this)"><span>금</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="6" onchange="toggleDayBtn(this)"><span>토</span></label>
              </div>
            </div>
            <!-- 시간대 -->
            <div class="grid grid-cols-2 gap-2">
              <div>
                <p class="text-xs font-bold text-gray-500 mb-1">시작 시각</p>
                <input class="field text-xs" type="time" id="rpt-startTime" value="00:00">
              </div>
              <div>
                <p class="text-xs font-bold text-gray-500 mb-1">종료 시각</p>
                <input class="field text-xs" type="time" id="rpt-endTime" value="23:59">
              </div>
            </div>
            <!-- 유효기간 (선택) -->
            <div class="grid grid-cols-2 gap-2">
              <div>
                <p class="text-xs font-bold text-gray-500 mb-1">반복 시작일 <span class="font-normal text-gray-400">(비워두면 즉시)</span></p>
                <input class="field text-xs" type="date" id="rpt-validFrom">
              </div>
              <div>
                <p class="text-xs font-bold text-gray-500 mb-1">반복 종료일 <span class="font-normal text-gray-400">(비워두면 무기한)</span></p>
                <input class="field text-xs" type="date" id="rpt-validUntil">
              </div>
            </div>
            <button class="btn btn-primary w-full py-2.5 text-sm" onclick="addRepeatEvent()">🔄 요일 반복 이벤트 추가</button>
          </div>
        </div>

        <!-- ── 등록된 요일반복 목록 ── -->
        <div id="evtPane-schedules" class="hidden">
          <div id="scheduleList" class="space-y-2">
            <p class="text-sm text-gray-400 text-center py-4">로딩 중...</p>
          </div>
        </div>
      </div>

      <!-- 이벤트 기록 -->
      <div class="clay-card p-5">
        <p class="text-sm font-black text-gray-700 mb-3">📜 최근 이벤트 기록</p>
        <div id="eventHistoryList" class="space-y-2"></div>
      </div>
    </div>
  </div>

    <!-- ♻️ 관리자 재활용센터 -->
    <div id="atab-recycle" class="hidden">
      <!-- 아이템 등록 -->
      <div class="clay-card p-5 mb-4">
        <h2 class="text-lg font-black text-gray-800 mb-4">♻️ 재활용 아이템 등록</h2>
        <div class="space-y-3">
          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">상품 선택</label>
            <select class="field" id="rc-productSelect">
              <option value="">상품을 선택하세요...</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">매입 범위</label>
            <div class="flex gap-2" id="rc-scopeBtns">
              <button type="button" class="rc-scope-btn active flex-1 py-2 rounded-2xl text-sm font-black" data-scope="all" onclick="setRecycleScope('all')">🛍️+🎲 모두</button>
              <button type="button" class="rc-scope-btn flex-1 py-2 rounded-2xl text-sm font-black" data-scope="store" onclick="setRecycleScope('store')">🛍️ 상점만</button>
              <button type="button" class="rc-scope-btn flex-1 py-2 rounded-2xl text-sm font-black" data-scope="gacha" onclick="setRecycleScope('gacha')">🎲 뽑기만</button>
            </div>
            <input type="hidden" id="rc-scope" value="all">
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">매입 가격 🌰</label>
            <input class="field" type="number" id="rc-price" placeholder="도토리 수량" min="1">
          </div>
          <button class="btn btn-green w-full py-3 font-black" onclick="addRecycleItem()">➕ 등록</button>
        </div>
      </div>

      <!-- 등록된 매입 목록 -->
      <div class="clay-card p-5">
        <p class="text-sm font-black text-gray-700 mb-3">📋 매입 목록</p>
        <div id="recycleAdminList" class="space-y-3"></div>
      </div>
    </div>

</div></div>

<!-- 토스트 -->
<div id="toast" class="toast-container hidden">
  <div id="toastInner" style="text-align:center;animation:toastIn .25s cubic-bezier(.34,1.56,.64,1) both;background:rgba(245,210,255,0.42);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1.5px solid rgba(255,255,255,0.6);border-radius:20px;padding:14px 24px;display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:0 8px 32px rgba(120,80,180,0.2)">
    <span id="toastIcon" class="text-2xl"></span>
    <span id="toastMsg" style="font-weight:800;font-size:14px;color:rgba(90,30,130,0.92)"></span>
  </div>
</div>

<!-- PWA 설치 배너 -->
<div id="installBanner" class="hidden">
  <div class="text-3xl">🌰</div>
  <div class="flex-1"><p class="font-black text-gray-800 text-sm">홈 화면에 추가</p><p class="text-xs text-gray-500 font-semibold">앱처럼 사용해요!</p></div>
  <button class="btn btn-primary px-4 py-2 text-sm" onclick="installPWA()">설치</button>
  <button class="btn btn-gray px-3 py-2 text-xs" onclick="document.getElementById('installBanner').classList.add('hidden')">✕</button>
</div>


<!-- 모달 (body 직속 — position:fixed 뷰포트 기준 보장) -->
<div id="modal" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()"><div id="modalContent"></div></div>
</div>

<!-- JS 모듈 (로드 순서 중요) -->
<script src="js/supabase-client.js"></script>
<script src="js/state.js"></script>
<script src="js/utils.js"></script>
<script src="js/helpers.js"></script>
<script src="js/ui.js"></script>
<script src="js/auth.js"></script>
<script src="js/shop.js"></script>
<script src="js/gacha.js"></script>
<script src="js/quest.js"></script>
<script src="js/mypage.js"></script>
<script src="js/notification.js"></script>
<script src="js/event.js"></script>
<script src="js/recycle.js"></script>
<script src="js/admin.js"></script>
<script src="js/app.js"></script>

</body>
</html>
