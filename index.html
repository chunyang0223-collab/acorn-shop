<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#ff8fab">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ë„í† ë¦¬ ìƒì ">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="icons/icon-192x192.png">
<title>ğŸŒ° ë„í† ë¦¬ ìƒì </title>
<script>
// â”€â”€ Supabase ê²½ëŸ‰ í´ë¼ì´ì–¸íŠ¸ (CDN ì—†ì´ ì§ì ‘ êµ¬í˜„) â”€â”€
const supabase = (() => {
  function createClient(url, key) {
    const headers = { 'apikey': key, 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' };
    let _session = null;
    let _listeners = [];
    let _refreshTimer = null;

    function _notify(event, session) {
      _listeners.forEach(fn => fn(event, session));
    }

    function _saveSession(s) {
      _session = s;
      if (s) {
        localStorage.setItem('sb_session', JSON.stringify(s));
        // ìë™ í† í° ê°±ì‹ 
        const exp = s.expires_at * 1000 - Date.now() - 60000;
        if (_refreshTimer) clearTimeout(_refreshTimer);
        if (exp > 0) _refreshTimer = setTimeout(_refreshSession, exp);
      } else {
        localStorage.removeItem('sb_session');
      }
    }

    async function _refreshSession() {
      const s = _session;
      if (!s?.refresh_token) return;
      try {
        const r = await fetch(url + '/auth/v1/token?grant_type=refresh_token', {
          method: 'POST', headers,
          body: JSON.stringify({ refresh_token: s.refresh_token })
        });
        const d = await r.json();
        if (d.access_token) {
          const ns = { ...d, user: d.user || s.user };
          _saveSession(ns);
          headers['Authorization'] = 'Bearer ' + d.access_token;
          _notify('TOKEN_REFRESHED', ns);
        }
      } catch(e) {}
    }

    const auth = {
      async getSession() {
        if (_session) return { data: { session: _session } };
        const stored = localStorage.getItem('sb_session');
        if (stored) {
          try {
            const s = JSON.parse(stored);
            if (s.expires_at && s.expires_at * 1000 > Date.now()) {
              _session = s;
              headers['Authorization'] = 'Bearer ' + s.access_token;
              return { data: { session: s } };
            }
          } catch(e) {}
        }
        return { data: { session: null } };
      },

      onAuthStateChange(fn) {
        _listeners.push(fn);
        return { data: { subscription: { unsubscribe: () => { _listeners = _listeners.filter(f => f !== fn); } } } };
      },

      async signUp({ email, password, options }) {
        const r = await fetch(url + '/auth/v1/signup', {
          method: 'POST', headers,
          body: JSON.stringify({ email, password, data: options?.data || {} })
        });
        const d = await r.json();
        if (d.error || d.msg) return { error: { message: d.error_description || d.msg || d.error } };
        if (d.access_token) {
          const s = { ...d, user: d.user };
          _saveSession(s);
          headers['Authorization'] = 'Bearer ' + d.access_token;
          _notify('SIGNED_IN', s);
        }
        return { data: d, error: null };
      },

      async signInWithPassword({ email, password }) {
        const r = await fetch(url + '/auth/v1/token?grant_type=password', {
          method: 'POST', headers,
          body: JSON.stringify({ email, password })
        });
        const d = await r.json();
        if (!r.ok) return { error: { message: d.error_description || d.msg || 'ë¡œê·¸ì¸ ì‹¤íŒ¨' } };
        const s = { ...d, user: d.user };
        _saveSession(s);
        headers['Authorization'] = 'Bearer ' + d.access_token;
        _notify('SIGNED_IN', s);
        return { data: { session: s }, error: null };
      },

      async signInWithOAuth({ provider, options }) {
        const redirectTo = encodeURIComponent(options?.redirectTo || window.location.href);
        window.location.href = url + '/auth/v1/authorize?provider=' + provider + '&redirect_to=' + redirectTo;
        return { error: null };
      },

      async signOut() {
        try {
          await fetch(url + '/auth/v1/logout', { method: 'POST', headers });
        } catch(e) {}
        _saveSession(null);
        headers['Authorization'] = 'Bearer ' + key;
        _notify('SIGNED_OUT', null);
      },

      async getUser() {
        if (!_session) return { data: { user: null } };
        return { data: { user: _session.user } };
      }
    };

    function from(table) {
      let _url = url + '/rest/v1/' + table;
      let _method = 'GET';
      let _body = null;
      let _filters = [];
      let _select = '*';
      let _order = null;
      let _single = false;
      let _maybeSingle = false;
      let _upsert = false;
      let _upsertConflict = null;
      let _countExact = false;

      const q = {
        select(cols, opts) {
          _select = cols || '*';
          _url = url + '/rest/v1/' + table + '?select=' + _select;
          if (opts?.count === 'exact') _countExact = true;
          return q;
        },
        eq(col, val)   { _filters.push(col + '=eq.'   + encodeURIComponent(val)); return q; },
        in(col, vals)  { _filters.push(col + '=in.(' + vals.map(v => encodeURIComponent(v)).join(',') + ')'); return q; },
        neq(col, val)  { _filters.push(col + '=neq.'  + encodeURIComponent(val)); return q; },
        ilike(col, val){ _filters.push(col + '=ilike.' + encodeURIComponent(val)); return q; },
        gte(col, val)  { _filters.push(col + '=gte.'  + encodeURIComponent(val)); return q; },
        order(col, opts){ _order = col + (opts?.ascending === false ? '.desc' : '.asc'); return q; },
        limit(n)       { _filters.push('limit=' + n); return q; },
        single()       { _single = true; return q; },
        maybeSingle()  { _maybeSingle = true; return q; },
        insert(data)   { _method = 'POST'; _body = JSON.stringify(data); return q; },
        upsert(data, opts) { _method = 'POST'; _body = JSON.stringify(data); _upsert = true; if (opts?.onConflict) _upsertConflict = opts.onConflict; return q; },
        update(data)   { _method = 'PATCH'; _body = JSON.stringify(data); return q; },
        delete()       { _method = 'DELETE'; return q; },

        async then(resolve, reject) {
          try {
            let finalUrl = _url;
            if (!finalUrl.includes('?')) finalUrl += '?select=' + _select;
            if (_filters.length) finalUrl += '&' + _filters.join('&');
            if (_order) finalUrl += '&order=' + _order;

            const h = { ...headers };
            if (_upsert) { h['Prefer'] = 'resolution=merge-duplicates,return=representation'; if (_upsertConflict) { const u = new URL(finalUrl); u.searchParams.set('on_conflict', _upsertConflict); finalUrl = u.toString(); } }
            else if (_method === 'POST' || _method === 'PATCH') h['Prefer'] = 'return=representation';
            if (_countExact) h['Prefer'] = (h['Prefer'] ? h['Prefer'] + ',' : '') + 'count=exact';
            if (_single || _maybeSingle) h['Accept'] = 'application/vnd.pgrst.object+json';

            const r = await fetch(finalUrl, { method: _method, headers: h, body: _body });
            const text = await r.text();
            let d = null;
            try { d = text ? JSON.parse(text) : null; } catch(e) { d = null; }

            // Content-Range í—¤ë”ì—ì„œ count íŒŒì‹±
            let count = null;
            const cr = r.headers?.get?.('Content-Range');
            if (cr) { const m = cr.match(/\/(\d+)/); if (m) count = parseInt(m[1]); }

            if (!r.ok) {
              // maybeSingle: 406(ê²°ê³¼ì—†ìŒ)ì€ ì—ëŸ¬ ì•„ë‹˜ â†’ data:null, error:null
              if (_maybeSingle && (r.status === 406 || r.status === 404)) {
                resolve({ data: null, error: null, count });
              } else {
                resolve({ data: null, error: { message: d?.message || d?.hint || r.statusText }, count });
              }
            } else {
              resolve({ data: d, error: null, count });
            }
          } catch(e) {
            resolve({ data: null, error: { message: e.message }, count: null });
          }
        }
      };
      return q;
    }

    async function rpc(fn, params) {
      const h = { ...headers, 'Prefer': 'return=representation' };
      try {
        const r = await fetch(url + '/rest/v1/rpc/' + fn, {
          method: 'POST', headers: h,
          body: JSON.stringify(params)
        });
        const d = await r.json();
        if (!r.ok) return { data: null, error: { message: d?.message || d?.hint || 'RPC ì˜¤ë¥˜' } };
        return { data: d, error: null };
      } catch(e) {
        return { data: null, error: { message: e.message } };
      }
    }

    function channel(name) {
      // Realtimeì€ WebSocket í•„ìš” - í´ë§ìœ¼ë¡œ ëŒ€ì²´ (ê°„ë‹¨ êµ¬í˜„)
      return {
        on(event, filter, cb) { return this; },
        subscribe() { return this; }
      };
    }

    return { auth, from, rpc, channel };
  }
  return { createClient };
})();
</script>


<link href="https://fonts.googleapis.com/css2?family=Jua&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>

/* â”€â”€ Tailwind í•µì‹¬ ìœ í‹¸ë¦¬í‹° (CDN ëŒ€ì²´) â”€â”€ */
.hidden{display:none!important}
.flex{display:flex}.inline-flex{display:inline-flex}.block{display:block}.grid{display:grid}
.flex-1{flex:1 1 0%}.flex-col{flex-direction:column}.flex-row{flex-direction:row}
.items-center{align-items:center}.items-start{align-items:flex-start}
.justify-center{justify-content:center}.justify-between{justify-content:space-between}.justify-end{justify-content:flex-end}
.gap-1{gap:4px}.gap-2{gap:8px}.gap-3{gap:12px}.gap-4{gap:16px}.gap-6{gap:24px}
.w-full{width:100%}.w-auto{width:auto}.h-full{height:100%}.h-px{height:1px}
.min-h-screen{min-height:100vh}
.max-w-2xl{max-width:42rem}.max-w-sm{max-width:24rem}.max-w-lg{max-width:32rem}
.mx-auto{margin-left:auto;margin-right:auto}
.p-1{padding:4px}.p-2{padding:8px}.p-3{padding:12px}.p-4{padding:16px}.p-5{padding:20px}.p-6{padding:24px}
.px-2{padding-left:8px;padding-right:8px}.px-3{padding-left:12px;padding-right:12px}.px-4{padding-left:16px;padding-right:16px}
.py-1{padding-top:4px;padding-bottom:4px}.py-2{padding-top:8px;padding-bottom:8px}.py-3{padding-top:12px;padding-bottom:12px}.py-4{padding-top:16px;padding-bottom:16px}
.pt-2{padding-top:8px}.pb-2{padding-bottom:8px}.pb-4{padding-bottom:16px}.pb-6{padding-bottom:24px}
.m-0{margin:0}.mt-1{margin-top:4px}.mt-2{margin-top:8px}.mt-3{margin-top:12px}.mt-4{margin-top:16px}
.mb-1{margin-bottom:4px}.mb-2{margin-bottom:8px}.mb-3{margin-bottom:12px}.mb-4{margin-bottom:16px}.mb-6{margin-bottom:24px}
.ml-1{margin-left:4px}.ml-2{margin-left:8px}.mr-1{margin-right:4px}.mr-2{margin-right:8px}
.space-y-2>*+*{margin-top:8px}.space-y-3>*+*{margin-top:12px}.space-y-4>*+*{margin-top:16px}
.text-xs{font-size:12px}.text-sm{font-size:13px}.text-base{font-size:14px}.text-lg{font-size:18px}.text-xl{font-size:20px}.text-2xl{font-size:24px}.text-3xl{font-size:30px}
.font-bold{font-weight:700}.font-semibold{font-weight:600}.font-black{font-weight:900}.font-medium{font-weight:500}
.text-center{text-align:center}.text-left{text-align:left}.text-right{text-align:right}
.text-white{color:#fff}.text-gray-400{color:#9ca3af}.text-gray-500{color:#6b7280}.text-gray-600{color:#4b5563}.text-gray-700{color:#374151}.text-gray-800{color:#1f2937}.text-gray-900{color:#111827}
.text-amber-500{color:#f59e0b}.text-amber-600{color:#d97706}.text-amber-700{color:#b45309}
.text-red-500{color:#ef4444}.text-red-600{color:#dc2626}.text-green-600{color:#16a34a}.text-blue-600{color:#2563eb}.text-purple-600{color:#9333ea}
.bg-white{background:#fff}.bg-gray-50{background:#f9fafb}.bg-gray-100{background:#f3f4f6}.bg-gray-200{background:#e5e7eb}
.bg-amber-50{background:#fffbeb}.bg-amber-100{background:#fef3c7}.bg-amber-500{background:#f59e0b}
.bg-green-100{background:#dcfce7}.bg-red-100{background:#fee2e2}.bg-blue-100{background:#dbeafe}
.bg-yellow-100{background:#fef9c3}.bg-purple-100{background:#ede9fe}
.rounded{border-radius:4px}.rounded-md{border-radius:6px}.rounded-lg{border-radius:8px}.rounded-xl{border-radius:12px}.rounded-2xl{border-radius:16px}.rounded-full{border-radius:9999px}
.border{border:1px solid #e5e7eb}.border-2{border:2px solid #e5e7eb}.border-gray-200{border-color:#e5e7eb}.border-amber-200{border-color:#fde68a}
.shadow{box-shadow:0 1px 3px rgba(0,0,0,.1)}.shadow-md{box-shadow:0 4px 6px rgba(0,0,0,.07)}.shadow-lg{box-shadow:0 10px 15px rgba(0,0,0,.1)}
.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.overflow-x-auto{overflow-x:auto}
.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.whitespace-nowrap{white-space:nowrap}
.relative{position:relative}.absolute{position:absolute}.fixed{position:fixed}.sticky{position:sticky}
.top-0{top:0}.bottom-0{bottom:0}.left-0{left:0}.right-0{right:0}.inset-0{inset:0}
.z-10{z-index:10}.z-50{z-index:50}
.opacity-50{opacity:.5}.opacity-0{opacity:0}.opacity-100{opacity:1}
.cursor-pointer{cursor:pointer}.pointer-events-none{pointer-events:none}
.underline{text-decoration:underline}.line-through{text-decoration:line-through}
.select-none{user-select:none}
.resize-none{resize:none}
.transition{transition:all .15s}
.grid-cols-2{grid-template-columns:repeat(2,1fr)}.grid-cols-3{grid-template-columns:repeat(3,1fr)}
.col-span-2{grid-column:span 2}
.shrink-0{flex-shrink:0}
.aspect-square{aspect-ratio:1}
.leading-tight{line-height:1.25}.leading-relaxed{line-height:1.625}
.italic{font-style:italic}
.capitalize{text-transform:capitalize}.uppercase{text-transform:uppercase}
.w-8{width:32px}.h-8{height:32px}.w-10{width:40px}.h-10{height:40px}.w-12{width:48px}.h-12{height:48px}
.w-6{width:24px}.h-6{height:24px}.w-4{width:16px}.h-4{height:16px}
.text-yellow-800{color:#854d0e}.text-green-800{color:#166534}.text-red-800{color:#991b1b}.text-blue-800{color:#1e40af}.text-purple-800{color:#6b21a8}

/* â”€â”€ ê¸°ë³¸ â”€â”€ */
*,*::before,*::after{box-sizing:border-box}
html{-webkit-tap-highlight-color:transparent}

/* UI í…ìŠ¤íŠ¸ëŠ” Jua, ë³¸ë¬¸ì€ Nunito */
body, input, select, textarea, button {
  font-family: 'Nunito', sans-serif;
}
h1, h2, h3, .tab-btn, .btn, .acorn-pill,
#headerUserLabel, .font-black {
  font-family: 'Jua', 'Nunito', sans-serif;
}

/* â”€â”€ ë°°ê²½ â”€â”€ */
@keyframes bgShift {
  0%   { background-position: 0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
body {
  background: linear-gradient(-45deg, #ffd6e7, #ffefba, #c3e8ff, #fce4ff);
  background-size: 400% 400%;
  animation: bgShift 18s ease infinite;
  min-height: 100dvh;
  padding-bottom: env(safe-area-inset-bottom);
}

/* â”€â”€ ê¸€ë¼ìŠ¤ ì¹´ë“œ â”€â”€ */
.clay-card {
  background: rgba(255,255,255,0.72);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border-radius: 24px;
  border: 1.5px solid rgba(255,255,255,0.85);
  box-shadow: 0 8px 32px rgba(180,140,200,0.13), 0 2px 8px rgba(180,140,200,0.08);
  transition: transform .2s, box-shadow .2s;
}
.card-hover:hover {
  transform: translateY(-2px);
  box-shadow: 0 14px 40px rgba(180,140,200,0.2);
}

/* â”€â”€ ë²„íŠ¼ â”€â”€ */
.btn {
  border-radius: 18px;
  font-weight: 800;
  font-family: 'Jua', 'Nunito', sans-serif;
  transition: all .15s;
  cursor: pointer;
  border: none;
  outline: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  letter-spacing: 0.01em;
}
.btn:active { transform: scale(.95); }

.btn-primary {
  background: linear-gradient(135deg, #ff8fab, #ff6b9d);
  color: #fff;
  box-shadow: 0 4px 18px rgba(255,107,157,.38);
}
.btn-primary:hover {
  box-shadow: 0 6px 26px rgba(255,107,157,.52);
  transform: translateY(-1px);
}
.btn-green {
  background: linear-gradient(135deg, #86efb5, #34d399);
  color: #065f46;
  box-shadow: 0 4px 14px rgba(52,211,153,.3);
}
.btn-red {
  background: linear-gradient(135deg, #fca5a5, #f87171);
  color: #7f1d1d;
  box-shadow: 0 4px 14px rgba(248,113,113,.3);
}
.btn-purple {
  background: linear-gradient(135deg, #c4b5fd, #a78bfa);
  color: #3b0764;
  box-shadow: 0 4px 14px rgba(167,139,250,.35);
}
.btn-blue {
  background: linear-gradient(135deg, #93c5fd, #60a5fa);
  color: #1e3a8a;
  box-shadow: 0 4px 14px rgba(96,165,250,.3);
}
.btn-gray {
  background: rgba(255,255,255,0.7);
  color: #6b7280;
  border: 1.5px solid rgba(200,200,220,0.4);
}
.btn-kakao {
  background: #FEE500;
  color: #191919;
  box-shadow: 0 4px 14px rgba(254,229,0,.4);
}
.btn-pink {
  background: linear-gradient(135deg, #fbcfe8, #f9a8d4);
  color: #9d174d;
  box-shadow: 0 4px 14px rgba(249,168,212,.35);
}

/* â”€â”€ íƒ­ ë²„íŠ¼ â”€â”€ */
.tab-btn {
  border-radius: 16px;
  padding: 10px 14px;
  font-weight: 700;
  font-size: 13px;
  font-family: 'Jua', 'Nunito', sans-serif;
  cursor: pointer;
  transition: all .2s;
  border: none;
  background: transparent;
  color: #b0a0c0;
  white-space: nowrap;
}
.tab-btn.active {
  background: linear-gradient(135deg, #ff8fab, #c084fc);
  color: #fff;
  box-shadow: 0 4px 16px rgba(192,132,252,.35);
}

/* â”€â”€ ì¸í’‹ í•„ë“œ â”€â”€ */
.field {
  border: 2px solid rgba(210,180,240,0.4);
  border-radius: 16px;
  padding: 10px 14px;
  font-family: 'Nunito', sans-serif;
  font-weight: 600;
  width: 100%;
  outline: none;
  transition: border-color .2s, background .2s;
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(8px);
  font-size: 14px;
  color: #4a3060;
}
.field:focus {
  border-color: #f9a8d4;
  background: rgba(255,255,255,0.9);
}

/* â”€â”€ ë°°ì§€ â”€â”€ */
.badge { border-radius: 20px; padding: 3px 12px; font-size: 12px; font-weight: 800; }
.rc-common  { background: #f3e8ff; color: #7c3aed; }
.rc-rare    { background: #dbeafe; color: #1d4ed8; }
.rc-epic    { background: #fce7f3; color: #be185d; }
.rc-legend  { background: #fee2e2; color: #dc2626; }

.st-pending  { background: #fef3c7; color: #92400e; }
.st-approved { background: #d1fae5; color: #065f46; }
.st-rejected { background: #fee2e2; color: #991b1b; }

.rt-auto   { background: #d1fae5; color: #065f46; border-radius: 10px; padding: 2px 9px; font-size: 11px; font-weight: 800; }
.rt-manual { background: #ede9fe; color: #5b21b6; border-radius: 10px; padding: 2px 9px; font-size: 11px; font-weight: 800; }

.rep-badge { border-radius: 10px; padding: 2px 8px; font-size: 11px; font-weight: 800; }
.rep-once   { background: rgba(243,232,255,0.8); color: #7c3aed; }
.rep-daily  { background: rgba(219,234,254,0.8); color: #1d4ed8; }
.rep-weekly { background: rgba(252,231,243,0.8); color: #be185d; }

.ct-auto     { background: #fef3c7; color: #92400e; border-radius: 10px; padding: 2px 8px; font-size: 11px; font-weight: 800; }
.ct-approval { background: #fce7f3; color: #9d174d; border-radius: 10px; padding: 2px 8px; font-size: 11px; font-weight: 800; }

.qs-inprogress { background: rgba(243,232,255,0.7); color: #7c3aed; border-radius: 12px; padding: 3px 10px; font-size: 11px; font-weight: 800; }
.qs-done       { background: rgba(209,250,229,0.8); color: #065f46; border-radius: 12px; padding: 3px 10px; font-size: 11px; font-weight: 800; }
.qs-pending    { background: rgba(254,243,199,0.8); color: #92400e; border-radius: 12px; padding: 3px 10px; font-size: 11px; font-weight: 800; }

/* â”€â”€ ë„í† ë¦¬ pill â”€â”€ */
.acorn-pill {
  background: linear-gradient(135deg, rgba(255,235,180,0.9), rgba(255,200,120,0.8));
  border: 2px solid rgba(251,191,36,0.5);
  backdrop-filter: blur(6px);
  border-radius: 20px;
  padding: 4px 16px;
  font-weight: 900;
  font-family: 'Jua', sans-serif;
  color: #92400e;
}

/* â”€â”€ ê±°ë˜ ë‚´ì—­ â”€â”€ */
.tx-plus  { color: #059669; font-weight: 900; }
.tx-minus { color: #dc2626; font-weight: 900; }

/* â”€â”€ í†µê³„ ì¹´ë“œ â”€â”€ */
.stat-card { border-radius: 20px; padding: 18px; }
/* â”€â”€ ì ê²€ í† ê¸€ ìŠ¤ìœ„ì¹˜ â”€â”€ */
.maint-btn {
  position: relative; width: 44px; height: 24px;
  border-radius: 12px; border: none; cursor: pointer;
  background: linear-gradient(135deg,#86efb5,#34d399);
  transition: background .25s;
  flex-shrink: 0;
}
.maint-btn::after {
  content: ''; position: absolute; top: 3px; left: 3px;
  width: 18px; height: 18px; border-radius: 50%;
  background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.18);
  transition: transform .25s;
}
.maint-btn.on { background: linear-gradient(135deg,#fca5a5,#f87171); }
.maint-btn.on::after { transform: translateX(20px); }
.sc-orange { background: rgba(255,237,213,0.8); border: 1.5px solid rgba(254,215,170,0.6); backdrop-filter: blur(10px); }
.sc-blue   { background: rgba(219,234,254,0.8); border: 1.5px solid rgba(191,219,254,0.6); backdrop-filter: blur(10px); }
.sc-green  { background: rgba(209,250,229,0.8); border: 1.5px solid rgba(187,247,208,0.6); backdrop-filter: blur(10px); }
.sc-purple { background: rgba(243,232,255,0.8); border: 1.5px solid rgba(221,214,254,0.6); backdrop-filter: blur(10px); }

/* â”€â”€ í† ê¸€ â”€â”€ */
.toggle-wrap { position: relative; display: inline-block; width: 44px; height: 24px; }
.toggle-wrap input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; inset: 0; background: #e2d9f3; border-radius: 24px; cursor: pointer; transition: .3s; }
.toggle-slider:before { content: ''; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: .3s; }
.toggle-wrap input:checked + .toggle-slider { background: linear-gradient(135deg, #86efb5, #34d399); }
.toggle-wrap input:checked + .toggle-slider:before { transform: translateX(20px); }

/* â”€â”€ ëª¨ë‹¬ â”€â”€ */
.modal-overlay {
  position: fixed;
  inset: 0;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100vw; height: 100vh;
  background: rgba(80,40,120,.4);
  z-index: 9999;
  display: flex; align-items: center; justify-content: center;
  animation: fadeIn .18s ease;
  overscroll-behavior: none;
  overflow: hidden;
}
.modal-box {
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1.5px solid rgba(255,255,255,0.9);
  border-radius: 28px;
  padding: 24px 24px 28px;
  width: 92%; max-width: min(440px, calc(100vw - 32px));
  animation: slideUp .22s cubic-bezier(.34,1.56,.64,1);
  box-shadow: 0 16px 60px rgba(140,100,200,.2);
  max-height: 88dvh; overflow-y: auto;
}
@media (max-width: 480px) {
  .modal-box {
    padding: 18px 16px 22px;
    border-radius: 22px;
    width: 88%;
    max-height: 75dvh;
  }
  .notif-scroll { max-height: 44dvh !important; }
}

/* â”€â”€ ë¡œê·¸ì¸ â”€â”€ */
.login-screen {
  position: fixed; inset: 0; z-index: 300;
  background: linear-gradient(-45deg, #ffd6e7, #ffefba, #c3e8ff, #fce4ff);
  background-size: 400% 400%;
  animation: bgShift 18s ease infinite;
  display: flex; align-items: center; justify-content: center;
}
.login-card {
  background: rgba(255,255,255,0.82);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border: 2px solid rgba(255,255,255,0.9);
  border-radius: 36px;
  padding: 40px 32px;
  width: 92%; max-width: 380px;
  box-shadow: 0 24px 80px rgba(180,140,220,.2);
}

/* â”€â”€ ë¡œë”© â”€â”€ */
.loading-screen {
  position: fixed; inset: 0; z-index: 400;
  background: linear-gradient(-45deg, #ffd6e7, #ffefba, #c3e8ff, #fce4ff);
  background-size: 400% 400%;
  animation: bgShift 18s ease infinite;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px;
}

/* â”€â”€ ì•Œë¦¼ ì  â”€â”€ */
.notif-dot {
  width: 8px; height: 8px;
  background: #f472b6;
  border-radius: 50%;
  position: absolute; top: 0; right: 0;
  animation: pulse .9s ease infinite;
}

/* â”€â”€ ìŠ¤í¬ë¡¤ë°” â”€â”€ */
#adminTabBar { overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; cursor: grab; }
#adminTabBar::-webkit-scrollbar { display: none; }
#userTabBar::-webkit-scrollbar { display: none; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: rgba(200,180,230,0.4); border-radius: 99px; }

/* â”€â”€ ì„¤ì¹˜ ë°°ë„ˆ â”€â”€ */
#installBanner {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  z-index: 150; width: calc(100% - 48px); max-width: 400px;
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(16px);
  border: 1.5px solid rgba(255,255,255,0.9);
  border-radius: 20px; padding: 14px 18px;
  box-shadow: 0 8px 32px rgba(180,140,200,.2);
  display: flex; align-items: center; gap: 12px;
  animation: slideUp .3s ease;
}

/* â”€â”€ ë“œë˜ê·¸ â”€â”€ */
.drag-item { cursor: grab; user-select: none; }
.drag-item:active { cursor: grabbing; }
.drag-over { border: 2px dashed #f9a8d4 !important; background: rgba(252,231,243,0.5) !important; }

/* â”€â”€ í‚¤í”„ë ˆì„ â”€â”€ */
@keyframes fadeIn   { from{opacity:0} to{opacity:1} }
@keyframes slideUp  { from{transform:translateY(40px) scale(.95);opacity:0} to{transform:translateY(0) scale(1);opacity:1} }
@keyframes bounceIn { from{transform:scale(.5);opacity:0} to{transform:scale(1);opacity:1} }
@keyframes toastIn { from{opacity:0;scale:.85} to{opacity:1;scale:1} }
@keyframes popIn    { 0%{transform:scale(0) rotate(-180deg);opacity:0} 100%{transform:scale(1) rotate(0);opacity:1} }
@keyframes shake    { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-6px)} 40%,80%{transform:translateX(6px)} }
@keyframes pulse    { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
@keyframes spin     { to{transform:rotate(360deg)} }

.bounce-in { animation: bounceIn .4s cubic-bezier(.34,1.56,.64,1) both; }
.pop-in    { animation: popIn .6s cubic-bezier(.34,1.56,.64,1) both; }
.shake-anim{ animation: shake .4s ease; }
.spinner {
  animation: spin 1s linear infinite;
  border: 3px solid rgba(240,210,255,0.5);
  border-top-color: #f9a8d4;
  border-radius: 50%; width: 32px; height: 32px;
}

.hidden { display: none !important; }

/* â”€â”€ ìƒì  ì¹´ë“œ â”€â”€ */
#shopGrid .clay-card { display: flex; flex-direction: column; min-height: 200px; }

/* â”€â”€ ë²„íŠ¼ ë¡œë”© â”€â”€ */
.btn-loading { opacity: 0.65; pointer-events: none; cursor: not-allowed; }
.btn-loading::after { content: '...'; margin-left: 4px; }

/* â”€â”€ ë½‘ê¸° ìŠ¤í”¼ë„ˆ â”€â”€ */
#gachaSpinner { display: none; flex-direction: column; align-items: center; gap: 12px; padding: 24px 0; }
#gachaSpinner.active { display: flex; }
@keyframes gachaSpin {
  0%   { transform: rotate(0deg) scale(1); }
  50%  { transform: rotate(180deg) scale(1.3); }
  100% { transform: rotate(360deg) scale(1); }
}
.gacha-spinning { animation: gachaSpin .6s ease-in-out infinite; }

/* â”€â”€ ì‹ ì²­ ë°°ì§€ â”€â”€ */
.req-badge {
  background: #f472b6;
  color: #fff;
  border-radius: 999px;
  font-size: 10px; font-weight: 900;
  padding: 0 5px; min-width: 16px; height: 16px;
  display: inline-flex; align-items: center; justify-content: center;
  margin-left: 3px; vertical-align: top;
}

/* â”€â”€ ìœ„ì¹˜ ê³ ì • í´ë˜ìŠ¤ë“¤ â”€â”€ */
.toast-container { position: fixed; top: 35%; left: 50%; transform: translateX(-50%); z-index: 500; min-width: 220px; max-width: calc(100vw - 48px); pointer-events: none; }
.notif-scroll { max-height: 55dvh; overflow-y: auto; margin: 0 -4px; padding: 0 4px; }
.text-ellipsis { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* â”€â”€ ë±ƒì§€ (ìƒì /ìƒí’ˆê´€ë¦¬) â”€â”€ */
.badge-soldout    { background: rgba(254,226,226,0.9); color: #b91c1c; border-radius: 10px; padding: 2px 10px; font-size: 11px; font-weight: 800; }
.badge-stock      { background: rgba(243,232,255,0.9); color: #7c3aed; border-radius: 10px; padding: 2px 10px; font-size: 11px; font-weight: 800; }
.badge-gacha-pct  { background: rgba(237,233,254,0.9); color: #7c3aed; border-radius: 10px; padding: 2px 10px; font-size: 12px; font-weight: 800; }
.badge-unlimited  { background: rgba(209,250,229,0.9); color: #065f46; border-radius: 10px; padding: 2px 10px; font-size: 11px; font-weight: 800; }
.badge-soldout-sm  { background: rgba(254,226,226,0.9); color: #b91c1c; border-radius: 6px; padding: 1px 5px; font-size: 10px; font-weight: 800; }
.badge-stock-sm    { background: rgba(243,232,255,0.9); color: #7c3aed; border-radius: 6px; padding: 1px 5px; font-size: 10px; font-weight: 800; }
.badge-unlimited-sm{ background: rgba(209,250,229,0.9); color: #065f46; border-radius: 6px; padding: 1px 5px; font-size: 10px; font-weight: 800; }
.badge-prob       { background: rgba(237,233,254,0.9); color: #7c3aed; border-radius: 10px; padding: 2px 10px; font-size: 12px; font-weight: 800; }
.badge-prob-sm    { background: rgba(237,233,254,0.9); color: #7c3aed; border-radius: 6px; padding: 1px 5px; font-size: 10px; font-weight: 800; }



.rt-coupon { background: rgba(251,191,36,0.18); color: #92400e; border-radius: 8px; padding: 2px 8px; font-size: 12px; font-weight: 800; }
[data-theme="dark"] .rt-coupon { background: rgba(251,191,36,0.15) !important; color: #fcd34d !important; }
/* â”€â”€ ì¬í™œìš©ì„¼í„° â”€â”€ */
.recycle-hero {
  background: linear-gradient(135deg, rgba(209,250,229,0.9), rgba(167,243,208,0.7));
  border: 2px solid rgba(52,211,153,0.3);
}
.recycle-bg-deco {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: space-around;
  font-size: 2rem; opacity: 0.12; pointer-events: none;
  overflow: hidden;
}
.recycle-item-card {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px; border-radius: 18px;
  background: rgba(240,253,244,0.8);
  border: 2px solid rgba(52,211,153,0.2);
  cursor: pointer; transition: all .18s;
  user-select: none; -webkit-user-select: none;
}
.recycle-item-card:active { transform: scale(0.97); }
.recycle-item-card.selected {
  background: rgba(209,250,229,0.95);
  border-color: rgba(16,185,129,0.6);
  box-shadow: 0 0 0 3px rgba(16,185,129,0.15);
}
.recycle-inv-card {
  display: flex; flex-direction: column; align-items: center;
  gap: 6px; padding: 12px 8px; border-radius: 18px;
  border: 2.5px solid rgba(200,240,220,0.6);
  background: rgba(240,253,244,0.7);
  cursor: pointer; transition: all .18s;
  user-select: none; -webkit-user-select: none;
  position: relative;
}
.recycle-inv-card:active { transform: scale(0.95); }
.recycle-inv-card.selected {
  border-color: rgba(16,185,129,0.7);
  background: rgba(209,250,229,0.95);
  box-shadow: 0 0 0 3px rgba(16,185,129,0.15);
}
.recycle-inv-card .check-badge {
  position: absolute; top: -6px; right: -6px;
  width: 22px; height: 22px; border-radius: 50%;
  background: #10b981; color: #fff;
  font-size: 12px; font-weight: 900;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 8px rgba(16,185,129,0.4);
  opacity: 0; transform: scale(0); transition: all .15s;
}
.recycle-inv-card.selected .check-badge { opacity: 1; transform: scale(1); }
.recycle-sell-bar {
  position: fixed; bottom: 0; left: 50%;
  transform: translateX(-50%);
  width: 100%; max-width: 672px;
  background: linear-gradient(135deg, #059669, #10b981);
  padding: 16px 20px 28px;
  box-shadow: 0 -4px 24px rgba(16,185,129,0.3);
  z-index: 200;
}
.recycle-sell-btn {
  background: rgba(255,255,255,0.25);
  color: #fff; font-weight: 900; font-size: 15px;
  padding: 12px 22px; border-radius: 16px;
  border: 2px solid rgba(255,255,255,0.4);
  cursor: pointer; transition: all .15s;
  font-family: 'Jua', sans-serif;
  white-space: nowrap;
}
.recycle-sell-btn:active { transform: scale(0.96); background: rgba(255,255,255,0.35); }
.recycle-badge-active { background: #dcfce7; color: #166534; font-size: 11px; font-weight: 800; padding: 2px 10px; border-radius: 20px; display: inline-block; }
.rc-scope-btn { background: rgba(255,255,255,0.5); border: 2px solid rgba(200,180,240,0.3); color: #9c87b8; cursor: pointer; transition: all .15s; font-family: 'Jua',sans-serif; }
.rc-scope-btn.active { background: linear-gradient(135deg,#c084fc,#818cf8); border-color: transparent; color: #fff; box-shadow: 0 3px 10px rgba(192,132,252,.35); }
[data-theme="dark"] .rc-scope-btn { background: rgba(255,255,255,0.07) !important; border-color: rgba(255,255,255,0.12) !important; color: #9490b8 !important; }
[data-theme="dark"] .rc-scope-btn.active { background: linear-gradient(135deg,#7c3aed,#4f46e5) !important; border-color: transparent !important; color: #fff !important; }
.recycle-badge-inactive { background: #fee2e2; color: #b91c1c; font-size: 11px; font-weight: 800; padding: 2px 10px; border-radius: 20px; display: inline-block; }
[data-theme="dark"] .recycle-hero { background: linear-gradient(135deg,rgba(6,78,59,0.7),rgba(4,120,87,0.5)) !important; }
[data-theme="dark"] .recycle-item-card { background: rgba(6,78,59,0.3) !important; border-color: rgba(52,211,153,0.2) !important; }
[data-theme="dark"] .recycle-item-card.selected { background: rgba(6,78,59,0.6) !important; }
[data-theme="dark"] .recycle-inv-card { background: rgba(6,78,59,0.25) !important; }
[data-theme="dark"] .recycle-inv-card.selected { background: rgba(6,78,59,0.5) !important; }

/* â”€â”€ ìš”ì¼ ì„ íƒ ë²„íŠ¼ (label+checkbox ë°©ì‹) â”€â”€ */
.evt-day-btn { cursor: pointer; }
.evt-day-btn input { display: none; }
.evt-day-btn span {
  display: inline-flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 12px;
  border: 1.5px solid rgba(200,180,240,0.4);
  background: rgba(255,255,255,0.6);
  color: #9c87b8; font-size: 12px; font-weight: 900;
  font-family: 'Jua','Nunito',sans-serif;
  transition: all .15s;
  user-select: none;
}
.evt-day-btn span:hover { background: rgba(249,168,212,0.2); color: #be185d; }
.evt-day-btn input:checked + span {
  background: linear-gradient(135deg,#f9a8d4,#c084fc);
  color: #fff; border-color: transparent;
  box-shadow: 0 3px 8px rgba(192,132,252,0.4);
}
[data-theme="dark"] .evt-day-btn span { background: rgba(255,255,255,0.08) !important; border-color: rgba(255,255,255,0.15) !important; color: #9490b8 !important; }
[data-theme="dark"] .evt-day-btn input:checked + span { background: linear-gradient(135deg,#b05878,#7c6bbf) !important; border-color: transparent !important; }

/* â”€â”€ íƒ­ ì½˜í…ì¸  ìƒë‹¨ ì—¬ë°± í†µì¼ â”€â”€ */
[id^="utab-"] { padding-top: 12px; }
[id^="atab-"] { padding-top: 12px; }

/* â”€â”€ í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ â”€â”€ */
.page-nav-btn {
  width: 28px; height: 28px;
  border-radius: 10px;
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(6px);
  border: 1.5px solid rgba(210,180,240,0.3);
  color: #9c87b8;
  font-size: 16px; font-weight: 900;
  cursor: pointer;
  display: inline-flex; align-items: center; justify-content: center;
  transition: all .15s;
  line-height: 1;
}
.page-nav-btn:hover:not(:disabled) {
  background: rgba(249,168,212,0.25);
  color: #be185d;
  border-color: rgba(249,168,212,0.5);
}
.page-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }


/* â”€â”€ í…Œë§ˆ: ë‹¤í¬ëª¨ë“œ â”€â”€ */
[data-theme="dark"] body {
  background: linear-gradient(-45deg, #0d0b1e, #1a1035, #0b1528, #1e1040, #0a1020, #160d30) !important;
  background-size: 400% 400% !important;
  animation: bgShift 24s ease infinite !important;
}
/* â”€â”€ ë³„ (ë‹¤í¬ëª¨ë“œ ì „ìš©) â”€â”€ */
.star {
  position: fixed;
  border-radius: 50%;
  pointer-events: none;
  z-index: -1;
  animation: starTwinkle var(--dur) ease-in-out var(--delay) infinite;
  opacity: 0;
  display: none;
  will-change: opacity;
}
[data-theme="dark"] .star { display: block; }
@keyframes starTwinkle {
  0%   { opacity: 0;           transform: scale(0.7); }
  40%  { opacity: var(--peak); transform: scale(1); }
  60%  { opacity: var(--peak); transform: scale(1); }
  100% { opacity: 0;           transform: scale(0.7); }
}
[data-theme="dark"] .clay-card {
  background: rgba(38,36,58,0.93) !important;
  border-color: rgba(255,255,255,0.1) !important;
  box-shadow: 0 8px 32px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.2) !important;
}
/* ë‹¤í¬ëª¨ë“œ ë²„íŠ¼: ì±„ë„Â·ë°ê¸° ë‚®ì¶° í˜•ê´‘ ì œê±° */
[data-theme="dark"] .btn-primary {
  background: linear-gradient(135deg, #c4607a, #b04d70) !important;
  box-shadow: 0 4px 14px rgba(180,80,110,0.3) !important;
}
[data-theme="dark"] .btn-purple {
  background: linear-gradient(135deg, #7c6bbf, #6657b0) !important;
  color: #e8e0ff !important;
  box-shadow: 0 4px 14px rgba(100,90,170,0.3) !important;
}
[data-theme="dark"] .btn-green {
  background: linear-gradient(135deg, #3a9b6e, #2d7d58) !important;
  color: #d1fae5 !important;
  box-shadow: 0 4px 14px rgba(45,125,90,0.3) !important;
}
[data-theme="dark"] .btn-pink {
  background: linear-gradient(135deg, #b06080, #904060) !important;
  color: #fce4ec !important;
  box-shadow: 0 4px 12px rgba(144,64,96,0.3) !important;
}
[data-theme="dark"] .btn-gray {
  background: rgba(255,255,255,0.08) !important;
  color: #a0a0b8 !important;
  border-color: rgba(255,255,255,0.12) !important;
}
[data-theme="dark"] .tab-btn.active {
  background: linear-gradient(135deg, #b05878, #8050b8) !important;
}
[data-theme="dark"] .field {
  background: rgba(255,255,255,0.07) !important;
  border-color: rgba(255,255,255,0.12) !important;
  color: #e2e8f0 !important;
}
[data-theme="dark"] .field::placeholder { color: #5a5870 !important; }
[data-theme="dark"] .tab-btn { color: #9490b8 !important; }
[data-theme="dark"] .tab-btn.active { color: #fff !important; }
[data-theme="dark"] .acorn-pill {
  background: linear-gradient(135deg,#92400e,#b45309) !important;
  color: #fde68a !important;
}

/* ë‹¤í¬: í…ìŠ¤íŠ¸ */
[data-theme="dark"] .text-gray-800,
[data-theme="dark"] .font-black.text-gray-800 { color: #d4cfe8 !important; }
[data-theme="dark"] .text-gray-700 { color: #bbb8cc !important; }
[data-theme="dark"] .text-gray-600 { color: #a0a0bc !important; }
[data-theme="dark"] .text-gray-500 { color: #8888a4 !important; }
[data-theme="dark"] .text-gray-400 { color: #7070a0 !important; }
[data-theme="dark"] .text-amber-900 { color: #e8c96a !important; }
[data-theme="dark"] .text-amber-700 { color: #dab84e !important; }
[data-theme="dark"] .text-amber-600 { color: #cda040 !important; }
[data-theme="dark"] .text-amber-500 { color: #b88830 !important; }

/* ë‹¤í¬: ë°°ê²½ ë±ƒì§€/ë°•ìŠ¤ */
[data-theme="dark"] .bg-gray-50    { background: rgba(255,255,255,0.04) !important; }
[data-theme="dark"] .bg-amber-50   { background: rgba(245,158,11,0.12) !important; }
[data-theme="dark"] .bg-pink-50    { background: rgba(236,72,153,0.1) !important; }
[data-theme="dark"] .bg-yellow-100 { background: rgba(251,191,36,0.1) !important; }
[data-theme="dark"] .bg-green-100  { background: rgba(34,197,94,0.1) !important; }
[data-theme="dark"] .bg-white      { background: rgba(30,30,46,0.9) !important; }
[data-theme="dark"] .divide-gray-50 > * + * { border-color: rgba(255,255,255,0.06) !important; }
[data-theme="dark"] .border-gray-100 { border-color: rgba(255,255,255,0.08) !important; }
[data-theme="dark"] .border-b-2 { border-color: rgba(255,255,255,0.08) !important; }
[data-theme="dark"] select,
[data-theme="dark"] option { background: #1e1e2e !important; color: #e2e8f0 !important; }
[data-theme="dark"] .stat-card { background: rgba(30,30,46,0.92) !important; border-color: rgba(255,255,255,0.08) !important; }
[data-theme="dark"] .modal-overlay { background: rgba(0,0,0,0.7) !important; inset: 0 !important; width: 100vw !important; height: 100vh !important; }
[data-theme="dark"] .login-card { background: rgba(20,20,32,0.95) !important; }
[data-theme="dark"] .h-px { background: rgba(255,255,255,0.1) !important; }
[data-theme="dark"] .page-nav-btn { background: rgba(255,255,255,0.08) !important; color: #e2e8f0 !important; border-color: rgba(255,255,255,0.1) !important; }

/* â”€â”€ ë‹¤í¬: ëˆ„ë½ í…ìŠ¤íŠ¸ ìƒ‰ìƒ â”€â”€ */
[data-theme="dark"] .text-amber-800  { color: #d4a843 !important; }
[data-theme="dark"] .text-gray-300   { color: #5a5870 !important; }
[data-theme="dark"] .text-green-700  { color: #4ade80 !important; }
[data-theme="dark"] .text-green-600  { color: #34d399 !important; }
[data-theme="dark"] .text-red-600    { color: #f87171 !important; }
[data-theme="dark"] .text-red-500    { color: #fca5a5 !important; }
[data-theme="dark"] .text-red-400    { color: #fecaca !important; }
[data-theme="dark"] .text-purple-600 { color: #c084fc !important; }
[data-theme="dark"] .text-blue-700   { color: #60a5fa !important; }
[data-theme="dark"] .text-orange-700 { color: #fb923c !important; }
[data-theme="dark"] .text-orange-500 { color: #fdba74 !important; }

/* â”€â”€ ë‹¤í¬: ëˆ„ë½ ë°°ê²½ ìƒ‰ìƒ â”€â”€ */
[data-theme="dark"] .bg-amber-100  { background: rgba(245,158,11,0.15) !important; }
[data-theme="dark"] .bg-gray-100   { background: rgba(255,255,255,0.06) !important; }
[data-theme="dark"] .bg-gray-200   { background: rgba(255,255,255,0.09) !important; }
[data-theme="dark"] .bg-red-50     { background: rgba(239,68,68,0.08) !important; }
[data-theme="dark"] .bg-red-100    { background: rgba(239,68,68,0.13) !important; }
[data-theme="dark"] .bg-blue-100   { background: rgba(96,165,250,0.12) !important; }
[data-theme="dark"] .bg-purple-100 { background: rgba(192,132,252,0.12) !important; }
[data-theme="dark"] .bg-pink-100   { background: rgba(236,72,153,0.1) !important; }

/* â”€â”€ ë‹¤í¬: ì»¤ìŠ¤í…€ ë°°ì§€ â”€â”€ */
[data-theme="dark"] .qs-done       { background: rgba(34,197,94,0.15) !important; color: #4ade80 !important; }
[data-theme="dark"] .qs-pending    { background: rgba(245,158,11,0.15) !important; color: #fcd34d !important; }
[data-theme="dark"] .qs-inprogress { background: rgba(139,92,246,0.15) !important; color: #c084fc !important; }
[data-theme="dark"] .ct-auto       { background: rgba(245,158,11,0.15) !important; color: #fcd34d !important; }
[data-theme="dark"] .ct-approval   { background: rgba(236,72,153,0.13) !important; color: #f9a8d4 !important; }
[data-theme="dark"] .tx-plus       { color: #4ade80 !important; }
[data-theme="dark"] .tx-minus      { color: #f87171 !important; }
[data-theme="dark"] .badge-soldout    { background: rgba(239,68,68,0.15) !important; color: #fca5a5 !important; }
[data-theme="dark"] .badge-stock      { background: rgba(139,92,246,0.15) !important; color: #c084fc !important; }
[data-theme="dark"] .badge-unlimited  { background: rgba(34,197,94,0.13) !important; color: #4ade80 !important; }
[data-theme="dark"] .badge-gacha-pct  { background: rgba(139,92,246,0.15) !important; color: #c084fc !important; }
[data-theme="dark"] .badge-prob       { background: rgba(139,92,246,0.15) !important; color: #c084fc !important; }

/* â”€â”€ ë‹¤í¬: stat-card â”€â”€ */
[data-theme="dark"] .sc-orange { background: rgba(251,146,60,0.12) !important; border-color: rgba(251,146,60,0.2) !important; }
[data-theme="dark"] .sc-blue   { background: rgba(96,165,250,0.12) !important; border-color: rgba(96,165,250,0.2) !important; }
[data-theme="dark"] .sc-green  { background: rgba(34,197,94,0.12) !important; border-color: rgba(34,197,94,0.2) !important; }
[data-theme="dark"] .sc-purple { background: rgba(192,132,252,0.12) !important; border-color: rgba(192,132,252,0.2) !important; }
[data-theme="dark"] .text-orange-700 { color: #fb923c !important; }
[data-theme="dark"] .text-blue-700   { color: #60a5fa !important; }
[data-theme="dark"] .text-green-700  { color: #4ade80 !important; }
[data-theme="dark"] .text-purple-700 { color: #c084fc !important; }
[data-theme="dark"] .text-orange-500 { color: #fdba74 !important; }
[data-theme="dark"] .text-blue-500   { color: #93c5fd !important; }
[data-theme="dark"] .text-green-500  { color: #6ee7b7 !important; }
[data-theme="dark"] .text-purple-500 { color: #d8b4fe !important; }

/* â”€â”€ ë‹¤í¬: row-item-bg (ì¸ë¼ì¸ bg ëŒ€ì²´) â”€â”€ */
.row-item-bg { background: rgba(255,255,255,0.5); border-radius: 12px; }
[data-theme="dark"] .row-item-bg { background: rgba(255,255,255,0.05) !important; }

/* â”€â”€ ë‹¤í¬: ëª¨ë‹¬ ì•ˆë‚´ë°•ìŠ¤ â”€â”€ */
.modal-notice-box {
  background: rgba(245,158,11,0.12);
  border: 1px solid rgba(245,158,11,0.25);
  border-radius: 14px;
  padding: 10px 12px;
  margin-bottom: 14px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  color: #92400e;
  line-height: 1.55;
}
[data-theme="dark"] .modal-notice-box {
  background: rgba(245,158,11,0.1) !important;
  border-color: rgba(245,158,11,0.2) !important;
  color: #fcd34d !important;
}
.modal-notice-text { font-size: 14px; font-weight: 700; color: inherit; }
.modal-notice-sub  { font-size: 12px; font-weight: 700; color: #059669; margin-top: 4px; }
[data-theme="dark"] .modal-notice-sub { color: #4ade80 !important; }

/* â”€â”€ ë‹¤í¬: ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ â”€â”€ */
[data-theme="dark"] .modal-overlay { background: rgba(0,0,0,0.7) !important; inset: 0 !important; width: 100vw !important; height: 100vh !important; }
[data-theme="dark"] .modal-box {
  background: rgba(34,32,52,0.97) !important;
  border-color: rgba(255,255,255,0.1) !important;
}

/* í…Œë§ˆ í† ê¸€ ë²„íŠ¼ */
/* ë‹¤í¬ëª¨ë“œì—ì„œ ë„í† ë¦¬ ì´ëª¨ì§€ ì–´ë‘¡ê²Œ */
[data-theme="dark"] #headerAcornEmoji {
  filter: brightness(0.55) sepia(0.3) !important;
}
/* í—¤ë” ì•„ì´ì½˜ ë²„íŠ¼ (ì¢…) */
/* í—¤ë” ì¢… ë²„íŠ¼ */
.header-icon-btn {
  position: relative;
  width: 46px; height: 46px;
  border-radius: 50%;
  border: 2px solid rgba(200,180,240,0.5);
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(8px);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .2s;
  box-shadow: 0 2px 10px rgba(160,100,220,0.15);
  flex-shrink: 0;
  padding: 0;
}
.header-icon-btn:hover { transform: scale(1.07); }
.header-icon-emoji {
  display: flex; align-items: center; justify-content: center;
  width: 100%; height: 100%;
  font-size: 22px; line-height: 1;
}
[data-theme="dark"] .header-icon-btn {
  background: rgba(45,40,70,0.9) !important;
  border-color: rgba(255,255,255,0.1) !important;
}
/* í—¤ë” ë„í† ë¦¬/í‹°ì¼“ í…ìŠ¤íŠ¸ */
.header-stats {
  display: flex; flex-direction: column; align-items: flex-end; gap: 2px;
}
.header-stat-ticket {
  font-family: 'Jua', 'Nunito', sans-serif;
  font-size: 14px; font-weight: 900;
  color: #6d28d9; letter-spacing: -0.3px;
}
.header-stat-acorn {
  font-family: 'Jua', 'Nunito', sans-serif;
  font-size: 14px; font-weight: 900;
  color: #78350f; letter-spacing: -0.3px;
}
[data-theme="dark"] .header-stat-acorn { color: #fde68a; }
[data-theme="dark"] .header-stat-ticket { color: #c4b5fd; }
/* í•˜ìœ„í˜¸í™˜ (acorn-pill-header idëŠ” ìœ ì§€) */
.acorn-pill-header { display: none; }
/* ë¡œê·¸ì•„ì›ƒ ì‘ì€ ë²„íŠ¼ */
.btn-logout-sm {
  font-size: 11px;
  font-weight: 700;
  color: rgba(120,80,160,0.55);
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 6px;
  transition: color .2s;
  font-family: 'Nunito', sans-serif;
}
.btn-logout-sm:hover { color: rgba(120,80,160,0.9); }
[data-theme="dark"] .btn-logout-sm { color: rgba(160,150,200,0.45) !important; }
[data-theme="dark"] .btn-logout-sm:hover { color: rgba(160,150,200,0.8) !important; }


/* â”€â”€ ì‚¬ìš©ì í˜„í™©íŒ â”€â”€ */
.status-card { background:rgba(255,255,255,0.78); backdrop-filter:blur(18px); border-radius:24px; border:1.5px solid rgba(255,255,255,0.9); box-shadow:0 6px 24px rgba(180,140,200,0.13); overflow:hidden; }
.status-card-header { display:flex; align-items:center; gap:12px; padding:14px 16px 12px; border-bottom:1.5px solid rgba(210,180,240,0.15); }
.sc-avatar { font-size:2rem; }
.sc-name { font-family:'Jua',sans-serif; font-size:16px; color:#2d1554; }
.sc-sub  { font-size:11px; color:#a78bfa; margin-top:1px; font-weight:700; }
.sc-acorn { font-family:'Jua',sans-serif; font-size:17px; color:#78350f; margin-left:auto; }
.sc-body { padding:14px 16px; }
.sc-label { font-family:'Jua',sans-serif; font-size:10px; color:#c4aee0; letter-spacing:.08em; text-transform:uppercase; margin-bottom:8px; display:block; }
.sc-divider { height:1px; background:rgba(210,180,240,0.15); margin:12px 0; }

/* ë‚ ì§œ ë„¤ë¹„ */
.date-nav { display:flex; align-items:center; background:rgba(255,255,255,0.6); border-radius:16px; border:1.5px solid rgba(210,180,240,0.2); overflow:hidden; margin-bottom:10px; }
.date-arrow { width:38px; height:38px; border:none; background:transparent; font-size:1rem; color:#c084fc; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:background .15s; }
.date-arrow:hover { background:rgba(192,132,252,0.1); }
.date-arrow:disabled { color:#e2d9f3; cursor:default; }
.date-center { flex:1; text-align:center; }
.date-center-label { font-family:'Jua',sans-serif; font-size:13px; color:#4b3060; }
.date-center-sub { font-size:10px; color:#a78bfa; font-weight:700; display:block; margin-top:1px; }

/* ë‚ ì§œ ìš”ì•½ */
.date-summary { display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap; }
.ds-pill { font-family:'Jua',sans-serif; font-size:11px; padding:3px 10px; border-radius:10px; }

/* íšŒì°¨ */
.gacha-session-card { border-radius:16px; border:1.5px solid rgba(210,180,240,0.2); background:rgba(255,255,255,0.5); margin-bottom:7px; overflow:hidden; }
.gacha-session-card.sc-latest { border-color:rgba(52,211,153,0.35); background:rgba(52,211,153,0.04); }
.gsc-header { display:flex; align-items:center; gap:7px; padding:10px 12px; cursor:pointer; user-select:none; }
.gsc-badge { font-family:'Jua',sans-serif; font-size:11px; padding:3px 9px; border-radius:10px; white-space:nowrap; }
.gsc-cost { font-size:11px; font-weight:800; color:#dc2626; white-space:nowrap; }
.gsc-gain { font-size:11px; font-weight:800; color:#059669; white-space:nowrap; }
.gsc-time { font-size:10px; color:#c4b5fd; margin-left:auto; white-space:nowrap; }
.gsc-arrow { font-size:11px; color:#c4b5fd; transition:transform .2s; flex-shrink:0; }
.gsc-arrow.open { transform:rotate(180deg); }
.gsc-body { padding:0 10px 10px; display:flex; gap:6px; overflow-x:auto; }
.gsc-body::-webkit-scrollbar { display:none; }
.gsc-body.closed { display:none; }

/* ë½‘ê¸° ê²°ê³¼ ì¹© */
.g-chip { display:flex; flex-direction:column; align-items:center; gap:3px; flex-shrink:0; border-radius:13px; padding:8px 10px; min-width:60px; background:rgba(52,211,153,0.1); border:1.5px solid rgba(52,211,153,0.2); }
.g-chip.acorn  { background:rgba(251,191,36,0.1);  border-color:rgba(251,191,36,0.3); }
.g-chip.ticket { background:rgba(167,139,250,0.1); border-color:rgba(167,139,250,0.3); }
.g-chip-icon { font-size:1.35rem; line-height:1; }
.g-chip-name { font-size:9px; font-weight:800; color:#374151; text-align:center; line-height:1.3; max-width:56px; }
.g-chip-amt  { font-family:'Jua',sans-serif; font-size:11px; color:#059669; }
.g-chip-amt.a { color:#d97706; }
.g-chip-amt.t { color:#7c3aed; }

/* ì¸ë²¤í† ë¦¬ */
.inv-grid2 { display:grid; grid-template-columns:1fr 1fr; gap:7px; }
.inv-chip2 { display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.7); border:1.5px solid rgba(210,180,240,0.25); border-radius:14px; padding:9px 11px; }
.inv-chip2.pending { border-color:rgba(251,191,36,0.4); background:rgba(251,191,36,0.06); }
.ic2-icon { font-size:1.3rem; flex-shrink:0; }
.ic2-name { font-size:11px; font-weight:800; color:#3b1f5e; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ic2-status { font-size:10px; margin-top:1px; }
.ic2-held    { color:#a78bfa; }
.ic2-pending { color:#d97706; }
.inv-empty2 { grid-column:span 2; text-align:center; font-size:11px; color:#d1d5db; font-weight:700; padding:8px 0; }
</style>
</head>
<body>

<!-- â”€â”€ ë¡œë”© â”€â”€ -->
<div id="loadingScreen" class="loading-screen hidden">
  <div class="text-6xl">ğŸŒ°</div>
  <div class="spinner"></div>
  <p class="text-sm font-bold text-amber-600">ë¡œë”© ì¤‘...</p>
</div>

<!-- â”€â”€ ë¡œê·¸ì¸ â”€â”€ -->
<div id="loginScreen" class="login-screen">
  <div class="login-card bounce-in">
    <div class="text-center mb-8">
      <div class="text-6xl mb-3">ğŸŒ°</div>
      <h1 class="text-3xl font-black text-amber-900">ë„í† ë¦¬ ìƒì </h1>
      <p class="text-sm text-amber-600 font-semibold mt-1">Acorn Shop âœ¨</p>
    </div>

    <!-- ì´ë©”ì¼ ë¡œê·¸ì¸ -->
    <div class="space-y-3 mb-4">
      <input class="field" type="email" id="loginEmail" placeholder="ì´ë©”ì¼" onkeydown="if(event.key==='Enter')doEmailLogin()">
      <input class="field" type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key==='Enter')doEmailLogin()">
      <div id="loginErr" class="hidden text-xs text-red-500 font-bold text-center pt-1"></div>
    </div>
    <button class="btn btn-primary w-full py-4 text-base mb-3" onclick="doEmailLogin()">ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸</button>

    <!-- êµ¬ë¶„ì„  -->
    <div class="flex items-center gap-3 mb-3">
      <div class="flex-1 h-px bg-gray-200"></div>
      <span class="text-xs text-gray-400 font-semibold">ë˜ëŠ”</span>
      <div class="flex-1 h-px bg-gray-200"></div>
    </div>

    <!-- ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ -->
    <button class="btn btn-kakao w-full py-4 text-base mb-4" onclick="doKakaoLogin()">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none" style="flex-shrink:0">
        <path d="M9 1.5C4.86 1.5 1.5 4.14 1.5 7.38c0 2.1 1.35 3.93 3.39 4.98L4.05 15l3.57-2.43c.45.06.9.09 1.38.09 4.14 0 7.5-2.64 7.5-5.88C16.5 4.14 13.14 1.5 9 1.5z" fill="#191919"/>
      </svg>
      ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸
    </button>

    <!-- íšŒì›ê°€ì… -->
    <div class="text-center">
      <button class="text-xs text-amber-600 font-bold underline" onclick="showSignup()">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ì•± ë£¨íŠ¸ â”€â”€ -->
<div id="appRoot" class="hidden min-h-screen p-4" style="position:relative;z-index:0">
<div class="max-w-2xl mx-auto">

  <!-- í—¤ë” -->
  <div class="mb-5">
    <!-- ë¡œê·¸ì•„ì›ƒ: ìµœìƒë‹¨ ìš°ì¸¡ -->
    <div class="flex justify-end mb-1">
      <button class="btn-logout-sm hidden" id="logoutBtn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <!-- ë©”ì¸ í—¤ë” -->
    <div class="flex items-center justify-between">
      <!-- ì¢Œì¸¡: ë„í† ë¦¬ ì´ëª¨ì§€(í…Œë§ˆí† ê¸€) + íƒ€ì´í‹€ -->
      <div class="flex items-center gap-4">
        <div id="headerAcornEmoji" onclick="toggleTheme()" title="í…Œë§ˆ ì „í™˜"
          style="font-size:3.2rem;line-height:1;cursor:pointer;transition:filter .3s,transform .2s;filter:drop-shadow(0 2px 8px rgba(180,100,0,0.25));user-select:none"
          onmouseover="this.style.transform='scale(1.08)'" onmouseout="this.style.transform='scale(1)'">ğŸŒ°</div>
        <div>
          <h1 class="font-black text-amber-900" style="font-size:1.35rem;line-height:1.2">ë„í† ë¦¬ ìƒì </h1>
          <p class="text-xs text-amber-500 font-bold mt-0.5" id="headerUserLabel">Acorn Shop âœ¨</p>
        </div>
      </div>
      <!-- ìš°ì¸¡: ë„í† ë¦¬ + í‹°ì¼“ + ì¢… -->
      <div class="flex items-center gap-3" id="headerRight" style="display:none!important">
        <div class="header-stats">
          <span class="header-stat-ticket" id="headerTickets">ğŸ« 0</span>
          <span class="header-stat-acorn" id="headerAcorns">ğŸŒ° 0</span>
        </div>
        <button class="header-icon-btn" onclick="showNotifications()" id="notifBtn">
          <span class="header-icon-emoji">ğŸ””</span>
          <span class="notif-dot hidden" id="notifDot"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- â”€â”€ ì‚¬ìš©ì ëª¨ë“œ â”€â”€ -->
  <div id="userMode" class="hidden">
    <div id="userTabBar" class="flex gap-1 mb-5 clay-card p-2" style="overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;cursor:grab">
      <button class="tab-btn active" onclick="uTab('shop',this)" style="flex-shrink:0">ğŸ›ï¸ ìƒì </button>
      <button class="tab-btn" onclick="uTab('gacha',this)" style="flex-shrink:0">ğŸ² ë½‘ê¸°</button>
      <button class="tab-btn" onclick="uTab('quest',this)" style="flex-shrink:0">ğŸ“‹ í€˜ìŠ¤íŠ¸</button>
      <button class="tab-btn" onclick="uTab('recycle',this)" style="flex-shrink:0">â™»ï¸ ì¬í™œìš©</button>
      <button class="tab-btn" onclick="uTab('mypage',this)" style="flex-shrink:0">ğŸ‘¤ ë§ˆì´</button>
    </div>
    <div id="utab-shop">
      <p class="text-sm font-bold text-amber-700 mb-3 px-1">ğŸ›’ êµ¬ë§¤ ê°€ëŠ¥í•œ ìƒí’ˆ</p>
      <div id="shopGrid" class="grid grid-cols-2 gap-3"></div>
    </div>
    <div id="utab-gacha" class="hidden">
      <div class="clay-card p-6 text-center mb-4">
        <div class="text-6xl mb-3" id="gachaIcon">ğŸ</div>
        <h2 class="text-xl font-black text-gray-800 mb-1">ë„í† ë¦¬ ë½‘ê¸°</h2>
        <p class="text-sm text-gray-400 font-semibold mb-4">1íšŒ = <span class="text-amber-600 font-black">ğŸŒ° 10</span> &nbsp;|&nbsp; 5íšŒ = <span class="text-amber-600 font-black">ğŸŒ° 50</span></p>
        <div id="freeGachaNotice" class="hidden text-xs font-bold rounded-2xl px-3 py-2 mb-3" style="background:rgba(220,252,231,0.8);color:#166534;border:1.5px solid rgba(34,197,94,0.3)"></div>
        <div class="flex justify-center gap-3">
          <button class="btn btn-primary px-8 py-3 text-base" id="btn-gacha1" onclick="doGacha(1)">1íšŒ ë½‘ê¸°</button>
          <button class="btn btn-purple px-8 py-3 text-base" id="btn-gacha5" onclick="doGacha(5)">5íšŒ ë½‘ê¸°</button>
        </div>
      </div>
      <!-- ë½‘ê¸° ì—°ì¶œ ìŠ¤í”¼ë„ˆ -->
      <div id="gachaSpinner" class="hidden">
        <div class="text-6xl" id="gachaSpinIcon">ğŸ</div>
        <p id="gachaSpinMsg" class="text-sm font-black text-amber-600">ë‘ê·¼ë‘ê·¼...</p>
      </div>

      <div id="gachaResult" class="hidden clay-card p-6 text-center mb-4">
        <p class="text-sm font-bold text-gray-400 mb-4">ğŸ‰ ê²°ê³¼!</p>
        <div id="gachaResultItems" class="flex flex-wrap justify-center gap-4"></div>
      </div>
      <div class="clay-card p-4 mb-4">
        <p class="text-sm font-black text-gray-700 mb-3">ğŸ“Š ë½‘ê¸° ìƒí’ˆ & í™•ë¥ </p>
        <div id="gachaProbTable" class="space-y-1">
          <p class="text-xs text-gray-400 text-center py-2">ë¡œë”© ì¤‘...</p>
        </div>
      </div>
    </div>
    <div id="utab-quest" class="hidden">
      <p class="text-sm font-bold text-amber-700 mb-3 px-1">ğŸ“‹ í€˜ìŠ¤íŠ¸</p>
      <div id="questList" class="space-y-3"></div>
    </div>
    <!-- â™»ï¸ ì¬í™œìš©ì„¼í„° íƒ­ -->
    <div id="utab-recycle" class="hidden">
      <!-- ë°°ê²½ í—¤ë” -->
      <div class="recycle-hero clay-card mb-4 p-6 text-center relative overflow-hidden">
        <div class="recycle-bg-deco" aria-hidden="true">
          <span>ğŸŒ¿</span><span>ğŸƒ</span><span>ğŸŒ±</span><span>â™»ï¸</span>
          <span>ğŸŒ¿</span><span>ğŸƒ</span><span>ğŸŒ±</span><span>â™»ï¸</span>
        </div>
        <div class="relative z-10">
          <div style="font-size:3.5rem;line-height:1;margin-bottom:8px;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.12))">â™»ï¸</div>
          <h2 class="text-xl font-black text-green-800 mb-1">ì¬í™œìš© ì„¼í„°</h2>
          <p class="text-sm text-green-600 font-bold">í•„ìš”ì—†ëŠ” ì•„ì´í…œì„ íŒ”ê³  ë„í† ë¦¬ë¥¼ ë°›ì•„ìš”!</p>
        </div>
      </div>

      <!-- ë§¤ì… ì¤‘ì¸ ì•„ì´í…œ ëª©ë¡ -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">ğŸ’° ì˜¤ëŠ˜ì˜ ë§¤ì… ëª©ë¡</p>
          <span class="text-xs text-gray-400">ì•„ì´í…œ ì¹´ë“œë¥¼ ëˆŒëŸ¬ íŒë§¤</span>
        </div>
        <div id="recycleShopList" class="space-y-2"></div>
      </div>

      <!-- ë‚´ íŒë§¤ ê°€ëŠ¥ ì•„ì´í…œ -->
      <div class="clay-card p-5 mb-28">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">ğŸ’ ë‚´ íŒë§¤ ê°€ëŠ¥ ì•„ì´í…œ</p>
          <span class="text-xs font-bold text-green-600" id="recycleSelCount"></span>
        </div>
        <div id="recycleInventoryList" class="grid grid-cols-3 gap-2"></div>
        <p id="recycleEmptyMsg" class="text-sm text-gray-400 text-center py-6 hidden">íŒë§¤ ê°€ëŠ¥í•œ ì•„ì´í…œì´ ì—†ì–´ìš”</p>
      </div>

      <!-- í•˜ë‹¨ ê³ ì • íŒë§¤ ë²„íŠ¼ -->
      <div id="recycleSellBar" class="recycle-sell-bar hidden">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-black text-white" id="recycleSellLabel">ì„ íƒí•œ ì•„ì´í…œ íŒë§¤</p>
            <p class="text-xs text-green-100" id="recycleSellSub"></p>
          </div>
          <button class="recycle-sell-btn" onclick="confirmRecycleSell()">ğŸ’° íŒë§¤í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <div id="utab-mypage" class="hidden">
      <div class="clay-card p-6 mb-4" id="mypageHeader"></div>

      <!-- ì¸ë²¤í† ë¦¬ -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">ğŸ’ ì¸ë²¤í† ë¦¬</p>
          <span class="text-xs text-gray-400 font-semibold">ì‚¬ìš© | íŒë§¤ëŠ” â™»ï¸ ì¬í™œìš© íƒ­ì—ì„œ</span>
        </div>
        <div id="myInventory" class="grid grid-cols-3 gap-2"></div>
      </div>

      <!-- ìƒí’ˆ ì‹ ì²­ í˜„í™© -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">ğŸ“¦ ìƒí’ˆ ì‹ ì²­ í˜„í™©</p>
          <div class="flex items-center gap-2">
            <button id="reqPrevBtn" class="page-nav-btn" onclick="moveReqPage(-1)">â€¹</button>
            <span id="reqPageLabel" class="text-xs font-bold text-gray-400"></span>
            <button id="reqNextBtn" class="page-nav-btn" onclick="moveReqPage(1)">â€º</button>
          </div>
        </div>
        <div id="myRequestList" class="space-y-2"></div>
      </div>

      <!-- í€˜ìŠ¤íŠ¸ ì‹ ì²­ í˜„í™© -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">ğŸ“‹ í€˜ìŠ¤íŠ¸ ì‹ ì²­ í˜„í™©</p>
          <div class="flex items-center gap-2">
            <button id="qcrPrevBtn" class="page-nav-btn" onclick="moveQcrPage(-1)">â€¹</button>
            <span id="qcrPageLabel" class="text-xs font-bold text-gray-400"></span>
            <button id="qcrNextBtn" class="page-nav-btn" onclick="moveQcrPage(1)">â€º</button>
          </div>
        </div>
        <div id="myQuestReqList" class="space-y-2"></div>
      </div>

      <!-- ë½‘ê¸° ê¸°ë¡ -->
      <div class="clay-card p-5 mb-4">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">ğŸ² ë½‘ê¸° ê¸°ë¡</p>
          <div class="flex items-center gap-2">
            <button id="glogPrevBtn" class="page-nav-btn" onclick="moveGlogPage(-1)">â€¹</button>
            <span id="glogPageLabel" class="text-xs font-bold text-gray-400"></span>
            <button id="glogNextBtn" class="page-nav-btn" onclick="moveGlogPage(1)">â€º</button>
          </div>
        </div>
        <div id="myGachaLogList" class="space-y-2"></div>
      </div>

      <!-- ë„í† ë¦¬ ë‚´ì—­ -->
      <div class="clay-card p-5">
        <div class="flex items-center justify-between mb-3">
          <p class="text-sm font-black text-gray-700">ğŸ“œ ë„í† ë¦¬ ë‚´ì—­</p>
          <div class="flex items-center gap-2">
            <button id="txPrevBtn" class="page-nav-btn" onclick="moveTxPage(-1)">â€¹</button>
            <span id="txPageLabel" class="text-xs font-bold text-gray-400"></span>
            <button id="txNextBtn" class="page-nav-btn" onclick="moveTxPage(1)">â€º</button>
          </div>
        </div>
        <div id="myTxList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ ê´€ë¦¬ì ëª¨ë“œ â”€â”€ -->
  <div id="adminMode" class="hidden">
    <div id="adminTabBar" class="flex gap-1 mb-5 clay-card p-2">
      <button class="tab-btn active" onclick="aTab('dashboard',this)">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
      <button class="tab-btn" onclick="aTab('requests',this)">ğŸ“¬ ì‹ ì²­ëª©ë¡<span class="req-badge hidden" id="reqBadge"></span></button>
      <button class="tab-btn" onclick="aTab('products',this)">ğŸ›ï¸ ìƒí’ˆ</button>
      <button class="tab-btn" onclick="aTab('gachaTest',this)">ğŸ² ë½‘ê¸°</button>
      <button class="tab-btn" onclick="aTab('quests',this)">ğŸ“‹ í€˜ìŠ¤íŠ¸</button>
      <button class="tab-btn" onclick="aTab('recycle',this)">â™»ï¸ ì¬í™œìš©ì„¼í„°</button>
      <button class="tab-btn" onclick="aTab('events',this)">ğŸ‰ ì´ë²¤íŠ¸</button>
      <button class="tab-btn" onclick="aTab('give',this)">ğŸŒ° ì§€ê¸‰</button>
      <button class="tab-btn" onclick="aTab('txlog',this)">ğŸ—‚ï¸ ë¡œê·¸</button>
      <button class="tab-btn" onclick="aTab('users',this)">ğŸ‘¥ íšŒì›</button>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ -->
    <div id="atab-dashboard">
      <!-- ìƒë‹¨: í˜„í™©(ì¢Œ) + ë©”ë‰´ ì ê²€(ìš°) -->
      <div class="flex gap-3 mb-5 items-stretch">
        <!-- ì¢Œ: ì˜¤ëŠ˜ í˜„í™© 4ê°œ ì†Œí˜• -->
        <div class="flex flex-col gap-2" style="flex:0 0 auto;min-width:130px">
          <p class="text-xs font-black text-amber-600 uppercase tracking-wider px-1">ì˜¤ëŠ˜ í˜„í™©</p>
          <div class="clay-card p-3 flex items-center gap-2 bounce-in">
            <span class="text-lg">ğŸ‘¥</span>
            <div><div class="text-base font-black text-orange-700 leading-none" id="ds-users">â€”</div><div class="text-xs text-orange-400 font-bold">ì „ì²´ ì‚¬ìš©ì</div></div>
          </div>
          <div class="clay-card p-3 flex items-center gap-2 bounce-in" style="animation-delay:.05s">
            <span class="text-lg">ğŸ²</span>
            <div><div class="text-base font-black text-blue-700 leading-none" id="ds-todayGacha">â€”</div><div class="text-xs text-blue-400 font-bold">ì˜¤ëŠ˜ ë½‘ê¸°</div></div>
          </div>
          <div class="clay-card p-3 flex items-center gap-2 bounce-in" style="animation-delay:.1s">
            <span class="text-lg">â¬†ï¸</span>
            <div><div class="text-base font-black text-green-700 leading-none" id="ds-todayGiven">â€”</div><div class="text-xs text-green-400 font-bold">ì˜¤ëŠ˜ ì§€ê¸‰</div></div>
          </div>
          <div class="clay-card p-3 flex items-center gap-2 bounce-in" style="animation-delay:.15s">
            <span class="text-lg">â¬‡ï¸</span>
            <div><div class="text-base font-black text-purple-700 leading-none" id="ds-todayUsed">â€”</div><div class="text-xs text-purple-400 font-bold">ì˜¤ëŠ˜ ì‚¬ìš©</div></div>
          </div>
        </div>

        <!-- ìš°: ë©”ë‰´ ì ê²€ í† ê¸€ -->
        <div class="clay-card p-4 flex-1 flex flex-col">
          <p class="text-xs font-black text-amber-600 uppercase tracking-wider mb-3 px-1">ë©”ë‰´ ì ê²€ ê´€ë¦¬</p>
          <div class="flex flex-col gap-2 flex-1 justify-around">
            <div class="flex items-center justify-between">
              <span class="text-sm font-black text-gray-700">ğŸ›ï¸ ìƒì </span>
              <button id="maint-shop" onclick="toggleMaintenance('shop')" class="maint-btn"></button>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-black text-gray-700">ğŸ² ë½‘ê¸°</span>
              <button id="maint-gacha" onclick="toggleMaintenance('gacha')" class="maint-btn"></button>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-black text-gray-700">ğŸ“‹ í€˜ìŠ¤íŠ¸</span>
              <button id="maint-quest" onclick="toggleMaintenance('quest')" class="maint-btn"></button>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-black text-gray-700">â™»ï¸ ì¬í™œìš©</span>
              <button id="maint-recycle" onclick="toggleMaintenance('recycle')" class="maint-btn"></button>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-black text-gray-700">ğŸ‘¤ ë§ˆì´</span>
              <button id="maint-mypage" onclick="toggleMaintenance('mypage')" class="maint-btn"></button>
            </div>
          </div>
        </div>
      </div>

      <p class="text-xs font-black text-amber-600 uppercase tracking-wider mb-3 px-1">ìµœê·¼ í™œë™</p>
      <div class="clay-card p-4"><div id="ds-activityLog"></div></div>
    </div>

    <!-- ì§€ê¸‰ -->
    <div id="atab-give" class="hidden">
      <div class="clay-card p-6">
        <h2 class="text-lg font-black text-gray-800 mb-5">ğŸŒ° ë„í† ë¦¬ ì§€ê¸‰</h2>
        <div class="space-y-4">
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ì‚¬ìš©ì ì„ íƒ</label><select class="field" id="giveUser"></select></div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ì§€ê¸‰ëŸ‰</label><input class="field" type="number" id="giveAmount" placeholder="ì§€ê¸‰(+) / ì°¨ê°(-)"></div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ë©”ëª¨</label><input class="field" type="text" id="giveMemo" placeholder="ì§€ê¸‰ ì‚¬ìœ "></div>
          <button class="btn btn-primary w-full py-3 text-base" onclick="giveAcorns()">ğŸŒ° ì§€ê¸‰í•˜ê¸°</button>
        </div>
      </div>
      <div class="clay-card p-5 mt-4"><p class="text-sm font-black text-gray-700 mb-3">ğŸ“œ ìµœê·¼ ì§€ê¸‰ ë‚´ì—­</p><div id="giveHistory" class="space-y-2"></div></div>
    </div>

    <!-- ë½‘ê¸° í…ŒìŠ¤íŠ¸ -->
    <div id="atab-gachaTest" class="hidden">
      <!-- ê´€ë¦¬ì ë¬´ë£Œ ë½‘ê¸° (ì‚¬ìš©ì íƒ­ê³¼ ë™ì¼í•œ UX, ë„í† ë¦¬ ì°¨ê° ì—†ìŒ) -->
      <div class="clay-card p-6 text-center mb-4">
        <div class="text-xs font-bold text-amber-700 bg-amber-50 rounded-2xl p-3 mb-4">ğŸ‘‘ ê´€ë¦¬ì ë¬´ë£Œ ë½‘ê¸° â€” ë„í† ë¦¬ ì°¨ê° ì—†ìŒ</div>
        <div class="text-6xl mb-3" id="adminGachaIcon">ğŸ</div>
        <h2 class="text-xl font-black text-gray-800 mb-1">ë„í† ë¦¬ ë½‘ê¸°</h2>
        <p class="text-sm text-gray-400 font-semibold mb-4">ê²°ê³¼ë§Œ í™•ì¸ Â· ì¸ë²¤í† ë¦¬ ì €ì¥ ì•ˆ ë¨</p>
        <div class="flex justify-center gap-3">
          <button class="btn btn-primary px-8 py-3 text-base" onclick="doAdminGacha(1)">1íšŒ ë½‘ê¸°</button>
          <button class="btn btn-purple px-8 py-3 text-base" onclick="doAdminGacha(5)">5íšŒ ë½‘ê¸°</button>
        </div>
      </div>
      <div id="adminGachaSpinner" style="display:none;flex-direction:column;align-items:center;gap:12px;padding:24px 0">
        <div class="text-6xl" id="adminGachaSpinIcon">ğŸ</div>
        <p id="adminGachaSpinMsg" class="text-sm font-black text-amber-600">ë‘ê·¼ë‘ê·¼...</p>
      </div>
      <div id="adminGachaResult" class="hidden clay-card p-6 text-center mb-4">
        <p class="text-sm font-bold text-gray-400 mb-4">ğŸ‰ ê²°ê³¼!</p>
        <div id="adminGachaResultItems" class="flex flex-wrap justify-center gap-4"></div>
      </div>
      <div class="clay-card p-4 mb-4">
        <p class="text-sm font-black text-gray-700 mb-3">ğŸ“Š ë½‘ê¸° ìƒí’ˆ & í™•ë¥ </p>
        <div id="adminGachaProbTable" class="space-y-1">
          <p class="text-xs text-gray-400 text-center py-2">ë¡œë”© ì¤‘...</p>
        </div>
      </div>

      <!-- í™•ë¥  ì‹œë®¬ë ˆì´í„° -->
      <div class="clay-card p-5 mb-4">
        <p class="text-sm font-black text-gray-700 mb-3">ğŸ§ª í™•ë¥  ì‹œë®¬ë ˆì´í„°</p>
        <p class="text-xs text-gray-400 mb-3">ì‹¤ì œ ë½‘ê¸° ë¡œì§ìœ¼ë¡œ ëŒ€ëŸ‰ ì‹œë®¬ë ˆì´ì…˜ â€” ì„¤ê³„ í™•ë¥ ê³¼ ì‹¤ì œ ê²°ê³¼ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.</p>
        <div class="flex gap-2 mb-3">
          <div class="flex-1">
            <label class="text-xs font-bold text-gray-500 mb-1 block">ë½‘ê¸° íšŸìˆ˜</label>
            <select class="field text-sm" id="simCount">
              <option value="1">1íšŒì”©</option>
              <option value="5" selected>5íšŒì”©</option>
              <option value="10">10íšŒì”©</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="text-xs font-bold text-gray-500 mb-1 block">ë°˜ë³µ íšŸìˆ˜</label>
            <select class="field text-sm" id="simRounds">
              <option value="100">100ë²ˆ</option>
              <option value="500">500ë²ˆ</option>
              <option value="1000" selected>1,000ë²ˆ</option>
              <option value="5000">5,000ë²ˆ</option>
              <option value="10000">10,000ë²ˆ</option>
            </select>
          </div>
        </div>
        <button class="btn btn-purple w-full py-3 font-black mb-4" onclick="runGachaSimulator()">â–¶ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
        <div id="simResult" class="hidden"></div>
      </div>
    </div>

    <!-- ìƒí’ˆ -->
    <div id="atab-products" class="hidden">

      <!-- ë“±ë¡ í¼: 2ì—´ (ìƒì  / ë½‘ê¸°) -->
      <div class="grid grid-cols-2 gap-3 mb-4" style="align-items:start">

        <!-- ìƒì  ìƒí’ˆ ë“±ë¡ -->
        <div class="clay-card p-4">
          <h3 class="font-black text-gray-800 mb-3 flex items-center gap-1">ğŸ›ï¸ <span>ìƒì  ìƒí’ˆ</span></h3>
          <div class="space-y-2">
            <input class="field" type="text" id="ns-name" placeholder="ìƒí’ˆëª…">
            <div class="grid grid-cols-2 gap-2">
              <input class="field" type="text" id="ns-icon" placeholder="ì´ëª¨ì§€ ğŸ">
              <input class="field" type="number" id="ns-price" placeholder="ê°€ê²©(ğŸŒ°)">
            </div>
            <input class="field" type="text" id="ns-desc" placeholder="ì„¤ëª…">
            <select class="field" id="ns-rewardType" onchange="toggleAcornField('ns')">
              <option value="MANUAL_ITEM">ğŸ“¬ ìŠ¹ì¸ í•„ìš”</option>
              <option value="AUTO_ACORN">âš¡ ì¦‰ì‹œ ì§€ê¸‰</option>
            </select>
            <div id="ns-acornWrap" class="hidden">
              <input class="field" type="number" id="ns-acornAmt" placeholder="ì§€ê¸‰ ë„í† ë¦¬ëŸ‰">
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 mb-1 block">íŒë§¤ ìˆ˜ëŸ‰</label>
              <div class="flex gap-2 items-center">
                <select class="field" id="ns-stockType" onchange="toggleStockField()" style="flex:1">
                  <option value="unlimited">â™¾ï¸ ë¬´ì œí•œ (ìƒì‹œíŒë§¤)</option>
                  <option value="limited">ğŸ”¢ ìˆ˜ëŸ‰ ì œí•œ</option>
                </select>
                <input class="field hidden" type="number" id="ns-stock" placeholder="ê°œìˆ˜" min="1" style="width:80px;flex-shrink:0">
              </div>
            </div>
            <button class="btn btn-primary w-full py-2 text-sm" onclick="addStoreProduct()">â• ì¶”ê°€</button>
          </div>
        </div>

        <!-- ë½‘ê¸° ìƒí’ˆ ë“±ë¡ -->
        <div class="clay-card p-4">
          <h3 class="font-black text-gray-800 mb-3 flex items-center gap-1">ğŸ² <span>ë½‘ê¸° ìƒí’ˆ</span></h3>
          <div class="space-y-2">
            <input class="field" type="text" id="ng-name" placeholder="ì•„ì´í…œëª…">
            <div class="grid grid-cols-2 gap-2">
              <input class="field" type="text" id="ng-icon" placeholder="ì´ëª¨ì§€ âœ¨">
              <input class="field" type="number" id="ng-probability" placeholder="í™•ë¥  %" step="0.1" min="0">
            </div>
            <input class="field" type="text" id="ng-desc" placeholder="ì„¤ëª…">
            <select class="field" id="ng-rewardType" onchange="toggleAcornField('ng');toggleCouponField('ng')">
              <option value="MANUAL_ITEM">ğŸ“¬ ì•„ì´í…œ (ìŠ¹ì¸ í•„ìš”)</option>
              <option value="AUTO_ACORN">âš¡ ì¦‰ì‹œ ë„í† ë¦¬ ì§€ê¸‰</option>
              <option value="COUPON">ğŸŸï¸ í• ì¸ì¿ í°</option>
              <option value="ACORN_TICKET">ğŸŒ° ë„í† ë¦¬ í‹°ì¼“ (ì‚¬ìš© ì‹œ ì¦‰ì‹œ ì§€ê¸‰)</option>
              <option value="GACHA_TICKET">ğŸ« ë½‘ê¸° í‹°ì¼“ (1íšŒ ë¬´ë£Œ ë½‘ê¸°)</option>
            </select>
            <div id="ng-acornWrap" class="hidden">
              <input class="field" type="number" id="ng-acornAmt" placeholder="ì§€ê¸‰ ë„í† ë¦¬ëŸ‰">
            </div>
            <div id="ng-couponWrap" class="hidden">
              <input class="field" type="number" id="ng-discountPct" placeholder="í• ì¸ìœ¨ % (ì˜ˆ: 20)" min="1" max="100">
              <p class="text-xs text-gray-400 mt-1">â€» ìƒì  êµ¬ë§¤ ì‹œ 1íšŒ ì‚¬ìš© ê°€ëŠ¥</p>
            </div>
            <div id="ng-resellWrap">
              <input class="field" type="number" id="ng-resellPrice" placeholder="ë˜íŒ”ê¸° ê°€ê²© ğŸŒ° (0=ë¶ˆê°€)" min="0">
            </div>
            <p class="text-xs text-gray-400">â€» í™•ë¥  í•©â‰ 100ì´ì–´ë„ ìë™ ì •ê·œí™”</p>
            <button class="btn btn-purple w-full py-2 text-sm" onclick="addGachaProduct()">â• ì¶”ê°€</button>
          </div>
        </div>

      </div>

      <!-- ëª©ë¡: 2ì—´ (ìƒì  / ë½‘ê¸°) -->
      <div class="grid grid-cols-2 gap-3" style="align-items:start">
        <div class="clay-card p-4">
          <p class="text-sm font-black text-gray-700 mb-3">ğŸ›ï¸ ìƒì  ìƒí’ˆ</p>
          <div id="storeProductList" class="space-y-2"></div>
        </div>
        <div class="clay-card p-4">
          <p class="text-sm font-black text-gray-700 mb-3">ğŸ² ë½‘ê¸° ìƒí’ˆ</p>
          <div id="gachaProductList" class="space-y-2"></div>
        </div>
      </div>

    </div>

    <!-- í€˜ìŠ¤íŠ¸ -->
    <div id="atab-quests" class="hidden">
      <div class="clay-card p-5 mb-4">
        <h2 class="text-lg font-black text-gray-800 mb-4">â• í€˜ìŠ¤íŠ¸ ë“±ë¡</h2>
        <div class="space-y-3">
          <input class="field" type="text" id="nq-name" placeholder="í€˜ìŠ¤íŠ¸ ì´ë¦„">
          <input class="field" type="text" id="nq-desc" placeholder="í€˜ìŠ¤íŠ¸ ì„¤ëª…">
          <div class="grid grid-cols-2 gap-3">
            <input class="field" type="number" id="nq-reward" placeholder="ë³´ìƒ ë„í† ë¦¬">
            <input class="field" type="text" id="nq-icon" placeholder="ì´ëª¨ì§€">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-bold text-gray-500 mb-1 block">ëª©í‘œ íšŸìˆ˜ (ìë™ì™„ë£Œ ì „ìš©)</label>
              <select class="field" id="nq-countType" onchange="toggleQuestCount()">
                <option value="once">1íšŒ â€” íŠ¸ë¦¬ê±°ë˜ë©´ ë°”ë¡œ ì™„ë£Œ</option>
                <option value="multi">íšŸìˆ˜ ì§€ì • â€” NíšŒ ëˆ„ì  í›„ ì™„ë£Œ</option>
              </select>
            </div>
            <div id="nq-countWrap" class="hidden">
              <label class="text-xs font-bold text-gray-500 mb-1 block">ëª©í‘œ íšŸìˆ˜</label>
              <input class="field" type="number" id="nq-targetCount" placeholder="ì˜ˆ: 3" min="2">
            </div>
          </div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ë°˜ë³µ ìœ í˜•</label>
            <select class="field" id="nq-repeat">
              <option value="once">1íšŒì„±</option>
              <option value="daily">ì¼ì¼ â€” ë§¤ì¼ ì´ˆê¸°í™”</option>
              <option value="weekly">ì£¼ê°„ â€” ë§¤ì£¼ ì›”ìš”ì¼</option>
            </select>
          </div>
          <div><label class="text-sm font-bold text-gray-600 mb-1 block">ì™„ë£Œ ë°©ì‹</label>
            <select class="field" id="nq-completionType">
              <option value="auto">âš¡ ìë™ ì™„ë£Œ</option>
              <option value="approval">ğŸ‘¤ ê´€ë¦¬ì ìŠ¹ì¸</option>
            </select>
          </div>
          <button class="btn btn-primary w-full py-3" onclick="addQuest()">ğŸ“‹ í€˜ìŠ¤íŠ¸ ì¶”ê°€</button>
        </div>
      </div>
      <div class="clay-card p-5 mb-4" id="questApprovalCard"><p class="text-sm font-black text-gray-700 mb-3" id="questApprovalTitle">âœ‹ ì™„ë£Œ ìŠ¹ì¸ ìš”ì²­</p><div id="questApprovalList" class="space-y-3"></div></div>
      <div class="clay-card p-5 mb-4"><p class="text-sm font-black text-gray-700 mb-3">ğŸ“‹ í€˜ìŠ¤íŠ¸ ëª©ë¡</p><div id="questAdminList" class="space-y-3"></div></div>
    </div>

    <!-- ì‹ ì²­ -->
    <div id="atab-requests" class="hidden">
      <div class="clay-card p-5">
        <h2 class="text-lg font-black text-gray-800 mb-4">ğŸ“¬ ìƒí’ˆ ì‹ ì²­ ëª©ë¡</h2>
        <div class="flex gap-2 mb-4 flex-wrap">
          <button class="tab-btn active text-xs px-3 py-2" onclick="filterReqs('all',this)">ì „ì²´</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('pending',this)">ëŒ€ê¸°ì¤‘</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('approved',this)">ìŠ¹ì¸</button>
          <button class="tab-btn text-xs px-3 py-2" onclick="filterReqs('rejected',this)">ê±°ì ˆ</button>
        </div>
        <div id="requestAdminList" class="space-y-3"></div>
      </div>
    </div>

    <!-- TX ë¡œê·¸ -->
    <div id="atab-txlog" class="hidden">
      <!-- ì‚¬ìš©ì ì„ íƒ -->
      <div class="clay-card p-4 mb-3" id="logUserSelectCard">
        <p class="font-black text-gray-700 mb-3" style="font-family:'Jua',sans-serif">ğŸ‘¤ ì‚¬ìš©ì ì„ íƒ</p>
        <div id="logUserBtnList" class="flex flex-wrap gap-2"></div>
      </div>
      <!-- ì„ íƒëœ ì‚¬ìš©ì í˜„í™©íŒ -->
      <div id="userStatusList" class="space-y-3"></div>
    </div>

    <!-- íšŒì› ëª©ë¡ -->
    <div id="atab-users" class="hidden">
      <div class="clay-card p-5"><h2 class="text-lg font-black text-gray-800 mb-4">ğŸ‘¥ ì „ì²´ íšŒì›</h2><div id="userAdminList" class="space-y-3"></div></div>
    </div>

    <!-- ì´ë²¤íŠ¸ í• ì¸ -->
    <div id="atab-events" class="hidden">

      <!-- í™œì„± ì´ë²¤íŠ¸ ìƒë‹¨ ë°°ë„ˆ -->
      <div id="activeEventsBanner" class="mb-4"></div>

      <div class="clay-card p-5 mb-4">
        <h2 class="text-lg font-black text-gray-800 mb-3">ğŸ‰ ì´ë²¤íŠ¸ í• ì¸ ê´€ë¦¬</h2>

        <!-- íƒ­ ì „í™˜ -->
        <div class="flex gap-1 mb-4 p-1 rounded-2xl" style="background:rgba(240,235,255,0.5)">
          <button id="evtTabOnce" class="tab-btn active flex-1 text-xs py-2" onclick="switchEvtTab('once',this)">â±ï¸ ê¸°ê°„ ì´ë²¤íŠ¸</button>
          <button id="evtTabRepeat" class="tab-btn flex-1 text-xs py-2" onclick="switchEvtTab('repeat',this)">ğŸ”„ ìš”ì¼ ë°˜ë³µ</button>
          <button id="evtTabSchedules" class="tab-btn flex-1 text-xs py-2" onclick="switchEvtTab('schedules',this)">ğŸ“‹ ëª©ë¡</button>
        </div>

        <!-- â”€â”€ ê¸°ê°„ ì´ë²¤íŠ¸ íŒ¨ë„ â”€â”€ -->
        <div id="evtPane-once">
          <!-- ìƒì  -->
          <div class="mb-4 p-4 rounded-2xl" style="background:rgba(254,215,170,0.3);border:1.5px solid rgba(251,146,60,0.25)">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2"><span class="text-xl">ğŸ›ï¸</span><p class="font-black text-gray-800 text-sm">ìƒì  í• ì¸</p></div>
              <div id="storeEventStatus" class="text-xs font-bold px-3 py-1 rounded-full" style="background:#fee2e2;color:#b91c1c">ë¹„í™œì„±</div>
            </div>
            <div class="space-y-2">
              <div class="flex gap-2 items-center">
                <input class="field" type="number" id="storeDiscountPct" placeholder="í• ì¸ìœ¨ %" min="1" max="100" style="width:90px;flex-shrink:0">
                <span class="text-sm font-bold text-gray-500">% í• ì¸</span>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <select class="field text-xs" id="storeEventPreset" onchange="applyEventPreset('store')">
                  <option value="">âš¡ ë¹ ë¥¸ ê¸°ê°„ ì„¤ì •</option>
                  <option value="1h">ì§€ê¸ˆë¶€í„° 1ì‹œê°„</option>
                  <option value="2h">ì§€ê¸ˆë¶€í„° 2ì‹œê°„</option>
                  <option value="4h">ì§€ê¸ˆë¶€í„° 4ì‹œê°„</option>
                  <option value="8h">ì§€ê¸ˆë¶€í„° 8ì‹œê°„</option>
                  <option value="24h">ì§€ê¸ˆë¶€í„° 24ì‹œê°„</option>
                </select>
                <button class="btn btn-gray text-xs py-1" onclick="clearEventDates('store')">ë‚ ì§œ ì´ˆê¸°í™”</button>
              </div>
              <input class="field text-xs" type="datetime-local" id="storeEventStart">
              <input class="field text-xs" type="datetime-local" id="storeEventEnd">
              <p class="text-xs text-gray-400">â€» ì‹œì‘ ë¹„ì›Œë‘ë©´ ì¦‰ì‹œ Â· ì¢…ë£Œ ë¹„ì›Œë‘ë©´ ìˆ˜ë™ ì¢…ë£Œ</p>
              <div class="flex gap-2">
                <button class="btn btn-green flex-1 py-2 text-sm" onclick="activateEvent('store')">âœ… í™œì„±í™”</button>
                <button class="btn btn-gray flex-1 py-2 text-sm" onclick="deactivateEvent('store')">â¹ ë¹„í™œì„±í™”</button>
              </div>
            </div>
          </div>
          <!-- ë½‘ê¸° -->
          <div class="p-4 rounded-2xl" style="background:rgba(196,181,253,0.25);border:1.5px solid rgba(139,92,246,0.2)">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2"><span class="text-xl">ğŸ²</span><p class="font-black text-gray-800 text-sm">ë½‘ê¸° í• ì¸</p></div>
              <div id="gachaEventStatus" class="text-xs font-bold px-3 py-1 rounded-full" style="background:#fee2e2;color:#b91c1c">ë¹„í™œì„±</div>
            </div>
            <div class="space-y-2">
              <div class="flex gap-2 items-center">
                <input class="field" type="number" id="gachaDiscountPct" placeholder="í• ì¸ìœ¨ %" min="1" max="100" style="width:90px;flex-shrink:0">
                <span class="text-sm font-bold text-gray-500">% í• ì¸</span>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <select class="field text-xs" id="gachaEventPreset" onchange="applyEventPreset('gacha')">
                  <option value="">âš¡ ë¹ ë¥¸ ê¸°ê°„ ì„¤ì •</option>
                  <option value="1h">ì§€ê¸ˆë¶€í„° 1ì‹œê°„</option>
                  <option value="2h">ì§€ê¸ˆë¶€í„° 2ì‹œê°„</option>
                  <option value="4h">ì§€ê¸ˆë¶€í„° 4ì‹œê°„</option>
                  <option value="8h">ì§€ê¸ˆë¶€í„° 8ì‹œê°„</option>
                  <option value="24h">ì§€ê¸ˆë¶€í„° 24ì‹œê°„</option>
                </select>
                <button class="btn btn-gray text-xs py-1" onclick="clearEventDates('gacha')">ë‚ ì§œ ì´ˆê¸°í™”</button>
              </div>
              <input class="field text-xs" type="datetime-local" id="gachaEventStart">
              <input class="field text-xs" type="datetime-local" id="gachaEventEnd">
              <p class="text-xs text-gray-400">â€» ì‹œì‘ ë¹„ì›Œë‘ë©´ ì¦‰ì‹œ Â· ì¢…ë£Œ ë¹„ì›Œë‘ë©´ ìˆ˜ë™ ì¢…ë£Œ</p>
              <div class="flex gap-2">
                <button class="btn btn-purple flex-1 py-2 text-sm" onclick="activateEvent('gacha')">âœ… í™œì„±í™”</button>
                <button class="btn btn-gray flex-1 py-2 text-sm" onclick="deactivateEvent('gacha')">â¹ ë¹„í™œì„±í™”</button>
              </div>
            </div>
          </div>
        </div>

        <!-- â”€â”€ ìš”ì¼ ë°˜ë³µ íŒ¨ë„ â”€â”€ -->
        <div id="evtPane-repeat" class="hidden">
          <div class="p-3 rounded-2xl mb-4" style="background:rgba(219,234,254,0.4);border:1.5px solid rgba(96,165,250,0.3)">
            <p class="text-xs font-black text-blue-700 mb-1">ğŸ’¡ ìš”ì¼ ë°˜ë³µì´ë€?</p>
            <p class="text-xs text-blue-600 font-semibold leading-relaxed">ë§¤ì£¼ ì„ íƒí•œ ìš”ì¼ì˜ íŠ¹ì • ì‹œê°„ëŒ€ì— ìë™ìœ¼ë¡œ í• ì¸ì´ ì ìš©ë©ë‹ˆë‹¤.<br>ì˜ˆ) ë§¤ì£¼ ê¸ˆÂ·í† ìš”ì¼ 18:00~23:59 ìƒì  20% í• ì¸</p>
          </div>
          <div class="space-y-3">
            <!-- ëŒ€ìƒ + í• ì¸ìœ¨ -->
            <div class="flex gap-2 items-center">
              <select class="field flex-1" id="rpt-target">
                <option value="store">ğŸ›ï¸ ìƒì  í• ì¸</option>
                <option value="gacha">ğŸ² ë½‘ê¸° í• ì¸</option>
              </select>
              <input class="field" type="number" id="rpt-pct" placeholder="%" min="1" max="100" style="width:70px;flex-shrink:0">
              <span class="text-sm font-bold text-gray-500 flex-shrink-0">%</span>
            </div>
            <!-- ìš”ì¼ ì„ íƒ -->
            <div>
              <p class="text-xs font-bold text-gray-500 mb-2">ë°˜ë³µ ìš”ì¼</p>
              <div class="flex gap-1.5 flex-wrap" id="rpt-days">
                <label class="evt-day-btn"><input type="checkbox" value="0" onchange="toggleDayBtn(this)"><span>ì¼</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="1" onchange="toggleDayBtn(this)"><span>ì›”</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="2" onchange="toggleDayBtn(this)"><span>í™”</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="3" onchange="toggleDayBtn(this)"><span>ìˆ˜</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="4" onchange="toggleDayBtn(this)"><span>ëª©</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="5" onchange="toggleDayBtn(this)"><span>ê¸ˆ</span></label>
                <label class="evt-day-btn"><input type="checkbox" value="6" onchange="toggleDayBtn(this)"><span>í† </span></label>
              </div>
            </div>
            <!-- ì‹œê°„ëŒ€ -->
            <div class="grid grid-cols-2 gap-2">
              <div>
                <p class="text-xs font-bold text-gray-500 mb-1">ì‹œì‘ ì‹œê°</p>
                <input class="field text-xs" type="time" id="rpt-startTime" value="00:00">
              </div>
              <div>
                <p class="text-xs font-bold text-gray-500 mb-1">ì¢…ë£Œ ì‹œê°</p>
                <input class="field text-xs" type="time" id="rpt-endTime" value="23:59">
              </div>
            </div>
            <!-- ìœ íš¨ê¸°ê°„ (ì„ íƒ) -->
            <div class="grid grid-cols-2 gap-2">
              <div>
                <p class="text-xs font-bold text-gray-500 mb-1">ë°˜ë³µ ì‹œì‘ì¼ <span class="font-normal text-gray-400">(ë¹„ì›Œë‘ë©´ ì¦‰ì‹œ)</span></p>
                <input class="field text-xs" type="date" id="rpt-validFrom">
              </div>
              <div>
                <p class="text-xs font-bold text-gray-500 mb-1">ë°˜ë³µ ì¢…ë£Œì¼ <span class="font-normal text-gray-400">(ë¹„ì›Œë‘ë©´ ë¬´ê¸°í•œ)</span></p>
                <input class="field text-xs" type="date" id="rpt-validUntil">
              </div>
            </div>
            <button class="btn btn-primary w-full py-2.5 text-sm" onclick="addRepeatEvent()">ğŸ”„ ìš”ì¼ ë°˜ë³µ ì´ë²¤íŠ¸ ì¶”ê°€</button>
          </div>
        </div>

        <!-- â”€â”€ ë“±ë¡ëœ ìš”ì¼ë°˜ë³µ ëª©ë¡ â”€â”€ -->
        <div id="evtPane-schedules" class="hidden">
          <div id="scheduleList" class="space-y-2">
            <p class="text-sm text-gray-400 text-center py-4">ë¡œë”© ì¤‘...</p>
          </div>
        </div>
      </div>

      <!-- ì´ë²¤íŠ¸ ê¸°ë¡ -->
      <div class="clay-card p-5">
        <p class="text-sm font-black text-gray-700 mb-3">ğŸ“œ ìµœê·¼ ì´ë²¤íŠ¸ ê¸°ë¡</p>
        <div id="eventHistoryList" class="space-y-2"></div>
      </div>
    </div>
  </div>

    <!-- â™»ï¸ ê´€ë¦¬ì ì¬í™œìš©ì„¼í„° -->
    <div id="atab-recycle" class="hidden">
      <!-- ì•„ì´í…œ ë“±ë¡ -->
      <div class="clay-card p-5 mb-4">
        <h2 class="text-lg font-black text-gray-800 mb-4">â™»ï¸ ì¬í™œìš© ì•„ì´í…œ ë“±ë¡</h2>
        <div class="space-y-3">
          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">ìƒí’ˆ ì„ íƒ</label>
            <select class="field" id="rc-productSelect">
              <option value="">ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”...</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">ë§¤ì… ë²”ìœ„</label>
            <div class="flex gap-2" id="rc-scopeBtns">
              <button type="button" class="rc-scope-btn active flex-1 py-2 rounded-2xl text-sm font-black" data-scope="all" onclick="setRecycleScope('all')">ğŸ›ï¸+ğŸ² ëª¨ë‘</button>
              <button type="button" class="rc-scope-btn flex-1 py-2 rounded-2xl text-sm font-black" data-scope="store" onclick="setRecycleScope('store')">ğŸ›ï¸ ìƒì ë§Œ</button>
              <button type="button" class="rc-scope-btn flex-1 py-2 rounded-2xl text-sm font-black" data-scope="gacha" onclick="setRecycleScope('gacha')">ğŸ² ë½‘ê¸°ë§Œ</button>
            </div>
            <input type="hidden" id="rc-scope" value="all">
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 mb-1 block">ë§¤ì… ê°€ê²© ğŸŒ°</label>
            <input class="field" type="number" id="rc-price" placeholder="ë„í† ë¦¬ ìˆ˜ëŸ‰" min="1">
          </div>
          <button class="btn btn-green w-full py-3 font-black" onclick="addRecycleItem()">â• ë“±ë¡</button>
        </div>
      </div>

      <!-- ë“±ë¡ëœ ë§¤ì… ëª©ë¡ -->
      <div class="clay-card p-5">
        <p class="text-sm font-black text-gray-700 mb-3">ğŸ“‹ ë§¤ì… ëª©ë¡</p>
        <div id="recycleAdminList" class="space-y-3"></div>
      </div>
    </div>

</div></div>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast" class="toast-container hidden">
  <div id="toastInner" style="text-align:center;animation:toastIn .25s cubic-bezier(.34,1.56,.64,1) both;background:rgba(245,210,255,0.42);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1.5px solid rgba(255,255,255,0.6);border-radius:20px;padding:14px 24px;display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:0 8px 32px rgba(120,80,180,0.2)">
    <span id="toastIcon" class="text-2xl"></span>
    <span id="toastMsg" style="font-weight:800;font-size:14px;color:rgba(90,30,130,0.92)"></span>
  </div>
</div>

<!-- PWA ì„¤ì¹˜ ë°°ë„ˆ -->
<div id="installBanner" class="hidden">
  <div class="text-3xl">ğŸŒ°</div>
  <div class="flex-1"><p class="font-black text-gray-800 text-sm">í™ˆ í™”ë©´ì— ì¶”ê°€</p><p class="text-xs text-gray-500 font-semibold">ì•±ì²˜ëŸ¼ ì‚¬ìš©í•´ìš”!</p></div>
  <button class="btn btn-primary px-4 py-2 text-sm" onclick="installPWA()">ì„¤ì¹˜</button>
  <button class="btn btn-gray px-3 py-2 text-xs" onclick="document.getElementById('installBanner').classList.add('hidden')">âœ•</button>
</div>

<script>
/* ================================================================
   ğŸŒ° ë„í† ë¦¬ ìƒì  v4 â€” Supabase ì™„ì „ ì—°ë™
   ================================================================ */


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ë²„íŠ¼ ì´ì¤‘í´ë¦­ ë°©ì§€ ìœ í‹¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function btnLock(el, text = 'ì²˜ë¦¬ ì¤‘...') {
  if (!el) return;
  el.dataset.origText = el.textContent;
  el.textContent = text;
  el.classList.add('btn-loading');
  el.disabled = true;
}
function btnUnlock(el) {
  if (!el) return;
  el.textContent = el.dataset.origText || el.textContent;
  el.classList.remove('btn-loading');
  el.disabled = false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SOUND SYSTEM (Web Audio API - ì™¸ë¶€ íŒŒì¼ ì—†ìŒ)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _audioCtx = null;

// ëª¨ë°”ì¼ ì—¬ë¶€ ê°ì§€ â†’ ë³¼ë¥¨ ë°°ìœ¨ (ëª¨ë°”ì¼ +15%)
const _isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const _volMult = _isMobile ? 1.15 : 1.0;

// ì²« í„°ì¹˜/í´ë¦­ ì‹œ AudioContext ìƒì„± (ë¸Œë¼ìš°ì € ìë™ì¬ìƒ ì •ì±… ìš°íšŒ)
function _ensureAudio() {
  if (!_audioCtx) {
    try { _audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
  }
  if (_audioCtx && _audioCtx.state === 'suspended') _audioCtx.resume();
}
['touchstart', 'mousedown', 'keydown'].forEach(e =>
  document.addEventListener(e, _ensureAudio, { once: false, passive: true })
);

function _playTone(freq, type, duration, vol=0.165) {
  _ensureAudio();
  if (!_audioCtx || _audioCtx.state !== 'running') return;
  try {
    const osc = _audioCtx.createOscillator();
    const gain = _audioCtx.createGain();
    osc.connect(gain); gain.connect(_audioCtx.destination);
    osc.type = type; osc.frequency.setValueAtTime(freq, _audioCtx.currentTime);
    gain.gain.setValueAtTime(vol * _volMult, _audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, _audioCtx.currentTime + duration);
    osc.start(); osc.stop(_audioCtx.currentTime + duration);
  } catch(e) {}
}

function _playChord(notes, type='sine', duration=0.12, vol=0.132) {
  notes.forEach((f,i) => setTimeout(() => _playTone(f, type, duration, vol), i*60));
}

function playSound(name) {
  if (!_audioCtx) return;
  // ì •ì§€ëœ AudioContext ì¬ê°œ
  if (_audioCtx.state === 'suspended') _audioCtx.resume();
  switch(name) {
    case 'click':
      _playTone(880, 'sine', 0.08, 0.11); break;
    case 'tab':
      _playTone(660, 'sine', 0.1, 0.088); break;
    case 'gacha':
      _playChord([261, 329, 392, 523], 'triangle', 0.18, 0.11); break;
    case 'gachaResult':
      _playChord([523, 659, 784, 1047], 'sine', 0.22, 0.132); break;
    case 'reward':
      _playChord([523, 659, 784], 'sine', 0.2, 0.143);
      setTimeout(() => _playChord([784, 1047], 'sine', 0.3, 0.11), 200); break;
    case 'notify':
      _playTone(880, 'sine', 0.12, 0.11);
      setTimeout(() => _playTone(1047, 'sine', 0.15, 0.11), 100); break;
    case 'approve':
      _playChord([523, 659, 784, 1047], 'sine', 0.25, 0.11); break;
    case 'reject':
      _playTone(220, 'sawtooth', 0.2, 0.088); break;
    case 'error':
      _playTone(180, 'square', 0.15, 0.077); break;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SUPABASE ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL = 'https://fqtnxrkxyzjrmaiaunqe.supabase.co';
const SUPABASE_KEY = 'sb_publishable_MpZnq9JYoQLTXc9Uda_nmA_5OAybs0X';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_EMAIL   = 'lovecoa37@gmail.com';
const GACHA_COST    = 10;

// â”€â”€ ì´ì¤‘ í´ë¦­ ë°©ì§€ (ì ê¸ˆ) â”€â”€
const _busy = new Set();
async function withLock(key, fn) {
  if (_busy.has(key)) { return; }
  _busy.add(key);
  try { await fn(); }
  finally { _busy.delete(key); }
}
// ë²„íŠ¼ ë¹„í™œì„±í™” í—¬í¼
function setBtnLoading(el, loading, text) {
  if (!el) return;
  el.disabled = loading;
  if (text !== undefined) el.textContent = loading ? 'ì²˜ë¦¬ ì¤‘...' : text;
  el.style.opacity = loading ? '0.6' : '';
}
// KST(UTC+9) ê¸°ì¤€ ë‚ ì§œ í—¬í¼
function _kstNow() {
  const now = new Date();
  return new Date(now.getTime() + 9 * 60 * 60 * 1000); // UTC+9
}
// TODAY, WEEK_KEYë¥¼ í•¨ìˆ˜ë¡œ â€” ì•±ì„ ì¼œë†“ì•„ë„ ìì •/ì›”ìš”ì¼ 0ì‹œì— ìë™ ê°±ì‹ 
function getToday() {
  return _kstNow().toISOString().slice(0, 10);
}
function getWeekKey() {
  const d = _kstNow();
  const day = d.getUTCDay() || 7;       // ì¼ìš”ì¼(0) â†’ 7
  const monday = new Date(d);
  monday.setUTCDate(d.getUTCDate() - (day - 1));
  return 'W-' + monday.toISOString().slice(0, 10); // ex) "W-2026-02-16"
}
// í•˜ìœ„ í˜¸í™˜: ê¸°ì¡´ TODAY/WEEK_KEY ë³€ìˆ˜ ì°¸ì¡° ì½”ë“œê°€ ìˆì„ ê²½ìš°ë¥¼ ìœ„í•œ ê²Œí„°
Object.defineProperty(window, 'TODAY',    { get: getToday });
Object.defineProperty(window, 'WEEK_KEY', { get: getWeekKey });
const NOW_TS = () => new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ì„¸ì…˜ ìƒíƒœ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let session   = null;   // supabase auth session
let myProfile = null;   // public.users í”„ë¡œí•„
let allUsers  = [];     // ê´€ë¦¬ììš© ì „ì²´ ìœ ì € ìºì‹œ
let allTxs    = [];     // ê´€ë¦¬ììš© ì „ì²´ TX ìºì‹œ
let gachaPool = [];     // gacha_items ìºì‹œ
let reqFilter = 'all';
let storeProducts = []; // ìƒì  ìƒí’ˆ ìºì‹œ (ëª¨ë‹¬ ì¦‰ì‹œ ì˜¤í”ˆìš©)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ì•± ì‹œì‘
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
  // â”€â”€ OAuth ì½œë°± ì²˜ë¦¬ (ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í›„ URL í•´ì‹œì—ì„œ í† í° íŒŒì‹±) â”€â”€
  const hash = window.location.hash;
  if (hash && hash.includes('access_token=')) {
    const params = new URLSearchParams(hash.substring(1));
    const access_token = params.get('access_token');

    if (access_token) {
      // JWT payloadì—ì„œ userId íŒŒì‹± (ì¹´ì¹´ì˜¤ OAuthëŠ” URLì— user ê°ì²´ë¥¼ ì•ˆ ì¤Œ)
      let userId = '';
      try {
        const rawUser = params.get('user');
        if (rawUser) {
          userId = JSON.parse(rawUser).id;
        } else {
          const payload = JSON.parse(atob(access_token.split('.')[1]));
          userId = payload.sub;
        }
      } catch(e) { userId = 'oauth_user'; }

      const sessionData = {
        access_token,
        refresh_token: params.get('refresh_token'),
        expires_at: Math.floor(Date.now() / 1000) + parseInt(params.get('expires_in') || '3600'),
        user: { id: userId, email: 'kakao_user' }
      };
      localStorage.setItem('sb_session', JSON.stringify(sessionData));
      window.history.replaceState(null, null, window.location.pathname);
      window.location.reload(); // ì„¸ì…˜ ì €ì¥ í›„ ìƒˆë¡œê³ ì¹¨í•´ì•¼ getSession()ì´ ì •ìƒ ë™ì‘
      return;
    }
  }

  // Auth ìƒíƒœ ë³€ê²½ êµ¬ë…
  sb.auth.onAuthStateChange(async (event, s) => {
    session = s;
    if (s && s.user) {
      await onSignedIn(s);
    } else if (event === 'SIGNED_OUT') {
      showLoginScreen();
    }
  });

  // í˜„ì¬ ì„¸ì…˜ í™•ì¸
  const { data } = await sb.auth.getSession();
  if (data && data.session && data.session.user) {
    await onSignedIn(data.session);
  } else {
    showLoginScreen();
  }
}

function showLoginScreen() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('appRoot').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì´ë©”ì¼ ìë™ ì…ë ¥
  const saved = localStorage.getItem('dotori_last_email');
  if (saved) { const el = document.getElementById('loginEmail'); if(el) el.value = saved; }
}

async function onSignedIn(s) {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('loadingScreen').classList.remove('hidden');

  try {
    // í”„ë¡œí•„ ë¡œë“œ (ì—†ìœ¼ë©´ ìƒì„±)
    let { data: profile, error } = await sb.from('users').select('*').eq('id', s.user.id).single();
    if (error || !profile) {
      // íŠ¸ë¦¬ê±°ê°€ ì´ë¯¸ ìƒì„±í–ˆì§€ë§Œ í˜¹ì‹œ ì—†ìœ¼ë©´ ìˆ˜ë™ ìƒì„±
      const email = s.user.email || '';
      const name  = s.user.user_metadata?.full_name || s.user.user_metadata?.name || email.split('@')[0] || 'ì‚¬ìš©ì';
      const { data: created } = await sb.from('users').upsert({
        id: s.user.id, display_name: name, acorns: 0, is_admin: email === ADMIN_EMAIL
      }).select().single();
      profile = created;
    }
    myProfile = profile;

    // ë§ˆì§€ë§‰ ì ‘ì† ì‹œê°„ ê¸°ë¡ â€” fetch ì§ì ‘ í˜¸ì¶œë¡œ í™•ì‹¤íˆ ì „ì†¡
    try {
      const _tok = s.access_token || SUPABASE_KEY;
      await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${s.user.id}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': 'Bearer ' + _tok,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ last_seen_at: new Date().toISOString() })
      });
    } catch(e) { /* ì ‘ì† ê¸°ë¡ ì‹¤íŒ¨í•´ë„ ì•± ì§„í–‰ */ }

    // ë½‘ê¸° í’€ ë¡œë“œ
    const { data: gi } = await sb.from('gacha_items').select('*').eq('active', true);
    gachaPool = gi || [];

    // ì‹¤ì‹œê°„ êµ¬ë…
    setupRealtime();

    // UI ì´ˆê¸°í™”
    initAppUI();
  } catch (err) {
    console.error('onSignedIn error:', err);
    toast('âŒ', 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”');
    showLoginScreen();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ì‹¤ì‹œê°„ êµ¬ë…
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Realtime: í´ë§ ë°©ì‹ (WebSocket ì—†ì´ ì£¼ê¸°ì  ë™ê¸°í™”)
let _pollTimer = null;
let _lastNotifCount = 0;
let _lastReqCount = 0;
let _lastReqRemindAt = 0;   // ë§ˆì§€ë§‰ ì¬ì•Œë¦¼ ì‹œê° (ms)
const REQ_REMIND_INTERVAL = 3 * 60 * 1000; // 3ë¶„

async function _pollSync() {
  if (!myProfile) return;
  const token = session?.access_token || SUPABASE_KEY;
  const h = { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + token };

  try {
    // ë‚´ ì”ì•¡ ë™ê¸°í™”
    const ur = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${myProfile.id}&select=acorns`, { headers: h });
    const ud = await ur.json();
    if (ud?.[0] && ud[0].acorns !== myProfile.acorns) {
      myProfile.acorns = ud[0].acorns;
      updateAcornDisplay();
      playSound('reward');
    }

    // ìƒˆ ì•Œë¦¼ í™•ì¸
    const nr = await fetch(`${SUPABASE_URL}/rest/v1/notifications?user_id=eq.${myProfile.id}&select=id&order=created_at.desc`, { headers: h });
    const nd = await nr.json();
    if (Array.isArray(nd) && nd.length > _lastNotifCount) {
      if (_lastNotifCount > 0) { playSound('notify'); }
      _lastNotifCount = nd.length;
      updateNotifDot();
    }

    // ê´€ë¦¬ì: ì‹ ì²­ ê°œìˆ˜ í™•ì¸
    if (myProfile.is_admin) {
      const rr = await fetch(`${SUPABASE_URL}/rest/v1/product_requests?status=eq.pending&select=id`, { headers: h });
      const rd = await rr.json();
      if (Array.isArray(rd)) {
        const cnt = rd.length;
        // ë°°ì§€ ì—…ë°ì´íŠ¸
        const badge = document.getElementById('reqBadge');
        if (badge) {
          if (cnt > 0) {
            badge.textContent = cnt > 9 ? '9+' : cnt;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
        if (cnt !== _lastReqCount) {
          _lastReqCount = cnt;
          if (!document.getElementById('atab-requests').classList.contains('hidden')) renderRequestAdmin();
          // ìƒˆ ì‹ ì²­ ë„ì°© ì‹œ ì¦‰ì‹œ ì•Œë¦¼
          if (cnt > 0) {
            sendBrowserNotif(`ğŸ“¬ ë¯¸ì²˜ë¦¬ ì‹ ì²­ ${cnt}ê±´`, 'í™•ì¸ì´ í•„ìš”í•œ ì‹ ì²­ì´ ìˆì–´ìš”!');
            _lastReqRemindAt = Date.now();
          }
        }
        // 3ë¶„ë§ˆë‹¤ ì¬ì•Œë¦¼ (pending ì‹ ì²­ì´ ìˆëŠ”ë° ì²˜ë¦¬ ì•ˆ ëì„ ë•Œ)
        if (cnt > 0 && Date.now() - _lastReqRemindAt >= REQ_REMIND_INTERVAL) {
          playSound('notify');
          sendBrowserNotif(`ğŸ“¬ ë¯¸ì²˜ë¦¬ ì‹ ì²­ ${cnt}ê±´`, `${cnt}ê±´ì˜ ì‹ ì²­ì´ ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ì–´ìš”. í™•ì¸í•´ì£¼ì„¸ìš”!`);
          _lastReqRemindAt = Date.now();
        }
      }
    }
  } catch(e) {}
}

function setupRealtime() {
  // 5ì´ˆë§ˆë‹¤ í´ë§
  if (_pollTimer) clearInterval(_pollTimer);
  _pollTimer = setInterval(_pollSync, 5000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  UI ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initAppUI() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('appRoot').classList.remove('hidden');

  if (myProfile.is_admin) {
    document.getElementById('headerUserLabel').textContent = 'ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ';
    document.getElementById('headerRight').style.display = 'none';
    document.getElementById('logoutBtn')?.classList.remove('hidden');
    document.getElementById('adminMode').classList.remove('hidden');
    document.getElementById('userMode').classList.add('hidden');
    renderDashboard();
    loadMaintenanceSettings().then(renderMaintenanceBtns);
    populateGiveSelect();
    populateLogFilter();
    updateReqBadge();
  } else {
    document.getElementById('headerUserLabel').textContent = myProfile.display_name;
    document.getElementById('headerRight').style.display = 'flex';
    document.getElementById('logoutBtn')?.classList.remove('hidden');
    document.getElementById('userMode').classList.remove('hidden');
    document.getElementById('adminMode').classList.add('hidden');
    updateAcornDisplay();
    updateNotifDot();
    await _loadEventsFromDB(); // ì´ë²¤íŠ¸ ë°ì´í„° DBì—ì„œ ë¡œë“œ
    await loadMaintenanceSettings(); // ì ê²€ ì„¤ì • ë¨¼ì € ë¡œë“œ ì™„ë£Œ í›„
    checkFreeGacha(); // ë¬´ë£Œ ë½‘ê¸° ìƒíƒœ ì´ˆê¸°í™”

    // ì²« íƒ­(ìƒì )ì´ ì ê²€ ì¤‘ì´ë©´ ì ê²€ ì•ˆë‚´ í‘œì‹œ, ì•„ë‹ˆë©´ ì •ìƒ ë Œë”
    const maint = window._maintSettings || {};
    if (maint['shop']) {
      const tabEl = document.getElementById('utab-shop');
      Array.from(tabEl.children).forEach(el => {
        el.style.display = 'none';
        el.setAttribute('data-maint-hidden', '1');
      });
      const overlay = document.createElement('div');
      overlay.id = 'maint-overlay-shop';
      overlay.innerHTML = `
        <div class="clay-card p-8 text-center mt-4">
          <div style="font-size:3rem;margin-bottom:12px">ğŸ”§</div>
          <p class="text-lg font-black text-gray-700 mb-2">ì ê²€ ì¤‘ì…ë‹ˆë‹¤</p>
          <p class="text-sm text-gray-400">ì ì‹œ í›„ ë‹¤ì‹œ ì´ìš©í•´ì£¼ì„¸ìš”</p>
        </div>`;
      tabEl.prepend(overlay);
    } else {
      renderShop();
      renderShopEventBanner(); // ì´ë²¤íŠ¸ ë°°ë„ˆ
    }
    setTimeout(() => triggerAutoQuest('attendance'), 500);
  }
  // íƒ­ë°” ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ ì´ˆê¸°í™” (PC ì›¹ ëŒ€ì‘)
  setTimeout(() => {
    initTabBarDragScroll(document.getElementById('userTabBar'));
    initTabBarDragScroll(document.getElementById('adminTabBar'));
  }, 300);
}

function updateAcornDisplay() {
  document.getElementById('headerAcorns').textContent = `ğŸŒ° ${myProfile.acorns || 0}`;
  updateTicketDisplay();
  const el = document.getElementById('myAcornVal');
  if (el) el.textContent = myProfile.acorns || 0;
}

async function updateTicketDisplay() {
  const el = document.getElementById('headerTickets');
  if (!el || !myProfile?.id) return;
  // ìºì‹œ ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ
  if (window._gachaTicketCount !== undefined) {
    el.textContent = `ğŸ« ${window._gachaTicketCount}`;
    return;
  }
  // gacha_tickets í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì¡°íšŒ
  const { data } = await sb.from('gacha_tickets')
    .select('id,ticket_count').eq('user_id', myProfile.id).maybeSingle();
  window._gachaTicketCount = data?.ticket_count ?? 0;
  el.textContent = `ğŸ« ${window._gachaTicketCount}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AUTH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doEmailLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pw    = document.getElementById('loginPw').value;
  const errEl = document.getElementById('loginErr');
  errEl.classList.add('hidden');
  if (!email || !pw) { showErr('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  document.getElementById('loginEmail').disabled = true;
  const { error } = await sb.auth.signInWithPassword({ email, password: pw });
  document.getElementById('loginEmail').disabled = false;
  if (error) { showErr(error.message.includes('Invalid') ? 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”' : error.message); }
}

async function doKakaoLogin() {
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'kakao',
    options: { redirectTo: window.location.href }
  });
  if (error) toast('âŒ', 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message);
}

async function doLogout() {
  playSound('click');
  await sb.auth.signOut();
}

function showErr(msg) {
  const el = document.getElementById('loginErr');
  el.textContent = 'âŒ ' + msg;
  el.classList.remove('hidden');
  document.getElementById('loginEmail').classList.add('shake-anim');
  setTimeout(() => document.getElementById('loginEmail').classList.remove('shake-anim'), 500);
}

function showSignup() {
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-4">âœ¨ íšŒì›ê°€ì…</h2>
    <div class="space-y-3">
      <input class="field" type="text" id="su-name" placeholder="ì´ë¦„ (ë‹‰ë„¤ì„)">
      <input class="field" type="email" id="su-email" placeholder="ì´ë©”ì¼">
      <input class="field" type="password" id="su-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
      <div id="su-err" class="hidden text-xs text-red-500 font-bold"></div>
      <button class="btn btn-primary w-full py-3" onclick="doSignup()">ê°€ì…í•˜ê¸°</button>
      <button class="btn btn-gray w-full py-2 text-sm" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>`);
}

async function doSignup() {
  const name  = document.getElementById('su-name').value.trim();
  const email = document.getElementById('su-email').value.trim();
  const pw    = document.getElementById('su-pw').value;
  const errEl = document.getElementById('su-err');
  if (!name || !email || !pw) { errEl.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'; errEl.classList.remove('hidden'); return; }
  if (pw.length < 6) { errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•´ìš”'; errEl.classList.remove('hidden'); return; }

  const { error } = await sb.auth.signUp({ email, password: pw, options: { data: { full_name: name } } });
  if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
  closeModal();
  toast('âœ…', 'ê°€ì… ì™„ë£Œ! ì´ë©”ì¼ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TABS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const U_TABS = ['shop','gacha','quest','recycle','mypage'];
const A_TABS = ['dashboard','give','gachaTest','products','quests','requests','txlog','users','events','recycle'];

function uTab(tab, btn) {
  U_TABS.forEach(t => document.getElementById('utab-'+t).classList.add('hidden'));
  document.querySelectorAll('#userTabBar .tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('utab-'+tab).classList.remove('hidden');
  btn.classList.add('active');
  playSound('tab');

  // ì ê²€ ì¤‘ í™•ì¸
  const maint = window._maintSettings || {};
  const tabEl = document.getElementById('utab-'+tab);
  const maintId = 'maint-overlay-'+tab;

  // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±° + ìˆ¨ê²¼ë˜ ì½˜í…ì¸  ë³µì›
  const prevOverlay = document.getElementById(maintId);
  if (prevOverlay) {
    prevOverlay.remove();
    tabEl.querySelectorAll('[data-maint-hidden]').forEach(el => {
      el.style.display = '';
      el.removeAttribute('data-maint-hidden');
    });
  }

  if (maint[tab]) {
    // ê¸°ì¡´ ìì‹ ìš”ì†Œ ì „ë¶€ ìˆ¨ê¸°ê¸°
    Array.from(tabEl.children).forEach(el => {
      el.style.display = 'none';
      el.setAttribute('data-maint-hidden', '1');
    });
    // ì ê²€ ì•ˆë‚´ ë°•ìŠ¤ ì‚½ì…
    const overlay = document.createElement('div');
    overlay.id = maintId;
    overlay.innerHTML = `
      <div class="clay-card p-8 text-center mt-4">
        <div style="font-size:3rem;margin-bottom:12px">ğŸ”§</div>
        <p class="text-lg font-black text-gray-700 mb-2">ì ê²€ ì¤‘ì…ë‹ˆë‹¤</p>
        <p class="text-sm text-gray-400">ì ì‹œ í›„ ë‹¤ì‹œ ì´ìš©í•´ì£¼ì„¸ìš”</p>
      </div>`;
    tabEl.prepend(overlay);
    return;
  }

  if (tab === 'shop')   { renderShop(); triggerAutoQuest('shopVisit'); }
  if (tab === 'gacha')  { renderGachaProbTable(); checkFreeGacha(); }
  if (tab === 'quest')  renderQuests();
  if (tab === 'mypage') renderMypage();
  if (tab === 'recycle') renderRecycleTab();
}

// â”€â”€ ë©”ë‰´ ì ê²€ ê´€ë¦¬ â”€â”€
const MAINT_TABS = ['shop','gacha','quest','recycle','mypage'];

async function toggleMaintenance(tab) {
  // í˜„ì¬ DB ê°’ ì½ê¸°
  const { data } = await sb.from('app_settings').select('value').eq('key', 'maintenance').single();
  const maint = data?.value || {};
  maint[tab] = !maint[tab];

  // DB ì—…ë°ì´íŠ¸
  await sb.from('app_settings').update({ value: maint, updated_at: new Date().toISOString() }).eq('key', 'maintenance');

  // ì „ì—­ ìºì‹œ ê°±ì‹ 
  window._maintSettings = maint;
  renderMaintenanceBtns();
  toast(maint[tab] ? 'ğŸ”§' : 'âœ…', `${tab} ${maint[tab] ? 'ì ê²€ ì¤‘ìœ¼ë¡œ ì „í™˜' : 'ì •ìƒ ìš´ì˜ìœ¼ë¡œ ì „í™˜'}`);
}

async function loadMaintenanceSettings() {
  const { data } = await sb.from('app_settings').select('value').eq('key', 'maintenance').single();
  window._maintSettings = data?.value || {};
  return window._maintSettings;
}

function renderMaintenanceBtns() {
  const maint = window._maintSettings || {};
  MAINT_TABS.forEach(tab => {
    const btn = document.getElementById('maint-'+tab);
    if (!btn) return;
    if (maint[tab]) {
      btn.classList.add('on');
      btn.title = 'ì ê²€ ì¤‘ (í´ë¦­í•˜ì—¬ í•´ì œ)';
    } else {
      btn.classList.remove('on');
      btn.title = 'ì •ìƒ ìš´ì˜ ì¤‘ (í´ë¦­í•˜ì—¬ ì ê²€ ì „í™˜)';
    }
  });
}

function aTab(tab, btn) {
  playSound('tab');
  A_TABS.forEach(t => { const el = document.getElementById('atab-'+t); if(el) el.classList.add('hidden'); });
  document.querySelectorAll('#adminTabBar .tab-btn').forEach(b => b.classList.remove('active'));
  const tabEl = document.getElementById('atab-'+tab);
  if (tabEl) tabEl.classList.remove('hidden');
  btn.classList.add('active');
  if (tab === 'dashboard')  { renderDashboard(); loadMaintenanceSettings().then(renderMaintenanceBtns); }
  if (tab === 'gachaTest')  renderAdminGachaProbTable();
  if (tab === 'products')   renderProductAdmin();
  if (tab === 'quests')     renderQuestAdmin();
  if (tab === 'requests')   renderRequestAdmin();
  if (tab === 'txlog')      renderTxLog();
  if (tab === 'give')       renderGiveHistory();
  if (tab === 'users')      renderUserAdmin();
  if (tab === 'events')     { _loadEventsFromDB().then(() => { renderEventAdmin(); renderScheduleList(); }); return; }
  if (tab === 'recycle')    renderRecycleAdmin();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SHOP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderShop() {
  const grid = document.getElementById('shopGrid');
  grid.innerHTML = '<p class="text-sm text-gray-400 col-span-2 text-center py-4">ë¡œë”© ì¤‘...</p>';
  const { data: products } = await sb.from('products').select('*').eq('active', true).eq('item_type', 'store').order('sort_order');
  storeProducts = products || [];
  const evtStoreDiscount = getActiveEventDiscount('store');
  if (!products?.length) { grid.innerHTML = '<p class="text-sm text-gray-400 col-span-2 text-center py-8">ìƒí’ˆì´ ì—†ì–´ìš”</p>'; renderShopEventBanner(); return; }
  grid.innerHTML = products.map((p,i) => {
    const unlimited = p.stock === null || p.stock === undefined || p.stock < 0;
    const soldOut   = !unlimited && p.stock <= 0;
    const stockLabel = unlimited ? '' : soldOut
      ? '<span class="badge-soldout">í’ˆì ˆ</span>'
      : `<span class="badge-stock">ë‚¨ì€ìˆ˜ëŸ‰ ${p.stock}ê°œ</span>`;
    const discountedPrice = evtStoreDiscount > 0 ? Math.floor(p.price * (1 - evtStoreDiscount/100)) : p.price;
    const priceHtml = evtStoreDiscount > 0
      ? `<div class="text-center mb-2">
           <span class="text-xs text-gray-400 line-through">ğŸŒ° ${p.price}</span>
           <span class="font-black text-green-600 ml-1">ğŸŒ° ${discountedPrice}</span>
           <span class="text-xs text-green-700 font-bold ml-1">(-${evtStoreDiscount}%)</span>
         </div>`
      : `<div class="text-center font-black text-amber-600 mb-2">ğŸŒ° ${p.price}</div>`;
    return `
    <div class="clay-card p-4 flex flex-col bounce-in ${soldOut?'opacity-60':''}" style="animation-delay:${i*.06}s">
      <div class="text-4xl text-center mb-2">${p.icon}</div>
      <h3 class="font-black text-gray-800 text-center text-sm mb-1">${p.name}</h3>
      <p class="text-xs text-gray-400 font-semibold text-center mb-2">${p.description||''}</p>
      <div class="flex justify-center gap-1 mb-3 flex-wrap">
        <span class="${p.reward_type==='AUTO_ACORN'||p.reward_type==='ACORN_TICKET'?'rt-auto':p.reward_type==='COUPON'?'rt-coupon':p.reward_type==='GACHA_TICKET'?'rt-coupon':'rt-manual'}">${
          p.reward_type==='AUTO_ACORN'?'âš¡ ì¦‰ì‹œì§€ê¸‰':
          p.reward_type==='ACORN_TICKET'?'ğŸŒ° ë„í† ë¦¬ í‹°ì¼“':
          p.reward_type==='GACHA_TICKET'?'ğŸ« ë½‘ê¸° í‹°ì¼“':
          p.reward_type==='COUPON'?'ğŸŸï¸ ì¿ í°':'ğŸ“¬ ìŠ¹ì¸í•„ìš”'}</span>
        ${stockLabel}
      </div>
      <div class="mt-auto">
        ${priceHtml}
        ${soldOut
          ? '<button class="btn btn-gray w-full py-2 text-sm" disabled>í’ˆì ˆ</button>'
          : `<button class="btn btn-primary w-full py-2 text-sm" onclick="requestProduct('${p.id}')">êµ¬ë§¤í•˜ê¸°</button>`
        }
      </div>
    </div>`;
  }).join('');
  renderShopEventBanner();
}

function requestProduct(id) {
  // storeProducts ìºì‹œì—ì„œ ì¦‰ì‹œ ì¡°íšŒ â†’ DB ì¿¼ë¦¬ ì—†ì´ ëª¨ë‹¬ ì¦‰ì‹œ ì˜¤í”ˆ
  const p = storeProducts.find(x => x.id === id);
  if (!p) return;
  const unlimited = p.stock === null || p.stock === undefined || p.stock < 0;
  if (!unlimited && p.stock <= 0) { toast('âŒ', 'í’ˆì ˆëœ ìƒí’ˆì´ì—ìš”!'); renderShop(); return; }
  // ë„í† ë¦¬ ë¶€ì¡± ì²´í¬ëŠ” confirmRequestì—ì„œ ìµœì¢… í• ì¸ê°€ ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬
  // (ì¿ í°/ì´ë²¤íŠ¸ í• ì¸ ì ìš© í›„ êµ¬ë§¤ ê°€ëŠ¥í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ)

  // ì´ë²¤íŠ¸ í• ì¸ ê³„ì‚°
  const evtDiscount = getActiveEventDiscount('store');
  const evtDiscountedPrice = evtDiscount > 0 ? Math.floor(p.price * (1 - evtDiscount/100)) : p.price;

  // ë³´ìœ  ì¿ í° í™•ì¸
  const coupons = (window._invCache || []).filter(i => i.status === 'held' && (i.products?.reward_type || i.product_snapshot?.reward_type) === 'COUPON');
  const couponOptions = coupons.length > 0
    ? `<div class="mt-3 p-3 rounded-xl" style="background:rgba(254,249,195,0.7);border:1.5px solid rgba(251,191,36,0.4)">
        <p class="text-xs font-black text-yellow-800 mb-2">ğŸŸï¸ ë³´ìœ  ì¿ í° ì„ íƒ (ì„ íƒ ì‚¬í•­)</p>
        <select class="field text-xs" id="couponSelect" onchange="updatePurchasePrice(${p.price}, ${evtDiscountedPrice})">
          <option value="">ì¿ í° ì‚¬ìš© ì•ˆ í•¨</option>
          ${coupons.map(c => { const cp = c.products || c.product_snapshot || {}; return `<option value="${c.id}" data-pct="${cp.discount_pct||0}">${cp.icon||'ğŸŸï¸'} ${cp.name} (${cp.discount_pct||0}% í• ì¸)</option>`; }).join('')}
        </select>
      </div>`
    : '';

  const evtNotice = evtDiscount > 0
    ? `<div class="text-xs font-black text-green-700 bg-green-50 rounded-lg px-3 py-1.5 mb-2">ğŸ‰ ì´ë²¤íŠ¸ í• ì¸ ${evtDiscount}% ì ìš© ì¤‘!</div>`
    : '';

  const myAcorns = myProfile.acorns || 0;
  const canAffordNow = myAcorns >= evtDiscountedPrice;
  const acornStatusHtml = `<p class="text-xs font-bold mt-2" style="color:${canAffordNow ? '#6b7280' : '#dc2626'}">
    ë³´ìœ  ë„í† ë¦¬: ğŸŒ° ${myAcorns}${!canAffordNow ? ' (ì¿ í° í• ì¸ í›„ êµ¬ë§¤ ê°€ëŠ¥í•  ìˆ˜ ìˆì–´ìš”)' : ''}
  </p>`;

  showModal(`
    <div class="text-center">
      <div style="font-size:3rem;margin-bottom:8px">${p.icon}</div>
      <h2 class="text-xl font-black text-gray-800" style="margin-bottom:6px">${p.name}</h2>
      <p class="text-sm text-gray-400" style="margin-bottom:14px">${p.description}</p>
      ${evtNotice}
      <div class="modal-notice-box">
        <p class="modal-notice-text">ğŸŒ° ì›ê°€: ${p.price}
          ${evtDiscount > 0 ? `â†’ <span style="color:#16a34a;font-weight:900">${evtDiscountedPrice}</span> (ì´ë²¤íŠ¸ ${evtDiscount}% í• ì¸)` : ''}
        </p>
        <p class="text-xs font-bold mt-1" id="finalPriceLabel" style="color:#059669">ìµœì¢… ê²°ì œ: ğŸŒ° ${evtDiscountedPrice}</p>
        ${acornStatusHtml}
        ${p.reward_type==='AUTO_ACORN'?`<p class="modal-notice-sub">âœ¨ ì¦‰ì‹œ +${p.acorn_amt} ë„í† ë¦¬!</p>`:''}
      </div>
      ${couponOptions}
      <div class="flex gap-3" style="margin-top:12px">
        <button class="btn btn-gray flex-1 py-3" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-3" onclick="confirmRequest('${p.id}')">êµ¬ë§¤í•˜ê¸°!</button>
      </div>
    </div>`);
  // ì´ˆê¸° ê°€ê²© í‘œì‹œë¥¼ ì´ë²¤íŠ¸ í• ì¸ ì ìš© ê°€ê²©ìœ¼ë¡œ ì„¸íŒ…
  window._purchaseBasePrice = evtDiscountedPrice;
  window._purchaseOriginalPrice = p.price;
  window._evtDiscount = evtDiscount;
}

function updatePurchasePrice(originalPrice, evtDiscountedBase) {
  const sel = document.getElementById('couponSelect');
  const pct = sel ? parseInt(sel.options[sel.selectedIndex]?.dataset?.pct || 0) : 0;
  const finalPrice = pct > 0 ? Math.floor(evtDiscountedBase * (1 - pct/100)) : evtDiscountedBase;
  const label = document.getElementById('finalPriceLabel');
  const myAcorns = myProfile?.acorns || 0;
  const canAfford = myAcorns >= finalPrice;
  if (label) {
    label.textContent = `ìµœì¢… ê²°ì œ: ğŸŒ° ${finalPrice}${pct > 0 ? ` (ì¿ í° ${pct}% ì¶”ê°€ í• ì¸)` : ''}`;
    label.style.color = canAfford ? '#059669' : '#dc2626';
  }
  // ë³´ìœ  ë„í† ë¦¬ ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  const acornStatus = label?.nextElementSibling;
  if (acornStatus && acornStatus.tagName === 'P') {
    acornStatus.textContent = `ë³´ìœ  ë„í† ë¦¬: ğŸŒ° ${myAcorns}`;
    acornStatus.style.color = canAfford ? '#6b7280' : '#dc2626';
  }
  window._purchaseBasePrice = finalPrice;
  window._selectedCouponId = (sel && sel.value) ? sel.value : null;
  window._couponDiscountPct = pct;
}

async function confirmRequest(productId) {
  await withLock('purchase_'+productId, async () => { await _confirmRequestInner(productId); });
}
async function _confirmRequestInner(productId) {
  closeModal();
  if (window._buyLock) return;
  window._buyLock = true;

  try {
    const { data: p } = await sb.from('products').select('*').eq('id', productId).single();
    if (!p) { toast('âŒ', 'ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”'); return; }

    // ìµœì¢… ê°€ê²© ê²°ì • (ì´ë²¤íŠ¸ í• ì¸ + ì¿ í° í• ì¸ ìˆœì°¨ ì ìš©)
    const couponId = window._selectedCouponId || null;
    const couponPct = window._couponDiscountPct || 0;
    const evtDiscount = window._evtDiscount || 0;

    let finalPrice = p.price;
    if (evtDiscount > 0) finalPrice = Math.floor(finalPrice * (1 - evtDiscount/100));
    if (couponPct > 0) finalPrice = Math.floor(finalPrice * (1 - couponPct/100));

    // ì”ì•¡ í™•ì¸
    if ((myProfile.acorns || 0) < finalPrice) { toast('âŒ', 'ë„í† ë¦¬ ë¶€ì¡±!'); return; }

    const unlimited = p.stock === null || p.stock === undefined || p.stock < 0;
    if (!unlimited && p.stock <= 0) { toast('âŒ', 'í’ˆì ˆëœ ìƒí’ˆì´ì—ìš”!'); renderShop(); return; }

    // ì´ë¯¸ pending ì‹ ì²­ì´ ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€ (ìƒì  êµ¬ë§¤ ì‹ ì²­ë¼ë¦¬ë§Œ ì²´í¬ â€” ì¸ë²¤í† ë¦¬ ì‚¬ìš©ì‹ ì²­ê³¼ êµ¬ë¶„)
    if (p.reward_type !== 'AUTO_ACORN') {
      const { data: existingReq } = await sb.from('product_requests')
        .select('id').eq('user_id', myProfile.id).eq('product_id', productId)
        .eq('status', 'pending').eq('from_gacha', false).neq('price', 0).limit(1);
      if (existingReq && existingReq.length > 0) {
        toast('â³', 'ì´ë¯¸ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ìˆì–´ìš”!'); return;
      }
    }

    // ì¿ í° ì†Œëª¨ (ë¨¼ì € ì²˜ë¦¬ â€” ì¤‘ë³µ ì‚¬ìš© ë°©ì§€)
    if (couponId) {
      await sb.from('inventory').update({ status: 'used' }).eq('id', couponId);
      // ìºì‹œì—ì„œë„ ì œê±°
      if (window._invCache) window._invCache = window._invCache.filter(i => i.id !== couponId);
    }

    const reasonSuffix = (evtDiscount > 0 || couponPct > 0)
      ? ` (í• ì¸: ${evtDiscount > 0 ? 'ì´ë²¤íŠ¸ ' + evtDiscount + '%' : ''}${evtDiscount > 0 && couponPct > 0 ? ' + ' : ''}${couponPct > 0 ? 'ì¿ í° ' + couponPct + '%' : ''})`
      : '';
    const res = await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: -finalPrice, p_reason: `ìƒí’ˆ êµ¬ë§¤ â€” ${p.icon} ${p.name}${reasonSuffix}` });
    if (!res.data?.success) { toast('âŒ', 'ì²˜ë¦¬ ì‹¤íŒ¨: ' + (res.data?.error || '')); return; }
    myProfile.acorns = res.data.balance;

    if (!unlimited) {
      await sb.from('products').update({ stock: p.stock - 1 }).eq('id', productId);
    }

    // êµ¬ë§¤ ì™„ë£Œ í›„ ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
    window._selectedCouponId = null;
    window._couponDiscountPct = 0;
    window._evtDiscount = 0;

    if (p.reward_type === 'MANUAL_ITEM') {
      await sb.from('inventory').insert({
        user_id: myProfile.id, product_id: p.id, product_snapshot: p, from_gacha: false, status: 'held'
      });
      await pushNotif(myProfile.id, 'request', 'ì•„ì´í…œ íšë“! ğŸ', `${p.icon} ${p.name} íšë“! ì¸ë²¤í† ë¦¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`);
      playSound('reward');
      toast('ğŸ’', `${p.icon} ${p.name} ì¸ë²¤í† ë¦¬ì— ì¶”ê°€ëì–´ìš”!`);
      updateAcornDisplay();
      renderShop();
      return;
    }

    await sb.from('product_requests').insert({
      user_id: myProfile.id, product_id: p.id,
      product_snapshot: p, price: finalPrice, status: 'approved',
      reward_type: p.reward_type, from_gacha: false
    });

    if (p.reward_type === 'AUTO_ACORN') {
      await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: p.acorn_amt, p_reason: `ìë™ ë³´ìƒ â€” ${p.name}` });
      myProfile.acorns += p.acorn_amt;
      await pushNotif(myProfile.id, 'reward', 'ë³´ìƒ ì§€ê¸‰! âš¡', `${p.name} êµí™˜ìœ¼ë¡œ +${p.acorn_amt}ğŸŒ°!`);
      toast('âš¡', `ì¦‰ì‹œ +${p.acorn_amt} ë„í† ë¦¬!`);
    } else {
      await pushNotif(myProfile.id, 'request', 'ì‹ ì²­ ì™„ë£Œ!', `${p.name} ì‹ ì²­ ì™„ë£Œ. ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì´ì—ìš”.`);
      toast('âœ…', `${p.name} ì‹ ì²­ ì™„ë£Œ!`);
    }
    playSound('reward');
    updateAcornDisplay();
    renderShop();
    triggerAutoQuest('itemBuy');
  } finally {
    window._buyLock = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GACHA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í™•ë¥  ê¸°ë°˜ weighted random ë½‘ê¸°
async function loadGachaPool() {
  const { data } = await sb.from('products')
    .select('*')
    .eq('active', true)
    .eq('item_type', 'gacha');
  gachaPool = data || [];
  return gachaPool;
}

// â”€â”€ ë¬´ë£Œ ë½‘ê¸° + í‹°ì¼“ ìƒíƒœ í™•ì¸ ë° ë²„íŠ¼ ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkFreeGacha() {
  if (!myProfile || myProfile.is_admin) return;

  // gacha_tickets í…Œì´ë¸”ì—ì„œ ì¹´ìš´í„° ì¡°íšŒ (inventory X)
  const [{ data: daily }, { data: weekly }, { data: ticketRow }] = await Promise.all([
    sb.from('free_gacha_usage').select('id')
      .eq('user_id', myProfile.id).eq('gacha_type', 'daily').eq('period_key', TODAY).limit(1),
    sb.from('free_gacha_usage').select('id')
      .eq('user_id', myProfile.id).eq('gacha_type', 'weekly').eq('period_key', WEEK_KEY).limit(1),
    sb.from('gacha_tickets').select('id,ticket_count')
      .eq('user_id', myProfile.id).maybeSingle()
  ]);

  const dailyUsed   = daily  && daily.length  > 0;
  const weeklyUsed  = weekly && weekly.length > 0;
  const ticketCount = ticketRow?.ticket_count ?? 0;
  console.log('[checkFreeGacha] ticketRow:', ticketRow, 'count:', ticketCount);

  // ì „ì—­ ìºì‹œ
  window._dailyFreeUsed    = dailyUsed;
  window._weeklyFreeUsed   = weeklyUsed;
  window._gachaTicketCount = ticketCount;

  const btn1   = document.getElementById('btn-gacha1');
  const btn5   = document.getElementById('btn-gacha5');
  const notice = document.getElementById('freeGachaNotice');

  // â”€â”€ 1íšŒ ë²„íŠ¼: ë¬´ë£Œì¼ > í‹°ì¼“ > ìœ ë£Œ ìˆœ ìš°ì„ ìˆœìœ„ â”€â”€
  if (btn1) {
    if (!dailyUsed) {
      btn1.innerHTML = 'ğŸ 1íšŒ ë¬´ë£Œ!';
      btn1.style.background = 'linear-gradient(135deg,#22c55e,#16a34a)';
      btn1.style.color = '#fff';
    } else if (ticketCount > 0) {
      btn1.innerHTML = `ğŸ« í‹°ì¼“ìœ¼ë¡œ ë½‘ê¸° <span style="font-size:10px;opacity:0.8">(${ticketCount}ì¥)</span>`;
      btn1.style.background = 'linear-gradient(135deg,#7c3aed,#5b21b6)';
      btn1.style.color = '#fff';
    } else {
      btn1.innerHTML = '1íšŒ ë½‘ê¸° <span style="font-size:10px;opacity:0.7">(ğŸŒ° 10)</span>';
      btn1.style.background = '';
      btn1.style.color = '';
    }
  }

  // â”€â”€ 5íšŒ ë²„íŠ¼: ë¬´ë£Œì£¼ê°„ > í‹°ì¼“ 5ì¥+ > ìœ ë£Œ â”€â”€
  if (btn5) {
    if (!weeklyUsed) {
      btn5.innerHTML = 'ğŸ 5íšŒ ë¬´ë£Œ!';
      btn5.style.background = 'linear-gradient(135deg,#a855f7,#7c3aed)';
      btn5.style.color = '#fff';
    } else if (ticketCount >= 5) {
      btn5.innerHTML = `ğŸ« í‹°ì¼“ìœ¼ë¡œ 5íšŒ ë½‘ê¸° <span style="font-size:10px;opacity:0.8">(${ticketCount}ì¥)</span>`;
      btn5.style.background = 'linear-gradient(135deg,#6d28d9,#4c1d95)';
      btn5.style.color = '#fff';
    } else {
      btn5.innerHTML = '5íšŒ ë½‘ê¸° <span style="font-size:10px;opacity:0.7">(ğŸŒ° 50)</span>';
      btn5.style.background = '';
      btn5.style.color = '';
    }
  }

  // ì•ˆë‚´ ë¬¸êµ¬
  const notices = [];
  if (!dailyUsed)      notices.push('ğŸ ì˜¤ëŠ˜ ë¬´ë£Œ 1íšŒ ë½‘ê¸° ë‚¨ì•„ìˆì–´ìš”!');
  if (!weeklyUsed)     notices.push('ğŸ ì´ë²ˆ ì£¼ ë¬´ë£Œ 5íšŒ ë½‘ê¸° ë‚¨ì•„ìˆì–´ìš”!');
  // í‹°ì¼“ ë³´ìœ  ì¤‘ ì•ˆë‚´ëŠ” ë²„íŠ¼ì— ì´ë¯¸ í‘œì‹œë˜ë¯€ë¡œ ìƒëµ
  if (notice) {
    notice.textContent = notices.join('  Â·  ');
    notice.classList.toggle('hidden', notices.length === 0);
  }

  // í—¤ë” í‹°ì¼“ ìˆ˜ ì—…ë°ì´íŠ¸
  const ticketEl = document.getElementById('headerTickets');
  if (ticketEl) ticketEl.textContent = `ğŸ« ${ticketCount}`;
}

function drawItemWeighted(pool) {
  if (!pool.length) return null;
  // probability í•©ê³„ ê³„ì‚°
  const total = pool.reduce((s, x) => s + (x.probability || 0), 0);
  if (total <= 0) {
    // í™•ë¥ ì´ ì„¤ì • ì•ˆ ëœ ê²½ìš° ê· ë“± ë¶„ë°°
    return pool[Math.floor(Math.random() * pool.length)];
  }
  let rand = Math.random() * total;
  for (const item of pool) {
    rand -= (item.probability || 0);
    if (rand <= 0) return item;
  }
  return pool[pool.length - 1];
}

// ë½‘ê¸° í‹°ì¼“ 1ì¥ ì†Œëª¨ í›„ 1íšŒ ë½‘ê¸°
async function _useGachaTicketAndPull() {
  const ticketCount = window._gachaTicketCount || 0;
  if (ticketCount < 1) { toast('âŒ', 'í‹°ì¼“ì´ ì—†ì–´ìš”!'); checkFreeGacha(); return; }

  const pool = await loadGachaPool();
  if (!pool.length) { toast('âŒ', 'ë½‘ê¸° ìƒí’ˆì´ ì—†ì–´ìš”!'); return; }

  const btns = document.querySelectorAll('#utab-gacha button');
  btns.forEach(b => btnLock(b, 'ë½‘ëŠ” ì¤‘...'));

  // í‹°ì¼“ 1ì¥ ì°¨ê° (gacha_tickets ì¹´ìš´í„°)
  const { data: ticketRes, error: ticketErr } = await sb.rpc('adjust_gacha_tickets', {
    p_user_id: myProfile.id, p_amount: -1
  });
  if (ticketErr || !ticketRes?.success) {
    btns.forEach(btnUnlock);
    toast('âŒ', 'í‹°ì¼“ ì‚¬ìš© ì‹¤íŒ¨');
    window._gachaTicketCount = undefined;
    checkFreeGacha();
    return;
  }
  window._gachaTicketCount = ticketRes.count;

  playSound('gacha');
  const spinner = document.getElementById('gachaSpinner');
  const gachaResultEl = document.getElementById('gachaResult');
  if (spinner) {
    if (gachaResultEl) gachaResultEl.classList.add('hidden');
    spinner.classList.remove('hidden');
    spinner.classList.add('active');
    const spinEmojis = ['ğŸ','ğŸŒ°','âœ¨','ğŸ²','ğŸŠ','â­','ğŸ€'];
    let spinIdx = 0;
    window._spinInterval = setInterval(() => {
      const si = document.getElementById('gachaSpinIcon');
      if (si) si.textContent = spinEmojis[spinIdx++ % spinEmojis.length];
    }, 120);
  }

  await new Promise(r => setTimeout(r, 1200));

  if (window._spinInterval) clearInterval(window._spinInterval);
  if (spinner) {
    spinner.classList.remove('active');
    spinner.classList.add('hidden');
    const si = document.getElementById('gachaSpinIcon');
    if (si) { si.classList.remove('gacha-spinning'); si.textContent = 'ğŸ'; }
  }

  const results = [drawItemWeighted(pool)].filter(Boolean);
  const sessionId = crypto.randomUUID();

  const acornItems  = results.filter(r => r.reward_type === 'AUTO_ACORN' && r.acorn_amt > 0);
  const manualItems = results.filter(r => r.reward_type === 'MANUAL_ITEM' || r.reward_type === 'COUPON'
    || r.reward_type === 'ACORN_TICKET' || r.reward_type === 'GACHA_TICKET');
  const totalAcorn  = acornItems.reduce((s, r) => s + r.acorn_amt, 0);

  const tasks = [];
  if (totalAcorn > 0) {
    tasks.push(sb.rpc('adjust_acorns', {
      p_user_id: myProfile.id, p_amount: totalAcorn,
      p_reason: `ë½‘ê¸° í‹°ì¼“ ë³´ìƒ (${acornItems.map(r=>r.name).join(', ')})`
    }).then(r => { if (r.data?.success) myProfile.acorns = r.data.balance; }));
  }
  if (manualItems.length) {
    tasks.push(sb.from('inventory').insert(manualItems.map(item => ({
      user_id: myProfile.id, product_id: item.id,
      product_snapshot: item, from_gacha: true, status: 'held'
    }))));
  }
  tasks.push(sb.from('gacha_logs').insert(results.map(item => ({
    user_id: myProfile.id, session_id: sessionId,
    item_name: item.name, item_icon: item.icon,
    rarity: item.rarity || 'common', reward_type: item.reward_type,
    acorn_amt: item.acorn_amt || 0, is_free: true
  }))));

  await Promise.all(tasks);
  updateAcornDisplay();  // í—¤ë” í‹°ì¼“ ìˆ˜ë„ ì—…ë°ì´íŠ¸
  playSound('reward');
  triggerAutoQuest('gachaPlay', 1);
  renderGachaCards(results, 'gachaResult', 'gachaResultItems');
  setTimeout(() => playSound('gachaResult'), 100);
  btns.forEach(btnUnlock);
  checkFreeGacha();  // ë‚¨ì€ í‹°ì¼“ ìˆ˜ ë°˜ì˜
}

// êµ¬ë²„ì „ í˜¸í™˜
async function doGachaTicket() {
  await _useGachaTicketAndPull();
}

// í‹°ì¼“ 5ì¥ìœ¼ë¡œ 5íšŒ ë½‘ê¸°
async function _useGachaTicketsPull5() {
  const tc = window._gachaTicketCount || 0;
  if (tc < 5) { toast('âŒ', 'í‹°ì¼“ì´ 5ì¥ ì´ìƒ í•„ìš”í•´ìš”!'); checkFreeGacha(); return; }

  const pool = await loadGachaPool();
  if (!pool.length) { toast('âŒ', 'ë½‘ê¸° ìƒí’ˆì´ ì—†ì–´ìš”!'); return; }

  const btns = document.querySelectorAll('#utab-gacha button');
  btns.forEach(b => btnLock(b, 'ë½‘ëŠ” ì¤‘...'));

  // í‹°ì¼“ 5ì¥ ì°¨ê°
  const { data: ticketRes, error: ticketErr } = await sb.rpc('adjust_gacha_tickets', {
    p_user_id: myProfile.id, p_amount: -5
  });
  if (ticketErr || !ticketRes?.success) {
    btns.forEach(btnUnlock);
    toast('âŒ', 'í‹°ì¼“ ì‚¬ìš© ì‹¤íŒ¨');
    window._gachaTicketCount = undefined;
    checkFreeGacha();
    return;
  }
  window._gachaTicketCount = ticketRes.count;

  playSound('gacha');
  const spinner = document.getElementById('gachaSpinner');
  const gachaResultEl = document.getElementById('gachaResult');
  if (spinner) {
    if (gachaResultEl) gachaResultEl.classList.add('hidden');
    spinner.classList.remove('hidden');
    spinner.classList.add('active');
    const spinEmojis = ['ğŸ','ğŸŒ°','âœ¨','ğŸ²','ğŸŠ','â­','ğŸ€'];
    let spinIdx = 0;
    window._spinInterval = setInterval(() => {
      const si = document.getElementById('gachaSpinIcon');
      if (si) si.textContent = spinEmojis[spinIdx++ % spinEmojis.length];
    }, 120);
  }

  await new Promise(r => setTimeout(r, 1500));

  if (window._spinInterval) clearInterval(window._spinInterval);
  if (spinner) {
    spinner.classList.remove('active');
    spinner.classList.add('hidden');
    const si = document.getElementById('gachaSpinIcon');
    if (si) { si.classList.remove('gacha-spinning'); si.textContent = 'ğŸ'; }
  }

  const results = Array.from({ length: 5 }, () => drawItemWeighted(pool)).filter(Boolean);
  const sessionId = crypto.randomUUID();

  const acornItems  = results.filter(r => r.reward_type === 'AUTO_ACORN' && r.acorn_amt > 0);
  const ticketItems = results.filter(r => r.reward_type === 'GACHA_TICKET');
  const manualItems = results.filter(r => r.reward_type === 'MANUAL_ITEM' || r.reward_type === 'COUPON' || r.reward_type === 'ACORN_TICKET');
  const totalAcorn  = acornItems.reduce((s, r) => s + r.acorn_amt, 0);

  const tasks = [];
  if (totalAcorn > 0) {
    tasks.push(sb.rpc('adjust_acorns', {
      p_user_id: myProfile.id, p_amount: totalAcorn,
      p_reason: `í‹°ì¼“ 5íšŒ ë½‘ê¸° ë³´ìƒ`
    }).then(r => { if (r.data?.success) myProfile.acorns = r.data.balance; }));
  }
  if (ticketItems.length > 0) {
    tasks.push(sb.rpc('adjust_gacha_tickets', {
      p_user_id: myProfile.id, p_amount: ticketItems.length
    }).then(r => { if (r.data?.success) window._gachaTicketCount = r.data.count; }));
  }
  if (manualItems.length) {
    tasks.push(sb.from('inventory').insert(manualItems.map(item => ({
      user_id: myProfile.id, product_id: item.id,
      product_snapshot: item, from_gacha: true, status: 'held'
    }))));
  }
  tasks.push(sb.from('gacha_logs').insert(results.map(item => ({
    user_id: myProfile.id, session_id: sessionId,
    item_name: item.name, item_icon: item.icon,
    rarity: item.rarity || 'common', reward_type: item.reward_type,
    acorn_amt: item.acorn_amt || 0, is_free: true
  }))));

  await Promise.all(tasks);
  updateAcornDisplay();
  playSound('reward');
  triggerAutoQuest('gachaPlay', 5);
  renderGachaCards(results, 'gachaResult', 'gachaResultItems');
  setTimeout(() => playSound('gachaResult'), 100);
  btns.forEach(btnUnlock);
  checkFreeGacha();
}

async function doGacha(count) {
  const tc = window._gachaTicketCount || 0;
  // 1íšŒ: ë¬´ë£Œì¼ ì†Œì§„ + í‹°ì¼“ ë³´ìœ  â†’ í‹°ì¼“ìœ¼ë¡œ
  if (count === 1 && window._dailyFreeUsed && tc >= 1) {
    await _useGachaTicketAndPull();
    return;
  }
  // 5íšŒ: ë¬´ë£Œì£¼ê°„ ì†Œì§„ + í‹°ì¼“ 5ì¥ ì´ìƒ â†’ í‹°ì¼“ 5ì¥ìœ¼ë¡œ
  if (count === 5 && window._weeklyFreeUsed && tc >= 5) {
    await _useGachaTicketsPull5();
    return;
  }
  const btns = document.querySelectorAll('#utab-gacha button');
  const spinner = document.getElementById('gachaSpinner');
  const gachaResultEl = document.getElementById('gachaResult');

  // ì´ì¤‘í´ë¦­ ë°©ì§€
  btns.forEach(b => btnLock(b, 'ë½‘ëŠ” ì¤‘...'));

  // ë½‘ê¸° ì—°ì¶œ ì‹œì‘
  if (spinner) {
    if (gachaResultEl) gachaResultEl.classList.add('hidden');
    spinner.classList.remove('hidden');
    spinner.classList.add('active');
    const spinMsg = document.getElementById('gachaSpinMsg');
    if (spinMsg) spinMsg.style.animation = 'pulse 1s infinite';
    const spinIcon = document.getElementById('gachaSpinIcon');
    const spinEmojis = ['ğŸ','ğŸŒ°','âœ¨','ğŸ²','ğŸŠ','â­','ğŸ€'];
    let spinIdx = 0;
    window._spinInterval = setInterval(() => {
      if (spinIcon) spinIcon.textContent = spinEmojis[spinIdx++ % spinEmojis.length];
    }, 120);
    if (spinIcon) spinIcon.classList.add('gacha-spinning');
  }

  // ìŠ¤í”¼ë„ˆ/ë²„íŠ¼ ì •ë¦¬ í—¬í¼ (ì—ëŸ¬ ì‹œì—ë„ ë°˜ë“œì‹œ ì‹¤í–‰)
  function _cleanupGacha() {
    if (window._spinInterval) clearInterval(window._spinInterval);
    if (spinner) {
      spinner.classList.remove('active');
      spinner.classList.add('hidden');
      const si = document.getElementById('gachaSpinIcon');
      if (si) { si.classList.remove('gacha-spinning'); si.textContent = 'ğŸ'; }
      const sm = document.getElementById('gachaSpinMsg'); if (sm) sm.style.animation = '';
    }
    btns.forEach(btnUnlock);
    // btnUnlockì´ í…ìŠ¤íŠ¸ë¥¼ ë³µì›í•œ ë’¤ ë¬´ë£Œ ìƒíƒœ ë°˜ì˜ (ìˆœì„œ ì¤‘ìš”)
    checkFreeGacha();
  }

  try {
    const gachaEvtDiscount = getActiveEventDiscount('gacha');

    // â”€â”€ ë¬´ë£Œ ë½‘ê¸° ì—¬ë¶€ íŒë‹¨ â”€â”€
    const isFreeDaily  = count === 1 && !window._dailyFreeUsed;
    const isFreeWeekly = count === 5 && !window._weeklyFreeUsed;
    const isFree = isFreeDaily || isFreeWeekly;
    const freeType = isFreeDaily ? 'daily' : 'weekly';
    const freePeriod = isFreeDaily ? TODAY : WEEK_KEY;

    // ë¬´ë£Œì¸ ê²½ìš°: DBì— ë¨¼ì € ê¸°ë¡ ì‹œë„ (ì¤‘ë³µ ë°©ì§€)
    if (isFree) {
      const { error: freeErr } = await sb.from('free_gacha_usage').insert({
        user_id: myProfile.id, gacha_type: freeType, period_key: freePeriod
      });
      if (freeErr) {
        // ì´ë¯¸ ì‚¬ìš© â†’ ìœ ë£Œë¡œ ì „í™˜
        window._dailyFreeUsed  = freeType === 'daily'  ? true : window._dailyFreeUsed;
        window._weeklyFreeUsed = freeType === 'weekly' ? true : window._weeklyFreeUsed;
        toast('âš ï¸', 'ë¬´ë£Œ ë½‘ê¸°ë¥¼ ì´ë¯¸ ì‚¬ìš©í–ˆì–´ìš”. ìœ ë£Œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
      }
    }

    const baseCost = GACHA_COST * count;
    const cost = isFree ? 0 : gachaEvtDiscount > 0 ? Math.floor(baseCost * (1 - gachaEvtDiscount/100)) : baseCost;

    if (!isFree && (myProfile.acorns||0) < cost) {
      playSound('reject'); toast('âŒ', 'ë„í† ë¦¬ê°€ ë¶€ì¡±í•´ìš”!', 1500); return;
    }

    if (isFree) toast('ğŸ', `ë¬´ë£Œ ë½‘ê¸°!`, 1500);
    else if (gachaEvtDiscount > 0) toast('ğŸ‰', `ë½‘ê¸° ì´ë²¤íŠ¸ ${gachaEvtDiscount}% í• ì¸! (${baseCost}ğŸŒ° â†’ ${cost}ğŸŒ°)`, 2000);
    playSound('gacha');

    // ë½‘ê¸° í’€ ìµœì‹ í™”
    const pool = await loadGachaPool();
    if (!pool.length) {
      toast('âŒ', 'ë½‘ê¸° ìƒí’ˆì´ ì—†ì–´ìš”! ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'); return;
    }

    // ë„í† ë¦¬ ì°¨ê° (ë¬´ë£Œë©´ 0ì›)
    if (cost > 0) {
      const res = await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: -cost, p_reason: `ë½‘ê¸° ì‚¬ìš© (${count}íšŒ)${gachaEvtDiscount > 0 ? ' - ì´ë²¤íŠ¸ ' + gachaEvtDiscount + '% í• ì¸' : ''}` });
      if (!res.data?.success) { toast('âŒ', 'ì²˜ë¦¬ ì‹¤íŒ¨'); return; }
      myProfile.acorns = res.data.balance;
      updateAcornDisplay();
    }

    // ë¬´ë£Œ ì‚¬ìš© í›„ ìºì‹œ ê°±ì‹  (ë²„íŠ¼ í…ìŠ¤íŠ¸ëŠ” _cleanupGachaì—ì„œ ì²˜ë¦¬)
    if (isFree) {
      if (isFreeDaily)  window._dailyFreeUsed  = true;
      if (isFreeWeekly) window._weeklyFreeUsed = true;
    }

    // â”€â”€ ë½‘ê¸° ê²°ê³¼ ê³„ì‚° (ë¡œì»¬, ì¦‰ì‹œ) â”€â”€
    const results = Array.from({ length: count }, () => drawItemWeighted(pool)).filter(Boolean);

    // â”€â”€ AUTO_ACORN ë³´ìƒ í•©ì‚° â†’ í•œ ë²ˆì— ì§€ê¸‰ â”€â”€
    const acornItems    = results.filter(r => r.reward_type === 'AUTO_ACORN' && r.acorn_amt > 0);
    const ticketItems   = results.filter(r => r.reward_type === 'GACHA_TICKET');  // ì¸ë²¤í† ë¦¬ X â†’ ì¹´ìš´í„°
    const manualItems   = results.filter(r => r.reward_type === 'MANUAL_ITEM' || r.reward_type === 'COUPON' || r.reward_type === 'ACORN_TICKET');
    const totalAcornAmt = acornItems.reduce((s, r) => s + r.acorn_amt, 0);

    // â”€â”€ DB ì‘ì—… ë³‘ë ¬ ì‹¤í–‰ â”€â”€
    const dbTasks = [];

    // ë„í† ë¦¬ ë³´ìƒ í•œ ë²ˆì—
    if (totalAcornAmt > 0) {
      dbTasks.push(
        sb.rpc('adjust_acorns', {
          p_user_id: myProfile.id,
          p_amount: totalAcornAmt,
          p_reason: `ë½‘ê¸° ë³´ìƒ (${acornItems.map(r=>r.name).join(', ')})`
        }).then(r => {
          if (r.data?.success) myProfile.acorns = r.data.balance;
        })
      );
    }

    // ë½‘ê¸° í‹°ì¼“ ê²°ê³¼ â†’ ì¹´ìš´í„°ì— ì¦‰ì‹œ ì¶”ê°€ (ì¸ë²¤í† ë¦¬ X)
    if (ticketItems.length > 0) {
      dbTasks.push(
        sb.rpc('adjust_gacha_tickets', {
          p_user_id: myProfile.id, p_amount: ticketItems.length
        }).then(({ data, error }) => {
          console.log('[í‹°ì¼“RPCê²°ê³¼]', data, error);
          if (error) return;
          window._gachaTicketCount = data?.count ?? data ?? 0;
          const el = document.getElementById('headerTickets');
          if (el) el.textContent = `ğŸ« ${window._gachaTicketCount}`;
        })
      );
    }

    // ì¸ë²¤í† ë¦¬ ì‚½ì… í•œ ë²ˆì— (ë°°ì—´ë¡œ)
    if (manualItems.length > 0) {
      dbTasks.push(
        sb.from('inventory').insert(
          manualItems.map(item => ({
            user_id: myProfile.id,
            product_id: item.id,
            product_snapshot: item,
            from_gacha: true,
            status: 'held'
          }))
        )
      );
    }

    // ë½‘ê¸° ë¡œê·¸ ì €ì¥
    const sessionId = crypto.randomUUID();
    dbTasks.push(
      sb.from('gacha_logs').insert(
        results.map(item => ({
          user_id: myProfile.id,
          session_id: sessionId,
          item_name: item.name,
          item_icon: item.icon,
          rarity: item.rarity || 'common',
          reward_type: item.reward_type,
          acorn_amt: item.acorn_amt || 0,
          is_free: isFree
        }))
      )
    );

    // ì•Œë¦¼ í•œ ë²ˆì— (ê° ì•„ì´í…œë³„ ì•Œë¦¼ â†’ ë³‘ë ¬)
    for (const item of results) {
      if (item.reward_type === 'AUTO_ACORN' && item.acorn_amt > 0) {
        dbTasks.push(pushNotif(myProfile.id, 'gachaReward', 'ë½‘ê¸° ë³´ìƒ! ğŸ²', `${item.icon} ${item.name} íšë“! +${item.acorn_amt}ğŸŒ°`));
      } else if (item.reward_type === 'MANUAL_ITEM') {
        dbTasks.push(pushNotif(myProfile.id, 'gachaReward', 'ì•„ì´í…œ íšë“! ğŸ²', `${item.icon} ${item.name} íšë“! ì¸ë²¤í† ë¦¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`));
      } else if (item.reward_type === 'COUPON') {
        dbTasks.push(pushNotif(myProfile.id, 'gachaReward', 'í• ì¸ì¿ í° íšë“! ğŸŸï¸', `${item.icon} ${item.name} (${item.discount_pct||0}% í• ì¸) íšë“! ìƒì  êµ¬ë§¤ ì‹œ ì‚¬ìš©í•˜ì„¸ìš”.`));
      }
    }

    await Promise.all(dbTasks);
    updateAcornDisplay();
    playSound('reward');
    triggerAutoQuest('gachaPlay', count); // ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ (ì™„ë£Œ í›„ renderQuestsê°€ ë‚´ë¶€ì—ì„œ í˜¸ì¶œë¨)

    renderGachaCards(results, 'gachaResult', 'gachaResultItems');
    setTimeout(() => playSound('gachaResult'), 100);
    const el = document.getElementById('gachaIcon');
    el.style.animation = 'none'; void el.offsetWidth;
    el.textContent = 'ğŸŠ'; el.style.animation = 'bounceIn .5s';
    setTimeout(() => { el.textContent = 'ğŸ'; el.style.animation = ''; }, 1600);

  } catch(err) {
    toast('âŒ', 'ë½‘ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”');
    console.error('doGacha error:', err);
  } finally {
    _cleanupGacha();
  }
}

function renderGachaCards(results, wrapId, itemsId) {
  document.getElementById(wrapId).classList.remove('hidden');
  document.getElementById(itemsId).innerHTML = results.map((item,i) => `
    <div class="text-center pop-in" style="animation-delay:${i*.12}s">
      <div class="text-5xl mb-2">${item.icon}</div>
      <div class="badge ${rcClass(item.rarity)} mb-1 block">${item.name}</div>
      <span class="${item.reward_type==='AUTO_ACORN'||item.reward_type==='ACORN_TICKET'?'rt-auto':item.reward_type==='COUPON'||item.reward_type==='GACHA_TICKET'?'rt-coupon':'rt-manual'} block mt-1">
        ${item.reward_type==='AUTO_ACORN'?`+${item.acorn_amt}ğŸŒ°`:item.reward_type==='ACORN_TICKET'?`ğŸŒ° ë„í† ë¦¬ í‹°ì¼“`:item.reward_type==='GACHA_TICKET'?`ğŸ« ë½‘ê¸° í‹°ì¼“`:item.reward_type==='COUPON'?`ğŸŸï¸ ${item.discount_pct||0}% ì¿ í°`:'ğŸ“¬ ì¸ë²¤í† ë¦¬'}
      </span>
    </div>`).join('');
}

const rcClass = r => ({common:'rc-common',rare:'rc-rare',epic:'rc-epic',legend:'rc-legend'})[r]||'rc-common';

async function renderGachaProbTable() {
  const el = document.getElementById('gachaProbTable');
  if (!el) return;

  // ë½‘ê¸° ì´ë²¤íŠ¸ ë°°ë„ˆ (ë§¤ë²ˆ ê°±ì‹ )
  {
    const gachaTab = document.getElementById('utab-gacha');
    const gachaCard = gachaTab?.querySelector('.clay-card');
    if (gachaCard) {
      let banner = document.getElementById('gachaEventBanner');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'gachaEventBanner';
        banner.className = 'text-sm font-black text-green-700 text-center mb-2';
        banner.style.cssText = 'background:rgba(220,252,231,0.8);border-radius:12px;padding:8px 12px;border:2px solid rgba(34,197,94,0.3)';
        gachaCard.insertBefore(banner, gachaCard.firstChild);
      }
      const evtDiscount = getActiveEventDiscount('gacha');
      if (evtDiscount > 0) {
        const endAt = _getEventEndAt('gacha');
        const timeStr = endAt ? `<span id="gachaEvtTimer" style="font-size:11px;opacity:0.8;display:block;margin-top:2px">â±ï¸ ${_fmtRemaining(endAt - Date.now())} ë‚¨ìŒ</span>` : '';
        banner.innerHTML = `ğŸ‰ ë½‘ê¸° ì´ë²¤íŠ¸! 10ğŸŒ° â†’ ${Math.floor(10*(1-evtDiscount/100))}ğŸŒ° (${evtDiscount}% í• ì¸ ì¤‘)${timeStr}`;
        banner.style.display = '';
        // ì¹´ìš´íŠ¸ë‹¤ìš´
        if (endAt) {
          if (window._gachaEvtTimer) clearInterval(window._gachaEvtTimer);
          window._gachaEvtTimer = setInterval(() => {
            const el = document.getElementById('gachaEvtTimer');
            if (!el) { clearInterval(window._gachaEvtTimer); return; }
            const rem = endAt - Date.now();
            if (rem > 0) el.textContent = 'â±ï¸ ' + _fmtRemaining(rem) + ' ë‚¨ìŒ';
            else { el.textContent = 'â±ï¸ ê³§ ì¢…ë£Œ'; clearInterval(window._gachaEvtTimer); }
          }, 1000);
        }
      } else {
        banner.style.display = 'none';
      }
    }
  }

  const { data: items, error } = await sb.from('products')
    .select('name,icon,probability,description')
    .eq('active', true).eq('item_type', 'gacha')
    .order('probability', { ascending: false });
  if (error) { el.innerHTML = `<p class="text-xs text-red-400 text-center py-2">ì˜¤ë¥˜: ${error.message}</p>`; return; }
  if (!items?.length) { el.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">ë“±ë¡ëœ ë½‘ê¸° ìƒí’ˆ ì—†ìŒ</p>'; return; }
  const total = items.reduce((s,x) => s+(x.probability||0), 0);
  el.innerHTML = items.map(x => {
    const pct = total > 0 ? ((x.probability||0)/total*100).toFixed(1) : (100/items.length).toFixed(1);
    return `<div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
      <span class="text-sm font-bold text-gray-700">${x.icon||'ğŸ'} ${x.name}</span>
      <span class="badge-gacha-pct">${pct}%</span>
    </div>`;
  }).join('');
}

function setForce(r) { forceRarity=r; document.getElementById('forceLabel').textContent=({'':'ëœë¤',common:'âšª ì¼ë°˜',rare:'ğŸ”µ ë ˆì–´',epic:'ğŸŸ£ ì—í”½',legend:'ğŸ”´ ì „ì„¤'})[r]; }
async function doAdminGacha(count) {
  const btns = document.querySelectorAll('#atab-gachaTest button');
  const spinner = document.getElementById('adminGachaSpinner');
  const resultEl = document.getElementById('adminGachaResult');

  btns.forEach(b => btnLock(b, 'ë½‘ëŠ” ì¤‘...'));
  if (spinner) { spinner.style.display = 'flex'; if (resultEl) resultEl.classList.add('hidden'); }

  const spinIcon = document.getElementById('adminGachaSpinIcon');
  const spinEmojis = ['ğŸ','ğŸŒ°','âœ¨','ğŸ²','ğŸŠ','â­','ğŸ€'];
  let spinIdx = 0;
  const spinInterval = setInterval(() => {
    if (spinIcon) spinIcon.textContent = spinEmojis[spinIdx++ % spinEmojis.length];
  }, 120);

  playSound('gacha');

  try {
    const pool = await loadGachaPool();
    if (!pool.length) { toast('âŒ', 'ë½‘ê¸° ìƒí’ˆì´ ì—†ì–´ìš”!'); return; }

    // ì‹¤ì œ í™•ë¥ ë¡œ ë½‘ë˜ ë„í† ë¦¬ ì°¨ê°/ì¸ë²¤í† ë¦¬ ì €ì¥ ì—†ìŒ
    const results = Array.from({length: count}, () => drawItemWeighted(pool)).filter(Boolean);

    renderGachaCards(results, 'adminGachaResult', 'adminGachaResultItems');
    setTimeout(() => playSound('gachaResult'), 100);

    const icon = document.getElementById('adminGachaIcon');
    if (icon) {
      icon.style.animation = 'none'; void icon.offsetWidth;
      icon.textContent = 'ğŸŠ'; icon.style.animation = 'bounceIn .5s';
      setTimeout(() => { icon.textContent = 'ğŸ'; icon.style.animation = ''; }, 1600);
    }
  } catch(e) {
    toast('âŒ', 'ì˜¤ë¥˜ ë°œìƒ');
  } finally {
    clearInterval(spinInterval);
    if (spinner) spinner.style.display = 'none';
    if (spinIcon) spinIcon.textContent = 'ğŸ';
    btns.forEach(btnUnlock);
  }
}

// â”€â”€ í™•ë¥  ì‹œë®¬ë ˆì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runGachaSimulator() {
  const drawCount  = parseInt(document.getElementById('simCount')?.value  || 5);
  const rounds     = parseInt(document.getElementById('simRounds')?.value || 1000);
  const resultEl   = document.getElementById('simResult');
  if (!resultEl) return;

  resultEl.classList.remove('hidden');
  resultEl.innerHTML = `<p class="text-xs text-gray-400 text-center py-3">â³ ì‹œë®¬ë ˆì´ì…˜ ì¤‘... (${drawCount}íšŒ Ã— ${rounds.toLocaleString()}ë²ˆ)</p>`;

  // ë¹„ë™ê¸°ë¡œ UI ì—…ë°ì´íŠ¸ í›„ ê³„ì‚° ì‹œì‘
  await new Promise(r => setTimeout(r, 30));

  const pool = await loadGachaPool();
  if (!pool.length) { resultEl.innerHTML = '<p class="text-xs text-red-400 text-center py-2">ë½‘ê¸° ìƒí’ˆì´ ì—†ì–´ìš”</p>'; return; }

  const total = pool.reduce((s, x) => s + (x.probability || 0), 0);
  const totalDraws = drawCount * rounds;

  // ì¹´ìš´í„° ì´ˆê¸°í™”
  const counts = {};
  pool.forEach(item => { counts[item.id] = 0; });

  // ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
  for (let r = 0; r < rounds; r++) {
    for (let d = 0; d < drawCount; d++) {
      const item = drawItemWeighted(pool);
      if (item) counts[item.id] = (counts[item.id] || 0) + 1;
    }
  }

  // ê²°ê³¼ ë Œë”
  const sorted = [...pool].sort((a, b) => (b.probability || 0) - (a.probability || 0));
  const totalProbability = total > 0 ? total : pool.length;

  // ì„¤ê³„ í™•ë¥ ê³¼ ì‹¤ì œ ê²°ê³¼ ì°¨ì´ ìµœëŒ€ê°’ ê³„ì‚° (ê²½ê³ ìš©)
  let maxDiff = 0;
  sorted.forEach(item => {
    const designed = total > 0 ? (item.probability || 0) / total * 100 : 100 / pool.length;
    const actual   = (counts[item.id] || 0) / totalDraws * 100;
    maxDiff = Math.max(maxDiff, Math.abs(actual - designed));
  });

  const totalWarning = Math.abs(total - 100) > 0.5
    ? `<div class="text-xs font-black text-amber-700 bg-amber-50 rounded-xl p-3 mb-3">
        âš ï¸ ì„¤ê³„ í™•ë¥  í•©ê³„: <span class="text-lg">${total.toFixed(1)}%</span>
        ${total > 100 ? 'â€” 100% ì´ˆê³¼! ê° ì•„ì´í…œ ì‹¤ì œ í™•ë¥ ì´ ì„¤ê³„ê°’ë³´ë‹¤ ë‚®ì•„ìš”.' : 'â€” 100% ë¯¸ë‹¬! ê° ì•„ì´í…œ ì‹¤ì œ í™•ë¥ ì´ ì„¤ê³„ê°’ë³´ë‹¤ ë†’ì•„ìš”.'}
       </div>`
    : `<div class="text-xs font-bold text-green-700 bg-green-50 rounded-xl p-2 mb-3">âœ… ì„¤ê³„ í™•ë¥  í•©ê³„: ${total.toFixed(1)}% â€” ì •ìƒ</div>`;

  const rows = sorted.map(item => {
    const cnt      = counts[item.id] || 0;
    const designed = total > 0 ? (item.probability || 0) / total * 100 : 100 / pool.length;
    const actual   = cnt / totalDraws * 100;
    const diff     = actual - designed;
    const diffAbs  = Math.abs(diff);
    // í†µê³„ì  í—ˆìš© ì˜¤ì°¨: sqrt(p*(1-p)/n) * 3 (3ì‹œê·¸ë§ˆ)
    const pDec     = designed / 100;
    const stdErr   = Math.sqrt(pDec * (1 - pDec) / totalDraws) * 100;
    const sigma3   = stdErr * 3;
    const isOdd    = diffAbs > sigma3 && diffAbs > 0.5; // í†µê³„ì ìœ¼ë¡œ ì´ìƒí•œ ê²½ìš°

    const diffColor = diffAbs < 0.5 ? '#6b7280'
                    : diff > 0 ? '#dc2626' : '#2563eb';
    const diffSign  = diff > 0 ? '+' : '';
    const oddMark   = isOdd ? ' âš ï¸' : '';

    // ë§‰ëŒ€ ê·¸ë˜í”„ (ì„¤ê³„ vs ì‹¤ì œ)
    const barMax    = Math.max(designed, actual, 1);
    const designedW = (designed / barMax * 100).toFixed(1);
    const actualW   = (actual   / barMax * 100).toFixed(1);

    return `<div class="py-3 border-b border-gray-100 last:border-0">
      <div class="flex items-center justify-between mb-1.5">
        <span class="text-sm font-black text-gray-800">${item.icon||'ğŸ'} ${item.name}${oddMark}</span>
        <span class="text-xs font-bold text-gray-400">${cnt.toLocaleString()}íšŒ</span>
      </div>
      <div class="flex items-center gap-2 mb-1">
        <span class="text-xs text-gray-400 w-16 shrink-0">ì„¤ê³„</span>
        <div class="flex-1 bg-gray-100 rounded-full h-2 overflow-hidden">
          <div class="h-full rounded-full" style="width:${designedW}%;background:#93c5fd"></div>
        </div>
        <span class="text-xs font-black text-blue-600 w-14 text-right">${designed.toFixed(2)}%</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-400 w-16 shrink-0">ì‹¤ì œ</span>
        <div class="flex-1 bg-gray-100 rounded-full h-2 overflow-hidden">
          <div class="h-full rounded-full" style="width:${actualW}%;background:#86efac"></div>
        </div>
        <span class="text-xs font-black w-14 text-right" style="color:${diffColor}">${actual.toFixed(2)}% <span style="font-size:10px">(${diffSign}${diff.toFixed(2)}%)</span></span>
      </div>
    </div>`;
  }).join('');

  resultEl.innerHTML = `
    <div class="text-xs text-gray-500 font-bold text-center mb-3">
      ğŸ“Š ${drawCount}íšŒ Ã— ${rounds.toLocaleString()}ë²ˆ = ì´ <span class="font-black text-gray-800">${totalDraws.toLocaleString()}íšŒ</span> ë½‘ê¸° ê²°ê³¼
    </div>
    ${totalWarning}
    <div class="space-y-0">${rows}</div>
    <p class="text-xs text-gray-400 text-center mt-3">
      ğŸ’¡ ì˜¤ì°¨ Â±0.5% ì´í•˜ëŠ” ì •ìƒ ë²”ìœ„ Â· âš ï¸ ëŠ” í†µê³„ì ìœ¼ë¡œ ì£¼ì˜ê°€ í•„ìš”í•œ ê²½ìš°
    </p>`;
}

// ê´€ë¦¬ì ë½‘ê¸° íƒ­ ì§„ì… ì‹œ í™•ë¥  í…Œì´ë¸” ë Œë”
async function renderAdminGachaProbTable() {
  const el = document.getElementById('adminGachaProbTable');
  if (!el) return;
  const { data: items, error } = await sb.from('products')
    .select('name,icon,probability,description')
    .eq('active', true).eq('item_type', 'gacha')
    .order('probability', { ascending: false });
  if (error || !items?.length) {
    el.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">ë“±ë¡ëœ ë½‘ê¸° ìƒí’ˆ ì—†ìŒ</p>';
    return;
  }
  const total = items.reduce((s,x) => s+(x.probability||0), 0);
  el.innerHTML = items.map(x => {
    const pct = total > 0 ? ((x.probability||0)/total*100).toFixed(1) : (100/items.length).toFixed(1);
    return `<div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
      <span class="text-sm font-bold text-gray-700">${x.icon||'ğŸ'} ${x.name}</span>
      <span class="badge-prob">${pct}%</span>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  QUEST HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPeriodKey(repeatType) {
  if (repeatType === 'once')   return 'once';
  if (repeatType === 'daily')  return TODAY;
  if (repeatType === 'weekly') return WEEK_KEY;
  return 'once';
}

async function isQuestDone(questId, repeatType, targetCount = 1) {
  const key = getPeriodKey(repeatType);
  const { data } = await sb.from('quest_progress')
    .select('id, progress_count')
    .eq('user_id', myProfile.id).eq('quest_id', questId).eq('period_key', key)
    .maybeSingle();
  if (!data) return false;
  // ëª¨ë“  í€˜ìŠ¤íŠ¸ progress_count >= targetCount ê¸°ì¤€ìœ¼ë¡œ ì™„ë£Œ íŒë‹¨
  return (data.progress_count || 0) >= targetCount;
}

async function hasPendingQCR(questId, repeatType) {
  const key = getPeriodKey(repeatType);
  const { data } = await sb.from('quest_completion_requests')
    .select('id').eq('user_id', myProfile.id).eq('quest_id', questId)
    .eq('status', 'pending').eq('period_key', key).maybeSingle();
  return !!data;
}

// quest_progress upsert ì „ìš© í—¬í¼
async function upsertQuestProgress(userId, questId, periodKey, progressCount) {
  // update ì‹œë„ (RLS: ë³¸ì¸ ìˆ˜ì • ì •ì±… í•„ìš”)
  const { data: updated } = await sb.from('quest_progress')
    .update({ progress_count: progressCount })
    .eq('user_id', userId).eq('quest_id', questId).eq('period_key', periodKey);

  // update ê²°ê³¼ê°€ ì—†ìœ¼ë©´(í–‰ ì—†ìŒ) insert ì‹œë„
  const updatedCount = Array.isArray(updated) ? updated.length : (updated ? 1 : 0);
  if (updatedCount === 0) {
    const { error } = await sb.from('quest_progress')
      .insert({ user_id: userId, quest_id: questId, period_key: periodKey, progress_count: progressCount });
    // insertë„ ì‹¤íŒ¨(ì¤‘ë³µ)í•˜ë©´ update ì¬ì‹œë„
    if (error) {
      await sb.from('quest_progress')
        .update({ progress_count: progressCount })
        .eq('user_id', userId).eq('quest_id', questId).eq('period_key', periodKey);
    }
  }
}

async function markQuestDone(questId, repeatType) {
  const key = getPeriodKey(repeatType);
  // 1íšŒì„± í€˜ìŠ¤íŠ¸: progress_countë¥¼ target(1)ìœ¼ë¡œ ì„¤ì •
  await upsertQuestProgress(myProfile.id, questId, key, 1);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AUTO QUEST TRIGGER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ í€˜ìŠ¤íŠ¸ ìë™ì™„ë£Œ íŠ¸ë¦¬ê±° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// triggerType ëª©ë¡:
//   'attendance'  - ë¡œê·¸ì¸/ì¶œì„ ì‹œ
//   'shopVisit'   - ìƒì  íƒ­ ë°©ë¬¸ ì‹œ
//   'gachaPlay'   - ë½‘ê¸° ì‹¤í–‰ ì‹œ (count: ë½‘ê¸° íšŸìˆ˜)
//   'itemBuy'     - ìƒì ì—ì„œ ìƒí’ˆ êµ¬ë§¤ ì‹œ
//   'itemUse'     - ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ì‚¬ìš© ì‹ ì²­ ì‹œ
//   'questSubmit' - í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì œì¶œ ì‹œ
//
// í€˜ìŠ¤íŠ¸ ì´ë¦„/ì„¤ëª…ì— í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ë¡œ ë§¤ì¹­:
//   attendance  â†’ ì´ë¦„: "ì¶œì„"  / ì„¤ëª…: "ì ‘ì†","ë¡œê·¸ì¸"
//   shopVisit   â†’ ì´ë¦„: "ìƒì ","ìƒí’ˆ" / ì„¤ëª…: "ìƒì ","ë°©ë¬¸"
//   gachaPlay   â†’ ì´ë¦„: "ë½‘ê¸°" / ì„¤ëª…: "ë½‘ê¸°"
//   itemBuy     â†’ ì´ë¦„: "êµ¬ë§¤" / ì„¤ëª…: "êµ¬ë§¤","ìƒì ì—ì„œ"
//   itemUse     â†’ ì´ë¦„: "ì‚¬ìš©","ì‹ ì²­" / ì„¤ëª…: "ì•„ì´í…œ","ì‚¬ìš©ì‹ ì²­"
//   questSubmit â†’ ì´ë¦„: "í€˜ìŠ¤íŠ¸","ì œì¶œ" / ì„¤ëª…: "í€˜ìŠ¤íŠ¸","ì œì¶œ"
//
// íšŸìˆ˜ ê¸°ë°˜ í€˜ìŠ¤íŠ¸: quests.target_count ì»¬ëŸ¼ (NULL=1íšŒ, N=NíšŒ ëˆ„ì  í›„ ì™„ë£Œ)
//   ì˜ˆ) target_count=3, ë½‘ê¸° í€˜ìŠ¤íŠ¸ â†’ ë½‘ê¸°ë¥¼ 3ë²ˆ íŠ¸ë¦¬ê±°í•´ì•¼ ì™„ë£Œ
//       (5íšŒ ë½‘ê¸° 1ë²ˆ = gachaPlay 1íšŒ ì¹´ìš´íŠ¸, 3ì´ ë¼ì•¼ ì™„ë£Œ)
async function triggerAutoQuest(triggerType, count = 1) {
  if (!myProfile || myProfile.is_admin) return;
  const { data: quests } = await sb.from('quests').select('*').eq('active', true).eq('completion_type', 'auto');
  if (!quests) return;

  for (const q of quests) {
    const match =
      (triggerType === 'attendance'    && (q.name.includes('ì¶œì„') || q.description.includes('ì ‘ì†') || q.description.includes('ë¡œê·¸ì¸'))) ||
      (triggerType === 'shopVisit'     && (q.name.includes('ìƒì ') || q.name.includes('ìƒí’ˆ') || q.description.includes('ìƒì ') || q.description.includes('ë°©ë¬¸'))) ||
      (triggerType === 'gachaPlay'     && (q.name.includes('ë½‘ê¸°') || q.description.includes('ë½‘ê¸°'))) ||
      (triggerType === 'itemBuy'       && (q.name.includes('êµ¬ë§¤') || q.description.includes('êµ¬ë§¤') || q.description.includes('ìƒì ì—ì„œ'))) ||
      (triggerType === 'itemUse'       && (q.name.includes('ì‚¬ìš©') || q.name.includes('ì‹ ì²­') || q.description.includes('ì•„ì´í…œ') || q.description.includes('ì‚¬ìš©ì‹ ì²­'))) ||
      (triggerType === 'questSubmit'   && (q.name.includes('í€˜ìŠ¤íŠ¸') || q.name.includes('ì œì¶œ') || q.description.includes('í€˜ìŠ¤íŠ¸') || q.description.includes('ì œì¶œ'))) ||
      (triggerType === 'questComplete' && (q.target_count||1) >= 2 && (q.name.includes('í€˜ìŠ¤íŠ¸') || q.description.includes('í€˜ìŠ¤íŠ¸') || q.description.includes('ì™„ë£Œ')));
    if (!match) continue;

    const done = await isQuestDone(q.id, q.repeat_type, q.target_count || 1);
    if (done) continue;

    // íšŸìˆ˜ ê¸°ë°˜ í€˜ìŠ¤íŠ¸ ì²˜ë¦¬
    const target = q.target_count || 1;
    if (target > 1) {
      // quest_progressì—ì„œ í˜„ì¬ ëˆ„ì  íšŸìˆ˜ í™•ì¸
      const key = getPeriodKey(q.repeat_type);
      const { data: prog } = await sb.from('quest_progress')
        .select('id, progress_count')
        .eq('user_id', myProfile.id).eq('quest_id', q.id).eq('period_key', key)
        .maybeSingle();

      const current = (prog?.progress_count || 0) + count;
      if (current < target) {
        // ì•„ì§ ëª©í‘œ ë¯¸ë‹¬ â†’ upsertë¡œ ì•ˆì „í•˜ê²Œ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        await upsertQuestProgress(myProfile.id, q.id, key, current);
        toast('ğŸ“‹', `${q.name} (${current}/${target})`);
        // í€˜ìŠ¤íŠ¸ íƒ­ì´ ì—´ë ¤ ìˆìœ¼ë©´ ì¦‰ì‹œ ê°±ì‹ 
        if (!document.getElementById('utab-quest')?.classList.contains('hidden')) renderQuests();
        continue;
      }
      // ëª©í‘œ ë‹¬ì„± â†’ "ìˆ˜ë ¹ ê°€ëŠ¥" ìƒíƒœë¡œ ì €ì¥ (ë³´ìƒì€ ì‚¬ìš©ìê°€ ì§ì ‘ ìˆ˜ë ¹)
      await upsertQuestProgress(myProfile.id, q.id, key, target);
    } else {
      // 1íšŒ ì™„ë£Œ í€˜ìŠ¤íŠ¸ â†’ "ìˆ˜ë ¹ ê°€ëŠ¥" ìƒíƒœë¡œ ì €ì¥
      await markQuestDone(q.id, q.repeat_type);
    }

    // ë³´ìƒ ìˆ˜ë ¹ ëŒ€ê¸° ì•Œë¦¼ (ìë™ ì§€ê¸‰ X)
    await pushNotif(myProfile.id, 'quest', 'í€˜ìŠ¤íŠ¸ ë‹¬ì„±! ğŸ‰', `${q.icon} ${q.name} ë‹¬ì„±! í€˜ìŠ¤íŠ¸ íƒ­ì—ì„œ ë³´ìƒì„ ë°›ìœ¼ì„¸ìš”.`);
    setTimeout(() => toast('ğŸ', `${q.name} ë‹¬ì„±! í€˜ìŠ¤íŠ¸ì—ì„œ ë³´ìƒ ë°›ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”`, 3000), 400);
    // í€˜ìŠ¤íŠ¸ íƒ­ì´ ì—´ë ¤ ìˆìœ¼ë©´ ì¦‰ì‹œ ê°±ì‹ 
    if (!document.getElementById('utab-quest')?.classList.contains('hidden')) renderQuests();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  QUEST (USER)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const repLabel = { once:'1íšŒì„±', daily:'ì¼ì¼', weekly:'ì£¼ê°„' };
const repClass  = { once:'rep-once', daily:'rep-daily', weekly:'rep-weekly' };

async function renderQuests() {
  const el = document.getElementById('questList');
  el.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ë¡œë”© ì¤‘...</p>';
  // ì„¸ì…˜ í† í°ì„ ëª…ì‹œì ìœ¼ë¡œ í¬í•¨í•œ ì§ì ‘ fetch (RLS ìš°íšŒ ë°©ì§€)
  let quests = null;
  try {
    const token = session?.access_token || SUPABASE_KEY;
    const res = await fetch(`${SUPABASE_URL}/rest/v1/quests?active=eq.true&order=sort_order.asc`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    quests = await res.json();
    if (!Array.isArray(quests)) quests = null;
  } catch(e) {
    const { data } = await sb.from('quests').select('*').eq('active', true).order('sort_order');
    quests = data;
  }
  if (!quests?.length) { el.innerHTML = '<p class="text-sm text-gray-400 text-center py-8">í€˜ìŠ¤íŠ¸ê°€ ì—†ì–´ìš”</p>'; return; }

  const cards = await Promise.all(quests.map(async q => {
    const ct   = q.completion_type || 'approval';
    const done = await isQuestDone(q.id, q.repeat_type, q.target_count || 1);
    const _done = done; // ì •ë ¬ìš©
    // íšŸìˆ˜ ê¸°ë°˜ í€˜ìŠ¤íŠ¸ ì§„í–‰ í˜„í™©
    let progCount = 0;
    if ((q.target_count||1) > 1) {
      const key = getPeriodKey(q.repeat_type);
      const { data: prog } = await sb.from('quest_progress')
        .select('progress_count')
        .eq('user_id', myProfile.id).eq('quest_id', q.id).eq('period_key', key)
        .maybeSingle();
      progCount = prog?.progress_count || 0;
    }

    if (ct === 'auto') {
      // "ë‹¬ì„±(ë³´ìƒ ìˆ˜ë ¹ ê°€ëŠ¥)" ìƒíƒœ: progress_count >= target ì´ì§€ë§Œ ì•„ì§ reward ë¯¸ì§€ê¸‰
      // "ì™„ë£Œë¨" ìƒíƒœ: quest_completions í…Œì´ë¸”ì— í–‰ ì¡´ì¬
      const key2 = getPeriodKey(q.repeat_type);
      const { data: comp } = await sb.from('quest_completions')
        .select('id').eq('user_id', myProfile.id).eq('quest_id', q.id).eq('period_key', key2)
        .limit(1);
      const claimed = comp && comp.length > 0;
      const claimable = done && !claimed; // ë‹¬ì„±í–ˆì§€ë§Œ ë³´ìƒ ë¯¸ìˆ˜ë ¹

      const target2 = q.target_count || 1;
      const displayCount = Math.min(progCount, target2);

      let iconBg, iconEmoji, cardStyle, nameClass, statusEl;
      if (claimed) {
        iconBg = 'bg-green-100'; iconEmoji = 'âœ…';
        cardStyle = 'opacity:0.45;filter:grayscale(0.4)';
        nameClass = 'line-through text-gray-400';
        statusEl = '<span class="qs-done">ì™„ë£Œë¨</span>';
      } else if (claimable) {
        iconBg = 'bg-amber-100'; iconEmoji = 'ğŸ';
        cardStyle = 'border:2px solid #f59e0b;box-shadow:0 0 0 3px rgba(245,158,11,0.15)';
        nameClass = 'text-gray-800';
        statusEl = `<button class="btn btn-primary px-3 py-1.5 text-xs font-black" style="background:linear-gradient(135deg,#f59e0b,#ef4444);border:none" onclick="claimQuestReward('${q.id}')">ğŸ ë³´ìƒ ë°›ê¸°</button>`;
      } else {
        iconBg = 'bg-amber-50'; iconEmoji = 'âš¡';
        cardStyle = '';
        nameClass = 'text-gray-800';
        statusEl = '<span class="qs-inprogress">ì§„í–‰ì¤‘</span>';
      }

      return { done: claimed, claimable, html: `<div class="clay-card p-4 flex items-center gap-3" style="${cardStyle}">
        <div class="w-10 h-10 rounded-2xl flex items-center justify-center flex-shrink-0 ${iconBg}">
          <span class="text-xl">${iconEmoji}</span>
        </div>
        <div class="text-2xl flex-shrink-0">${q.icon}</div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-0.5 flex-wrap">
            <p class="font-black text-sm ${nameClass}">${q.name}</p>
            <span class="rep-badge ${repClass[q.repeat_type]}">${repLabel[q.repeat_type]}</span>
            <span class="ct-auto">âš¡ ìë™</span>
          </div>
          <p class="text-xs text-gray-400 font-semibold">${q.description}</p>
          ${target2 > 1 ? `<div class="mt-1.5">
            <div style="background:#f3f4f6;border-radius:999px;height:6px;overflow:hidden">
              <div style="background:${claimable?'#f59e0b':claimed?'#22c55e':'#f59e0b'};height:100%;width:${claimed||claimable?100:Math.min(100,Math.round((displayCount/target2)*100))}%;transition:width .3s;border-radius:999px"></div>
            </div>
            <p class="text-xs text-gray-400 mt-0.5 font-bold">${claimed||claimable?target2:displayCount} / ${target2}íšŒ</p>
          </div>` : ''}
        </div>
        <div class="text-right flex-shrink-0">
          <div class="font-black text-amber-600 text-sm">+${q.reward}ğŸŒ°</div>
          ${statusEl}
        </div>
      </div>` };
    } else {
      const pending = done ? false : await hasPendingQCR(q.id, q.repeat_type);
      const canReq  = !done && !pending;
      return { done: _done, html: `<div class="clay-card p-4 flex items-center gap-3" style="${done?'opacity:0.45;filter:grayscale(0.4)':''}">
        <div class="w-10 h-10 rounded-2xl flex items-center justify-center flex-shrink-0 ${done?'bg-green-100':pending?'bg-yellow-100':'bg-pink-50'}">
          <span class="text-xl">${done?'âœ…':pending?'â³':'ğŸ‘¤'}</span>
        </div>
        <div class="text-2xl flex-shrink-0">${q.icon}</div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-0.5 flex-wrap">
            <p class="font-black text-sm ${done?'line-through text-gray-400':'text-gray-800'}">${q.name}</p>
            <span class="rep-badge ${repClass[q.repeat_type]}">${repLabel[q.repeat_type]}</span>
            <span class="ct-approval">ğŸ‘¤ ìŠ¹ì¸</span>
          </div>
          <p class="text-xs text-gray-400 font-semibold">${q.description}</p>
        </div>
        <div class="text-right flex-shrink-0 flex flex-col items-end gap-1">
          <div class="font-black text-amber-600 text-sm">+${q.reward}ğŸŒ°</div>
          ${done?'<span class="qs-done">ì™„ë£Œë¨</span>':pending?'<span class="qs-pending">ìŠ¹ì¸ ëŒ€ê¸°</span>':canReq?`<button class="btn btn-pink px-3 py-1 text-xs" onclick="requestQuestCompletion('${q.id}')">âœ‹ ì™„ë£Œ ìš”ì²­</button>`:'<span class="qs-inprogress">ë¶ˆê°€</span>'}
        </div>
      </div>` };
    }
  }));
  // ë¯¸ì™„ë£Œ ë¨¼ì €, ì™„ë£Œ ë‚˜ì¤‘
  cards.sort((a, b) => {
    // ìˆ˜ë ¹ ê°€ëŠ¥ â†’ ì§„í–‰ì¤‘ â†’ ì™„ë£Œë¨ ìˆœì„œ
    const rank = x => x.claimable ? 0 : x.done ? 2 : 1;
    return rank(a) - rank(b);
  });
  el.innerHTML = cards.map(c => c.html).join('');
}

// â”€â”€ ìë™ í€˜ìŠ¤íŠ¸ ë³´ìƒ ìˆ˜ë ¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function claimQuestReward(questId) {
  const { data: q } = await sb.from('quests').select('*').eq('id', questId).maybeSingle();
  if (!q) return;

  // ë‹¬ì„± ì—¬ë¶€ ì¬í™•ì¸
  const done = await isQuestDone(questId, q.repeat_type, q.target_count || 1);
  if (!done) { toast('âŒ', 'ì•„ì§ í€˜ìŠ¤íŠ¸ ì¡°ê±´ì„ ë‹¬ì„±í•˜ì§€ ëª»í–ˆì–´ìš”!'); return; }

  // ì´ë¯¸ ìˆ˜ë ¹í–ˆëŠ”ì§€ í™•ì¸
  const key = getPeriodKey(q.repeat_type);
  const { data: comp } = await sb.from('quest_completions')
    .select('id').eq('user_id', myProfile.id).eq('quest_id', questId).eq('period_key', key)
    .limit(1);
  if (comp && comp.length > 0) { toast('â³', 'ì´ë¯¸ ë³´ìƒì„ ë°›ì•˜ì–´ìš”!'); return; }

  // ì™„ë£Œ ê¸°ë¡ ë¨¼ì € ì €ì¥ (ì¤‘ë³µ ìˆ˜ë ¹ ì›ì²œ ì°¨ë‹¨ â€” unique ì œì•½ìœ¼ë¡œ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨)
  const { error: insertErr } = await sb.from('quest_completions').insert({
    user_id: myProfile.id, quest_id: questId, period_key: key
  });
  if (insertErr) { toast('â³', 'ì´ë¯¸ ë³´ìƒì„ ë°›ì•˜ì–´ìš”!'); return; }

  // ì™„ë£Œ ê¸°ë¡ ì„±ê³µ í›„ ë³´ìƒ ì§€ê¸‰
  const res = await sb.rpc('adjust_acorns', {
    p_user_id: myProfile.id, p_amount: q.reward,
    p_reason: `í€˜ìŠ¤íŠ¸ ì™„ë£Œ â€” ${q.name}`
  });
  if (!res.data?.success) { toast('âŒ', 'ì²˜ë¦¬ ì‹¤íŒ¨: ' + (res.data?.error || '')); return; }
  myProfile.acorns = res.data.balance;
  updateAcornDisplay();

  // ì•Œë¦¼ + íš¨ê³¼
  await pushNotif(myProfile.id, 'quest', 'í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ğŸ‰', `${q.icon} ${q.name} ì™„ë£Œ! +${q.reward}ğŸŒ°`);
  playSound('reward');
  toast('ğŸ‰', `${q.name} ì™„ë£Œ! +${q.reward}ğŸŒ°`);
  renderQuests();

  // "í€˜ìŠ¤íŠ¸ NíšŒ ì™„ë£Œí•˜ê¸°" í€˜ìŠ¤íŠ¸ ì¹´ìš´íŠ¸
  triggerAutoQuest('questComplete');
}

async function requestQuestCompletion(questId) {
  const { data: q } = await sb.from('quests').select('*').eq('id', questId).single();
  if (!q) return;
  const done    = await isQuestDone(questId, q.repeat_type);
  const pending = await hasPendingQCR(questId, q.repeat_type);
  if (done || pending) { toast('â³', 'ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ì—ìš”!'); return; }

  const key = getPeriodKey(q.repeat_type);
  await sb.from('quest_completion_requests').insert({
    user_id: myProfile.id, quest_id: questId, status: 'pending', period_key: key
  });
  await pushNotif(myProfile.id, 'quest', 'ì™„ë£Œ ìš”ì²­ ì „ì†¡! âœ‹', `${q.icon} ${q.name} ì™„ë£Œ ìš”ì²­ì„ ë³´ëƒˆì–´ìš”.`);
  toast('âœ‹', `${q.name} ì™„ë£Œ ìš”ì²­ ì „ì†¡!`);
  renderQuests();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MYPAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ ë§ˆì´í˜ì´ì§€ í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ â”€â”€
let _reqPage = 0, _reqItems = [];
let _txPage  = 0, _txItems  = [];
let _glogPage = 0, _glogItems = [];
const PAGE_SIZE_REQ  = 3;  // ìƒí’ˆ ì‹ ì²­ í˜„í™©
const PAGE_SIZE_QCR  = 2;  // í€˜ìŠ¤íŠ¸ ì‹ ì²­ í˜„í™©
const PAGE_SIZE_TX   = 3;  // ë„í† ë¦¬ ë‚´ì—­
const PAGE_SIZE_GLOG = 5;  // ë½‘ê¸° ê¸°ë¡ (session ë‹¨ìœ„)
const PAGE_SIZE = 5;       // í•˜ìœ„í˜¸í™˜

function _renderGlogPage() {
  const el = document.getElementById('myGachaLogList');
  if (!el) return;
  const total = _glogItems.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  const slice = _glogItems.slice(_glogPage * PAGE_SIZE, (_glogPage + 1) * PAGE_SIZE);

  // session ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”í•´ì„œ í‘œì‹œ
  const sessions = [];
  let lastSession = null;
  for (const g of slice) {
    if (g.session_id !== lastSession) {
      sessions.push({ session_id: g.session_id, created_at: g.created_at, items: [] });
      lastSession = g.session_id;
    }
    sessions[sessions.length - 1].items.push(g);
  }

  const rarityColor = { legendary:'#f59e0b', epic:'#a855f7', rare:'#3b82f6', common:'#6b7280' };

  el.innerHTML = sessions.length
    ? sessions.map(s => `
        <div class="p-3 rounded-2xl bg-gray-50 border border-gray-100">
          <p class="text-xs text-gray-400 mb-2">${fmtTs(s.created_at)} Â· ${s.items.length}íšŒ${s.items[0]?.is_free ? ' ğŸ ë¬´ë£Œ' : ''}</p>
          <div class="flex flex-wrap gap-1">
            ${s.items.map(item => `
              <div class="flex items-center gap-1 px-2 py-1 rounded-xl text-xs font-bold" style="background:rgba(0,0,0,0.04)">
                <span>${item.item_icon}</span>
                <span class="text-gray-700">${item.item_name}</span>
                ${item.reward_type==='AUTO_ACORN' ? `<span class="text-amber-600">+${item.acorn_amt}ğŸŒ°</span>` : ''}
                ${item.reward_type==='MANUAL_ITEM' ? '<span style="color:#7c3aed">ğŸ“¦</span>' : ''}
                ${item.reward_type==='COUPON' ? '<span style="color:#d97706">ğŸŸï¸</span>' : ''}
              </div>`).join('')}
          </div>
        </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-3">ë½‘ê¸° ê¸°ë¡ì´ ì—†ì–´ìš”</p>';

  const label = document.getElementById('glogPageLabel');
  const prev  = document.getElementById('glogPrevBtn');
  const next  = document.getElementById('glogNextBtn');
  if (label) label.textContent = total ? `${_glogPage+1} / ${totalPages}` : '';
  if (prev)  prev.disabled  = _glogPage === 0;
  if (next)  next.disabled  = _glogPage >= totalPages - 1;
}

function moveGlogPage(dir) {
  const totalPages = Math.max(1, Math.ceil(_glogItems.length / PAGE_SIZE));
  _glogPage = Math.max(0, Math.min(totalPages - 1, _glogPage + dir));
  _renderGlogPage();
}

function _renderReqPage() {
  const el = document.getElementById('myRequestList');
  const total = _reqItems.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE_REQ));
  const slice = _reqItems.slice(_reqPage * PAGE_SIZE_REQ, (_reqPage + 1) * PAGE_SIZE_REQ);

  el.innerHTML = slice.length
    ? slice.map(r => `<div class="flex items-center justify-between p-3 rounded-xl" class="row-item-bg">
        <div class="min-w-0 mr-2">
          <p class="text-sm font-bold text-gray-800">${r.icon} ${r.label}</p>
          <p class="text-xs text-gray-400">${r.sub}</p>
        </div>
        <span class="badge ${stClass(r.status)} shrink-0">${stLabel(r.status)}</span>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-3">ì‹ ì²­ ë‚´ì—­ì´ ì—†ì–´ìš”</p>';

  const label = document.getElementById('reqPageLabel');
  const prev  = document.getElementById('reqPrevBtn');
  const next  = document.getElementById('reqNextBtn');
  if (label) label.textContent = total ? `${_reqPage+1} / ${totalPages}` : '';
  if (prev)  prev.disabled  = _reqPage === 0;
  if (next)  next.disabled  = _reqPage >= totalPages - 1;
}

function _renderQcrPage(qcrs) {
  const el = document.getElementById('myQuestReqList');
  if (!el) return;
  const total = qcrs.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE_QCR));
  const slice = qcrs.slice(window._qcrPage * PAGE_SIZE_QCR, (window._qcrPage + 1) * PAGE_SIZE_QCR);
  el.innerHTML = slice.length
    ? slice.map(r => `<div class="flex items-center justify-between p-3 rounded-xl" style="background:#f9fafb">
        <div class="min-w-0 mr-2">
          <p class="text-sm font-bold text-gray-800">${r.quests?.icon||'ğŸ“‹'} ${r.quests?.name||'í€˜ìŠ¤íŠ¸'}</p>
          <p class="text-xs text-gray-400">${fmtTs(r.created_at)} Â· ì™„ë£Œ ìš”ì²­</p>
        </div>
        <span class="badge ${stClass(r.status)} shrink-0">${stLabel(r.status)}</span>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-3">í€˜ìŠ¤íŠ¸ ì‹ ì²­ ë‚´ì—­ì´ ì—†ì–´ìš”</p>';
  const label = document.getElementById('qcrPageLabel');
  const prev  = document.getElementById('qcrPrevBtn');
  const next  = document.getElementById('qcrNextBtn');
  if (label) label.textContent = total ? `${window._qcrPage+1} / ${totalPages}` : '';
  if (prev)  prev.disabled  = window._qcrPage === 0;
  if (next)  next.disabled  = window._qcrPage >= totalPages - 1;
}
function moveQcrPage(dir) {
  if (!window._qcrCache) return;
  const totalPages = Math.max(1, Math.ceil(window._qcrCache.length / PAGE_SIZE_QCR));
  window._qcrPage = Math.max(0, Math.min(totalPages - 1, (window._qcrPage||0) + dir));
  _renderQcrPage(window._qcrCache);
}

function _renderTxPage() {
  const el = document.getElementById('myTxList');
  const total = _txItems.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE_TX));
  const slice = _txItems.slice(_txPage * PAGE_SIZE_TX, (_txPage + 1) * PAGE_SIZE_TX);

  el.innerHTML = slice.length
    ? slice.map(t => `<div class="flex items-center justify-between p-3 rounded-xl" class="row-item-bg">
        <div class="flex-1 min-w-0 mr-3">
          <p class="text-sm font-bold text-gray-700 truncate">${t.reason}</p>
          <p class="text-xs text-gray-400">${fmtTs(t.created_at)} Â· ì”ì•¡ ${t.balance}ğŸŒ°</p>
        </div>
        <span class="font-black text-base shrink-0 ${t.amount>0?'tx-plus':'tx-minus'}">${t.amount>0?'+':''}${t.amount}ğŸŒ°</span>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-3">ë‚´ì—­ì´ ì—†ì–´ìš”</p>';

  const label = document.getElementById('txPageLabel');
  const prev  = document.getElementById('txPrevBtn');
  const next  = document.getElementById('txNextBtn');
  if (label) label.textContent = total ? `${_txPage+1} / ${totalPages}` : '';
  if (prev)  prev.disabled  = _txPage === 0;
  if (next)  next.disabled  = _txPage >= totalPages - 1;
}

function moveReqPage(dir) {
  const totalPages = Math.max(1, Math.ceil(_reqItems.length / PAGE_SIZE_REQ));
  _reqPage = Math.max(0, Math.min(totalPages - 1, _reqPage + dir));
  _renderReqPage();
}

function moveTxPage(dir) {
  const totalPages = Math.max(1, Math.ceil(_txItems.length / PAGE_SIZE_TX));
  _txPage = Math.max(0, Math.min(totalPages - 1, _txPage + dir));
  _renderTxPage();
}

async function renderMypage() {
  document.getElementById('mypageHeader').innerHTML = `
    <div class="flex items-center gap-4">
      <div class="text-5xl">${myProfile.avatar_emoji || 'ğŸ¿ï¸'}</div>
      <div>
        <h2 class="text-xl font-black text-gray-800">${myProfile.display_name}</h2>
        <p class="text-xs text-gray-400 font-semibold">${session?.user?.email || ''}</p>
      </div>
      <div class="ml-auto text-center">
        <div class="text-3xl font-black text-amber-600" id="myAcornVal">${myProfile.acorns || 0}</div>
        <div class="text-xs text-gray-500 font-bold">ğŸŒ° ë„í† ë¦¬</div>
      </div>
    </div>`;

  renderInventory();

  // 30ì¼ ê¸°ì¤€ ë‚ ì§œ (KST)
  const cutoff = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();

  const [{ data: myReqs }, { data: myQCRs }, { data: txs }, { data: gachaLogs }] = await Promise.all([
    sb.from('product_requests').select('*')
      .eq('user_id', myProfile.id).gte('created_at', cutoff)
      .order('created_at', { ascending: false }).limit(200),
    sb.from('quest_completion_requests').select('*, quests(name,icon)')
      .eq('user_id', myProfile.id).gte('created_at', cutoff)
      .order('created_at', { ascending: false }).limit(100),
    sb.from('transactions').select('*')
      .eq('user_id', myProfile.id).gte('created_at', cutoff)
      .order('created_at', { ascending: false }).limit(500),
    sb.from('gacha_logs').select('*')
      .eq('user_id', myProfile.id).gte('created_at', cutoff)
      .order('created_at', { ascending: false }).limit(300),
  ]);

  // ìƒí’ˆ ì‹ ì²­ í˜„í™©ë§Œ í‘œì‹œ (í€˜ìŠ¤íŠ¸ ì‹ ì²­ì€ ë³„ë„)
  _reqPage  = 0;
  _reqItems = (myReqs||[]).map(r => ({
    label: r.product_snapshot?.name || 'ìƒí’ˆ',
    icon:  r.product_snapshot?.icon || 'ğŸ',
    sub:   fmtTs(r.created_at) + (r.price ? ` Â· ${r.price}ğŸŒ°` : ' Â· ë½‘ê¸°') + (r.from_gacha ? ' ğŸ²' : ''),
    status: r.status,
    created_at: r.created_at,
  }));

  _renderReqPage();

  // í€˜ìŠ¤íŠ¸ ì‹ ì²­ í˜„í™© (í˜ì´ì§€ë„¤ì´ì…˜)
  window._qcrPage = 0;
  window._qcrCache = myQCRs || [];
  _renderQcrPage(window._qcrCache);

  // ë½‘ê¸° ê¸°ë¡
  _glogPage  = 0;
  _glogItems = gachaLogs || [];
  _renderGlogPage();

  // ë„í† ë¦¬ ë‚´ì—­
  _txPage  = 0;
  _txItems = txs || [];
  _renderTxPage();
}

async function renderInventory() {
  const el = document.getElementById('myInventory');
  if (!el) return;
  el.innerHTML = '<p class="text-xs text-gray-400 col-span-3 text-center py-2">ë¡œë”© ì¤‘...</p>';
  // í—¤ë” í‹°ì¼“ ìˆ˜ ê°±ì‹ 
  updateTicketDisplay().catch(()=>{});

  // products JOINìœ¼ë¡œ í•­ìƒ ìµœì‹  ìƒí’ˆ ì •ë³´ ì‚¬ìš©
  const [{ data: items }, { data: pendingReqs }] = await Promise.all([
    sb.from('inventory')
      .select('*, products(id,name,icon,description,reward_type,discount_pct,acorn_amt)')
      .eq('user_id', myProfile.id).eq('status', 'held')
      .order('created_at', { ascending: false }),
    sb.from('product_requests')
      .select('inventory_id')
      .eq('user_id', myProfile.id).eq('status', 'pending')
  ]);

  if (!items?.length) {
    el.innerHTML = '<p class="text-xs text-gray-400 col-span-3 text-center py-4">ì•„ì´í…œì´ ì—†ì–´ìš” ğŸ’</p>';
    return;
  }

  // pending ìƒíƒœì¸ inventory_id ì§‘í•© (DB + ë¡œì»¬ ìºì‹œ í•©ì‚°)
  const pendingIds = new Set((pendingReqs||[]).map(r => r.inventory_id).filter(Boolean));
  if (window._pendingInvIds) window._pendingInvIds.forEach(id => pendingIds.add(id));

  window._invCache = items;
  el.innerHTML = items.map(item => {
    // snapshot ìš°ì„  (ì„ ë¬¼ ì•„ì´í…œì€ product_id=nullì´ë¼ JOIN ì—†ìŒ)
    const p = item.product_snapshot || item.products || {};
    const isCoupon       = p.reward_type === 'COUPON';
    const isAcornTicket  = p.reward_type === 'ACORN_TICKET';
    const isGachaTicket  = p.reward_type === 'GACHA_TICKET';
    const isGiftTicket   = p.reward_type === 'GIFT_GACHA_TICKET';
    const isGiftAcorn    = p.reward_type === 'GIFT_ACORN';
    const isInstant      = isGiftTicket || isGiftAcorn || isAcornTicket;
    const isPending = pendingIds.has(item.id);

    let btnLabel = 'ì‚¬ìš©í•˜ê¸°';
    if (isCoupon)      btnLabel = 'ğŸŸï¸ ì¿ í° ì‚¬ìš©';
    if (isAcornTicket) btnLabel = `ğŸŒ° +${p.acorn_amt||0} ë°›ê¸°`;
    if (isGachaTicket) btnLabel = 'ğŸ« ë½‘ê¸° 1íšŒ';
    if (isGiftTicket)  btnLabel = `ğŸ« í‹°ì¼“ ${p.gift_qty||1}ì¥ ë°›ê¸°`;
    if (isGiftAcorn)   btnLabel = `ğŸŒ° ë„í† ë¦¬ ${p.gift_qty||0} ë°›ê¸°`;

    const btnColor = isGiftTicket||isGachaTicket ? 'btn-purple'
      : isGiftAcorn||isAcornTicket ? 'btn-green' : 'btn-primary';
    const btnHtml = isPending
      ? `<button class="btn w-full py-1 text-xs mt-1" disabled style="background:#fef3c7;color:#92400e;border:1.5px solid rgba(245,158,11,0.3);cursor:not-allowed">â³ ìŠ¹ì¸ ëŒ€ê¸°ì¤‘</button>`
      : `<button class="btn ${btnColor} w-full py-1 text-xs mt-1" onclick="useInventoryItem('${item.id}')">${btnLabel}</button>`;

    const bgClass = isPending ? 'bg-gray-50 border-gray-200 opacity-70'
      : isCoupon                    ? 'bg-yellow-50 border-yellow-200 cursor-pointer card-hover'
      : isAcornTicket||isGiftAcorn  ? 'bg-green-50 border-green-200 cursor-pointer card-hover'
      : isGachaTicket||isGiftTicket ? 'bg-purple-50 border-purple-200 cursor-pointer card-hover'
      : 'bg-amber-50 border-amber-100 cursor-pointer card-hover';

    // GIFT_ACORN: ì´ë¦„/ë²„íŠ¼ë§Œ í‘œì‹œ (badge, sourceTag ì—†ìŒ)
    if (isGiftAcorn) {
      return `<div class="flex flex-col items-center gap-1 p-3 rounded-2xl border-2 ${bgClass}">
        <div class="text-3xl" onclick="useInventoryItem('${item.id}')">ğŸ</div>
        <p class="text-xs font-black text-gray-700 text-center leading-tight">ë„í† ë¦¬ ì„ ë¬¼</p>
        ${btnHtml}
      </div>`;
    }

    const badge = isCoupon      ? `<span class="text-xs font-black text-yellow-700 bg-yellow-100 rounded-full px-2 py-0.5">ğŸŸï¸ ${p.discount_pct||0}% í• ì¸</span>`
      : isAcornTicket            ? `<span class="text-xs font-black text-green-700 bg-green-100 rounded-full px-2 py-0.5">ğŸŒ° ${p.acorn_amt||0} ë„í† ë¦¬</span>`
      : isGachaTicket            ? `<span class="text-xs font-black text-purple-700 bg-purple-100 rounded-full px-2 py-0.5">ğŸ« ë½‘ê¸°ê¶Œ</span>`
      : isGiftTicket             ? `<span class="text-xs font-black text-purple-700 bg-purple-100 rounded-full px-2 py-0.5">ğŸ« í‹°ì¼“ ${p.gift_qty||1}ì¥</span>`
      : '';

    const sourceTag = isGiftTicket
      ? `<span class="text-xs it-store">ğŸ ì„ ë¬¼</span>`
      : `<span class="text-xs ${item.from_gacha ? 'it-gacha' : 'it-store'}">${item.from_gacha ? 'ğŸ² ë½‘ê¸°' : 'ğŸ›ï¸ êµ¬ë§¤'}</span>`;

    return `<div class="flex flex-col items-center gap-1 p-3 rounded-2xl border-2 ${bgClass}">
      <div class="text-3xl" ${isPending ? '' : `onclick="useInventoryItem('${item.id}')"`}>${p.icon || 'ğŸ'}</div>
      <p class="text-xs font-black text-gray-700 text-center leading-tight">${p.name || 'ì•„ì´í…œ'}</p>
      ${badge}
      ${sourceTag}
      ${btnHtml}
    </div>`;
  }).join('');
}

async function useInventoryItem(inventoryId) {
  const item = (window._invCache || []).find(i => i.id === inventoryId);
  const p = item?.products || item?.product_snapshot || {};

  // ë„í† ë¦¬ í‹°ì¼“ í™•ì¸ ëª¨ë‹¬
  if (p.reward_type === 'ACORN_TICKET') {
    showModal(`<div class="text-center">
      <div style="font-size:2.5rem">ğŸŒ°</div>
      <h2 class="text-lg font-black text-gray-800 mt-2 mb-1">${p.name}</h2>
      <div class="text-3xl font-black text-amber-600 my-3">+${p.acorn_amt||0}ğŸŒ°</div>
      <p class="text-sm text-gray-500 mb-4">ì‚¬ìš©í•˜ë©´ ì¦‰ì‹œ ë„í† ë¦¬ê°€ ì§€ê¸‰ë©ë‹ˆë‹¤.</p>
      <div class="flex gap-2">
        <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-green flex-1 py-2" onclick="closeModal();confirmUseItem('${inventoryId}')">ğŸŒ° ì‚¬ìš©í•˜ê¸°</button>
      </div></div>`);
    return;
  }

  // ì„ ë¬¼ ë½‘ê¸° í‹°ì¼“ í™•ì¸ ëª¨ë‹¬
  if (p.reward_type === 'GIFT_GACHA_TICKET') {
    const giftQty = p.gift_qty || 1;
    showModal(`<div class="text-center">
      <div style="font-size:2.5rem">ğŸ</div>
      <h2 class="text-lg font-black text-gray-800 mt-2 mb-1">${p.name}</h2>
      <div class="text-2xl font-black text-purple-600 my-3">ğŸ« +${giftQty}ì¥</div>
      <p class="text-sm text-gray-500 mb-4">ì‚¬ìš©í•˜ë©´ ë½‘ê¸° í‹°ì¼“ ${giftQty}ì¥ì´ ì¦‰ì‹œ ì¶”ê°€ë©ë‹ˆë‹¤.</p>
      <div class="flex gap-2">
        <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-purple flex-1 py-2" onclick="closeModal();confirmUseItem('${inventoryId}')">ğŸ« ë°›ê¸°</button>
      </div></div>`);
    return;
  }

  // ì„ ë¬¼ ë„í† ë¦¬ í™•ì¸ ëª¨ë‹¬
  if (p.reward_type === 'GIFT_ACORN') {
    const giftQty = p.gift_qty || item.product_snapshot?.gift_qty || 0;
    const memo = p.memo || item.product_snapshot?.memo || '';
    showModal(`<div style="text-align:center;font-family:'Nunito',sans-serif">
      <div style="position:relative;display:inline-block;margin-bottom:4px">
        <span style="position:absolute;top:2px;right:-2px;font-size:13px;animation:sparkle 2s ease-in-out infinite">âœ¨</span>
        <span style="position:absolute;top:18px;left:-6px;font-size:10px;animation:sparkle 2s ease-in-out infinite;animation-delay:.6s">â­</span>
        <span style="font-size:3rem;display:block;animation:float 3s ease-in-out infinite;filter:drop-shadow(0 6px 12px rgba(52,211,153,0.25))">ğŸ</span>
      </div>
      <h2 style="font-family:'Jua',sans-serif;font-size:1.1rem;color:#374151;margin:8px 0 4px">ë„í† ë¦¬ ì„ ë¬¼</h2>
      <div style="display:inline-flex;align-items:center;gap:5px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1.5px solid rgba(52,211,153,0.3);border-radius:20px;padding:4px 12px;font-size:11px;font-weight:700;color:#065f46;margin-bottom:14px">
        <span style="width:6px;height:6px;border-radius:50%;background:#34d399;display:inline-block;flex-shrink:0"></span>
        ê´€ë¦¬ìê°€ ë³´ë‚¸ ì„ ë¬¼
      </div>
      <div style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:2px solid rgba(52,211,153,0.25);border-radius:20px;padding:14px 20px;margin-bottom:14px">
        <div style="font-family:'Jua',sans-serif;font-size:2rem;color:#065f46;line-height:1;display:flex;align-items:center;justify-content:center;gap:6px">
          <span style="font-size:1.1rem;color:#34d399">+</span>ğŸŒ° ${giftQty}
        </div>
        <div style="font-size:11px;color:#6ee7b7;margin-top:3px;font-weight:700">ì¦‰ì‹œ ì§€ê¸‰</div>
      </div>
      ${memo ? `<div style="display:flex;flex-direction:row;align-items:center;justify-content:center;gap:6px;background:rgba(249,250,251,0.8);border:1.5px solid rgba(210,180,240,0.3);border-radius:14px;padding:10px 14px;margin-bottom:18px">
        <span style="font-size:15px;line-height:1;flex-shrink:0">ğŸ’¬</span>
        <span style="font-size:12px;font-weight:700;color:#6b7280;line-height:1">${memo}</span>
      </div>` : '<div style="margin-bottom:18px"></div>'}
      <div style="display:flex;gap:8px">
        <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-green flex-1 py-2" onclick="closeModal();confirmUseItem('${inventoryId}')">ğŸŒ° ë°›ê¸°</button>
      </div>
    </div>`);
    return;
  }

  // ë½‘ê¸° í‹°ì¼“ í™•ì¸ ëª¨ë‹¬
  if (p.reward_type === 'GACHA_TICKET') {
    showModal(`<div class="text-center">
      <div style="font-size:2.5rem">ğŸ«</div>
      <h2 class="text-lg font-black text-gray-800 mt-2 mb-1">${p.name}</h2>
      <p class="text-sm text-gray-500 mb-4">ë½‘ê¸° íƒ­ì—ì„œ <b>í‹°ì¼“ìœ¼ë¡œ ë½‘ê¸°</b> ë²„íŠ¼ìœ¼ë¡œ ìë™ ì ìš©ë©ë‹ˆë‹¤.<br>ì¸ë²¤í† ë¦¬ì— ë³´ê´€ ì¤‘ì¸ í‹°ì¼“ì€ ë½‘ê¸° íƒ­ì—ì„œ ìš°ì„  ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
      <div class="flex gap-2">
        <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-purple flex-1 py-2" onclick="closeModal();confirmUseItem('${inventoryId}')">ğŸ« ë½‘ê¸° ì‹œì‘</button>
      </div></div>`);
    return;
  }

  if (p.reward_type === 'COUPON') {
    showModal(`
      <div class="text-center">
        <div style="font-size:2.6rem;line-height:1;margin-bottom:8px">ğŸŸï¸</div>
        <h2 class="text-lg font-black text-gray-800 mb-1">${p.name}</h2>
        <div class="text-3xl font-black text-yellow-600 my-3">${p.discount_pct || 0}% í• ì¸ ì¿ í°</div>
        <p class="text-sm text-gray-500 mb-4">${p.description || 'ìƒì ì—ì„œ ì•„ì´í…œ êµ¬ë§¤ ì‹œ<br>í• ì¸ëœ ê°€ê²©ìœ¼ë¡œ êµ¬ë§¤í•  ìˆ˜ ìˆì–´ìš”!'}</p>
        <div class="modal-notice-box">
          ğŸ›ï¸ ìƒì ì—ì„œ ì•„ì´í…œ êµ¬ë§¤ ì‹œ ì´ ì¿ í°ì„ ì„ íƒí•˜ë©´<br>
          <span class="font-black text-yellow-700">${p.discount_pct || 0}% í• ì¸</span>ëœ ê°€ê²©ìœ¼ë¡œ êµ¬ë§¤í•  ìˆ˜ ìˆì–´ìš”.<br>
          ë‹¨, <span class="font-black">1íšŒë§Œ</span> ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
        <div class="flex gap-2">
          <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ë‹«ê¸°</button>
          <button class="btn btn-primary flex-1 py-2" onclick="closeModal();uTab('shop',document.querySelector('#userMode .tab-btn'))">ğŸ›ï¸ ìƒì ìœ¼ë¡œ</button>
        </div>
      </div>`);
    return;
  }

  showModal(`
    <div class="text-center">
      <div style="font-size:2.6rem;line-height:1;margin-bottom:8px">${p.icon || 'ğŸ'}</div>
      <h2 class="text-lg font-black text-gray-800" style="margin-bottom:4px">${p.name || 'ì•„ì´í…œ'}</h2>
      <p class="text-sm text-gray-400" style="margin-bottom:12px">${p.description || ''}</p>
      <div class="modal-notice-box">
        âœ‹ ì‚¬ìš©í•˜ë©´ ê´€ë¦¬ìì—ê²Œ ì‹ ì²­ì´ ì „ë‹¬ë¼ìš”.<br>ìŠ¹ì¸ í›„ ì•„ì´í…œì´ ì§€ê¸‰ë©ë‹ˆë‹¤.
      </div>
      <div class="flex gap-2" style="margin-top:4px">
        <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-2" onclick="confirmUseItem('${inventoryId}')">ì‚¬ìš©í•˜ê¸°!</button>
      </div>
    </div>`);
}

async function resellInventoryItem(inventoryId, e) {
  if (e) e.stopPropagation();
  const item = (window._invCache || []).find(i => i.id === inventoryId);
  const p = item?.products || item?.product_snapshot || {};
  const resellPrice = p.resell_price || 0;
  if (!resellPrice) { toast('âŒ', 'ì´ ì•„ì´í…œì€ ë˜íŒ”ê¸°ê°€ ë¶ˆê°€í•´ìš”'); return; }

  showModal(`
    <div class="text-center">
      <div style="font-size:2.6rem;line-height:1;margin-bottom:8px">${p.icon || 'ğŸ'}</div>
      <h2 class="text-lg font-black text-gray-800 mb-1">${p.name}</h2>
      <div class="text-3xl font-black text-amber-600 my-3">+${resellPrice} ğŸŒ°</div>
      <div class="modal-notice-box" style="background:rgba(245,158,11,0.1);border-color:rgba(245,158,11,0.25)">
        ğŸ’° ì´ ì•„ì´í…œì„ ë˜íŒ”ë©´ <span class="font-black">${resellPrice} ë„í† ë¦¬</span>ë¥¼ ë°›ì•„ìš”.<br>
        ë˜íŒ”ê¸°í•œ ì•„ì´í…œì€ <span class="font-black">ë³µêµ¬ë˜ì§€ ì•Šì•„ìš”!</span>
      </div>
      <div class="flex gap-2" style="margin-top:4px">
        <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-green flex-1 py-2" onclick="confirmResellItem('${inventoryId}')">ğŸ’° ë˜íŒ”ê¸°!</button>
      </div>
    </div>`);
}

async function confirmResellItem(inventoryId) {
  await withLock('resell_'+inventoryId, async () => {
    closeModal();
    const { data: item } = await sb.from('inventory')
      .select('*, products(id,name,icon,resell_price)')
      .eq('id', inventoryId).eq('status', 'held').single();
    if (!item) { toast('âŒ', 'ì´ë¯¸ ì²˜ë¦¬ëœ ì•„ì´í…œì´ì—ìš”'); return; }

    const p = item.products || item.product_snapshot || {};
    const resellPrice = p.resell_price || 0;
    if (!resellPrice) { toast('âŒ', 'ì´ ì•„ì´í…œì€ ë˜íŒ”ê¸°ê°€ ë¶ˆê°€í•´ìš”'); return; }

    // pending ì‹ ì²­ì´ ìˆìœ¼ë©´ ë˜íŒ”ê¸° ì°¨ë‹¨
    const { data: pendingReq } = await sb.from('product_requests')
      .select('id').eq('inventory_id', inventoryId).eq('status', 'pending').limit(1);
    if (pendingReq && pendingReq.length > 0) {
      toast('âŒ', 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ìˆì–´ìš”. ì·¨ì†Œ í›„ ë˜íŒ”ê¸° í•´ì£¼ì„¸ìš”.'); return;
    }

    const { data: updated, error: updateErr } = await sb.from('inventory')
      .update({ status: 'resold' })
      .eq('id', inventoryId).eq('status', 'held').select('id');
    if (updateErr || !updated || updated.length === 0) {
      toast('âŒ', 'ì´ë¯¸ ì²˜ë¦¬ëœ ì•„ì´í…œì´ì—ìš” (ì¤‘ë³µ ë°©ì§€)'); return;
    }

    const res = await sb.rpc('adjust_acorns', { p_user_id: myProfile.id, p_amount: resellPrice, p_reason: `ë˜íŒ”ê¸° â€” ${p.name}` });
    if (res.data?.success) { myProfile.acorns = res.data.balance; updateAcornDisplay(); }
    await pushNotif(myProfile.id, 'reward', 'ë˜íŒ”ê¸° ì™„ë£Œ! ğŸ’°', `${p.icon} ${p.name} ë˜íŒ”ê¸°ë¡œ +${resellPrice}ğŸŒ° íšë“!`);
    playSound('reward');
    toast('ğŸ’°', `${p.name} ë˜íŒ”ê¸°! +${resellPrice}ğŸŒ°`);
    renderInventory();
  });
}

async function confirmUseItem(inventoryId) {
  await withLock('useitem_'+inventoryId, async () => { await _confirmUseItemInner(inventoryId); });
}
async function _confirmUseItemInner(inventoryId) {
  closeModal();
  const { data: item } = await sb.from('inventory')
    .select('*, products(id,name,icon,description,reward_type)')
    .eq('id', inventoryId).single();
  if (!item) { toast('âŒ', 'ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”'); return; }
  const p = item.products || item.product_snapshot || {};

  // ë™ì¼ ì¸ë²¤í† ë¦¬ ì•„ì´í…œì˜ ì¤‘ë³µ ì‚¬ìš©ì‹ ì²­ ë°©ì§€ (inventoryId ê¸°ì¤€)
  {
    const { data: existingReq } = await sb.from('product_requests')
      .select('id').eq('user_id', myProfile.id).eq('inventory_id', inventoryId).eq('status', 'pending').limit(1);
    if (existingReq && existingReq.length > 0) {
      toast('â³', 'ì´ë¯¸ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ìˆì–´ìš”!'); return;
    }
  }

  // â”€â”€ ì„ ë¬¼ ë½‘ê¸° í‹°ì¼“: ì¦‰ì‹œ ì¹´ìš´í„° ì¶”ê°€ â”€â”€
  if (p.reward_type === 'GIFT_GACHA_TICKET') {
    const giftQty = p.gift_qty || item.product_snapshot?.gift_qty || 1;
    await sb.from('inventory').update({ status: 'used' }).eq('id', inventoryId);
    const { data: tr } = await sb.rpc('adjust_gacha_tickets', {
      p_user_id: myProfile.id, p_amount: giftQty
    });
    if (tr?.success) window._gachaTicketCount = tr.count;
    playSound('reward');
    toast('ğŸ«', `ë½‘ê¸° í‹°ì¼“ ${giftQty}ì¥ íšë“!`);
    triggerAutoQuest('itemUse');
    window._gachaTicketCount = undefined; // ìºì‹œ ë¬´íš¨í™”
    renderInventory();
    renderMypage();
    return;
  }

  // â”€â”€ ì„ ë¬¼ ë„í† ë¦¬: ì¦‰ì‹œ ì§€ê¸‰ â”€â”€
  if (p.reward_type === 'GIFT_ACORN') {
    const giftQty = p.gift_qty || item.product_snapshot?.gift_qty || 0;
    await sb.from('inventory').update({ status: 'used' }).eq('id', inventoryId);
    if (giftQty > 0) {
      const res = await sb.rpc('adjust_acorns', {
        p_user_id: myProfile.id, p_amount: giftQty,
        p_reason: `ë„í† ë¦¬ ì„ ë¬¼ ì‚¬ìš© â€” ${giftQty}ğŸŒ°`
      });
      if (res.data?.success) myProfile.acorns = res.data.balance;
    }
    playSound('reward');
    toast('ğŸŒ°', `ë„í† ë¦¬ +${giftQty}ğŸŒ° íšë“!`);
    triggerAutoQuest('itemUse');
    updateAcornDisplay();
    renderInventory();
    renderMypage();
    return;
  }

  // â”€â”€ ë„í† ë¦¬ í‹°ì¼“: ì¦‰ì‹œ ì§€ê¸‰ â”€â”€
  if (p.reward_type === 'ACORN_TICKET') {
    await sb.from('inventory').update({ status: 'used' }).eq('id', inventoryId);
    const acornAmt = p.acorn_amt || item.product_snapshot?.acorn_amt || 0;
    if (acornAmt > 0) {
      const res = await sb.rpc('adjust_acorns', {
        p_user_id: myProfile.id, p_amount: acornAmt,
        p_reason: `ë„í† ë¦¬ í‹°ì¼“ ì‚¬ìš© â€” ${p.icon} ${p.name}`
      });
      if (res.data?.success) myProfile.acorns = res.data.balance;
    }
    playSound('reward');
    toast('ğŸŒ°', `${p.name} ì‚¬ìš©! +${acornAmt}ğŸŒ°`);
    updateAcornDisplay();
    triggerAutoQuest('itemUse');
    renderInventory();
    renderMypage();
    return;
  }

  // â”€â”€ ë½‘ê¸° í‹°ì¼“: ë¬´ë£Œ ë½‘ê¸° 1íšŒ â”€â”€
  if (p.reward_type === 'GACHA_TICKET') {
    await sb.from('inventory').update({ status: 'used' }).eq('id', inventoryId);
    playSound('pop');
    toast('ğŸ«', 'ë½‘ê¸° í‹°ì¼“ ì‚¬ìš©! ë½‘ê¸°ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤');
    triggerAutoQuest('itemUse');
    renderInventory();
    // ë½‘ê¸° íƒ­ìœ¼ë¡œ ì´ë™ (í‹°ì¼“ì€ ìë™ìœ¼ë¡œ ì¸ì‹ë¨)
    setTimeout(() => {
      uTab('gacha', document.querySelector('#userMode .tab-btn[onclick*="gacha"]'));
    }, 300);
    return;
  }

  // ì¸ë²¤í† ë¦¬ëŠ” pending ìƒíƒœ ìœ ì§€ (ê´€ë¦¬ì ìŠ¹ì¸ ì‹œ 'used'ë¡œ ë³€ê²½)
  // UIì—ì„œ ë²„íŠ¼ë§Œ "ìŠ¹ì¸ ëŒ€ê¸°ì¤‘"ìœ¼ë¡œ ë³€ê²½

  // product_requestsì— ì‹ ì²­ ìƒì„± (product_id + snapshot + inventory_id ì €ì¥)
  const { error: reqErr } = await sb.from('product_requests').insert({
    user_id: myProfile.id,
    product_id: item.product_id,
    product_snapshot: item.product_snapshot,
    price: 0,
    status: 'pending',
    reward_type: 'MANUAL_ITEM',
    from_gacha: item.from_gacha || false,
    inventory_id: inventoryId
  });
  if (reqErr) { toast('âŒ', 'ì‹ ì²­ ì‹¤íŒ¨: ' + reqErr.message); return; }

  // ì¦‰ì‹œ pending ìºì‹œì— ì¶”ê°€ â†’ renderInventory í˜¸ì¶œ ì‹œ ë²„íŠ¼ ì¦‰ì‹œ ë³€ê²½
  if (!window._pendingInvIds) window._pendingInvIds = new Set();
  window._pendingInvIds.add(inventoryId);

  playSound('pop');
  toast('âœ…', `${p.name || snap?.name} ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`);
  triggerAutoQuest('itemUse');

  // ë Œë”ë§ ë¨¼ì € â€” ë²„íŠ¼ ì¦‰ì‹œ ë³€ê²½
  await renderInventory();
  renderMypage();

  // ì•Œë¦¼ì€ ë°±ê·¸ë¼ìš´ë“œ (UI ë¸”ë¡œí‚¹ ì—†ìŒ)
  pushNotif(myProfile.id, 'request', 'ì‹ ì²­ ì™„ë£Œ! âœ‹', `${p.icon||snap?.icon} ${p.name||snap?.name} ì‹ ì²­ì„ ë³´ëƒˆì–´ìš”. ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì´ì—ìš”.`).catch(()=>{});
  sb.from('users').select('id').eq('is_admin', true).maybeSingle().then(({ data: adminUser }) => {
    if (adminUser) {
      pushNotif(adminUser.id, 'request', `ğŸ“¬ ì‹ ì²­ ë„ì°©! ${snap?.icon} ${snap?.name}`,
        `${myProfile.display_name}ë‹˜ì´ ì•„ì´í…œ ì‚¬ìš©ì„ ì‹ ì²­í–ˆì–´ìš”.`).catch(()=>{});
    }
  }).catch(()=>{});
  sendBrowserNotif('ğŸ“¬ ìƒˆ ì‹ ì²­ì´ ë„ì°©í–ˆì–´ìš”!', `${myProfile.display_name}ë‹˜: ${snap?.icon} ${snap?.name} ì‚¬ìš© ì‹ ì²­`);
}

// ë¸Œë¼ìš°ì € Push ì•Œë¦¼ (Web Notification API)
async function requestNotifPermission() {
  if (!('Notification' in window)) return false;
  if (Notification.permission === 'granted') return true;
  if (Notification.permission === 'denied') return false;
  const result = await Notification.requestPermission();
  return result === 'granted';
}

function sendBrowserNotif(title, body, icon = 'ğŸŒ°') {
  if (!('Notification' in window)) return;
  if (Notification.permission !== 'granted') return;
  try {
    new Notification(title, {
      body,
      icon: '/acorn-shop/apple-touch-icon.png',
      badge: '/acorn-shop/apple-touch-icon.png',
      tag: 'acorn-admin-request',
      renotify: true
    });
  } catch(e) {}
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  NOTIFICATIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pushNotif(userId, type, title, body) {
  await sb.from('notifications').insert({ user_id: userId, type, title, body });
}

async function updateReqBadge() {
  if (!myProfile?.is_admin) return;
  try {
    const { data } = await sb.from('product_requests').select('id').eq('status', 'pending');
    const badge = document.getElementById('reqBadge');
    if (!badge) return;
    const cnt = data?.length || 0;
    if (cnt > 0) {
      badge.textContent = cnt > 9 ? '9+' : cnt;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  } catch(e) {}
}

async function updateNotifDot() {
  const { count } = await sb.from('notifications').select('*', { count: 'exact', head: true })
    .eq('user_id', myProfile.id).eq('is_read', false);
  const dot = document.getElementById('notifDot');
  const btn = document.getElementById('notifBtn');
  if (dot) dot.classList.toggle('hidden', !count);
  if (btn) btn.classList.toggle('hidden', false);
}

async function showNotifications() {
  // ëª¨ë‹¬ ì¦‰ì‹œ ì—´ê¸° â†’ ë¡œë”© ëŠë‚Œ ì—†ì• ê¸°
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-3">ğŸ”” ì•Œë¦¼</h2>
    <div class="notif-scroll" id="notifContent">
      <p class="text-sm text-gray-400 text-center py-6">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>`);

  const typeIcon = { reward:'ğŸ', quest:'ğŸ“‹', admin:'ğŸ‘‘', gachaReward:'ğŸ²', request:'ğŸ“¬', quest_approved:'âœ…', quest_rejected:'âŒ' };
  const [{ data: notifs }] = await Promise.all([
    sb.from('notifications').select('*').eq('user_id', myProfile.id).order('created_at', { ascending: false }).limit(20),
    sb.from('notifications').update({ is_read: true }).eq('user_id', myProfile.id).eq('is_read', false)
  ]);
  updateNotifDot();

  const el = document.getElementById('notifContent');
  if (!el) return;
  el.innerHTML = !notifs?.length
    ? '<p class="text-sm text-gray-400 text-center py-6">ì•Œë¦¼ì´ ì—†ì–´ìš”</p>'
    : notifs.map(n => `<div class="row-item-bg p-3 rounded-2xl mb-2 flex gap-3">
        <span class="text-xl shrink-0">${typeIcon[n.type]||'ğŸ””'}</span>
        <div><p class="text-sm font-black text-gray-800">${n.title}</p>
          <p class="text-xs text-gray-500 font-semibold" style="word-break:break-word">${n.body}</p>
          <p class="text-xs text-gray-400 mt-1">${fmtTs(n.created_at)}</p>
        </div>
      </div>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” GIVE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function populateGiveSelect() {
  const { data: users } = await sb.from('users').select('*').eq('is_admin', false).order('display_name');
  allUsers = users || [];
  const sel = document.getElementById('giveUser');
  if (!sel) return;
  sel.innerHTML = allUsers.map(u => `<option value="${u.id}">${u.display_name} (${u.acorns}ğŸŒ°)</option>`).join('');
  // logUserFilter ì œê±°ë¨ (ì‚¬ìš©ì í˜„í™©íŒìœ¼ë¡œ ëŒ€ì²´)
}

async function giveAcorns() {
  await withLock('giveAcorns', async () => { await _giveAcornsInner(); });
}
async function _giveAcornsInner() {
  const giveBtn = document.querySelector('#atab-give .btn-primary');
  btnLock(giveBtn, 'ì§€ê¸‰ ì¤‘...');
  playSound('click');

  try {
    const userId = document.getElementById('giveUser').value;
    const amount = parseInt(document.getElementById('giveAmount').value);
    const memo   = document.getElementById('giveMemo')?.value || '';
    if (!userId || !amount || amount === 0) { toast('âŒ', 'ì‚¬ìš©ìì™€ ì§€ê¸‰ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”'); return; }

    const { data: u } = await sb.from('users').select('display_name').eq('id', userId).single();
    const isDeduct = amount < 0;
    const absAmt = Math.abs(amount);

    if (isDeduct) {
      // ì°¨ê°: RPCë¡œ ì¦‰ì‹œ ì²˜ë¦¬
      const res = await sb.rpc('admin_give_acorns', { p_target_user_id: userId, p_amount: amount, p_memo: memo || 'ê´€ë¦¬ì ì°¨ê°' });
      if (res.error) { toast('âŒ', 'ì°¨ê° ì‹¤íŒ¨: ' + res.error.message); return; }
      // res.dataëŠ” ê°ì²´ ë˜ëŠ” ë°°ì—´ì¼ ìˆ˜ ìˆìŒ
      const resData = Array.isArray(res.data) ? res.data[0] : res.data;
      if (!resData?.success) { toast('âŒ', 'ì°¨ê° ì‹¤íŒ¨: ' + (resData?.error || JSON.stringify(resData))); return; }
      await pushNotif(userId, 'admin', 'ë„í† ë¦¬ ì°¨ê° ğŸŒ°',
        `ê´€ë¦¬ìê°€ ${absAmt} ë„í† ë¦¬ë¥¼ ì°¨ê°í–ˆì–´ìš”. ${memo ? '(' + memo + ')' : ''}`);
    } else {
      // ì§€ê¸‰: ì„ ë¬¼ìƒìë¥¼ ì¸ë²¤í† ë¦¬ì— ìƒì„±, ì‚¬ìš©ìê°€ ìˆ˜ë ¹ ì‹œ ë„í† ë¦¬ ì¦ê°€
      const { error: invErr } = await sb.from('inventory').insert({
        user_id: userId,
        product_id: null,
        product_snapshot: {
          name: `ë„í† ë¦¬ ì„ ë¬¼ (+${absAmt}ğŸŒ°)`,
          icon: 'ğŸ',
          reward_type: 'GIFT_ACORN',
          gift_qty: absAmt,
          memo: memo || ''
        },
        from_gacha: false,
        status: 'held'
      });
      if (invErr) { toast('âŒ', 'ì„ ë¬¼ ì‹¤íŒ¨: ' + invErr.message); return; }
      await pushNotif(userId, 'admin', 'ì„ ë¬¼ ë„ì°©! ğŸ',
        `ë„í† ë¦¬ ${absAmt}ğŸŒ°ë¥¼ ì„ ë¬¼ë°›ì•˜ì–´ìš”! ì¸ë²¤í† ë¦¬ë¥¼ í™•ì¸í•˜ì„¸ìš”. ${memo ? '(' + memo + ')' : ''}`);
    }
    toast('âœ…', `${u?.display_name||'ì‚¬ìš©ì'}ì—ê²Œ ${absAmt} ë„í† ë¦¬ ${isDeduct ? 'ì°¨ê°' : 'ì„ ë¬¼'}!`);
    document.getElementById('giveAmount').value = '';
    document.getElementById('giveMemo').value = '';
    populateGiveSelect();
    renderGiveHistory();
  } finally {
    btnUnlock(giveBtn);
  }
}


async function renderGiveHistory() {
  const { data: list } = await sb.from('transactions').select('*, users(display_name)').ilike('reason', 'ê´€ë¦¬ì ì§€ê¸‰%').order('created_at', { ascending: false }).limit(8);
  const el = document.getElementById('giveHistory');
  el.innerHTML = list?.length
    ? list.map(t => `<div class="flex items-center justify-between p-3 rounded-xl bg-gray-50">
        <div><p class="text-sm font-bold text-gray-800">${t.users?.display_name||''}</p>
          <p class="text-xs text-gray-400">${t.reason.replace('ê´€ë¦¬ì ì§€ê¸‰ â€” ','')} Â· ${fmtTs(t.created_at)}</p></div>
        <span class="font-black text-amber-600">+${t.amount}ğŸŒ°</span>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-4">ì§€ê¸‰ ë‚´ì—­ ì—†ìŒ</p>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” PRODUCTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAcornField(prefix) {
  const sel = document.getElementById(prefix+'-rewardType');
  const fld = document.getElementById(prefix+'-acornWrap');
  if (sel && fld) fld.classList.toggle('hidden', sel.value !== 'AUTO_ACORN' && sel.value !== 'ACORN_TICKET');
}

function toggleCouponField(prefix) {
  const sel = document.getElementById(prefix+'-rewardType');
  const couponWrap = document.getElementById(prefix+'-couponWrap');
  if (sel && couponWrap) couponWrap.classList.toggle('hidden', sel.value !== 'COUPON');
}

function toggleItemType(prefix) {
  const sel = document.getElementById(prefix+'-itemType');
  const probWrap = document.getElementById(prefix+'-probabilityWrap');
  const priceWrap = document.getElementById(prefix+'-priceWrap');
  const resellWrap = document.getElementById(prefix+'-resellWrap');
  const stockWrap = document.getElementById(prefix+'-stockWrap');
  if (sel && probWrap) probWrap.classList.toggle('hidden', sel.value !== 'gacha');
  if (sel && priceWrap) priceWrap.classList.toggle('hidden', sel.value === 'gacha');
  if (sel && resellWrap) resellWrap.classList.toggle('hidden', sel.value !== 'gacha');
  if (sel && stockWrap) stockWrap.classList.toggle('hidden', sel.value !== 'store');
}

function _productCard(p, i, listType) {
  const bg = p.active ? 'bg-gray-50' : 'bg-red-50 opacity-60';
  return `<div class="p-3 rounded-2xl ${bg} drag-item border-2 border-transparent"
      data-id="${p.id}" data-type="${listType}" data-order="${p.sort_order}"
      draggable="true"
      ondragstart="drgStart(event,'${p.id}','${listType}')"
      ondragover="drgOver(event)"
      ondrop="drgDrop(event,'${p.id}','${listType}')"
      ondragend="drgEnd(event)">
    <div class="flex items-center gap-2">
      <div class="text-gray-300 select-none">â ¿</div>
      <div class="text-xl">${p.icon}</div>
      <div class="flex-1 min-w-0">
        <p class="font-black text-gray-800 text-sm truncate">${p.name}</p>
        <div class="flex items-center gap-1 flex-wrap mt-0.5">
          ${listType === 'store'
          ? `<span class="text-xs text-gray-500 font-bold">${p.price}ğŸŒ°</span>
             ${p.stock !== null && p.stock !== undefined && p.stock >= 0
               ? (p.stock === 0
                 ? '<span class="badge-soldout-sm">í’ˆì ˆ</span>'
                 : `<span class="badge-stock-sm">ì¬ê³  ${p.stock}</span>`)
               : '<span class="badge-unlimited-sm">ë¬´ì œí•œ</span>'}`
          : `<span class="text-xs text-purple-600 font-bold">${p.probability||0}%</span>`}
          <span class="${p.reward_type==='AUTO_ACORN'?'rt-auto':'rt-manual'} text-xs">${p.reward_type==='AUTO_ACORN'?'âš¡':'ğŸ“¬'}</span>
          ${p.reward_type==='AUTO_ACORN'?`<span class="text-xs text-green-600 font-bold">+${p.acorn_amt}ğŸŒ°</span>`:''}
          ${!p.active?'<span class="badge-soldout-sm">ë¹„í™œì„±</span>':''}
        </div>
      </div>
    </div>
    <div class="flex gap-1 mt-2">
      <button class="btn btn-blue flex-1 py-1 text-xs" onclick="editProduct('${p.id}')">ìˆ˜ì •</button>
      <button class="btn btn-red px-2 py-1 text-xs" onclick="deleteProduct('${p.id}')">ğŸ—‘</button>
    </div>
  </div>`;
}

async function renderProductAdmin() {
  const { data: products } = await sb.from('products').select('*').order('sort_order');
  const storeEl = document.getElementById('storeProductList');
  const gachaEl = document.getElementById('gachaProductList');
  if (!storeEl || !gachaEl) return;

  const storeItems = (products||[]).filter(p => (p.item_type||'store') === 'store');
  const gachaItems = (products||[]).filter(p => p.item_type === 'gacha');

  storeEl.innerHTML = storeItems.length
    ? storeItems.map((p,i) => _productCard(p,i,'store')).join('')
    : '<p class="text-xs text-gray-400 text-center py-3">ìƒí’ˆì´ ì—†ì–´ìš”</p>';

  gachaEl.innerHTML = gachaItems.length
    ? gachaItems.map((p,i) => _productCard(p,i,'gacha')).join('')
    : '<p class="text-xs text-gray-400 text-center py-3">ìƒí’ˆì´ ì—†ì–´ìš”</p>';
}

function toggleStockField() {
  const type = document.getElementById('ns-stockType')?.value;
  const fld  = document.getElementById('ns-stock');
  if (fld) fld.classList.toggle('hidden', type !== 'limited');
}

async function addStoreProduct() {
  const name       = document.getElementById('ns-name').value.trim();
  const icon       = document.getElementById('ns-icon').value || 'ğŸ';
  const price      = parseInt(document.getElementById('ns-price').value) || 0;
  const desc       = document.getElementById('ns-desc').value || '';
  const rewardType = document.getElementById('ns-rewardType').value;
  const acornAmt   = parseInt(document.getElementById('ns-acornAmt').value) || 0;
  const stockType  = document.getElementById('ns-stockType')?.value || 'unlimited';
  const stock      = stockType === 'limited' ? (parseInt(document.getElementById('ns-stock').value) || 1) : null;
  if (!name) { toast('âŒ', 'ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!price) { toast('âŒ', 'ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (stockType === 'limited' && (!stock || stock < 1)) { toast('âŒ', 'ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const { data: all } = await sb.from('products').select('id');
  const { error } = await sb.from('products').insert({
    name, price, icon, description: desc,
    reward_type: rewardType, acorn_amt: acornAmt,
    item_type: 'store', probability: 0,
    stock: stock,
    active: true, sort_order: (all?.length||0)+1
  });
  if (error) { toast('âŒ', 'ì¶”ê°€ ì‹¤íŒ¨: ' + (error.message || error.details || JSON.stringify(error))); console.error('product insert error:', error); return; }
  ['ns-name','ns-icon','ns-price','ns-desc','ns-acornAmt','ns-stock'].forEach(id => { const e=document.getElementById(id); if(e) e.value=''; });
  document.getElementById('ns-stockType').value = 'unlimited';
  toggleStockField();
  playSound('click');
  renderProductAdmin(); toast('âœ…', 'ìƒì  ìƒí’ˆ ì¶”ê°€ ì™„ë£Œ!');
}

async function addGachaProduct() {
  const name        = document.getElementById('ng-name').value.trim();
  const icon        = document.getElementById('ng-icon').value || 'âœ¨';
  const probability = parseFloat(document.getElementById('ng-probability').value) || 0;
  const desc        = document.getElementById('ng-desc').value || '';
  const rewardType  = document.getElementById('ng-rewardType').value;
  const acornAmt    = parseInt(document.getElementById('ng-acornAmt').value) || 0;
  const resellPrice = parseInt(document.getElementById('ng-resellPrice')?.value) || 0;
  const discountPct = rewardType === 'COUPON' ? (parseInt(document.getElementById('ng-discountPct')?.value) || 0) : 0;
  if (!name) { toast('âŒ', 'ì•„ì´í…œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!probability) { toast('âŒ', 'í™•ë¥ ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 10)'); return; }
  if (rewardType === 'COUPON' && (!discountPct || discountPct < 1 || discountPct > 100)) { toast('âŒ', 'í• ì¸ìœ¨ì„ 1~100 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (rewardType === 'ACORN_TICKET' && !acornAmt) { toast('âŒ', 'ì§€ê¸‰í•  ë„í† ë¦¬ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const { data: all } = await sb.from('products').select('id');
  const { error } = await sb.from('products').insert({
    name, price: 0, icon, description: desc,
    reward_type: rewardType, acorn_amt: acornAmt,
    item_type: 'gacha', probability,
    resell_price: resellPrice,
    discount_pct: discountPct,
    active: true, sort_order: (all?.length||0)+1
  });
  if (error) { toast('âŒ', 'ì¶”ê°€ ì‹¤íŒ¨: ' + error.message); return; }
  ['ng-name','ng-icon','ng-probability','ng-desc','ng-acornAmt','ng-resellPrice','ng-discountPct'].forEach(id => { const e=document.getElementById(id); if(e) e.value=''; });
  playSound('click');
  renderProductAdmin(); toast('âœ…', 'ë½‘ê¸° ìƒí’ˆ ì¶”ê°€ ì™„ë£Œ!');
}

async function deleteProduct(id) {
  if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;

  // ì¸ë²¤í† ë¦¬Â·ì‹ ì²­ í…Œì´ë¸”ì˜ product_id ì°¸ì¡° í•´ì œ
  // (product_snapshotì— ìƒí’ˆ ì •ë³´ê°€ ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆì–´ ê¸°ë¡ í‘œì‹œì—” ë¬¸ì œ ì—†ìŒ)
  await sb.from('inventory').update({ product_id: null }).eq('product_id', id);
  await sb.from('product_requests').update({ product_id: null }).eq('product_id', id);

  const { error } = await sb.from('products').delete().eq('id', id);
  if (error) { toast('âŒ', 'ì‚­ì œ ì‹¤íŒ¨: ' + error.message); return; }
  renderProductAdmin();
  toast('ğŸ—‘ï¸', 'ìƒí’ˆ ì‚­ì œë¨');
}

async function editProduct(id) {
  const { data: p } = await sb.from('products').select('*').eq('id', id).single();
  const it = p.item_type || 'store';
  const prob = p.probability || 0;
  const resell = p.resell_price || 0;
  const discountPct = p.discount_pct || 0;
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-4">âœï¸ ìƒí’ˆ ìˆ˜ì •</h2>
    <div class="space-y-3">
      <input class="field" id="ep-name" value="${p.name}" placeholder="ìƒí’ˆëª…">
      <div class="grid grid-cols-2 gap-2">
        <input class="field" type="number" id="ep-price" value="${p.price}" placeholder="ê°€ê²©">
        <input class="field" id="ep-icon" value="${p.icon}" placeholder="ì´ëª¨ì§€">
      </div>
      <input class="field" id="ep-desc" value="${p.description||''}" placeholder="ì„¤ëª…">
      <div>
        <label class="text-xs font-bold text-gray-500 mb-1 block">ë³´ìƒ íƒ€ì…</label>
        <select class="field" id="ep-rt" onchange="toggleEditAcorn();toggleEditCoupon()">
          <option value="MANUAL_ITEM" ${p.reward_type==='MANUAL_ITEM'?'selected':''}>ğŸ“¬ MANUAL â€” ê´€ë¦¬ì ìŠ¹ì¸</option>
          <option value="AUTO_ACORN" ${p.reward_type==='AUTO_ACORN'?'selected':''}>âš¡ AUTO â€” ì¦‰ì‹œ ì§€ê¸‰</option>
          <option value="COUPON" ${p.reward_type==='COUPON'?'selected':''}>ğŸŸï¸ í• ì¸ì¿ í°</option>
        </select>
      </div>
      <div id="ep-acornWrap" class="${p.reward_type==='AUTO_ACORN'?'':'hidden'}">
        <label class="text-xs font-bold text-gray-500 mb-1 block">ì§€ê¸‰ ë„í† ë¦¬</label>
        <input class="field" type="number" id="ep-acornAmt" value="${p.acorn_amt||0}" placeholder="ë„í† ë¦¬ ìˆ˜ëŸ‰">
      </div>
      <div id="ep-couponWrap" class="${p.reward_type==='COUPON'?'':'hidden'}">
        <label class="text-xs font-bold text-gray-500 mb-1 block">í• ì¸ìœ¨ (%)</label>
        <input class="field" type="number" id="ep-discountPct" value="${discountPct}" placeholder="ì˜ˆ: 20" min="1" max="100">
        <p class="text-xs text-gray-400 mt-1">â€» ìƒì  êµ¬ë§¤ ì‹œ 1íšŒ ì‚¬ìš© ê°€ëŠ¥</p>
      </div>
      <div>
        <label class="text-xs font-bold text-gray-500 mb-1 block">ìƒí’ˆ íƒ€ì…</label>
        <select class="field" id="ep-itemType" onchange="toggleItemType('ep')">
          <option value="store" ${it==='store'?'selected':''}>ğŸ›ï¸ ìƒì  ìƒí’ˆ</option>
          <option value="gacha" ${it==='gacha'?'selected':''}>ğŸ² ë½‘ê¸° ìƒí’ˆ</option>
        </select>
      </div>
      <div id="ep-probabilityWrap" class="${it==='gacha'?'':'hidden'}">
        <label class="text-xs font-bold text-gray-500 mb-1 block">í™•ë¥  (%)</label>
        <input class="field" type="number" step="0.1" min="0" id="ep-probability" value="${prob}" placeholder="ì˜ˆ: 10 â†’ 10%">
        <p class="text-xs text-gray-400 mt-1">â€» í•©ì´ 100ì´ ì•„ë‹ˆì–´ë„ ìë™ ì •ê·œí™”ë©ë‹ˆë‹¤</p>
      </div>
      <div id="ep-resellWrap" class="${it==='gacha'?'':'hidden'}">
        <label class="text-xs font-bold text-gray-500 mb-1 block">ë˜íŒ”ê¸° ê°€ê²© ğŸŒ°</label>
        <input class="field" type="number" id="ep-resellPrice" value="${resell}" placeholder="0 = ë˜íŒ”ê¸° ë¶ˆê°€" min="0">
      </div>
      <div id="ep-stockWrap" class="${it==='store'?'':'hidden'}">
        <label class="text-xs font-bold text-gray-500 mb-1 block">íŒë§¤ ìˆ˜ëŸ‰</label>
        <div class="flex gap-2">
          <select class="field" id="ep-stockType" onchange="toggleEditStock()" style="flex:1">
            <option value="unlimited" ${(p.stock===null||p.stock===undefined||p.stock<0)?'selected':''}>â™¾ï¸ ë¬´ì œí•œ</option>
            <option value="limited" ${(p.stock!==null&&p.stock!==undefined&&p.stock>=0)?'selected':''}>ğŸ”¢ ìˆ˜ëŸ‰ ì œí•œ</option>
          </select>
          <input class="field" type="number" id="ep-stock" value="${(p.stock!==null&&p.stock!==undefined&&p.stock>=0)?p.stock:''}"
            placeholder="ê°œìˆ˜" min="0"
            class="${(p.stock!==null&&p.stock!==undefined&&p.stock>=0)?'':'hidden'}"
            style="width:80px;flex-shrink:0;${(p.stock!==null&&p.stock!==undefined&&p.stock>=0)?'':'display:none'}">
        </div>
      </div>
      <div class="flex gap-3 pt-2">
        <button class="btn btn-gray flex-1 py-3" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-3" onclick="saveProduct('${id}')">ì €ì¥</button>
      </div>
    </div>`);
}
function toggleEditStock() {
  const type = document.getElementById('ep-stockType')?.value;
  const fld  = document.getElementById('ep-stock');
  if (fld) fld.style.display = type === 'limited' ? '' : 'none';
}
function toggleEditAcorn() { const s=document.getElementById('ep-rt'),f=document.getElementById('ep-acornWrap'); if(s&&f)f.classList.toggle('hidden',s.value!=='AUTO_ACORN'); }
function toggleEditCoupon() { const s=document.getElementById('ep-rt'),f=document.getElementById('ep-couponWrap'); if(s&&f)f.classList.toggle('hidden',s.value!=='COUPON'); }
async function saveProduct(id) {
  const it = document.getElementById('ep-itemType')?.value || 'store';
  const stockType = document.getElementById('ep-stockType')?.value || 'unlimited';
  const stockVal = stockType === 'limited'
    ? (parseInt(document.getElementById('ep-stock')?.value) ?? 0)
    : null;
  const rt = document.getElementById('ep-rt').value;
  await sb.from('products').update({
    name: document.getElementById('ep-name').value,
    price: parseInt(document.getElementById('ep-price').value)||0,
    icon: document.getElementById('ep-icon').value,
    description: document.getElementById('ep-desc').value,
    reward_type: rt,
    acorn_amt: parseInt(document.getElementById('ep-acornAmt')?.value)||0,
    item_type: it,
    probability: it === 'gacha' ? (parseFloat(document.getElementById('ep-probability')?.value)||0) : 0,
    stock: it === 'store' ? stockVal : null,
    resell_price: it === 'gacha' ? (parseInt(document.getElementById('ep-resellPrice')?.value)||0) : 0,
    discount_pct: rt === 'COUPON' ? (parseInt(document.getElementById('ep-discountPct')?.value)||0) : 0,
  }).eq('id', id);
  closeModal(); renderProductAdmin(); renderShop(); toast('âœ…', 'ìˆ˜ì • ì™„ë£Œ!');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DRAG & DROP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _dragSrcId = null;
let _dragSrcType = null;

function drgStart(e, id, type) {
  _dragSrcId = id;
  _dragSrcType = type;
  setTimeout(() => { e.target.style.opacity = '.4'; }, 0);
  e.dataTransfer.effectAllowed = 'move';
}
function drgOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}
function drgEnd(e) {
  e.currentTarget.style.opacity = '';
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}
async function drgDrop(e, targetId, targetType) {
  e.preventDefault();
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  if (!_dragSrcId || _dragSrcId === targetId || _dragSrcType !== targetType) {
    _dragSrcId = null; return;
  }

  // ê°™ì€ íƒ€ì… ë‚´ì—ì„œë§Œ ìˆœì„œ ë³€ê²½
  const listEl = targetType === 'store'
    ? document.getElementById('storeProductList')
    : document.getElementById('gachaProductList');
  const cards = Array.from(listEl.querySelectorAll('[data-id]'));
  const ids = cards.map(c => c.dataset.id);

  const srcIdx = ids.indexOf(_dragSrcId);
  const tgtIdx = ids.indexOf(targetId);
  if (srcIdx === -1 || tgtIdx === -1) { _dragSrcId = null; return; }

  // ë°°ì—´ ìˆœì„œ êµí™˜
  ids.splice(srcIdx, 1);
  ids.splice(tgtIdx, 0, _dragSrcId);

  // DBì— sort_order ì €ì¥
  await Promise.all(ids.map((id, idx) =>
    sb.from('products').update({ sort_order: idx + 1 }).eq('id', id)
  ));

  _dragSrcId = null;
  renderProductAdmin();
  playSound('click');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” QUESTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderQuestAdmin() {
  const [{ data: quests }, { data: qcrs }] = await Promise.all([
    sb.from('quests').select('*').order('sort_order'),
    sb.from('quest_completion_requests').select('*, users(display_name), quests(name,icon,reward)').eq('status','pending').order('created_at',{ascending:false}),
  ]);

  const el = document.getElementById('questAdminList');
  el.innerHTML = quests?.length
    ? quests.map(q => {
        const ct = q.completion_type;
        return `<div class="flex items-center gap-2 p-3 rounded-2xl ${q.active?'bg-gray-50':'bg-red-50 opacity-60'} border-2 border-transparent">
          <div class="text-xl flex-shrink-0">${q.icon}</div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <p class="font-black text-gray-800 text-sm">${q.name}</p>
              <span class="rep-badge ${repClass[q.repeat_type]}">${repLabel[q.repeat_type]}</span>
              <span class="${ct==='auto'?'ct-auto':'ct-approval'}">${ct==='auto'?'âš¡ ìë™':'ğŸ‘¤ ìŠ¹ì¸'}</span>
              ${!q.active?'<span class="rep-badge bg-red-100 text-red-600">ë¹„í™œì„±</span>':''}
            </div>
            <p class="text-xs text-gray-400">${q.description} Â· +${q.reward}ğŸŒ°</p>
          </div>
          <button class="btn btn-blue px-2 py-1 text-xs flex-shrink-0" onclick="editQuest('${q.id}')">ìˆ˜ì •</button>
          <label class="toggle-wrap flex-shrink-0"><input type="checkbox" ${q.active?'checked':''} onchange="toggleQuestActive('${q.id}')"><span class="toggle-slider"></span></label>
          <button class="btn btn-red px-2 py-1 text-xs flex-shrink-0" onclick="deleteQuest('${q.id}')">ì‚­ì œ</button>
        </div>`;
      }).join('')
    : '<p class="text-sm text-gray-400 text-center py-4">í€˜ìŠ¤íŠ¸ê°€ ì—†ì–´ìš”</p>';

  const apEl = document.getElementById('questApprovalList');
  const apCard = document.getElementById('questApprovalCard');
  const apTitle = document.getElementById('questApprovalTitle');
  const pendingCount = qcrs?.length || 0;
  // ëŒ€ê¸° ê±´ìˆ˜ì— ë”°ë¼ ì¹´ë“œ ê°•ì¡°
  if (apCard) {
    apCard.style.border = pendingCount > 0 ? '2px solid rgba(236,72,153,0.5)' : '';
    apCard.style.background = pendingCount > 0 ? 'rgba(253,242,248,0.8)' : '';
  }
  if (apTitle) {
    apTitle.textContent = pendingCount > 0 ? `âœ‹ ì™„ë£Œ ìŠ¹ì¸ ìš”ì²­ (${pendingCount}ê±´ ëŒ€ê¸°ì¤‘)` : 'âœ‹ ì™„ë£Œ ìŠ¹ì¸ ìš”ì²­';
    apTitle.style.color = pendingCount > 0 ? '#be185d' : '';
  }
  apEl.innerHTML = qcrs?.length
    ? qcrs.map(r => `<div class="p-4 rounded-2xl bg-pink-50 border border-pink-100 flex flex-col gap-2">
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-xl">${r.quests?.icon||'ğŸ“‹'}</span>
              <p class="font-black text-gray-800 text-sm">${r.quests?.name||'í€˜ìŠ¤íŠ¸'}</p>
              <span class="ct-approval">ğŸ‘¤ ìŠ¹ì¸ í•„ìš”</span>
            </div>
            <p class="text-xs text-gray-400 mt-1">${r.users?.display_name||''} Â· ${fmtTs(r.created_at)}</p>
          </div>
          <span class="font-black text-amber-600 flex-shrink-0">+${r.quests?.reward||0}ğŸŒ°</span>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-green flex-1 py-2 text-sm" onclick="approveQuestReq('${r.id}')">âœ… ìŠ¹ì¸í•˜ê¸°</button>
          <button class="btn btn-red flex-1 py-2 text-sm" onclick="rejectQuestReq('${r.id}')">âŒ ê±°ì ˆ</button>
        </div>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-4">ëŒ€ê¸°ì¤‘ì¸ ìš”ì²­ì´ ì—†ì–´ìš”</p>';
}

function toggleQuestCount() {
  const type = document.getElementById('nq-countType')?.value;
  const wrap = document.getElementById('nq-countWrap');
  if (wrap) wrap.classList.toggle('hidden', type !== 'multi');
}

async function addQuest() {
  const name = document.getElementById('nq-name').value.trim();
  const desc = document.getElementById('nq-desc').value;
  const reward = parseInt(document.getElementById('nq-reward').value);
  const icon = document.getElementById('nq-icon').value || 'ğŸ“‹';
  const repeat = document.getElementById('nq-repeat').value;
  const ct = document.getElementById('nq-completionType').value;
  const countType = document.getElementById('nq-countType')?.value || 'once';
  const targetCount = countType === 'multi' ? (parseInt(document.getElementById('nq-targetCount')?.value) || 1) : 1;
  if (!name || !reward) { toast('âŒ', 'ì´ë¦„ê³¼ ë³´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const { count } = await sb.from('quests').select('*',{count:'exact',head:true});
  await sb.from('quests').insert({ name, target_count: targetCount, description:desc, icon, reward, repeat_type:repeat, completion_type:ct, sort_order:(count||0)+1 });
  ['nq-name','nq-desc','nq-reward','nq-icon'].forEach(id => document.getElementById(id).value='');
  renderQuestAdmin(); toast('âœ…', 'í€˜ìŠ¤íŠ¸ ì¶”ê°€ ì™„ë£Œ!');
}

async function deleteQuest(id) {
  if (!confirm('í€˜ìŠ¤íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  await sb.from('quests').delete().eq('id', id);
  renderQuestAdmin(); toast('ğŸ—‘ï¸', 'í€˜ìŠ¤íŠ¸ ì‚­ì œë¨');
}

async function toggleQuestActive(id) {
  const { data: q } = await sb.from('quests').select('active').eq('id', id).single();
  await sb.from('quests').update({ active: !q.active }).eq('id', id);
  renderQuestAdmin(); toast(q.active?'â¸ï¸':'âœ…', q.active?'ë¹„í™œì„±í™”ë¨':'í™œì„±í™”ë¨');
}

async function editQuest(id) {
  const { data: q } = await sb.from('quests').select('*').eq('id', id).single();
  showModal(`
    <h2 class="text-lg font-black text-gray-800 mb-4">âœï¸ í€˜ìŠ¤íŠ¸ ìˆ˜ì •</h2>
    <div class="space-y-3">
      <input class="field" id="eq-name" value="${q.name}">
      <input class="field" id="eq-desc" value="${q.description}">
      <div class="grid grid-cols-2 gap-2">
        <input class="field" type="number" id="eq-reward" value="${q.reward}">
        <input class="field" id="eq-icon" value="${q.icon}">
      </div>
      <select class="field" id="eq-repeat">
        <option value="once" ${q.repeat_type==='once'?'selected':''}>1íšŒì„±</option>
        <option value="daily" ${q.repeat_type==='daily'?'selected':''}>ì¼ì¼</option>
        <option value="weekly" ${q.repeat_type==='weekly'?'selected':''}>ì£¼ê°„</option>
      </select>
      <select class="field" id="eq-ct">
        <option value="auto" ${q.completion_type==='auto'?'selected':''}>âš¡ ìë™ ì™„ë£Œ</option>
        <option value="approval" ${q.completion_type==='approval'?'selected':''}>ğŸ‘¤ ê´€ë¦¬ì ìŠ¹ì¸</option>
      </select>
      <div class="flex gap-3 pt-2">
        <button class="btn btn-gray flex-1 py-3" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary flex-1 py-3" onclick="saveQuest('${id}')">ì €ì¥</button>
      </div>
    </div>`);
}

async function saveQuest(id) {
  await sb.from('quests').update({
    name: document.getElementById('eq-name').value,
    description: document.getElementById('eq-desc').value,
    reward: parseInt(document.getElementById('eq-reward').value)||0,
    icon: document.getElementById('eq-icon').value,
    repeat_type: document.getElementById('eq-repeat').value,
    completion_type: document.getElementById('eq-ct').value,
  }).eq('id', id);
  closeModal(); renderQuestAdmin(); toast('âœ…', 'í€˜ìŠ¤íŠ¸ ìˆ˜ì • ì™„ë£Œ!');
}

async function approveQuestReq(reqId) {
  playSound('approve');
  // ìŠ¹ì¸ ì „ ìš”ì²­ ì •ë³´ ì¡°íšŒ (user_id í™•ë³´)
  const { data: qcr } = await sb.from('quest_completion_requests')
    .select('user_id').eq('id', reqId).maybeSingle();

  const res = await sb.rpc('approve_quest_request', { p_request_id: reqId });
  if (!res.data?.success) { toast('âŒ', 'ì²˜ë¦¬ ì‹¤íŒ¨: ' + (res.data?.error||'')); return; }

  // ìŠ¹ì¸ëœ ìœ ì €ì˜ "í€˜ìŠ¤íŠ¸ NíšŒ ì™„ë£Œí•˜ê¸°" ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
  if (qcr?.user_id) await incrementQuestComplete(qcr.user_id);

  renderQuestAdmin(); toast('âœ…', 'í€˜ìŠ¤íŠ¸ ìŠ¹ì¸ ì™„ë£Œ!');
}

// íŠ¹ì • ìœ ì €ì˜ questComplete ì¹´ìš´íŠ¸ë¥¼ DBì—ì„œ ì§ì ‘ ì—…ë°ì´íŠ¸
async function incrementQuestComplete(userId) {
  try {
    const { data: quests } = await sb.from('quests')
      .select('*').eq('active', true).eq('completion_type', 'auto');
    if (!quests) return;
    for (const q of quests) {
      const isQC = (q.target_count||1) >= 2 &&
        (q.name.includes('í€˜ìŠ¤íŠ¸') || q.description.includes('í€˜ìŠ¤íŠ¸') || q.description.includes('ì™„ë£Œ'));
      if (!isQC) continue;
      const key = getPeriodKey(q.repeat_type);
      const { data: prog } = await sb.from('quest_progress')
        .select('id, progress_count')
        .eq('user_id', userId).eq('quest_id', q.id).eq('period_key', key)
        .maybeSingle();
      const current = (prog?.progress_count || 0) + 1;
      if (current < (q.target_count||1)) {
        await upsertQuestProgress(userId, q.id, key, current);
      } else if (!prog || (prog.progress_count||0) < (q.target_count||1)) {
        // ëª©í‘œ ë‹¬ì„± â†’ ë³´ìƒ ì§€ê¸‰
        await upsertQuestProgress(userId, q.id, key, q.target_count);
        await sb.rpc('adjust_acorns', { p_user_id: userId, p_amount: q.reward, p_reason: `í€˜ìŠ¤íŠ¸ ìë™ì™„ë£Œ â€” ${q.name}` });
        await pushNotif(userId, 'quest', 'í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ğŸ‰', `${q.icon} ${q.name} ì™„ë£Œ! +${q.reward}ğŸŒ°`);
      }
    }
  } catch(e) {}
}

async function rejectQuestReq(reqId) {
  const { data: r } = await sb.from('quest_completion_requests').select('*, quests(name,icon), users(display_name)').eq('id', reqId).single();
  await sb.from('quest_completion_requests').update({ status: 'rejected' }).eq('id', reqId);
  if (r) await pushNotif(r.user_id, 'quest_rejected', 'í€˜ìŠ¤íŠ¸ ê±°ì ˆ âŒ', `${r.quests?.icon||''} ${r.quests?.name||''} ì™„ë£Œ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆì–´ìš”.`);
  renderQuestAdmin(); toast('âŒ', 'ê±°ì ˆ ì™„ë£Œ');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” REQUESTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderRequestAdmin() {
  const { data: list } = await sb.from('product_requests')
    .select('*, users(display_name)')
    .order('created_at', { ascending: false })
    .limit(50);
  const el = document.getElementById('requestAdminList');
  let items = list || [];
  if (reqFilter !== 'all') items = items.filter(r => r.status === reqFilter);
  // pending í•­ìƒ ìƒë‹¨ ê³ ì • (ê°™ì€ ìƒíƒœ ë‚´ì—ì„œëŠ” ìµœì‹ ìˆœ ìœ ì§€)
  if (reqFilter === 'all') {
    items.sort((a, b) => {
      if (a.status === 'pending' && b.status !== 'pending') return -1;
      if (a.status !== 'pending' && b.status === 'pending') return 1;
      return 0;
    });
  }
  el.innerHTML = items.length
    ? items.map(r => `<div class="p-4 rounded-2xl flex flex-col gap-2" style="${r.status==='pending'?'background:rgba(254,243,199,0.7);border:1.5px solid rgba(245,158,11,0.3)':'background:#f9fafb'}">
        <div class="flex items-start justify-between gap-2">
          <div>
            <p class="font-black text-gray-800 text-sm">${r.status==='pending'?'ğŸ”” ':''}${r.product_snapshot?.icon||'ğŸ'} ${r.product_snapshot?.name||'ìƒí’ˆ'}</p>
            <p class="text-xs text-gray-400 mt-0.5">${r.users?.display_name||''} Â· ${fmtTs(r.created_at)}${r.price?` Â· ${r.price}ğŸŒ°`:''}${r.from_gacha?' Â· ğŸ²':''}</p>
          </div>
          <span class="badge ${stClass(r.status)} flex-shrink-0">${stLabel(r.status)}</span>
        </div>
        ${r.status==='pending'?`<div class="flex gap-2">
          <button class="btn btn-green flex-1 py-2 text-sm" onclick="updateReq('${r.id}','approved')">âœ… ìŠ¹ì¸</button>
          <button class="btn btn-red flex-1 py-2 text-sm" onclick="updateReq('${r.id}','rejected')">âŒ ê±°ì ˆ</button>
        </div>`:''}
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-6">ì‹ ì²­ ë‚´ì—­ ì—†ìŒ</p>';
}

async function updateReq(id, status) {
  playSound(status === 'approved' ? 'approve' : 'reject');
  const { data: r } = await sb.from('product_requests').select('*, users(display_name)').eq('id', id).single();
  await sb.from('product_requests').update({ status }).eq('id', id);

  // ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ì‚¬ìš©ì‹ ì²­ì¸ ê²½ìš° â†’ ìŠ¹ì¸ ì‹œ 'used', ê±°ì ˆ ì‹œ 'held'ë¡œ ë³µêµ¬
  if (r?.inventory_id) {
    await sb.from('inventory').update({
      status: status === 'approved' ? 'used' : 'held'
    }).eq('id', r.inventory_id);
    // ë¡œì»¬ pending ìºì‹œì—ì„œë„ ì œê±°
    if (window._pendingInvIds) window._pendingInvIds.delete(r.inventory_id);
  }

  if (r) await pushNotif(r.user_id, status==='approved'?'approved':'rejected',
    status==='approved'?'ì‹ ì²­ ìŠ¹ì¸! âœ…':'ì‹ ì²­ ê±°ì ˆ âŒ',
    status==='approved'?`${r.product_snapshot?.name||'ìƒí’ˆ'} ì‹ ì²­ì´ ìŠ¹ì¸ë˜ì—ˆì–´ìš”!`:`${r.product_snapshot?.name||'ìƒí’ˆ'} ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆì–´ìš”.`);
  renderRequestAdmin();
  updateReqBadge();
  toast(status==='approved'?'âœ…':'âŒ', status==='approved'?'ìŠ¹ì¸í–ˆì–´ìš”!':'ê±°ì ˆí–ˆì–´ìš”');
}

function filterReqs(f, btn) {
  reqFilter = f;
  document.querySelectorAll('#atab-requests .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active'); renderRequestAdmin();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” TX LOG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function populateLogFilter() {
  await populateGiveSelect();
}

// â”€â”€ ì‚¬ìš©ì í˜„í™©íŒ â”€â”€
// ì‚¬ìš©ìë³„ ë½‘ê¸° ë‚ ì§œ í˜ì´ì§€ ìƒíƒœ
const _statusPage = {}; // { userId: dateIndex }

async function renderTxLog() {
  const btnList = document.getElementById('logUserBtnList');
  const el = document.getElementById('userStatusList');
  btnList.innerHTML = '<p class="text-sm text-gray-400">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
  el.innerHTML = '';

  const { data: users, error: uErr } = await sb.from('users').select('id, display_name, acorns, avatar_emoji').order('display_name');
  if (uErr) { btnList.innerHTML = `<p class="text-sm text-red-400">ë¡œë“œ ì‹¤íŒ¨: ${uErr.message}</p>`; return; }
  if (!users?.length) { btnList.innerHTML = '<p class="text-sm text-gray-400">ì‚¬ìš©ì ì—†ìŒ</p>'; return; }

  // ì‚¬ìš©ì ë²„íŠ¼ ëª©ë¡
  window._logUsers = users;
  btnList.innerHTML = users.map(u => `
    <button id="logBtn-${u.id}" onclick="selectLogUser('${u.id}')"
      style="display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:16px;border:1.5px solid rgba(200,180,240,0.3);background:rgba(255,255,255,0.7);font-family:'Jua',sans-serif;font-size:13px;color:#4b3060;cursor:pointer;transition:all .15s">
      <span>${u.avatar_emoji || 'ğŸ¿ï¸'}</span>
      <span>${u.display_name}</span>
      <span style="font-size:11px;color:#a78bfa">ğŸŒ°${u.acorns||0}</span>
    </button>`).join('');
}

function selectLogUser(uid) {
  // ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
  document.querySelectorAll('[id^="logBtn-"]').forEach(b => {
    b.style.background = 'rgba(255,255,255,0.7)';
    b.style.borderColor = 'rgba(200,180,240,0.3)';
    b.style.color = '#4b3060';
  });
  const activeBtn = document.getElementById('logBtn-' + uid);
  if (activeBtn) {
    activeBtn.style.background = 'linear-gradient(135deg,#ff8fab,#c084fc)';
    activeBtn.style.borderColor = 'transparent';
    activeBtn.style.color = '#fff';
  }

  // ì¹´ë“œ ë Œë”
  const el = document.getElementById('userStatusList');
  el.innerHTML = '';
  const u = (window._logUsers || []).find(x => x.id === uid);
  if (!u) return;
  const card = document.createElement('div');
  card.className = 'status-card';
  card.id = 'sc-' + u.id;
  el.appendChild(card);
  renderUserStatusCard(u, card);
}

async function renderUserStatusCard(u, card) {
  // ë½‘ê¸° ì¸ë²¤í† ë¦¬ (from_gacha = true) - ì•„ì´í…œ ê²°ê³¼
  const { data: gachaInv } = await sb.from('inventory')
    .select('*, product_snapshot')
    .eq('user_id', u.id)
    .eq('from_gacha', true)
    .order('created_at', { ascending: false })
    .limit(200);

  // ë½‘ê¸°ë¡œ ì–»ì€ ë„í† ë¦¬ ê±°ë˜ ë‚´ì—­ (transactionsì—ì„œ ë½‘ê¸° ê´€ë ¨ë§Œ)
  const { data: gachaTx } = await sb.from('transactions')
    .select('*')
    .eq('user_id', u.id)
    .gt('amount', 0)
    .ilike('reason', '%ë½‘ê¸°%')
    .order('created_at', { ascending: false })
    .limit(200);

  // ì¼ë°˜ ì¸ë²¤í† ë¦¬ (ë³´ê´€ì¤‘/ëŒ€ê¸°ì¤‘ì¸ ê²ƒ)
  const { data: heldInv } = await sb.from('inventory')
    .select('*, product_snapshot')
    .eq('user_id', u.id)
    .in('status', ['held', 'pending'])
    .order('created_at', { ascending: false });

  // ë½‘ê¸° ê²°ê³¼ë¥¼ ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™” (ì•„ì´í…œ + ë„í† ë¦¬ ê±°ë˜ í•©ì‚°)
  const sessions = buildGachaSessions(gachaInv || [], gachaTx || []);
  // ë‚ ì§œë³„ ê·¸ë£¹
  const byDate = {};
  sessions.forEach(s => {
    const d = s.date;
    if (!byDate[d]) byDate[d] = [];
    byDate[d].push(s);
  });
  const dates = Object.keys(byDate).sort((a,b) => b.localeCompare(a));

  const uid = u.id;
  if (!_statusPage[uid]) _statusPage[uid] = 0;
  const curIdx = Math.min(_statusPage[uid], dates.length - 1);

  // í—¤ë”
  const avatarEmoji = u.avatar_emoji || 'ğŸ¿ï¸';
  let html = `<div class="status-card-header">
    <span class="sc-avatar">${avatarEmoji}</span>
    <div>
      <div class="sc-name">${u.display_name}</div>
    </div>
    <span class="sc-acorn">ğŸŒ° ${u.acorns || 0}</span>
  </div>
  <div class="sc-body">`;

  // â”€â”€ ë½‘ê¸° ê¸°ë¡ (ë‚ ì§œë³„) â”€â”€
  html += `<span class="sc-label">ë½‘ê¸° ê¸°ë¡</span>`;

  if (dates.length === 0) {
    html += `<p style="font-size:11px;color:#d1d5db;font-weight:700;text-align:center;padding:10px 0">ë½‘ê¸° ê¸°ë¡ ì—†ìŒ</p>`;
  } else {
    const curDate = dates[curIdx];
    const todaySessions = byDate[curDate];
    const totalCost = todaySessions.reduce((s,x) => s + x.cost, 0);
    const totalGain = todaySessions.reduce((s,x) => s + x.acornGain, 0);

    // ë‚ ì§œ ë„¤ë¹„
    const isToday = curDate === todayStr();
    const isYesterday = curDate === yesterdayStr();
    const dateLabel = isToday ? `ì˜¤ëŠ˜ (${formatDateShort(curDate)})` : isYesterday ? `ì–´ì œ (${formatDateShort(curDate)})` : formatDateShort(curDate);

    html += `<div class="date-nav">
      <button class="date-arrow" onclick="changeStatusDate('${uid}',1)" ${curIdx >= dates.length-1 ? 'disabled' : ''}>â—€</button>
      <div class="date-center">
        <div class="date-center-label">${dateLabel}</div>
        <span class="date-center-sub">${todaySessions.length}íšŒì°¨ ë½‘ê¸°</span>
      </div>
      <button class="date-arrow" onclick="changeStatusDate('${uid}',-1)" ${curIdx <= 0 ? 'disabled' : ''}>â–¶</button>
    </div>`;

    // ë‚ ì§œ ìš”ì•½
    html += `<div class="date-summary">
      <span class="ds-pill" style="background:#d1fae5;color:#065f46">ì´ ${todaySessions.length}íšŒì°¨</span>
      ${totalCost > 0 ? `<span class="ds-pill" style="background:rgba(220,38,38,0.08);color:#dc2626">-${totalCost}ğŸŒ° ì‚¬ìš©</span>` : ''}
      ${totalGain > 0 ? `<span class="ds-pill" style="background:rgba(5,150,105,0.08);color:#059669">+${totalGain}ğŸŒ° íšë“</span>` : ''}
    </div>`;

    // íšŒì°¨ ì¹´ë“œë“¤
    todaySessions.forEach((session, si) => {
      const isLatest = si === 0 && curIdx === 0;
      const sessionId = `gs-${uid}-${curIdx}-${si}`;
      html += `<div class="gacha-session-card ${isLatest ? 'sc-latest' : ''}">
        <div class="gsc-header" onclick="toggleGscBody('${sessionId}')">
          <span class="gsc-badge" style="background:#d1fae5;color:#065f46">${session.items.length}íšŒ ë½‘ê¸°</span>
          ${session.cost > 0 ? `<span class="gsc-cost">-${session.cost}ğŸŒ°</span>` : ''}
          ${session.acornGain > 0 ? `<span class="gsc-gain">+${session.acornGain}ğŸŒ°</span>` : ''}
          <span class="gsc-time">${session.timeLabel}</span>
          <span class="gsc-arrow ${isLatest ? 'open' : ''}" id="arr-${sessionId}">â–¼</span>
        </div>
        <div class="gsc-body ${isLatest ? '' : 'closed'}" id="${sessionId}">
          ${session.items.map(item => {
            const p = item.product_snapshot || {};
            const rtype = p.reward_type || '';
            const isAcorn  = rtype === 'AUTO_ACORN' || rtype === 'GIFT_ACORN';
            const isTicket = rtype === 'GIFT_GACHA_TICKET' || (p.name||'').includes('í‹°ì¼“');
            const amt = isAcorn ? `<span class="g-chip-amt a">+${p.acorn_amt||0}ğŸŒ°</span>`
                      : isTicket ? `<span class="g-chip-amt t">+1ì¥</span>`
                      : `<span class="g-chip-amt">ì•„ì´í…œ</span>`;
            return `<div class="g-chip ${isAcorn?'acorn':isTicket?'ticket':''}">
              <span class="g-chip-icon">${p.icon||'ğŸ“¦'}</span>
              <span class="g-chip-name">${p.name||'ì•„ì´í…œ'}</span>
              ${amt}
            </div>`;
          }).join('')}
        </div>
      </div>`;
    });
  }

  // â”€â”€ ì¸ë²¤í† ë¦¬ â”€â”€
  html += `<div class="sc-divider"></div>
  <span class="sc-label">ì¸ë²¤í† ë¦¬ (${(heldInv||[]).length}ê°œ)</span>`;

  if (!heldInv?.length) {
    html += `<div class="inv-grid2"><span class="inv-empty2">ë³´ìœ  ì•„ì´í…œ ì—†ìŒ</span></div>`;
  } else {
    html += `<div class="inv-grid2">`;
    heldInv.forEach(item => {
      const p = item.product_snapshot || {};
      const isPending = item.status === 'pending';
      html += `<div class="inv-chip2 ${isPending ? 'pending' : ''}">
        <span class="ic2-icon">${p.icon||'ğŸ“¦'}</span>
        <div>
          <div class="ic2-name">${p.name||'ì•„ì´í…œ'}</div>
          <div class="ic2-status ${isPending ? 'ic2-pending' : 'ic2-held'}">${isPending ? 'â³ ëŒ€ê¸°ì¤‘' : 'ğŸ“¦ ë³´ê´€ì¤‘'}</div>
        </div>
      </div>`;
    });
    html += `</div>`;
  }

  html += `</div>`; // sc-body ë‹«ê¸°
  card.innerHTML = html;
}

function buildGachaSessions(invList, txList) {
  // ì¸ë²¤í† ë¦¬(ì•„ì´í…œ)ì™€ transactions(ë„í† ë¦¬)ë¥¼ í•©ì³ ì‹œê°„ìˆœ íšŒì°¨ ë¬¶ê¸° (5ë¶„ ì´ë‚´ = ê°™ì€ íšŒì°¨)
  txList = txList || [];

  // transactionsë¥¼ ì¸ë²¤í† ë¦¬ì™€ ê°™ì€ í˜•íƒœë¡œ ë³€í™˜
  const txAsItems = txList.map(tx => ({
    id: 'tx-' + tx.id,
    created_at: tx.created_at,
    _isTx: true,
    _amount: tx.amount,
    _reason: tx.reason,
    product_snapshot: {
      icon: 'ğŸŒ°',
      name: tx.reason || 'ë„í† ë¦¬',
      reward_type: 'AUTO_ACORN',
      acorn_amt: tx.amount
    }
  }));

  const all = [...invList, ...txAsItems].sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
  if (!all.length) return [];

  const sessions = [];
  let cur = null;

  all.forEach(item => {
    const t = new Date(item.created_at);
    const p = item.product_snapshot || {};
    const acornAmt = item._isTx ? (item._amount || 0) : 0;

    if (!cur || (new Date(cur.firstTime) - t) > 5 * 60 * 1000) {
      const d = toDateStr(t);
      cur = {
        date: d,
        firstTime: item.created_at,
        timeLabel: fmtTime(item.created_at),
        items: [item],
        cost: 0,
        acornGain: acornAmt
      };
      sessions.push(cur);
    } else {
      cur.items.push(item);
      cur.acornGain += acornAmt;
    }
  });

  return sessions;
}

function toggleGscBody(id) {
  const body  = document.getElementById(id);
  const arrow = document.getElementById('arr-' + id);
  if (!body || !arrow) return;
  const isClosed = body.classList.contains('closed');
  body.classList.toggle('closed', !isClosed);
  arrow.classList.toggle('open', isClosed);
}

function changeStatusDate(uid, delta) {
  _statusPage[uid] = (_statusPage[uid] || 0) + delta;
  const card = document.getElementById('sc-' + uid);
  if (!card) return;
  // ì‚¬ìš©ì ì •ë³´ ì¬ì¡°íšŒ ì—†ì´ ì¹´ë“œë§Œ ë¦¬ë Œë”
  sb.from('users').select('id,display_name,acorns,avatar_emoji').eq('id', uid).single()
    .then(({ data: u }) => { if (u) renderUserStatusCard(u, card); });
}

function todayStr() {
  return toDateStr(new Date());
}
function yesterdayStr() {
  const d = new Date(); d.setDate(d.getDate() - 1);
  return toDateStr(d);
}
function toDateStr(d) {
  return d.toLocaleDateString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit' }).replace(/\. /g,'-').replace('.','');
}
function formatDateShort(dateStr) {
  // "2025-02-27" â†’ "2/27"
  const parts = dateStr.split('-');
  if (parts.length >= 3) return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
  return dateStr;
}
function fmtTime(ts) {
  const d = new Date(ts);
  const h = d.getHours(), m = String(d.getMinutes()).padStart(2,'0');
  return `${h >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „'} ${h > 12 ? h-12 : h}:${m}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” USERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderUserAdmin() {
  const { data: users } = await sb.from('users').select('*').order('acorns', { ascending: false });
  const el = document.getElementById('userAdminList');
  el.innerHTML = users?.length
    ? users.map(u => `<div class="flex items-center gap-3 p-3 rounded-2xl" style="background:#f9fafb">
        <div class="text-2xl">${u.avatar_emoji||'ğŸ¿ï¸'}</div>
        <div class="flex-1 min-w-0">
          <p class="font-black text-gray-800 text-sm">${u.display_name}${u.is_admin?' ğŸ‘‘':''}</p>
          <p class="text-xs text-gray-400">ê°€ì…: ${fmtTs(u.created_at)}</p>
          <p class="text-xs" style="color:#a78bfa">ğŸ• ìµœê·¼ì ‘ì†: ${u.last_seen_at ? fmtTs(u.last_seen_at) : 'ê¸°ë¡ì—†ìŒ'}</p>
        </div>
        <div class="flex flex-col items-end gap-1">
          <div class="font-black text-amber-600 text-sm">ğŸŒ° ${u.acorns}</div>
          ${u.is_admin ? '' : `<button class="btn btn-purple px-2 py-1 text-xs" onclick="showGiftItemModal('${u.id}','${u.display_name}')">ğŸ ì„ ë¬¼</button>`}
        </div>
      </div>`).join('')
    : '<p class="text-sm text-gray-400 text-center py-6">íšŒì›ì´ ì—†ì–´ìš”</p>';
}

async function showGiftItemModal(userId, userName) {
  const { data: products } = await sb.from('products')
    .select('id,name,icon,reward_type,acorn_amt').eq('active', true)
    .order('name');
  if (!products?.length) { toast('âŒ', 'ì„ ë¬¼í•  ìƒí’ˆì´ ì—†ì–´ìš”'); return; }

  // AUTO_ACORN ì œì™¸ (ë„í† ë¦¬=ì§€ê¸‰ë©”ë‰´ì—ì„œ ì²˜ë¦¬), GACHA_TICKETì€ í—ˆìš©
  const giftable = (products || []).filter(p => p.reward_type !== 'AUTO_ACORN');
  if (!giftable.length) { toast('âŒ', 'ì„ ë¬¼ ê°€ëŠ¥í•œ ìƒí’ˆì´ ì—†ì–´ìš”'); return; }

  const typeLabel = p => {
    if (p.reward_type === 'ACORN_TICKET') return 'ğŸŒ° ë„í† ë¦¬í‹°ì¼“';
    if (p.reward_type === 'COUPON')       return 'ğŸŸï¸ ì¿ í°';
    return 'ğŸ“¬ ì•„ì´í…œ';
  };

  showModal(`
    <div>
      <div class="text-center mb-4">
        <div style="font-size:2rem">ğŸ</div>
        <h2 class="text-lg font-black text-gray-800">${userName}ë‹˜ê»˜ ì„ ë¬¼</h2>
        <p class="text-xs text-gray-400 mt-1">ì¸ë²¤í† ë¦¬ì— ë°”ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤</p>
      </div>
      <select id="giftProductId" class="field w-full mb-3">
        <option value="">ìƒí’ˆ ì„ íƒ</option>
        ${giftable.map(p => `<option value="${p.id}">${p.icon} ${p.name} (${typeLabel(p)})</option>`).join('')}
      </select>
      <input type="number" id="giftQty" class="field w-full mb-4" placeholder="ìˆ˜ëŸ‰ (ê¸°ë³¸ 1)" min="1" max="99" value="1">
      <div class="flex gap-2">
        <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-purple flex-1 py-2" onclick="confirmGiftItem('${userId}','${userName}')">ğŸ ì„ ë¬¼í•˜ê¸°</button>
      </div>
    </div>`);
}

async function confirmGiftItem(userId, userName) {
  const productId = document.getElementById('giftProductId')?.value;
  const qty = parseInt(document.getElementById('giftQty')?.value) || 1;
  if (!productId) { toast('âŒ', 'ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }

  const { data: p } = await sb.from('products').select('*').eq('id', productId).single();
  if (!p) { toast('âŒ', 'ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”'); return; }

  closeModal();

  // ë½‘ê¸° í‹°ì¼“: gacha_tickets ì¹´ìš´í„°ì— ì§ì ‘ ì¶”ê°€
  if (p.reward_type === 'GACHA_TICKET') {
    const { data: tr, error: trErr } = await sb.rpc('adjust_gacha_tickets', {
      p_user_id: userId, p_amount: qty
    });
    if (trErr) { toast('âŒ', 'ì„ ë¬¼ ì‹¤íŒ¨: ' + trErr.message); return; }
    await pushNotif(userId, 'reward', 'ì„ ë¬¼ ë„ì°©! ğŸ', `ê´€ë¦¬ìê°€ ğŸ« ë½‘ê¸° í‹°ì¼“ ${qty}ì¥ì„ ì„ ë¬¼í–ˆì–´ìš”!`);
    toast('ğŸ', `${userName}ë‹˜ê»˜ ğŸ« ë½‘ê¸° í‹°ì¼“ ${qty}ì¥ ì„ ë¬¼í–ˆì–´ìš”!`);
    playSound('approve');
    return;
  }

  // ì¼ë°˜ ì•„ì´í…œ: ìˆ˜ëŸ‰ë§Œí¼ ì¸ë²¤í† ë¦¬ì— ì¶”ê°€
  const rows = Array.from({ length: qty }, () => ({
    user_id: userId,
    product_id: p.id,
    product_snapshot: p,
    from_gacha: false,
    status: 'held'
  }));
  const { error } = await sb.from('inventory').insert(rows);
  if (error) { toast('âŒ', 'ì„ ë¬¼ ì‹¤íŒ¨: ' + error.message); return; }

  await pushNotif(userId, 'request', 'ì„ ë¬¼ ë„ì°©! ğŸ', `ê´€ë¦¬ìê°€ ${p.icon} ${p.name}ì„(ë¥¼) ${qty}ê°œ ì„ ë¬¼í–ˆì–´ìš”! ì¸ë²¤í† ë¦¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
  toast('ğŸ', `${userName}ë‹˜ê»˜ ${p.icon} ${p.name} ${qty}ê°œ ì„ ë¬¼í–ˆì–´ìš”!`);
  playSound('approve');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  EVENT DISCOUNT SYSTEM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// localStorage êµ¬ì¡°:
//   dotori_events_v2  â†’ { store: EventObj, gacha: EventObj }  (ê¸°ê°„ ì´ë²¤íŠ¸)
//   dotori_repeats    â†’ [ RepeatObj, ... ]                    (ìš”ì¼ë°˜ë³µ ëª©ë¡)
//   dotori_event_history â†’ [ HistoryObj, ... ]                (ê¸°ë¡)
//
// EventObj: { active, discountPct, startAt, endAt, createdAt }
// RepeatObj: { id, type, discountPct, weekDays[], startTime, endTime, validFrom, validUntil, active, createdAt }

const DOW_KR = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

// â”€â”€ ì´ë²¤íŠ¸ DB ìºì‹œ (ì•± ë¡œë“œ ì‹œ í•œ ë²ˆ ë¡œë“œ, ë³€ê²½ ì‹œ ê°±ì‹ ) â”€â”€
let _events = {};       // { store: {...}, gacha: {...} }
let _repeats = [];      // ìš”ì¼ë°˜ë³µ ì´ë²¤íŠ¸ ë°°ì—´

// DBì—ì„œ ì´ë²¤íŠ¸ ì „ì²´ ë¡œë“œ â†’ ìºì‹œ ê°±ì‹ 
async function _loadEventsFromDB() {
  const [{ data: evRows }, { data: repRows }] = await Promise.all([
    sb.from('events').select('*'),
    sb.from('repeat_events').select('*').order('created_at', { ascending: false })
  ]);
  _events = {};
  if (evRows) evRows.forEach(r => {
    _events[r.id] = {
      active: r.active,
      discountPct: r.discount_pct,
      startAt: r.start_at ? new Date(r.start_at).getTime() : null,
      endAt:   r.end_at   ? new Date(r.end_at).getTime()   : null,
    };
  });
  _repeats = (repRows || []).map(r => ({
    id: r.id,
    type: r.type,
    active: r.active,
    discountPct: r.discount_pct,
    weekDays: r.week_days || [],
    startTime: r.start_time,
    endTime: r.end_time,
    validFrom: r.valid_from,
    validUntil: r.valid_until,
    createdAt: new Date(r.created_at).getTime()
  }));
}

// í•˜ìœ„ í˜¸í™˜ ë™ê¸° ë˜í¼ (ìºì‹œì—ì„œ ì½ê¸°)
function _loadEvents() { /* ìºì‹œ ì‚¬ìš© â€” _loadEventsFromDB() í›„ ìë™ ê°±ì‹  */ }
function _loadRepeats() { return _repeats; }

// DB ì €ì¥
async function _saveEventToDB(type, data) {
  await sb.from('events').update({
    active: data.active,
    discount_pct: data.discountPct || 0,
    start_at: data.startAt ? new Date(data.startAt).toISOString() : null,
    end_at:   data.endAt   ? new Date(data.endAt).toISOString()   : null,
    updated_at: new Date().toISOString()
  }).eq('id', type);
}

// â”€â”€ í• ì¸ ê³„ì‚° (ìºì‹œ ê¸°ë°˜ ë™ê¸° í•¨ìˆ˜ â€” ì•± ë¡œë“œ ì‹œ ìºì‹œ ê°±ì‹ ë¨) â”€â”€
function getActiveEventDiscount(type) {
  const now = Date.now();
  let best = 0;

  // 1) ê¸°ê°„ ì´ë²¤íŠ¸
  const ev = _events[type];
  if (ev && ev.active) {
    if ((!ev.startAt || now >= ev.startAt) && (!ev.endAt || now <= ev.endAt)) {
      best = Math.max(best, ev.discountPct || 0);
    }
  }

  // 2) ìš”ì¼ë°˜ë³µ ì´ë²¤íŠ¸
  const kst  = new Date(now + 9 * 3600 * 1000);
  const dow  = kst.getUTCDay();
  const hhmm = kst.toISOString().slice(11, 16);
  const ds   = kst.toISOString().slice(0, 10);

  for (const r of _repeats) {
    if (!r.active || r.type !== type) continue;
    if (!r.weekDays.includes(dow)) continue;
    if (hhmm < r.startTime || hhmm > r.endTime) continue;
    if (r.validFrom  && ds < r.validFrom)  continue;
    if (r.validUntil && ds > r.validUntil) continue;
    best = Math.max(best, r.discountPct || 0);
  }

  return best;
}

// â”€â”€ ì´ë²¤íŠ¸ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchEvtTab(name, btn) {
  ['once','repeat','schedules'].forEach(n => {
    const p = document.getElementById(`evtPane-${n}`);
    if (p) p.classList.toggle('hidden', n !== name);
  });
  document.querySelectorAll('#atab-events .tab-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (name === 'schedules') renderScheduleList();
}

// â”€â”€ ìš”ì¼ ì²´í¬ë°•ìŠ¤ ì‹œê° í”¼ë“œë°± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleDayBtn(checkbox) {
  // CSSì˜ input:checked + spanì´ ìë™ ì²˜ë¦¬í•˜ë¯€ë¡œ ì¶”ê°€ ì‘ì—… ë¶ˆí•„ìš”
}

// â”€â”€ ë‚ ì§œ ì…ë ¥ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearEventDates(type) {
  const start = document.getElementById(`${type}EventStart`);
  const end   = document.getElementById(`${type}EventEnd`);
  const sel   = document.getElementById(`${type}EventPreset`);
  if (start) start.value = '';
  if (end)   end.value   = '';
  if (sel)   sel.value   = '';
}

// â”€â”€ ë¹ ë¥¸ ê¸°ê°„ í”„ë¦¬ì…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyEventPreset(type) {
  const val = document.getElementById(`${type}EventPreset`)?.value;
  if (!val) return;
  const hours = { '1h':1, '2h':2, '4h':4, '8h':8, '24h':24 }[val];
  if (!hours) return;
  const endDate = new Date(Date.now() + hours * 3600 * 1000);
  const local = new Date(endDate.getTime() - endDate.getTimezoneOffset() * 60000).toISOString().slice(0,16);
  const endEl = document.getElementById(`${type}EventEnd`);
  if (endEl) endEl.value = local;
  setTimeout(() => { const s = document.getElementById(`${type}EventPreset`); if (s) s.value = ''; }, 50);
}

// â”€â”€ ê¸°ê°„ ì´ë²¤íŠ¸ í™œì„±í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function activateEvent(type) {
  const pct = parseInt(document.getElementById(`${type}DiscountPct`)?.value || 0);
  if (!pct || pct < 1 || pct > 100) { toast('âŒ', 'í• ì¸ìœ¨ì„ 1~100 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  const startVal = document.getElementById(`${type}EventStart`)?.value;
  const endVal   = document.getElementById(`${type}EventEnd`)?.value;
  const startAt  = startVal ? new Date(startVal).getTime() : null;
  const endAt    = endVal   ? new Date(endVal).getTime()   : null;

  if (endAt && startAt && endAt <= startAt) { toast('âŒ', 'ì¢…ë£Œ ì‹œê°ì´ ì‹œì‘ ì‹œê°ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•´ìš”'); return; }
  if (endAt && endAt <= Date.now())         { toast('âŒ', 'ì¢…ë£Œ ì‹œê°ì´ ì´ë¯¸ ì§€ë‚¬ì–´ìš”'); return; }

  const evData = { active: true, discountPct: pct, startAt, endAt };
  await _saveEventToDB(type, evData);
  _events[type] = evData; // ìºì‹œ ì¦‰ì‹œ ê°±ì‹ 

  const label    = type === 'store' ? 'ìƒì ' : 'ë½‘ê¸°';
  const startStr = startAt ? new Date(startAt).toLocaleString('ko-KR', { timeZone:'Asia/Seoul' }) : 'ì¦‰ì‹œ';
  const endStr   = endAt   ? new Date(endAt).toLocaleString('ko-KR',   { timeZone:'Asia/Seoul' }) : 'ìˆ˜ë™ ì¢…ë£Œê¹Œì§€';
  _addEvtHistory({ type, label, pct, mode:'ê¸°ê°„', startStr, endStr });

  playSound('approve');
  toast('ğŸ‰', `${label} ${pct}% í• ì¸ í™œì„±í™”!`);
  renderEventAdmin();
  renderShopEventBanner();
}

// â”€â”€ ê¸°ê°„ ì´ë²¤íŠ¸ ë¹„í™œì„±í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deactivateEvent(type) {
  if (_events[type]) _events[type].active = false;
  else _events[type] = { active: false, discountPct: 0, startAt: null, endAt: null };
  await _saveEventToDB(type, _events[type]);
  const label = type === 'store' ? 'ìƒì ' : 'ë½‘ê¸°';
  toast('â¹', `${label} ì´ë²¤íŠ¸ ë¹„í™œì„±í™”`);
  renderEventAdmin();
  renderShopEventBanner();
}

// â”€â”€ ìš”ì¼ë°˜ë³µ ì´ë²¤íŠ¸ ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addRepeatEvent() {
  const type      = document.getElementById('rpt-target')?.value;
  const pct       = parseInt(document.getElementById('rpt-pct')?.value || 0);
  const weekDays  = Array.from(document.querySelectorAll('#rpt-days input:checked')).map(c => parseInt(c.value));
  const startTime = document.getElementById('rpt-startTime')?.value || '00:00';
  const endTime   = document.getElementById('rpt-endTime')?.value   || '23:59';
  const validFrom = document.getElementById('rpt-validFrom')?.value  || null;
  const validUntil= document.getElementById('rpt-validUntil')?.value || null;

  if (!pct || pct < 1 || pct > 100) { toast('âŒ', 'í• ì¸ìœ¨ì„ 1~100ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”'); return; }
  if (!weekDays.length)  { toast('âŒ', 'ìš”ì¼ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
  if (endTime <= startTime) { toast('âŒ', 'ì¢…ë£Œ ì‹œê°ì´ ì‹œì‘ ì‹œê°ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•´ìš”'); return; }
  if (validFrom && validUntil && validUntil < validFrom) { toast('âŒ', 'ë°˜ë³µ ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¦…ë‹ˆë‹¤'); return; }

  const { data: newRow, error } = await sb.from('repeat_events').insert({
    type, active: true,
    discount_pct: pct,
    week_days: weekDays,
    start_time: startTime,
    end_time: endTime,
    valid_from: validFrom || null,
    valid_until: validUntil || null
  }).select('*').single();

  if (error) { toast('âŒ', 'ì €ì¥ ì‹¤íŒ¨: ' + error.message); return; }

  // ìºì‹œ ì¦‰ì‹œ ê°±ì‹ 
  _repeats.unshift({
    id: newRow.id, type, active: true, discountPct: pct,
    weekDays, startTime, endTime, validFrom, validUntil,
    createdAt: Date.now()
  });

  const label   = type === 'store' ? 'ìƒì ' : 'ë½‘ê¸°';
  const daysStr = weekDays.map(d => DOW_KR[d]).join('/');
  _addEvtHistory({ type, label, pct, mode:'ìš”ì¼ë°˜ë³µ', startStr: `${daysStr} ${startTime}~${endTime}`, endStr: validUntil || 'ë¬´ê¸°í•œ' });

  // í¼ ì´ˆê¸°í™”
  if (document.getElementById('rpt-pct'))      document.getElementById('rpt-pct').value = '';
  document.querySelectorAll('#rpt-days input').forEach(c => c.checked = false);
  if (document.getElementById('rpt-startTime')) document.getElementById('rpt-startTime').value = '00:00';
  if (document.getElementById('rpt-endTime'))   document.getElementById('rpt-endTime').value   = '23:59';
  if (document.getElementById('rpt-validFrom')) document.getElementById('rpt-validFrom').value  = '';
  if (document.getElementById('rpt-validUntil'))document.getElementById('rpt-validUntil').value = '';

  playSound('approve');
  toast('ğŸ”„', `${label} ìš”ì¼ë°˜ë³µ ì´ë²¤íŠ¸ ì¶”ê°€!`);
  renderEventAdmin();
  renderShopEventBanner();
  switchEvtTab('schedules', document.getElementById('evtTabSchedules'));
}

// â”€â”€ ìš”ì¼ë°˜ë³µ ì´ë²¤íŠ¸ ì‚­ì œ/í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deleteRepeatEvent(id) {
  await sb.from('repeat_events').delete().eq('id', id);
  _repeats = _repeats.filter(r => r.id !== id);
  toast('ğŸ—‘', 'ì‚­ì œë˜ì—ˆì–´ìš”');
  renderScheduleList();
  renderEventAdmin();
  renderShopEventBanner();
}
async function toggleRepeatEvent(id) {
  const r = _repeats.find(r => r.id === id);
  if (!r) return;
  r.active = !r.active;
  await sb.from('repeat_events').update({ active: r.active }).eq('id', id);
  renderScheduleList();
  renderEventAdmin();
  renderShopEventBanner();
}

// â”€â”€ ìš”ì¼ë°˜ë³µ ëª©ë¡ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderScheduleList() {
  const el = document.getElementById('scheduleList');
  if (!el) return;
  const repeats = _repeats;
  if (!repeats.length) { el.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ë“±ë¡ëœ ìš”ì¼ë°˜ë³µ ì´ë²¤íŠ¸ ì—†ìŒ</p>'; return; }
  const now = Date.now();
  el.innerHTML = repeats.map(r => {
    const label    = r.type === 'store' ? 'ğŸ›ï¸ ìƒì ' : 'ğŸ² ë½‘ê¸°';
    const daysStr  = (r.weekDays||[]).map(d => DOW_KR[d]).join(' ');
    const period   = (r.validFrom||r.validUntil) ? `${r.validFrom||'ì¦‰ì‹œ'} ~ ${r.validUntil||'ë¬´ê¸°í•œ'}` : 'ë¬´ê¸°í•œ';
    // í˜„ì¬ í™œì„±ì¸ì§€ ê³„ì‚°
    const kst  = new Date(now + 9*3600000);
    const dow  = kst.getUTCDay(), hhmm = kst.toISOString().slice(11,16), ds = kst.toISOString().slice(0,10);
    const isNowOn = r.active && r.weekDays.includes(dow) && hhmm >= r.startTime && hhmm <= r.endTime
      && (!r.validFrom||ds>=r.validFrom) && (!r.validUntil||ds<=r.validUntil);
    const badge = isNowOn
      ? 'background:#dcfce7;color:#166534'
      : r.active ? 'background:#fef9c3;color:#854d0e' : 'background:#fee2e2;color:#b91c1c';
    const badgeTxt = isNowOn ? 'âœ… ì§€ê¸ˆ í™œì„±' : r.active ? 'ğŸ“† ëŒ€ê¸° ì¤‘' : 'â¸ ì¼ì‹œì¤‘ì§€';
    return `<div class="p-3 rounded-2xl row-item-bg flex items-start gap-3">
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 mb-1 flex-wrap">
          <span class="text-sm font-black text-gray-800">${label} ${r.discountPct}% í• ì¸</span>
          <span class="text-xs px-2 py-0.5 rounded-full font-black" style="${badge}">${badgeTxt}</span>
        </div>
        <p class="text-xs text-gray-500 font-bold">ğŸ“… ${daysStr} &nbsp;â° ${r.startTime}~${r.endTime}</p>
        <p class="text-xs text-gray-400">ìœ íš¨ê¸°ê°„: ${period}</p>
      </div>
      <div class="flex flex-col gap-1 shrink-0">
        <button class="btn btn-gray text-xs px-3 py-1" onclick="toggleRepeatEvent('${r.id}')">${r.active?'â¸':'â–¶ï¸'}</button>
        <button class="btn btn-gray text-xs px-3 py-1" onclick="deleteRepeatEvent('${r.id}')">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ ì´ë ¥ ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _addEvtHistory({ type, label, pct, mode, startStr, endStr }) {
  try {
    const h = JSON.parse(localStorage.getItem('dotori_event_history') || '[]');
    h.unshift({ type, label, pct, mode, startStr, endStr, ts: Date.now() });
    if (h.length > 30) h.pop();
    localStorage.setItem('dotori_event_history', JSON.stringify(h));
  } catch(e) {}
}

// â”€â”€ ê´€ë¦¬ì ì´ë²¤íŠ¸ íƒ­ ì „ì²´ ê°±ì‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEventAdmin() {
  const now = Date.now();

  ['store','gacha'].forEach(type => {
    const ev = _events[type];
    const statusEl = document.getElementById(`${type}EventStatus`);
    if (!statusEl) return;

    let text = 'ë¹„í™œì„±', bg = '#fee2e2', color = '#b91c1c';
    let evActive = false;

    // ê¸°ê°„ ì´ë²¤íŠ¸ ìƒíƒœ
    if (ev && ev.active) {
      const started  = !ev.startAt || now >= ev.startAt;
      const notEnded = !ev.endAt   || now <= ev.endAt;
      if (started && notEnded) {
        evActive = true;
        text = `âœ… í™œì„± ${ev.discountPct}%`;
        bg = '#dcfce7'; color = '#166534';
        if (ev.endAt) {
          text += ` (<span id="adminEvtTimer-${type}">${_fmtRemaining(ev.endAt - now)}</span> ë‚¨ìŒ)`;
        }
      } else if (ev.startAt && now < ev.startAt) {
        text = `â³ ì˜ˆì•½ ${ev.discountPct}% (<span id="adminEvtTimer-${type}">${_fmtRemaining(ev.startAt - now)}</span> í›„ ì‹œì‘)`;
        bg = '#fef9c3'; color = '#854d0e';
      }
    }

    // ê¸°ê°„ ì´ë²¤íŠ¸ê°€ ë¹„í™œì„±ì´ë©´ ìš”ì¼ë°˜ë³µ ìƒíƒœ í™•ì¸
    if (!evActive) {
      const disc = getActiveEventDiscount(type);
      if (disc > 0) {
        text = `âœ… ìš”ì¼ë°˜ë³µ ${disc}% í™œì„±`; bg = '#dcfce7'; color = '#166534';
      } else {
        const hasRepeat = _repeats.some(r => r.active && r.type === type);
        if (hasRepeat) { text = 'ğŸ“† ìš”ì¼ë°˜ë³µ ëŒ€ê¸°'; bg = '#fef9c3'; color = '#854d0e'; }
      }
    }

    statusEl.innerHTML = text;
    statusEl.style.background = bg;
    statusEl.style.color = color;
  });

  // í™œì„± ë°°ë„ˆ
  const bannerEl = document.getElementById('activeEventsBanner');
  if (bannerEl) {
    const msgs = [];
    ['store','gacha'].forEach(t => {
      const d = getActiveEventDiscount(t);
      if (d > 0) {
        const endAt = _getEventEndAt(t);
        const timeStr = endAt ? ` <span id="adminTopTimer-${t}" style="font-size:11px;font-weight:700;opacity:0.8">â±ï¸ ${_fmtRemaining(endAt - Date.now())} ë‚¨ìŒ</span>` : '';
        msgs.push(`${t==='store'?'ğŸ›ï¸ ìƒì ':'ğŸ² ë½‘ê¸°'} ${d}% í• ì¸ ì¤‘!${timeStr}`);
      }
    });
    bannerEl.innerHTML = msgs.length
      ? `<div class="clay-card p-3 mb-2 text-center font-black text-green-700" style="background:rgba(220,252,231,0.85);border:2px solid rgba(34,197,94,0.3)">ğŸ‰ ${msgs.join('&emsp;|&emsp;')}</div>`
      : '';
  }

  // ê´€ë¦¬ì ì´ë²¤íŠ¸ ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸
  _clearAdminEvtTimer();
  const adminTimerNeeded = ['store','gacha'].some(type => {
    const ev = _events[type];
    return ev && ev.active && (ev.endAt || ev.startAt);
  });
  if (adminTimerNeeded) {
    window._adminEvtTimer = setInterval(() => {
      const n = Date.now();
      ['store','gacha'].forEach(type => {
        const ev = _events[type];
        // ìƒíƒœ ì¹´ë“œ íƒ€ì´ë¨¸
        const el = document.getElementById(`adminEvtTimer-${type}`);
        if (el && ev) {
          const started = !ev.startAt || n >= ev.startAt;
          const target = started ? ev.endAt : ev.startAt;
          if (target) el.textContent = _fmtRemaining(target - n);
        }
        // ìƒë‹¨ ë°°ë„ˆ íƒ€ì´ë¨¸
        const topEl = document.getElementById(`adminTopTimer-${type}`);
        if (topEl) {
          const endAt = _getEventEndAt(type);
          if (endAt) topEl.textContent = 'â±ï¸ ' + _fmtRemaining(endAt - n) + ' ë‚¨ìŒ';
        }
      });
    }, 1000);
  }

  // ì´ë²¤íŠ¸ ê¸°ë¡
  const histEl = document.getElementById('eventHistoryList');
  if (histEl) {
    const history = JSON.parse(localStorage.getItem('dotori_event_history') || '[]');
    histEl.innerHTML = history.length
      ? history.map(h => `<div class="flex items-center gap-3 p-3 rounded-xl row-item-bg">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-black text-gray-800">${h.label==='ìƒì '?'ğŸ›ï¸':'ğŸ²'} ${h.label} ${h.pct}% <span class="text-xs font-bold text-gray-400">[${h.mode||''}]</span></p>
            <p class="text-xs text-gray-400 truncate">${h.startStr} ~ ${h.endStr}</p>
          </div>
          <span class="text-xs text-gray-400 shrink-0">${fmtTs(new Date(h.ts).toISOString())}</span>
        </div>`).join('')
      : '<p class="text-sm text-gray-400 text-center py-4">ê¸°ë¡ ì—†ìŒ</p>';
  }
}

// â”€â”€ ìƒì  íƒ­ ì´ë²¤íŠ¸ ë°°ë„ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _fmtRemaining(ms) {
  if (ms <= 0) return 'ê³§ ì¢…ë£Œ';
  const s = Math.floor(ms / 1000);
  const m = Math.floor(s / 60);
  const h = Math.floor(m / 60);
  const d = Math.floor(h / 24);
  const ss = s % 60;
  const mm = m % 60;
  const hh = h % 24;
  if (d > 0)  return `${d}ì¼ ${hh}ì‹œê°„ ${mm}ë¶„ ë‚¨ìŒ`;
  if (h > 0)  return `${h}ì‹œê°„ ${mm}ë¶„ ${ss}ì´ˆ ë‚¨ìŒ`;
  if (m > 0)  return `${mm}ë¶„ ${ss}ì´ˆ ë‚¨ìŒ`;
  return `${s}ì´ˆ ë‚¨ìŒ`;
}

function _getEventEndAt(type) {
  const now = Date.now();
  const ev = _events[type];
  if (ev && ev.active && ev.endAt && (!ev.startAt || now >= ev.startAt) && now <= ev.endAt) {
    return ev.endAt;
  }
  // ìš”ì¼ ë°˜ë³µ ì´ë²¤íŠ¸ëŠ” ë‹¹ì¼ endTime ê¸°ì¤€
  const kst  = new Date(now + 9 * 3600 * 1000);
  const dow  = kst.getUTCDay();
  const hhmm = kst.toISOString().slice(11, 16);
  const ds   = kst.toISOString().slice(0, 10);
  for (const r of _repeats) {
    if (!r.active || r.type !== type) continue;
    if (!r.weekDays.includes(dow)) continue;
    if (r.startTime && hhmm < r.startTime) continue;
    if (r.endTime   && hhmm > r.endTime)   continue;
    if (r.validFrom  && ds < r.validFrom)  continue;
    if (r.validUntil && ds > r.validUntil) continue;
    if (r.endTime) {
      const [eh, em] = r.endTime.split(':').map(Number);
      const end = new Date(kst);
      end.setUTCHours(eh - 9, em, 0, 0);
      return end.getTime();
    }
  }
  return null;
}

function renderShopEventBanner() {
  const storeEl = document.getElementById('utab-shop');
  if (!storeEl) return;
  let bannerEl = document.getElementById('shopEventBanner');
  if (!bannerEl) {
    bannerEl = document.createElement('div');
    bannerEl.id = 'shopEventBanner';
    storeEl.insertBefore(bannerEl, storeEl.firstChild);
  }
  const sd = getActiveEventDiscount('store');
  const gd = getActiveEventDiscount('gacha');

  if (!sd && !gd) { bannerEl.innerHTML = ''; _clearBannerTimer(); return; }

  const now = Date.now();
  const banners = [];
  if (sd > 0) {
    const endAt = _getEventEndAt('store');
    const timeStr = endAt ? `<span id="evtTimer-store" style="font-size:11px;opacity:0.8;display:block;margin-top:2px">â±ï¸ ${_fmtRemaining(endAt - now)}</span>` : '';
    banners.push({ html: `<div class="clay-card p-3 mb-3 text-center font-black text-green-700" style="background:rgba(220,252,231,0.8);border:2px solid rgba(34,197,94,0.3)">ğŸ‰ ğŸ›ï¸ ìƒì  ${sd}% í• ì¸ ì´ë²¤íŠ¸ ì§„í–‰ ì¤‘!${timeStr}</div>`, endAt, timerEl: 'evtTimer-store' });
  }
  if (gd > 0) {
    const endAt = _getEventEndAt('gacha');
    const timeStr = endAt ? `<span id="evtTimer-gacha" style="font-size:11px;opacity:0.8;display:block;margin-top:2px">â±ï¸ ${_fmtRemaining(endAt - now)}</span>` : '';
    banners.push({ html: `<div class="clay-card p-3 mb-3 text-center font-black text-green-700" style="background:rgba(220,252,231,0.8);border:2px solid rgba(34,197,94,0.3)">ğŸ‰ ğŸ² ë½‘ê¸° ${gd}% í• ì¸ ì´ë²¤íŠ¸ ì§„í–‰ ì¤‘!${timeStr}</div>`, endAt, timerEl: 'evtTimer-gacha' });
  }

  bannerEl.innerHTML = banners.map(b => b.html).join('');

  // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸
  _clearBannerTimer();
  const hasTimer = banners.some(b => b.endAt);
  if (hasTimer) {
    window._bannerTimer = setInterval(() => {
      const now2 = Date.now();
      let allExpired = true;
      banners.forEach(b => {
        if (!b.endAt) return;
        const el = document.getElementById(b.timerEl);
        if (el) {
          const rem = b.endAt - now2;
          if (rem > 0) { el.textContent = 'â±ï¸ ' + _fmtRemaining(rem); allExpired = false; }
          else { el.textContent = 'â±ï¸ ê³§ ì¢…ë£Œ'; }
        }
      });
      if (allExpired) { _clearBannerTimer(); renderShopEventBanner(); }
    }, 1000);
  }
}

function _clearBannerTimer() {
  if (window._bannerTimer) { clearInterval(window._bannerTimer); window._bannerTimer = null; }
}
function _clearAdminEvtTimer() {
  if (window._adminEvtTimer) { clearInterval(window._adminEvtTimer); window._adminEvtTimer = null; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN â€” DASHBOARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderDashboard() {
  const todayStart = getToday() + 'T00:00:00+09:00'; // KST ìì • ê¸°ì¤€
  const [{ data: users }, { data: todayTxs }, { data: recentTxs }] = await Promise.all([
    sb.from('users').select('id', { count: 'exact' }),
    sb.from('transactions').select('amount,reason').gte('created_at', todayStart),
    sb.from('transactions').select('*, users(display_name)').order('created_at', { ascending: false }).limit(10),
  ]);

  const todayGacha = (todayTxs||[]).filter(t => t.reason?.startsWith('ë½‘ê¸° ì‚¬ìš©'));
  const todayGachaCount = todayGacha.reduce((s,t) => s + Math.abs(t.amount)/GACHA_COST, 0);
  const todayGiven = (todayTxs||[]).filter(t => t.amount > 0 && !t.reason?.startsWith('ë½‘ê¸° ì‚¬ìš©')).reduce((s,t)=>s+t.amount,0);
  const todayUsed  = (todayTxs||[]).filter(t => t.amount < 0).reduce((s,t)=>s+Math.abs(t.amount),0);

  document.getElementById('ds-users').textContent      = users?.length || 0;
  document.getElementById('ds-todayGacha').textContent = todayGachaCount;
  document.getElementById('ds-todayGiven').textContent = '+' + todayGiven;
  document.getElementById('ds-todayUsed').textContent  = '-' + todayUsed;

  const logEl = document.getElementById('ds-activityLog');
  logEl.innerHTML = recentTxs?.length
    ? `<div class="overflow-x-auto"><table class="w-full" style="min-width:340px">
        <thead><tr class="border-b border-gray-100 text-left">
          <th class="pb-2 font-black text-gray-400 text-xs pr-2">ì‚¬ìš©ì</th>
          <th class="pb-2 font-black text-gray-400 text-xs pr-2">í™œë™</th>
          <th class="pb-2 font-black text-gray-400 text-xs pr-2">ë³€í™”</th>
          <th class="pb-2 font-black text-gray-400 text-xs">ì¼ì‹œ</th>
        </tr></thead>
        <tbody>${recentTxs.map(t=>`<tr class="border-b border-gray-50">
          <td class="py-2 pr-2 font-bold text-gray-700 text-xs whitespace-nowrap">${t.users?.display_name||''}</td>
          <td class="py-2 pr-2 text-gray-400 text-xs text-ellipsis">${t.reason}</td>
          <td class="py-2 pr-2 font-black text-sm ${t.amount>0?'tx-plus':'tx-minus'}">${t.amount>0?'+':''}${t.amount}ğŸŒ°</td>
          <td class="py-2 text-gray-400 text-xs whitespace-nowrap">${fmtTs(t.created_at)}</td>
        </tr>`).join('')}</tbody>
      </table></div>`
    : '<p class="text-sm text-gray-400 text-center py-4">í™œë™ ì—†ìŒ</p>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const stClass = s => ({ pending:'st-pending', approved:'st-approved', rejected:'st-rejected' })[s] || 'st-pending';
const stLabel = s => ({ pending:'â³ ëŒ€ê¸°ì¤‘', approved:'âœ… ìŠ¹ì¸', rejected:'âŒ ê±°ì ˆ' })[s] || s;

function fmtTs(iso) {
  if (!iso) return '';
  try {
    const now  = new Date();
    const date = new Date(iso);
    const diff = Math.floor((now - date) / 1000); // ì´ˆ ë‹¨ìœ„
    if (diff < 60)   return 'ë°©ê¸ˆ ì „';
    if (diff < 3600) return `${Math.floor(diff/60)}ë¶„ ì „`;
    if (diff < 86400) return `${Math.floor(diff/3600)}ì‹œê°„ ì „`;
    if (diff < 604800) return `${Math.floor(diff/86400)}ì¼ ì „`;
    return date.toLocaleString('ko-KR', { timeZone:'Asia/Seoul', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  } catch { return iso.slice(0,16).replace('T',' '); }
}

// â”€â”€ í…Œë§ˆ ê´€ë¦¬ â”€â”€
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  // ë„í† ë¦¬ ì´ëª¨ì§€ ë‹¤í¬ëª¨ë“œ ì‹œ ì–´ë‘¡ê²Œ
  const emoji = document.getElementById('headerAcornEmoji');
  if (emoji) emoji.style.filter = theme === 'dark'
    ? 'brightness(0.5) sepia(0.3) drop-shadow(0 2px 6px rgba(0,0,0,0.5))'
    : 'drop-shadow(0 2px 8px rgba(180,100,0,0.25))';
  localStorage.setItem('acornTheme', theme);
}
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  applyTheme(current === 'dark' ? 'light' : 'dark');
}
// ì €ì¥ëœ í…Œë§ˆ ë°˜ì˜ (ê¸°ë³¸ê°’: light)
(function() {
  const saved = localStorage.getItem('acornTheme') || 'light';
  applyTheme(saved);
})();

// â”€â”€ ë³„ ìƒì„± (ë‹¤í¬ëª¨ë“œìš©, 35ê°œ ëœë¤) â”€â”€
(function() {
  const COUNT = 23;
  // ë³„ ìƒ‰ìƒ: í°ìƒ‰, ë”°ëœ»í•œ ë…¸ë‘, ì°¨ê°€ìš´ íŒŒë‘ ê³„ì—´ ì„ê¸°
  const COLORS = [
    '#ffffff', '#ffffff', '#ffffff',   // í°ìƒ‰ (ê°€ì¥ ë§ì´)
    '#fffbe8', '#fff5cc', '#ffeea0',   // ë…¸ë€ë¹› ë³„
    '#ddeeff', '#cce4ff', '#b8d8ff',   // íŒŒë€ë¹› ë³„
    '#ffe8d0',                          // ì£¼í™©ë¹› ë³„ (ë“œë¬¼ê²Œ)
  ];
  for (let i = 0; i < COUNT; i++) {
    const el = document.createElement('div');
    el.className = 'star';
    const size  = (Math.random() * 2.5 + 2).toFixed(1);          // 2~4.5px
    const peak  = (Math.random() * 0.30 + 0.10).toFixed(2);      // 0.10~0.40
    const dur   = (Math.random() * 6 + 4).toFixed(1) + 's';      // 4~10ì´ˆ
    const delay = '-' + (Math.random() * 12).toFixed(1) + 's';   // 0~12ì´ˆ ì˜¤í”„ì…‹
    const top   = (Math.random() * 100).toFixed(1) + 'vh';
    const left  = (Math.random() * 100).toFixed(1) + 'vw';
    const blur  = (Math.random() * 0.8).toFixed(1) + 'px';       // 0~0.8px ë²ˆì§
    const color = COLORS[Math.floor(Math.random() * COLORS.length)];
    el.style.cssText = `width:${size}px;height:${size}px;top:${top};left:${left};--peak:${peak};--dur:${dur};--delay:${delay};filter:blur(${blur});background:${color}`;
    document.body.appendChild(el);
  }
})();

function _blockScroll(e) {
  // ëª¨ë‹¬ ë‚´ë¶€ ìŠ¤í¬ë¡¤(.modal-box)ì€ í—ˆìš©, ì˜¤ë²„ë ˆì´ í„°ì¹˜ëŠ” ì°¨ë‹¨
  if (!e.target.closest('.modal-box')) e.preventDefault();
}
function showModal(html) {
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('modal').addEventListener('touchmove', _blockScroll, { passive: false });
}
function closeModal() {
  document.getElementById('modal').classList.add('hidden');
  document.getElementById('modal').removeEventListener('touchmove', _blockScroll);
}

let _toastT;
function toast(icon, msg, duration = 3000) {
  clearTimeout(_toastT);
  document.getElementById('toastIcon').textContent = icon;
  document.getElementById('toastMsg').textContent  = msg;
  const el = document.getElementById('toast');
  const inner = document.getElementById('toastInner');
  el.classList.remove('hidden');
  if (inner) { inner.style.animation='none'; void inner.offsetWidth; inner.style.animation='toastIn .25s cubic-bezier(.34,1.56,.64,1) both'; }
  _toastT = setTimeout(()=>{ el.classList.add('hidden'); el.style.animation=''; }, duration);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PWA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _deferredInstall = null;
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault(); _deferredInstall = e;
  document.getElementById('installBanner').classList.remove('hidden');
});
window.addEventListener('appinstalled', () => {
  document.getElementById('installBanner').classList.add('hidden'); _deferredInstall = null;
});
function installPWA() {
  if (!_deferredInstall) return;
  _deferredInstall.prompt();
  _deferredInstall.userChoice.then(r => {
    if (r.outcome === 'accepted') document.getElementById('installBanner').classList.add('hidden');
    _deferredInstall = null;
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ì¬í™œìš©ì„¼í„°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _recycleItems = [];        // ë§¤ì… ëª©ë¡ (DB)
let _recycleSelMap = {};       // { inventoryId: { item, recycleItem } }

// â”€â”€ ì‚¬ìš©ì: ì¬í™œìš©ì„¼í„° íƒ­ ë Œë” â”€â”€
async function renderRecycleTab() {
  // ë§¤ì… ëª©ë¡ ë¡œë“œ
  const { data: rItems } = await sb.from('recycle_items')
    .select('*, products(id,name,icon,item_type)')
    .eq('active', true);
  _recycleItems = rItems || [];

  // â”€â”€ ë§¤ì… ëª©ë¡ UI: ì´ë¦„ ê¸°ì¤€ ê·¸ë£¹í•‘ â”€â”€
  // ê°™ì€ ì´ë¦„ì´ë©´ì„œ ê°€ê²©ë„ ê°™ìœ¼ë©´ â†’ í•˜ë‚˜ë¡œ í•©ì³ í‘œì‹œ (ë§ˆí¬ ì—†ìŒ)
  // ê°™ì€ ì´ë¦„ì´ì§€ë§Œ ê°€ê²©ì´ ë‹¤ë¥´ë©´ â†’ ê°ê° í‘œì‹œ + ğŸ›ï¸/ğŸ² ë§ˆí¬
  const shopEl = document.getElementById('recycleShopList');
  if (shopEl) {
    if (_recycleItems.length === 0) {
      shopEl.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">í˜„ì¬ ë§¤ì… ì¤‘ì¸ ì•„ì´í…œì´ ì—†ì–´ìš”</p>';
    } else {
      // ì´ë¦„ë³„ë¡œ ê·¸ë£¹í•‘
      const groups = {};
      _recycleItems.forEach(ri => {
        const name = ri.products?.name || 'ì•„ì´í…œ';
        if (!groups[name]) groups[name] = [];
        groups[name].push(ri);
      });

      shopEl.innerHTML = Object.values(groups).map(grp => {
        const sample = grp[0];
        const p = sample.products || {};
        // ê·¸ë£¹ ë‚´ ê°€ê²©ì´ ëª¨ë‘ ë™ì¼í•œì§€ í™•ì¸
        const allSamePrice = grp.every(ri => ri.recycle_price === sample.recycle_price);

        if (allSamePrice) {
          // ê°€ê²© ë™ì¼ â†’ í•˜ë‚˜ë¡œ í•©ì³ì„œ í‘œì‹œ
          const types = [...new Set(grp.map(ri => ri.products?.item_type || 'store'))];
          const hasBoth = types.includes('store') && types.includes('gacha');
          const typeLabel = hasBoth
            ? '<span class="text-xs font-bold" style="color:#7c6bbf;font-size:10px">ğŸ›ï¸ ìƒì  + ğŸ² ë½‘ê¸°</span>'
            : types[0] === 'gacha'
              ? '<span class="it-gacha text-xs" style="font-size:10px">ğŸ² ë½‘ê¸°</span>'
              : '<span class="it-store text-xs" style="font-size:10px">ğŸ›ï¸ ìƒì </span>';
          return `<div class="recycle-item-card">
            <div class="flex items-center gap-3">
              <span style="font-size:2rem">${p.icon || 'ğŸ'}</span>
              <div>
                <div class="mb-0.5">${typeLabel}</div>
                <p class="text-sm font-black text-gray-800">${p.name || 'ì•„ì´í…œ'}</p>
                <p class="text-xs text-gray-500">ë³´ìœ  ì‹œ íŒë§¤ ê°€ëŠ¥</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-lg font-black text-amber-600">+${sample.recycle_price}ğŸŒ°</p>
              <p class="text-xs text-green-600 font-bold">ë§¤ì… ì¤‘</p>
            </div>
          </div>`;
        } else {
          // ê°€ê²© ë‹¤ë¦„ â†’ ê°ê° í‘œì‹œ + ì¶œì²˜ ë§ˆí¬
          return grp.map(ri => {
            const rp = ri.products || {};
            const typeLabel = rp.item_type === 'gacha'
              ? '<span class="it-gacha text-xs" style="font-size:10px">ğŸ² ë½‘ê¸°</span>'
              : '<span class="it-store text-xs" style="font-size:10px">ğŸ›ï¸ ìƒì </span>';
            return `<div class="recycle-item-card">
              <div class="flex items-center gap-3">
                <span style="font-size:2rem">${rp.icon || 'ğŸ'}</span>
                <div>
                  <div class="flex items-center gap-1 mb-0.5">${typeLabel}</div>
                  <p class="text-sm font-black text-gray-800">${rp.name || 'ì•„ì´í…œ'}</p>
                  <p class="text-xs text-gray-500">ë³´ìœ  ì‹œ íŒë§¤ ê°€ëŠ¥</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-lg font-black text-amber-600">+${ri.recycle_price}ğŸŒ°</p>
                <p class="text-xs text-green-600 font-bold">ë§¤ì… ì¤‘</p>
              </div>
            </div>`;
          }).join('');
        }
      }).join('');
    }
  }

  // ë‚´ ì¸ë²¤í† ë¦¬ ì¤‘ íŒë§¤ ê°€ëŠ¥í•œ ì•„ì´í…œ ë¡œë“œ
  _recycleSelMap = {};
  updateRecycleSellBar();
  await renderRecycleInventory();
}

async function renderRecycleInventory() {
  const el = document.getElementById('recycleInventoryList');
  const emptyEl = document.getElementById('recycleEmptyMsg');
  if (!el) return;

  // íŒë§¤ ê°€ëŠ¥í•œ product_id ëª©ë¡
  const recyclableIds = new Set(_recycleItems.map(ri => ri.product_id));
  if (recyclableIds.size === 0) {
    el.innerHTML = '';
    if (emptyEl) emptyEl.classList.remove('hidden');
    return;
  }

  // ë‚´ ì¸ë²¤í† ë¦¬ì—ì„œ held ìƒíƒœ ì•„ì´í…œ ë¡œë“œ (products JOIN)
  const [{ data: items }, { data: pendingReqs }] = await Promise.all([
    sb.from('inventory')
      .select('*, products(id,name,icon,reward_type)')
      .eq('user_id', myProfile.id).eq('status', 'held')
      .order('created_at', { ascending: false }),
    sb.from('product_requests')
      .select('inventory_id')
      .eq('user_id', myProfile.id).eq('status', 'pending')
  ]);

  // pending ì‹ ì²­ ì¤‘ì¸ inventory_id ì§‘í•© (ë¡œì»¬ ìºì‹œ í¬í•¨)
  const pendingInvIds = new Set((pendingReqs||[]).map(r => r.inventory_id).filter(Boolean));
  if (window._pendingInvIds) window._pendingInvIds.forEach(id => pendingInvIds.add(id));

  // product_idë¡œ ë§¤ì¹­ + pending ì•„ì´í…œ ì œì™¸
  const sellable = (items || []).filter(item => {
    if (pendingInvIds.has(item.id)) return false;  // ìŠ¹ì¸ ëŒ€ê¸°ì¤‘ ì œì™¸
    const pid = item.product_id || item.product_snapshot?.id;
    return pid && recyclableIds.has(pid);
  });

  if (sellable.length === 0) {
    el.innerHTML = '';
    if (emptyEl) emptyEl.classList.remove('hidden');
    return;
  }
  if (emptyEl) emptyEl.classList.add('hidden');

  el.innerHTML = sellable.map(item => {
    const p = item.products || item.product_snapshot || {};
    const pid = item.product_id || item.product_snapshot?.id;
    const ri = _recycleItems.find(r => r.product_id === pid);
    const price = ri?.recycle_price || 0;
    const isSelected = !!_recycleSelMap[item.id];
    return `<div class="recycle-inv-card ${isSelected ? 'selected' : ''}" onclick="toggleRecycleSel('${item.id}')" data-inv-id="${item.id}" data-price="${price}">
      <div class="check-badge">âœ“</div>
      <span style="font-size:2rem">${p.icon || 'ğŸ'}</span>
      <p class="text-xs font-black text-gray-700 text-center leading-tight">${p.name || 'ì•„ì´í…œ'}</p>
      <span class="text-xs font-black text-amber-600">+${price}ğŸŒ°</span>
      <span class="text-xs ${item.from_gacha ? 'it-gacha' : 'it-store'}">${item.from_gacha ? 'ğŸ² ë½‘ê¸°' : 'ğŸ›ï¸ ìƒì '}</span>
    </div>`;
  }).join('');
}

function toggleRecycleSel(inventoryId) {
  // ì¸ë²¤í† ë¦¬ ì¹´ë“œì—ì„œ ì§ì ‘ ë°ì´í„° ì°¾ê¸°
  const cardEl = document.querySelector(`.recycle-inv-card[data-inv-id="${inventoryId}"]`);
  if (!cardEl) return;

  if (_recycleSelMap[inventoryId]) {
    delete _recycleSelMap[inventoryId];
    cardEl.classList.remove('selected');
  } else {
    const price = parseInt(cardEl.dataset.price || '0') || 0;
    _recycleSelMap[inventoryId] = { price };
    cardEl.classList.add('selected');
  }
  updateRecycleSellBar();
}

function updateRecycleSellBar() {
  const bar = document.getElementById('recycleSellBar');
  const label = document.getElementById('recycleSellLabel');
  const sub = document.getElementById('recycleSellSub');
  const cntEl = document.getElementById('recycleSelCount');
  const keys = Object.keys(_recycleSelMap);
  const total = keys.reduce((s, id) => s + (_recycleSelMap[id].price || 0), 0);

  if (keys.length === 0) {
    if (bar) bar.classList.add('hidden');
    if (cntEl) cntEl.textContent = '';
    return;
  }
  if (bar) bar.classList.remove('hidden');
  if (label) label.textContent = `${keys.length}ê°œ ì•„ì´í…œ ì„ íƒë¨`;
  if (sub) sub.textContent = `ì´ +${total}ğŸŒ° ë°›ì„ ìˆ˜ ìˆì–´ìš”`;
  if (cntEl) cntEl.textContent = `${keys.length}ê°œ ì„ íƒ`;
}

async function confirmRecycleSell() {
  const keys = Object.keys(_recycleSelMap);
  if (keys.length === 0) return;
  const total = keys.reduce((s, id) => s + (_recycleSelMap[id].price || 0), 0);

  showModal(`
    <div class="text-center">
      <div style="font-size:3rem;margin-bottom:8px">â™»ï¸</div>
      <h2 class="text-lg font-black text-gray-800 mb-1">ì•„ì´í…œ íŒë§¤</h2>
      <p class="text-sm text-gray-500 mb-3">${keys.length}ê°œ ì•„ì´í…œì„ íŒë§¤í•´ìš”</p>
      <div class="text-3xl font-black text-amber-600 my-3">+${total} ğŸŒ°</div>
      <div class="modal-notice-box" style="background:rgba(16,185,129,0.08);border-color:rgba(16,185,129,0.25)">
        íŒë§¤í•œ ì•„ì´í…œì€ <span class="font-black">ë³µêµ¬ë˜ì§€ ì•Šì•„ìš”!</span>
      </div>
      <div class="flex gap-2 mt-4">
        <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-green flex-1 py-2" onclick="executeRecycleSell()">ğŸ’° íŒë§¤!</button>
      </div>
    </div>`);
}

async function executeRecycleSell() {
  const keys = Object.keys(_recycleSelMap);
  if (keys.length === 0) return;
  closeModal();

  await withLock('recycleSell', async () => {
    let successCount = 0;
    let totalEarned = 0;

    for (const inventoryId of keys) {
      // status='held' ì¡°ê±´ í¬í•¨í•´ì„œ ì—…ë°ì´íŠ¸ â†’ ì´ì¤‘ íŒë§¤ ë°©ì§€
      const { data: updated, count } = await sb.from('inventory')
        .update({ status: 'resold' })
        .eq('id', inventoryId)
        .eq('user_id', myProfile.id)
        .eq('status', 'held')
        .select('id');
      const didUpdate = (Array.isArray(updated) && updated.length > 0)
                     || (updated && !Array.isArray(updated) && updated.id)
                     || (typeof count === 'number' && count > 0);
      if (didUpdate) {
        successCount++;
        totalEarned += (_recycleSelMap[inventoryId].price || 0);
      }
    }

    if (totalEarned > 0) {
      const res = await sb.rpc('adjust_acorns', {
        p_user_id: myProfile.id,
        p_amount: totalEarned,
        p_reason: `ì¬í™œìš©ì„¼í„° íŒë§¤ ${successCount}ê°œ`
      });
      if (res.data?.success) { myProfile.acorns = res.data.balance; updateAcornDisplay(); }
      await pushNotif(myProfile.id, 'reward', 'íŒë§¤ ì™„ë£Œ! â™»ï¸', `${successCount}ê°œ ì•„ì´í…œ íŒë§¤ â†’ +${totalEarned}ğŸŒ° íšë“!`);
    }

    _recycleSelMap = {};
    playSound('reward');
    toast('â™»ï¸', `${successCount}ê°œ íŒë§¤ ì™„ë£Œ! +${totalEarned}ğŸŒ°`);
    await renderRecycleInventory();
    updateRecycleSellBar();
  });
}

// â”€â”€ ê´€ë¦¬ì: ì¬í™œìš©ì„¼í„° ê´€ë¦¬ â”€â”€
async function renderRecycleAdmin() {
  // ìƒí’ˆ ë“œë¡­ë‹¤ìš´: ì´ë¦„ ê¸°ì¤€ ì¤‘ë³µ ì œê±° ë‹¨ì¼ ëª©ë¡ (ìƒì /ë½‘ê¸° êµ¬ë¶„ ì—†ì´)
  const sel = document.getElementById('rc-productSelect');
  if (sel) {
    sel.innerHTML = '<option value="">ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”...</option>';
    const { data: prods } = await sb.from('products').select('id,name,icon,item_type').order('sort_order');
    if (prods) {
      // ì´ë¦„ ê¸°ì¤€ ì¤‘ë³µ ì œê±° (store ìš°ì„ , ì—†ìœ¼ë©´ gacha)
      const seen = {};
      prods.forEach(p => {
        if (!seen[p.name]) seen[p.name] = p;
        else if (seen[p.name].item_type !== 'store' && p.item_type === 'store') seen[p.name] = p;
      });
      Object.values(seen).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name; // nameì„ keyë¡œ ì‚¬ìš© (scope ì²˜ë¦¬ ì‹œ nameìœ¼ë¡œ ê²€ìƒ‰)
        opt.textContent = `${p.icon || 'ğŸ'} ${p.name}`;
        sel.appendChild(opt);
      });
    }
  }
  // ë²”ìœ„ ë²„íŠ¼ ì´ˆê¸°í™”
  setRecycleScope('all');
  // ë§¤ì… ëª©ë¡ ë Œë”
  await renderRecycleAdminList();
}

function setRecycleScope(scope) {
  document.getElementById('rc-scope').value = scope;
  document.querySelectorAll('.rc-scope-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.scope === scope);
  });
}

async function renderRecycleAdminList() {
  const el = document.getElementById('recycleAdminList');
  if (!el) return;
  const { data: items } = await sb.from('recycle_items')
    .select('*, products(id,name,icon,item_type)')
    .order('created_at', { ascending: false });

  if (!items || items.length === 0) {
    el.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ë“±ë¡ëœ ì•„ì´í…œì´ ì—†ì–´ìš”</p>';
    return;
  }

  // ì´ë¦„ë³„ ê·¸ë£¹í•‘í•´ì„œ ê°™ì€ ì´ë¦„ í•­ëª©ì€ ë¬¶ì–´ì„œ í‘œì‹œ
  const adminGroups = {};
  items.forEach(ri => {
    const name = ri.products?.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
    if (!adminGroups[name]) adminGroups[name] = [];
    adminGroups[name].push(ri);
  });

  el.innerHTML = Object.values(adminGroups).map(grp => {
    const sample = grp[0];
    const p = sample.products || {};
    const allSamePrice = grp.every(ri => ri.recycle_price === sample.recycle_price);
    const allActive = grp.every(ri => ri.active);
    const anyActive = grp.some(ri => ri.active);

    // ë²”ìœ„ í‘œì‹œ
    const types = grp.map(ri => ri.products?.item_type || 'store');
    const hasStore = types.includes('store');
    const hasGacha = types.includes('gacha');
    const scopeLabel = (hasStore && hasGacha)
      ? '<span class="text-xs font-bold" style="background:rgba(192,132,252,0.15);color:#7c3aed;padding:2px 8px;border-radius:12px">ğŸ›ï¸+ğŸ² ëª¨ë‘</span>'
      : hasGacha
        ? '<span class="it-gacha text-xs">ğŸ² ë½‘ê¸°</span>'
        : '<span class="it-store text-xs">ğŸ›ï¸ ìƒì </span>';

    const priceDisplay = allSamePrice
      ? `<p class="text-base font-black text-amber-600">+${sample.recycle_price}ğŸŒ°</p>`
      : grp.map(ri => {
          const t = ri.products?.item_type === 'gacha' ? 'ğŸ²' : 'ğŸ›ï¸';
          return `<span class="text-sm font-black text-amber-600">${t} +${ri.recycle_price}ğŸŒ°</span>`;
        }).join(' Â· ');

    // í™œì„± ìƒíƒœ (ê·¸ë£¹ ì „ì²´ ê¸°ì¤€)
    const activeStatus = allActive ? 'recycle-badge-active' : anyActive ? 'recycle-badge-inactive' : 'recycle-badge-inactive';
    const activeText = allActive ? 'í™œì„±' : anyActive ? 'ì¼ë¶€í™œì„±' : 'ë¹„í™œì„±';

    // ë²„íŠ¼: ê·¸ë£¹ ì „ì²´ í† ê¸€ / ê°œë³„ ì‚­ì œ
    const ids = grp.map(ri => ri.id);
    return `<div class="p-4 rounded-2xl row-item-bg space-y-2">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span style="font-size:1.8rem">${p.icon || 'ğŸ'}</span>
          <div>
            <div class="flex items-center gap-2 mb-0.5">${scopeLabel}</div>
            <p class="text-sm font-black text-gray-800">${p.name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
            <div class="flex items-center gap-1 mt-0.5">${priceDisplay}</div>
          </div>
        </div>
        <span class="${activeStatus}">${activeText}</span>
      </div>
      <div class="flex gap-2">
        <button class="btn btn-primary flex-1 py-1 text-xs" onclick="editRecycleGroup(${JSON.stringify(ids).replace(/"/g,'&quot;')},${sample.recycle_price})">âœï¸ ê°€ê²© ìˆ˜ì •</button>
        <button class="btn btn-gray flex-1 py-1 text-xs" onclick="toggleRecycleGroup(${JSON.stringify(ids).replace(/"/g,'&quot;')},${allActive})">${allActive ? 'â¹ ë¹„í™œì„±í™”' : 'âœ… í™œì„±í™”'}</button>
        <button class="btn py-1 px-3 text-xs" style="background:#fee2e2;color:#b91c1c" onclick="deleteRecycleGroup(${JSON.stringify(ids).replace(/"/g,'&quot;')})">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

async function addRecycleItem() {
  const productName = document.getElementById('rc-productSelect')?.value;
  const scope = document.getElementById('rc-scope')?.value || 'all';
  const price = parseInt(document.getElementById('rc-price')?.value || 0);
  if (!productName) { toast('âŒ', 'ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
  if (!price || price < 1) { toast('âŒ', 'ë§¤ì… ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  // ì„ íƒí•œ ì´ë¦„ + scopeì— í•´ë‹¹í•˜ëŠ” productë“¤ ì¡°íšŒ
  let query = sb.from('products').select('id,name,icon,item_type').eq('name', productName);
  if (scope === 'store') query = query.eq('item_type', 'store');
  else if (scope === 'gacha') query = query.eq('item_type', 'gacha');
  const { data: targets } = await query;

  if (!targets || targets.length === 0) {
    toast('âŒ', 'í•´ë‹¹ ë²”ìœ„ì— ë§ëŠ” ìƒí’ˆì´ ì—†ì–´ìš”'); return;
  }

  // ì´ë¯¸ ë“±ë¡ëœ product_id í™•ì¸ (limit(1)ìœ¼ë¡œ 406 ë°©ì§€)
  const existIds = new Set();
  for (const t of targets) {
    const { data: ex } = await sb.from('recycle_items').select('id').eq('product_id', t.id).limit(1);
    if (Array.isArray(ex) && ex.length > 0) existIds.add(t.id);
  }
  const newTargets = targets.filter(t => !existIds.has(t.id));

  if (newTargets.length === 0) {
    toast('âŒ', 'ì„ íƒí•œ ë²”ìœ„ì˜ ìƒí’ˆì´ ì´ë¯¸ ëª¨ë‘ ë“±ë¡ë˜ì–´ ìˆì–´ìš”'); return;
  }

  // ë“±ë¡
  const rows = newTargets.map(t => ({
    product_id: t.id,
    recycle_price: price,
    scope: scope === 'all' ? t.item_type : scope, // ì‹¤ì œ item_type ì €ì¥
    active: true
  }));
  const { error } = await sb.from('recycle_items').insert(rows);
  if (error) {
    toast('âŒ', 'ë“±ë¡ ì‹¤íŒ¨: ' + (error.message || '')); return;
  }

  const scopeLabel = scope === 'all' ? 'ìƒì +ë½‘ê¸° ëª¨ë‘' : scope === 'store' ? 'ìƒì ' : 'ë½‘ê¸°';
  document.getElementById('rc-productSelect').value = '';
  document.getElementById('rc-price').value = '';
  toast('âœ…', `${productName} (${scopeLabel}) ë“±ë¡ ì™„ë£Œ!`);
  await renderRecycleAdminList();
}

async function toggleRecycleActive(id, current) {
  await sb.from('recycle_items').update({ active: !current }).eq('id', id);
  await renderRecycleAdminList();
}

// ê·¸ë£¹ ì¼ê´„ í† ê¸€
async function toggleRecycleGroup(ids, allActive) {
  for (const id of ids) {
    await sb.from('recycle_items').update({ active: !allActive }).eq('id', id);
  }
  await renderRecycleAdminList();
}

// ê·¸ë£¹ ê°€ê²© ìˆ˜ì •
async function editRecycleGroup(ids, currentPrice) {
  showModal(`
    <div class="text-center">
      <div style="font-size:2.5rem;margin-bottom:8px">âœï¸</div>
      <h2 class="text-lg font-black text-gray-800 mb-4">ë§¤ì… ê°€ê²© ìˆ˜ì •</h2>
      <div class="text-left mb-4">
        <label class="text-xs font-bold text-gray-500 mb-1 block">ìƒˆ ë§¤ì… ê°€ê²© ğŸŒ°</label>
        <input class="field" type="number" id="editRecyclePrice" value="${currentPrice}" min="1" placeholder="ë„í† ë¦¬ ìˆ˜ëŸ‰">
      </div>
      <div class="flex gap-2">
        <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-green flex-1 py-2 font-black" onclick="confirmEditRecycleGroup(${JSON.stringify(ids).replace(/"/g,'&quot;')})">âœ… ì €ì¥</button>
      </div>
    </div>`);
  setTimeout(() => document.getElementById('editRecyclePrice')?.focus(), 100);
}

async function confirmEditRecycleGroup(ids) {
  const price = parseInt(document.getElementById('editRecyclePrice')?.value || 0);
  if (!price || price < 1) { toast('âŒ', 'ê°€ê²©ì„ 1 ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  closeModal();
  for (const id of ids) {
    await sb.from('recycle_items').update({ recycle_price: price }).eq('id', id);
  }
  toast('âœ…', `ë§¤ì… ê°€ê²© ${price}ğŸŒ°ë¡œ ìˆ˜ì •!`);
  await renderRecycleAdminList();
}

// ê·¸ë£¹ ì‚­ì œ
async function deleteRecycleGroup(ids) {
  showModal(`<div class="text-center">
    <div style="font-size:2.5rem;margin-bottom:8px">ğŸ—‘ï¸</div>
    <h2 class="text-lg font-black text-gray-800 mb-2">ë§¤ì… í•­ëª© ì‚­ì œ</h2>
    <p class="text-sm text-gray-500 mb-4">ì‚­ì œí•˜ë©´ ì‚¬ìš©ìê°€ í•´ë‹¹ ì•„ì´í…œì„ ì¬í™œìš©ì„¼í„°ì—ì„œ íŒë§¤í•  ìˆ˜ ì—†ì–´ìš”.</p>
    <div class="flex gap-2">
      <button class="btn btn-gray flex-1 py-2" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn flex-1 py-2 font-black" style="background:#fee2e2;color:#b91c1c" onclick="confirmDeleteRecycleGroup(${JSON.stringify(ids).replace(/"/g,'&quot;')})">ì‚­ì œ</button>
    </div>
  </div>`);
}

async function confirmDeleteRecycleGroup(ids) {
  closeModal();
  for (const id of ids) {
    await sb.from('recycle_items').delete().eq('id', id);
  }
  toast('ğŸ—‘ï¸', 'ì‚­ì œ ì™„ë£Œ');
  await renderRecycleAdminList();
}

// í•˜ìœ„ í˜¸í™˜ìš© ë‹¨ì¼ í•¨ìˆ˜ ìœ ì§€
async function deleteRecycleItem(id) { deleteRecycleGroup([id]); }
async function confirmDeleteRecycle(id) { confirmDeleteRecycleGroup([id]); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  íƒ­ë°” ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ (PC ì›¹ ëŒ€ì‘)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initTabBarDragScroll(el) {
  if (!el) return;
  let isDown = false, startX = 0, scrollLeft = 0;
  el.addEventListener('mousedown', e => {
    isDown = true;
    el.style.cursor = 'grabbing';
    startX = e.pageX - el.offsetLeft;
    scrollLeft = el.scrollLeft;
  });
  el.addEventListener('mouseleave', () => { isDown = false; el.style.cursor = 'grab'; });
  el.addEventListener('mouseup',    () => { isDown = false; el.style.cursor = 'grab'; });
  el.addEventListener('mousemove',  e => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - el.offsetLeft;
    el.scrollLeft = scrollLeft - (x - startX) * 1.2;
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  START
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
boot();
</script>

<!-- ëª¨ë‹¬ (body ì§ì† â€” position:fixed ë·°í¬íŠ¸ ê¸°ì¤€ ë³´ì¥) -->
<!-- ëª¨ë‹¬ -->
<div id="modal" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()"><div id="modalContent"></div></div>
</div>

</body>
</html>
